import{getCurrentIndex,getFileMetadata,getFileList,getFileIconState}from"./fileState.js";let importKmlFileFn=null;export function initMapPopup({buttonId:t="mapBtn",popupId:e="mapPopup",mapId:o="map"}={}){const n=document.getElementById(t),a=document.getElementById(e),i=document.getElementById(o),r=document.getElementById("viewer-container"),l=document.getElementById("control-bar"),s=document.getElementById("sidebar"),c=a.querySelector(".popup-drag-bar"),d=a.querySelector(".popup-close-btn");if(!n||!a||!i)return;i.style.cursor="default";function p(t,e){const o=a.getBoundingClientRect(),n=t-o.left,i=e-o.top,r=i>=-5&&i<=o.height+5,l=n>=-5&&n<=o.width+5;return{onLeft:Math.abs(n-0)<=5&&r,onRight:Math.abs(n-o.width)<=5&&r,onTop:Math.abs(i-0)<=5&&l,onBottom:Math.abs(i-o.height)<=5&&l}}function u(t){const{onLeft:e,onRight:o,onTop:n,onBottom:a}=t;let i="";return e&&n||o&&a?i="nwse-resize":o&&n||e&&a?i="nesw-resize":e||o?i="ew-resize":(n||a)&&(i="ns-resize"),i}let m=parseInt(localStorage.getItem("mapPopupWidth"),10),g=parseInt(localStorage.getItem("mapPopupHeight"),10);(isNaN(m)||m<=0)&&(m=500),(isNaN(g)||g<=0)&&(g=500),a.style.width=`${m}px`,a.style.height=`${g}px`;let f=null,y=[],h=[],v=null,x=[],E=null,b=null,w=null,k=null,T=!1,C=[],D=null,F=!1,I=null,z=null,S=!1,N=null,$=null;const M=i.querySelector(".coord-scale-wrapper"),P=i.querySelector("#coord-display"),B=i.querySelector("#no-coord-message"),A=i.querySelector("#copy-coord-message");let H=null,R=null,G=!1;const K=document.createElement("input");K.type="file",K.accept=".kml",K.style.display="none",a.appendChild(K);const O=document.getElementById("map-drop-overlay");let U=0;function Z(){i.style.cursor=G?"grabbing":T?"text":"default"}function X(){O&&(O.style.display="none",O.style.pointerEvents="none"),f?.dragging.enable()}function Y(){B&&(B.style.display="none")}function q(t,e){if(f=L.map(i).setView([t,e],13),f.on("dragstart",(()=>{G=!0,Z()})),f.on("dragend",(()=>{G=!1,Z()})),Z(),R=L.control.scale({position:"bottomleft",metric:!0,imperial:!1}).addTo(f),M){const t=R.getContainer();t.style.position="static",M.appendChild(t)}function o(t){if(!P)return;const{lat:e,lng:o}=t;P.textContent=`${e.toFixed(4)} ${o.toFixed(4)}`}f.on("mousemove",(t=>o(t.latlng))),f.on("move",(()=>o(f.getCenter()))),o(f.getCenter()),f.on("contextmenu",(t=>{const{lat:e,lng:o}=t.latlng,n=`${e.toFixed(6)}\t${o.toFixed(6)}`;navigator.clipboard?.writeText(n).catch((()=>{})),A&&(A.style.display="flex",clearTimeout(H),H=setTimeout((()=>{A.style.display="none"}),3e3))}));const n={attribution:"&copy; CARTO"},a={attribution:"&copy; Google"},r=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(f),l=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; Esri"}),s=L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",n),c=L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",n),d=L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",a),p=L.tileLayer("https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",a),u=L.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",a),m=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/imagery/wgs84/{z}/{x}/{y}.png",{attribution:"&copy; HKSAR Government",minZoom:0,maxZoom:19}),g=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/basemap/wgs84/{z}/{x}/{y}.png",{attribution:"&copy; HKSAR Government",maxZoom:20,minZoom:10}),y=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/label/hk/tc/wgs84/{z}/{x}/{y}.png",{attribution:!1,maxZoom:20,minZoom:0}),h=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/label/hk/tc/wgs84/{z}/{x}/{y}.png",{attribution:!1,maxZoom:20,minZoom:0}),x=L.layerGroup([g,y]),T=L.layerGroup([m,h]);f.on("zoomend",(()=>{f.getZoom()>19&&f.hasLayer(T)&&f.setZoom(19)}));const C={OpenStreetMap:r,"Esri Satellite":l,"Carto Light":s,"Carto Dark":c,"Google Streets":d,"Google Satellite":p,"Google Hybrid":u,"HK Vector":x,"HK Imagery":T};N=L.control.layers(C,null,{position:"topright"}).addTo(f),fetch("https://raw.githubusercontent.com/PanTong55/spectrogram/main/hkgrid.geojson").then((t=>t.json())).then((t=>{$=L.geoJSON(t,{interactive:!1,style:{color:"#3388ff",weight:2,fillColor:"#3388ff",fillOpacity:0}}),N.addOverlay($,"1km Grid")})),z=(new L.FeatureGroup).addTo(f),I=new L.Control.Draw({position:"topleft",edit:{featureGroup:z},draw:{circlemarker:!1}}),f.on(L.Draw.Event.CREATED,(t=>{z.addLayer(t.layer)}));const D=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-route-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Route",e.innerHTML='<i class="fa-solid fa-route"></i>',v=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",J),t}});f.addControl(new D);const F=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-import-kml-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Import KML",e.innerHTML='<i class="fa-solid fa-file-import"></i>',E=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",(()=>{K.value="",K.click()})),t}});f.addControl(new F);const S=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-clear-kml-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Clear KML",e.innerHTML='<i class="fa-solid fa-trash"></i>',b=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",V),t}});f.addControl(new S);const B=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-text-toggle-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Text",e.innerHTML='<i class="fa-solid fa-font"></i>',k=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",nt),t}});f.addControl(new B);const O=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-draw-toggle-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Draw",e.innerHTML='<i class="fa-solid fa-pen-to-square"></i>',w=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",Q),t}});f.addControl(new O)}function W(){if(!f)return;y.forEach((t=>t.remove())),y=[];const t=getFileList(),e=getCurrentIndex(),o={};function n(t){if(!t)return"";return`${(t.date||"").replace(/\D/g,"")}${t.time||""}`}t.forEach(((t,e)=>{const n=getFileMetadata(e),a=parseFloat(n.latitude),i=parseFloat(n.longitude);if(isNaN(a)||isNaN(i))return;const r=`${a.toFixed(6)},${i.toFixed(6)}`;o[r]||(o[r]=[]),o[r].push({file:t,idx:e,meta:n,lat:a,lon:i})})),Object.values(o).forEach((t=>{t.sort(((t,e)=>n(t.meta).localeCompare(n(e.meta))));const o=t[0],{lat:a,lon:i}=o,r=t.some((t=>t.idx===e)),l=t.every((t=>getFileIconState(t.idx).trash));let s="map-marker-other";r?s="map-marker-current":l&&(s="map-marker-trash");const c=L.divIcon({html:'<i class="fa-solid fa-location-dot"></i>',className:s,iconSize:[28,28],iconAnchor:[14,28]}),d=t.map((t=>t.file.name.replace(/\.wav$/i,""))),p=d.length<=5?d.join("<br>"):`${d[0]}<br>â‹®<br>${d[d.length-1]}`,u=r?1e3:0,m=L.marker([a,i],{icon:c,zIndexOffset:u});m.on("click",(()=>{document.dispatchEvent(new CustomEvent("map-file-selected",{detail:{index:o.idx}}))})),m.bindTooltip(p,{direction:"top",offset:[-3,-32],className:"map-tooltip"}),m.addTo(f),y.push(m)}))}function j(){h.forEach((t=>t.remove())),h=[],v?.classList.remove("active")}function V(){x.forEach((t=>t.remove())),x=[]}async function _(t){if(!t)return;const e=function(t){const e=(new DOMParser).parseFromString(t,"text/xml"),o=[],n=e.getElementsByTagName("LineString");for(let t=0;t<n.length;t++){const e=n[t].getElementsByTagName("coordinates")[0];if(!e)continue;const a=e.textContent.trim().split(/\s+/).map((t=>{const[e,o]=t.split(",").map(Number);return isNaN(o)||isNaN(e)?null:[o,e]})).filter(Boolean);a.length>1&&o.push(a)}return o}(await t.text());V();const o=[];e.forEach((t=>{const e=L.polyline(t,{color:"deeppink",weight:2,opacity:.8}).addTo(f);x.push(e),o.push(...t)})),o.length>0&&(f.fitBounds(o),it())}function J(){h.length>0?j():(!function(){if(!f)return;j();const t=getFileList(),e=[];t.forEach(((t,o)=>{const n=getFileMetadata(o),a=parseFloat(n.latitude),i=parseFloat(n.longitude),r=`${(n.date||"").replace(/\D/g,"")}${n.time||""}`;isNaN(a)||isNaN(i)||!r||e.push({lat:a,lon:i,ts:r})})),e.sort(((t,e)=>t.ts.localeCompare(e.ts)));let o=[],n=null;e.forEach((t=>{n&&f.distance([n.lat,n.lon],[t.lat,t.lon])>=1e3&&(o.length>1&&h.push(L.polyline(o,{color:"black",weight:2,opacity:.8}).addTo(f)),o=[]),o.push([t.lat,t.lon]),n=t})),o.length>1&&h.push(L.polyline(o,{color:"black",weight:2,opacity:.8}).addTo(f))}(),v?.classList.add("active"))}function Q(){if(!I)return;!S&&T&&nt(),S?(f.removeControl(I),w?.classList.remove("active"),S=!1):(I.addTo(f),w?.classList.add("active"),S=!0)}function tt(t,e=!1){const o=e?' title="Left click to edit\nRight click to delete"':"";return L.divIcon({className:"map-text-icon",html:`<span class="map-text-label"${o}>${n=t,n.replace(/[&<>"]/g,(t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[t])))}</span>`,iconSize:null,iconAnchor:[0,0],popupAnchor:[0,0]});var n}function et(t){if(!f||D)return;const e=t.getLatLng(),o=f.latLngToContainerPoint(e),n=document.createElement("textarea");n.value=t.text||"",n.className="map-text-input",n.rows=1,n.style.left=`${o.x}px`,n.style.top=`${o.y}px`,f.getContainer().appendChild(n),D=n,f.dragging.disable(),n.focus();const a=()=>{n.style.height="auto",n.style.height=`${n.scrollHeight}px`};a(),n.addEventListener("input",a);const i=()=>{if(!D)return;const e=n.value.trim();f.getContainer().removeChild(n),D=null,f.dragging.enable(),e?(t.text=e,t.setIcon(tt(e,T))):(f.removeLayer(t),C=C.filter((e=>e!==t)))};n.addEventListener("keydown",(t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),i())})),n.addEventListener("pointerdown",(t=>t.stopPropagation())),n.addEventListener("blur",(()=>{F=!0,setTimeout((()=>{document.activeElement!==n&&i()}))}))}function ot(t){if(F)return void(F=!1);if(D)return;const e=function(t,e){const o=L.marker(t,{icon:tt(e,T),draggable:T});return o.text=e,o.on("dblclick",(()=>{T&&et(o)})),o.on("click",(t=>{T&&!D&&(t.originalEvent.stopPropagation(),et(o))})),o.on("contextmenu",(()=>{T&&!D&&(f.removeLayer(o),C=C.filter((t=>t!==o)))})),o}(t.latlng,"");e.addTo(f),C.push(e),et(e)}function nt(){const t=!T;t&&S&&Q(),T=t,k?.classList.toggle("active",T),T?f.on("click",ot):(f.off("click",ot),D&&D.blur()),C.forEach((t=>{T?t.dragging.enable():t.dragging.disable();const e=t.text||"";t.setIcon(tt(e,T))})),Z()}i.addEventListener("dragenter",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),U++,O&&(O.style.display="flex",O.style.pointerEvents="auto"),f?.dragging.disable())})),i.addEventListener("dragover",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),t.dataTransfer.dropEffect="copy")})),i.addEventListener("dragleave",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),U--,U<=0&&X())})),i.addEventListener("drop",(async t=>{t.preventDefault(),U=0,X();const e=Array.from(t.dataTransfer.files).find((t=>t.name.endsWith(".kml")));e&&await _(e)})),importKmlFileFn=_,K.addEventListener("change",(async()=>{const t=K.files[0];t&&await _(t)}));const at=13;function it(){const t=getCurrentIndex();if(t<0)return W(),navigator.geolocation&&navigator.geolocation.getCurrentPosition((t=>{const{latitude:e,longitude:o}=t.coords,n=L.divIcon({html:'<i class="fa-solid fa-location-crosshairs"></i>',className:"map-marker-device",iconSize:[28,28],iconAnchor:[14,28]});f?f.setView([e,o]):q(e,o);const a=L.marker([e,o],{icon:n,zIndexOffset:1001});a.addTo(f),y.push(a)})),void Y();const e=getFileMetadata(t),o=parseFloat(e.latitude),n=parseFloat(e.longitude);if(isNaN(o)||isNaN(n))return W(),void(B&&(B.style.display="flex"));Y(),f?"block"!==a.style.display?f.setView([o,n],at):f.setView([o,n]):q(o,n),W()}function rt(){"block"===a.style.display?(a.style.display="none",document.body.classList.remove("map-open"),T&&nt()):(a.style.display="block",document.body.classList.add("map-open"),a.style.width=`${m}px`,a.style.height=`${g}px`,f&&f.invalidateSize(),it(),Z())}let lt=!1,st=0,ct=0,dt=!1,pt=!1,ut=!1,mt=!1,gt=!1,ft=0,yt=0,ht=0,vt=0,Lt=0,xt=0;function Et(){r&&(r.style.pointerEvents="none",r.classList.remove("hide-cursor")),l&&(l.style.pointerEvents="none"),s&&(s.style.pointerEvents="none")}function bt(){r&&(r.style.pointerEvents=""),l&&(l.style.pointerEvents=""),s&&(s.style.pointerEvents="")}c&&c.addEventListener("mousedown",(t=>{lt=!0,st=t.clientX-a.offsetLeft,ct=t.clientY-a.offsetTop,f?.dragging.disable(),Et(),document.dispatchEvent(new Event("hide-spectrogram-hover")),t.preventDefault(),t.stopPropagation()})),a.addEventListener("mousemove",(t=>{if(lt||dt)return void t.stopPropagation();const e=u(p(t.clientX,t.clientY))||"default";a.style.cursor=e,"default"!==e?(i.style.cursor=e,document.body.style.cursor=e,Et(),document.dispatchEvent(new Event("hide-spectrogram-hover")),t.stopPropagation()):(i.style.cursor="",document.body.style.cursor="",bt(),Z())})),a.addEventListener("mousedown",(t=>{if(t.target===c||c.contains(t.target))return;const e=p(t.clientX,t.clientY);if(e.onLeft||e.onRight||e.onTop||e.onBottom){dt=!0,pt=e.onLeft,ut=e.onRight,mt=e.onTop,gt=e.onBottom;const o=u(e)||"default";a.style.cursor=o,i.style.cursor=o,document.body.style.cursor=o,Et(),document.dispatchEvent(new Event("hide-spectrogram-hover")),ft=t.clientX,yt=t.clientY,ht=a.offsetWidth,vt=a.offsetHeight,Lt=a.offsetLeft,xt=a.offsetTop,f?.dragging.disable(),t.preventDefault(),t.stopPropagation()}})),document.addEventListener("mousemove",(t=>{if("block"!==a.style.display)return;if(lt||dt)return void t.stopPropagation();const e=u(p(t.clientX,t.clientY));e?(document.body.style.cursor=e,i.style.cursor=e,Et(),document.dispatchEvent(new Event("hide-spectrogram-hover")),t.stopPropagation()):(document.body.style.cursor="",i.style.cursor="",bt(),Z())}),!0),document.addEventListener("mousedown",(t=>{if("block"!==a.style.display)return;if(lt||dt)return t.stopPropagation(),void t.preventDefault();if(t.target===c||c.contains(t.target))return;const e=p(t.clientX,t.clientY);if(e.onLeft||e.onRight||e.onTop||e.onBottom){dt=!0,pt=e.onLeft,ut=e.onRight,mt=e.onTop,gt=e.onBottom;const o=u(e)||"default";a.style.cursor=o,i.style.cursor=o,document.body.style.cursor=o,Et(),document.dispatchEvent(new Event("hide-spectrogram-hover")),ft=t.clientX,yt=t.clientY,ht=a.offsetWidth,vt=a.offsetHeight,Lt=a.offsetLeft,xt=a.offsetTop,f?.dragging.disable(),t.preventDefault(),t.stopPropagation()}}),!0),window.addEventListener("mousemove",(t=>{if(lt)return a.style.left=t.clientX-st+"px",a.style.top=t.clientY-ct+"px",void t.stopPropagation();if(dt){const e=t.clientX-ft,o=t.clientY-yt;i.style.cursor=a.style.cursor,document.body.style.cursor=a.style.cursor,Et(),document.dispatchEvent(new Event("hide-spectrogram-hover")),ut&&(m=Math.max(200,ht+e),a.style.width=`${m}px`),gt&&(g=Math.max(200,vt+o),a.style.height=`${g}px`),pt&&(m=Math.max(200,ht-e),a.style.width=`${m}px`,a.style.left=`${Lt+e}px`),mt&&(g=Math.max(200,vt-o),a.style.height=`${g}px`,a.style.top=`${xt+o}px`),t.stopPropagation()}}),!0),window.addEventListener("mouseup",(t=>{lt&&(lt=!1,f?.dragging.enable(),bt(),t.stopPropagation()),dt&&(dt=!1,f?.dragging.enable(),localStorage.setItem("mapPopupWidth",m),localStorage.setItem("mapPopupHeight",g),f?.invalidateSize(),document.body.style.cursor="",a.style.cursor="",i.style.cursor="",bt(),Z(),t.stopPropagation())}),!0),n.addEventListener("click",rt),d&&d.addEventListener("click",rt),document.addEventListener("file-loaded",it),document.addEventListener("file-list-cleared",(()=>W())),document.addEventListener("file-list-changed",(()=>W())),document.addEventListener("file-icon-toggled",(()=>W()))}export async function importKmlFile(t){importKmlFileFn&&t&&await importKmlFileFn(t)}