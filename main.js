import{initWavesurfer,getWavesurfer,getPlugin,replacePlugin,createSpectrogramPlugin,getCurrentColorMap,initScrollSync}from"./modules/wsManager.js";import{initZoomControls}from"./modules/zoomControl.js";import{initFileLoader,getWavSampleRate}from"./modules/fileLoader.js";import{initBrightnessControl}from"./modules/brightnessControl.js";import{initFrequencyHover}from"./modules/frequencyHover.js";import{cropWavBlob}from"./modules/cropAudio.js";import{drawTimeAxis,drawFrequencyGrid}from"./modules/axisRenderer.js";import{initExportCsv}from"./modules/exportCsv.js";import{initTrashProgram}from"./modules/trashProgram.js";import{initDragDropLoader}from"./modules/dragDropLoader.js";import{initMapPopup}from"./modules/mapPopup.js";import{initSidebar}from"./modules/sidebar.js";import{initTagControl}from"./modules/tagControl.js";import{initDropdown}from"./modules/dropdown.js";import{showMessageBox}from"./modules/messageBox.js";import{getCurrentIndex,getFileList,toggleFileIcon,setFileList,clearFileList,getFileIconState,getFileNote,setFileNote,getFileMetadata,setFileMetadata,clearTrashFiles,getTrashFileCount,getCurrentFile}from"./modules/fileState.js";const spectrogramHeight=800;let sidebarControl,fileLoaderControl;const container=document.getElementById("spectrogram-only"),viewer=document.getElementById("viewer-container"),timeAxis=document.getElementById("time-axis"),timeWrapper=document.getElementById("time-axis-wrapper"),timeLabel=document.getElementById("time-label"),freqGrid=document.getElementById("freq-grid"),freqLabelContainer=document.getElementById("freq-labels"),hoverLineElem=document.getElementById("hover-line"),hoverLineVElem=document.getElementById("hover-line-vertical"),progressLineElem=document.getElementById("progress-line"),hoverLabelElem=document.getElementById("hover-label"),zoomControlsElem=document.getElementById("zoom-controls"),playPauseBtn=document.getElementById("playPauseBtn"),stopBtn=document.getElementById("stopBtn");let isDraggingProgress=!1,manualSeekTime=null,duration=0,lastLoadedFileName=null,currentFreqMin=10,currentFreqMax=128,currentSampleRate=256e3,selectedSampleRate="auto",currentFftSize=1024,currentOverlap="auto",overlapWarningShown=!1,freqHoverControl=null;const sampleRateBtn=document.getElementById("sampleRateInput");let selectionExpandMode=!1,expandHistory=[],currentExpandBlob=null;const expandBackBtn=document.getElementById("expandBackBtn");let ignoreNextPause=!1;const canvasElem=document.getElementById("spectrogram-canvas"),offscreen=canvasElem.transferControlToOffscreen(),specWorker=new Worker("./spectrogramWorker.js",{type:"module"});function updateExpandBackBtn(){expandBackBtn.style.display=expandHistory.length>0?"inline-flex":"none"}function showStopButton(){stopBtn.style.display="inline-flex",requestAnimationFrame((()=>stopBtn.classList.add("show")))}function hideStopButton(){stopBtn.classList.remove("show"),stopBtn.addEventListener("transitionend",(function e(){stopBtn.removeEventListener("transitionend",e),stopBtn.classList.contains("show")||(stopBtn.style.display="none")}),{once:!0})}specWorker.postMessage({type:"init",canvas:offscreen},[offscreen]),playPauseBtn.disabled=!0,hideStopButton();const getDuration=()=>duration,guanoOutput=document.getElementById("guano-output"),metadataDiv=document.getElementById("Metadata"),fileListElem=document.getElementById("fileList"),metadataToggle=document.getElementById("metadata-toggle");metadataToggle.addEventListener("click",(()=>{const e=metadataDiv.classList.toggle("collapsed");fileListElem.classList.toggle("metadata-collapsed",e),metadataToggle.classList.toggle("fa-caret-down",!e),metadataToggle.classList.toggle("fa-caret-up",e)})),initWavesurfer({container:container,sampleRate:currentSampleRate}),getWavesurfer().on("finish",(()=>{playPauseBtn.innerHTML='<i class="fa-solid fa-play"></i>',playPauseBtn.title="Play",playPauseBtn.classList.remove("playing","paused"),progressLineElem.style.display="none",progressLineElem.style.pointerEvents="none",manualSeekTime=null,hideStopButton()})),getWavesurfer().on("play",(()=>{progressLineElem.style.display="block",progressLineElem.style.pointerEvents="none",playPauseBtn.innerHTML='<i class="fa-solid fa-pause"></i>',playPauseBtn.title="Pause",playPauseBtn.classList.add("playing"),playPauseBtn.classList.remove("paused"),showStopButton()})),getWavesurfer().on("pause",(()=>{ignoreNextPause?ignoreNextPause=!1:(playPauseBtn.innerHTML='<i class="fa-solid fa-play"></i>',playPauseBtn.title="Continue",playPauseBtn.classList.add("paused"),playPauseBtn.classList.remove("playing"),progressLineElem.style.pointerEvents="auto",0===getWavesurfer().getCurrentTime()?hideStopButton():showStopButton())})),getWavesurfer().on("audioprocess",(e=>{updateProgressLine(e)})),getWavesurfer().on("seek",(e=>{updateProgressLine(e*duration)})),document.addEventListener("file-loaded",(()=>{playPauseBtn.innerHTML='<i class="fa-solid fa-play"></i>',playPauseBtn.title="Play",playPauseBtn.classList.remove("playing","paused"),progressLineElem.style.display="none",progressLineElem.style.pointerEvents="none",manualSeekTime=null,playPauseBtn.disabled=!1,hideStopButton(),updateProgressLine(0)})),playPauseBtn.addEventListener("click",(()=>{const e=getWavesurfer();e&&(e.isPlaying()?e.pause():(null!==manualSeekTime&&(e.setTime(manualSeekTime),manualSeekTime=null),e.play()))})),stopBtn.addEventListener("click",(()=>{const e=getWavesurfer();e&&(ignoreNextPause=!0,e.stop(),playPauseBtn.innerHTML='<i class="fa-solid fa-play"></i>',playPauseBtn.title="Play",playPauseBtn.classList.remove("playing","paused"),progressLineElem.style.display="none",progressLineElem.style.pointerEvents="none",manualSeekTime=null,updateProgressLine(0),hideStopButton())}));const overlay=document.getElementById("drop-overlay"),loadingOverlay=document.getElementById("loading-overlay"),uploadOverlay=document.getElementById("upload-overlay");function showDropOverlay(){overlay.style.display="flex",overlay.style.pointerEvents="auto",hoverLineElem.style.display="none",hoverLineVElem.style.display="none",hoverLabelElem.style.display="none",viewer.classList.remove("hide-cursor"),freqHoverControl?.setPersistentLinesEnabled(!1)}function hideDropOverlay(){overlay.style.display="none",overlay.style.pointerEvents="none",hoverLineElem.style.display="block",hoverLineVElem.style.display="block",freqHoverControl?.setPersistentLinesEnabled(!0),freqHoverControl?.refreshHover()}showDropOverlay(),document.addEventListener("drop-overlay-show",showDropOverlay),document.addEventListener("drop-overlay-hide",hideDropOverlay),updateSpectrogramSettingsText(),fileLoaderControl=initFileLoader({fileInputId:"fileInput",wavesurfer:getWavesurfer(),spectrogramHeight:spectrogramHeight,colorMap:[],onPluginReplaced:()=>{},onFileLoaded:e=>{hideDropOverlay(),zoomControlsElem.style.display="flex",sidebarControl.refresh(e.name)},onBeforeLoad:()=>{"flex"!==uploadOverlay.style.display&&(loadingOverlay.style.display="flex"),freqHoverControl?.hideHover(),freqHoverControl?.clearSelections(),selectionExpandMode&&(selectionExpandMode=!1,sampleRateBtn.disabled=!1,expandHistory=[],currentExpandBlob=null,updateExpandBackBtn())},onAfterLoad:()=>{"flex"!==uploadOverlay.style.display&&(loadingOverlay.style.display="none"),freqHoverControl?.refreshHover(),drawColorBar(getCurrentColorMap()),updateSpectrogramSettingsText()},onSampleRateDetected:autoSetSampleRate}),sidebarControl=initSidebar({onFileSelected:e=>{fileLoaderControl.loadFileAtIndex(e),hideDropOverlay()}});const tagControl=initTagControl();(async()=>{try{const e=await fetch("https://raw.githubusercontent.com/hkbatradar/SonoRadar/main/recording/demo_recording.wav"),t=await e.blob(),r=new File([t],"demo_recording.wav",{type:"audio/wav"});setFileList([r],-1),toggleFileIcon(0,"trash"),toggleFileIcon(0,"star"),toggleFileIcon(0,"question"),sidebarControl.refresh(r.name)}catch(e){console.error("Failed to preload demo file",e)}})(),document.addEventListener("keydown",(e=>{const t=getCurrentIndex();t<0||("Delete"===e.key?(toggleFileIcon(t,"trash"),sidebarControl.refresh(getFileList()[t].name,!1)):"*"===e.key?(toggleFileIcon(t,"star"),sidebarControl.refresh(getFileList()[t].name,!1)):"?"===e.key&&(toggleFileIcon(t,"question"),sidebarControl.refresh(getFileList()[t].name,!1)))}));const toggleGridSwitch=document.getElementById("toggleGridSwitch");async function applySampleRate(e,t=!0){const r=currentSampleRate;currentSampleRate=e;const n=currentSampleRate/2e3;freqMaxInput.max=n,freqMinInput.max=n;if(("auto"!==selectedSampleRate&&e<r||parseFloat(freqMaxInput.value)>n)&&(freqMaxInput.value=n),parseFloat(freqMinInput.value)>n&&(freqMinInput.value=n),currentFreqMax=parseFloat(freqMaxInput.value),currentFreqMin=parseFloat(freqMinInput.value),getWavesurfer()&&(getWavesurfer().options.sampleRate=currentSampleRate,t)){const e=getCurrentIndex();e>=0&&await fileLoaderControl.loadFileAtIndex(e)}freqHoverControl?.hideHover(),replacePlugin(getCurrentColorMap(),spectrogramHeight,currentFreqMin,currentFreqMax,getOverlapPercent(),(()=>{duration=getWavesurfer().getDuration(),zoomControl.applyZoom(),renderAxes(),freqHoverControl?.refreshHover()})),updateSpectrogramSettingsText()}async function handleSampleRate(e){if(selectedSampleRate=e,"auto"!==e)await applySampleRate(e);else{const e=getCurrentFile();if(e){const t=await getWavSampleRate(e);await autoSetSampleRate(t)}else updateSpectrogramSettingsText()}}async function autoSetSampleRate(e,t=!1){"auto"===selectedSampleRate&&e?await applySampleRate(e,!t):"auto"===selectedSampleRate&&updateSpectrogramSettingsText()}freqGrid.style.display="none",toggleGridSwitch.checked=!1,toggleGridSwitch.addEventListener("change",(()=>{freqGrid.style.display=toggleGridSwitch.checked?"block":"none"}));const renderAxes=()=>{drawTimeAxis({containerWidth:container.scrollWidth,duration:duration,zoomLevel:zoomControl.getZoomLevel(),axisElement:timeAxis,labelElement:timeLabel}),drawFrequencyGrid({gridCanvas:freqGrid,labelContainer:freqLabelContainer,containerElement:container,spectrogramHeight:spectrogramHeight,maxFrequency:currentFreqMax-currentFreqMin,offsetKHz:currentFreqMin}),freqHoverControl?freqHoverControl.setFrequencyRange(currentFreqMin,currentFreqMax):freqHoverControl=initFrequencyHover({viewerId:"viewer-container",wrapperId:"viewer-wrapper",hoverLineId:"hover-line",hoverLineVId:"hover-line-vertical",freqLabelId:"hover-label",spectrogramHeight:spectrogramHeight,spectrogramWidth:container.scrollWidth,maxFrequency:currentFreqMax,minFrequency:currentFreqMin,totalDuration:duration,getZoomLevel:()=>zoomControl.getZoomLevel(),getDuration:()=>duration}),updateProgressLine(getWavesurfer().getCurrentTime())},wrapper=document.getElementById("viewer-wrapper"),zoomControl=initZoomControls(getWavesurfer(),container,getDuration,renderAxes,wrapper,(()=>{freqHoverControl?.hideHover()}),(()=>{freqHoverControl?.refreshHover()}),(()=>selectionExpandMode));function updateProgressLine(e){if(isDraggingProgress)return;const t=(null===manualSeekTime||getWavesurfer().isPlaying()?e:manualSeekTime)*zoomControl.getZoomLevel()-viewer.scrollLeft;progressLineElem.style.left=`${t}px`}viewer.addEventListener("scroll",(()=>{const e=getWavesurfer();e&&updateProgressLine(e.getCurrentTime())})),progressLineElem.addEventListener("mousedown",(e=>{const t=getWavesurfer();t&&!t.isPlaying()&&(isDraggingProgress=!0,e.preventDefault())})),viewer.addEventListener("mousemove",(e=>{if(!isDraggingProgress)return;const t=viewer.getBoundingClientRect();let r=e.clientX-t.left;r=Math.max(0,Math.min(t.width,r)),manualSeekTime=Math.max(0,Math.min(duration,(r+viewer.scrollLeft)/zoomControl.getZoomLevel())),progressLineElem.style.left=`${r}px`})),document.addEventListener("mouseup",(()=>{isDraggingProgress&&(isDraggingProgress=!1)})),viewer.addEventListener("expand-selection",(async e=>{const{startTime:t,endTime:r}=e.detail;if(r>t){const e=currentExpandBlob||getCurrentFile(),n=await cropWavBlob(e,t,r);n&&(expandHistory.push(e),await getWavesurfer().loadBlob(n),currentExpandBlob=n,selectionExpandMode=!0,zoomControl.setZoomLevel(0),sampleRateBtn.disabled=!0,renderAxes(),freqHoverControl?.clearSelections(),updateExpandBackBtn())}})),initBrightnessControl({brightnessSliderId:"brightnessSlider",gainSliderId:"gainSlider",contrastSliderId:"contrastSlider",brightnessValId:"brightnessVal",gainValId:"gainVal",contrastValId:"contrastVal",resetBtnId:"resetButton",onColorMapUpdated:e=>{freqHoverControl?.hideHover(),replacePlugin(e,spectrogramHeight,currentFreqMin,currentFreqMax,getOverlapPercent(),(()=>{duration=getWavesurfer().getDuration(),zoomControl.applyZoom(),renderAxes(),freqHoverControl?.refreshHover()})),drawColorBar(e)}}),initDragDropLoader({targetElementId:"viewer-wrapper",wavesurfer:getWavesurfer(),spectrogramHeight:spectrogramHeight,colorMap:[],onPluginReplaced:()=>{},onFileLoaded:e=>{hideDropOverlay(),zoomControlsElem.style.display="flex",sidebarControl.refresh(e.name)},onBeforeLoad:()=>{"flex"!==uploadOverlay.style.display&&(loadingOverlay.style.display="flex"),freqHoverControl?.hideHover(),freqHoverControl?.clearSelections()},onAfterLoad:()=>{"flex"!==uploadOverlay.style.display&&(loadingOverlay.style.display="none"),freqHoverControl?.refreshHover(),drawColorBar(getCurrentColorMap()),updateSpectrogramSettingsText()},onSampleRateDetected:autoSetSampleRate}),initScrollSync({scrollSourceId:"viewer-container",scrollTargetId:"time-axis-wrapper"}),getWavesurfer().on("ready",(()=>{duration=getWavesurfer().getDuration(),zoomControl.setZoomLevel(0),progressLineElem.style.display="none",updateProgressLine(0),getPlugin()?.render(),requestAnimationFrame((()=>{renderAxes(),freqHoverControl?.refreshHover()}))})),getWavesurfer().on("decode",(()=>{duration=getWavesurfer().getDuration(),zoomControl.setZoomLevel(0),progressLineElem.style.display="none",updateProgressLine(0),renderAxes(),freqHoverControl?.refreshHover()})),document.body.addEventListener("touchstart",(()=>{"suspended"===getWavesurfer()?.backend?.ac?.state&&getWavesurfer().backend.ac.resume()}),{once:!0});const freqMinInput=document.getElementById("freqMinInput"),freqMaxInput=document.getElementById("freqMaxInput"),applyFreqRangeBtn=document.getElementById("applyFreqRangeBtn");freqMaxInput.max=currentSampleRate/2e3,freqMinInput.max=freqMaxInput.max;const sampleRateDropdown=initDropdown("sampleRateInput",[{label:"Auto",value:"auto"},{label:"96",value:96e3},{label:"192",value:192e3},{label:"256",value:256e3},{label:"384",value:384e3},{label:"500",value:5e5}],{onChange:e=>handleSampleRate(e.value)});sampleRateDropdown.select(0);const fftSizeDropdown=initDropdown("fftSizeInput",[{label:"512",value:512},{label:"1024",value:1024},{label:"2048",value:2048}],{onChange:e=>handleFftSize(e.value)});fftSizeDropdown.select(1);const overlapInput=document.getElementById("overlapInput");overlapInput.value="",overlapInput.addEventListener("change",(()=>{const e=overlapInput.value.trim();if(""===e)currentOverlap="auto";else{const t=parseInt(e,10);!isNaN(t)&&t>=1&&t<=99?(currentOverlap=t,t>=80&&!overlapWarningShown&&(showMessageBox({title:"Reminder",message:"Using an overlap size above 80% can significantly increase rendering time. If the .wav file is longer than 8 seconds or high-level zoom-in is enabled, large overlap sizes are not recommended."}),overlapWarningShown=!0)):(alert("Overlap must be between 1 and 99."),overlapInput.value="",currentOverlap="auto")}handleOverlapChange()}));const quickPresetBtn=document.getElementById("quickPresetBtn");function updateSpectrogramSettingsText(){const e=document.getElementById("spectrogram-settings-text"),t=currentSampleRate,r=currentFftSize,n=getOverlapPercent(),o=null!==n?`${n}%`:"Auto";e&&(e.textContent=`Sampling rate: ${t/1e3}kHz, FFT size: ${r}, Overlap size: ${o}, Hanning window`)}function drawColorBar(e){const t=document.getElementById("color-bar");if(!t)return;const r=t.getContext("2d"),n=t.width,o=t.height,a=n/e.length;for(let t=0;t<e.length;t++){const[n,l,s,i]=e[t];r.fillStyle=`rgba(${Math.round(255*n)}, ${Math.round(255*l)}, ${Math.round(255*s)}, ${i})`,r.fillRect(t*a,0,a,o)}}function getOverlapPercent(){if("auto"===currentOverlap)return null;const e=parseInt(currentOverlap,10);return isNaN(e)?null:e}function handleFftSize(e){currentFftSize=e;const t=getCurrentColorMap();freqHoverControl?.hideHover(),replacePlugin(t,spectrogramHeight,currentFreqMin,currentFreqMax,getOverlapPercent(),(()=>{duration=getWavesurfer().getDuration(),zoomControl.applyZoom(),renderAxes(),freqHoverControl?.refreshHover()}),currentFftSize),updateSpectrogramSettingsText()}function handleOverlapChange(){const e=getCurrentColorMap();freqHoverControl?.hideHover(),replacePlugin(e,spectrogramHeight,currentFreqMin,currentFreqMax,getOverlapPercent()),freqHoverControl?.refreshHover(),duration=getWavesurfer().getDuration(),zoomControl.applyZoom(),renderAxes(),updateSpectrogramSettingsText()}function updateFrequencyRange(e,t){const r=getCurrentColorMap();currentFreqMin=e,currentFreqMax=t,freqHoverControl?.hideHover(),replacePlugin(r,spectrogramHeight,e,t,getOverlapPercent()),freqHoverControl?.refreshHover(),duration=getWavesurfer().getDuration(),zoomControl.applyZoom(),renderAxes(),freqHoverControl&&freqHoverControl.setFrequencyRange(currentFreqMin,currentFreqMax),updateSpectrogramSettingsText()}quickPresetBtn.addEventListener("click",(()=>{fftSizeDropdown.select(0),overlapInput.value="",currentOverlap="auto",handleOverlapChange(),sampleRateDropdown.select(3)})),applyFreqRangeBtn.addEventListener("click",(()=>{const e=Math.max(0,parseFloat(freqMinInput.value)),t=currentSampleRate/2e3,r=Math.min(t,parseFloat(freqMaxInput.value));isNaN(e)||isNaN(r)||e>=r?alert("Please enter valid frequency values. Min must be less than Max."):updateFrequencyRange(e,r)})),document.getElementById("fileInputBtn").addEventListener("click",(()=>{document.getElementById("fileInput").click()}));const clearAllBtn=document.getElementById("clearAllBtn");clearAllBtn.addEventListener("click",(()=>{clearFileList(),sidebarControl.refresh(""),replacePlugin(getCurrentColorMap(),spectrogramHeight,currentFreqMin,currentFreqMax,getOverlapPercent()),showDropOverlay(),loadingOverlay.style.display="none",zoomControlsElem.style.display="none",guanoOutput.textContent="(no file selected)",tagControl.updateTagButtonStates(),document.dispatchEvent(new Event("file-list-cleared"))}));const clearTrashBtn=document.getElementById("clearTrashBtn");clearTrashBtn.addEventListener("click",(()=>{const e=getTrashFileCount();if(0===e)return;if(!confirm(`Confirm to clear ${e} trash flagged file(s) from the list?`))return;const t=getCurrentIndex(),r=getFileList();let n=null;if(t>=0&&getFileIconState(t).trash){for(let e=t+1;e<r.length;e++)if(!getFileIconState(e).trash){n=r[e];break}if(!n)for(let e=t-1;e>=0;e--)if(!getFileIconState(e).trash){n=r[e];break}}if(clearTrashFiles()>0){const e=getFileList();if(0===e.length)sidebarControl.refresh(""),replacePlugin(getCurrentColorMap(),spectrogramHeight,currentFreqMin,currentFreqMax,getOverlapPercent()),showDropOverlay(),loadingOverlay.style.display="none",zoomControlsElem.style.display="none",guanoOutput.textContent="(no file selected)";else{let t="";if(n)t=n.name;else{const e=getCurrentFile();t=e?e.name:""}if(sidebarControl.refresh(t),n){const t=e.findIndex((e=>e===n));t>=0&&fileLoaderControl.loadFileAtIndex(t)}}tagControl.updateTagButtonStates(),document.dispatchEvent(new Event("file-list-changed"))}}));const settingBtn=document.getElementById("setting"),toolBar=document.getElementById("tool-bar");settingBtn.addEventListener("click",(()=>{const e=toolBar.classList.toggle("open");document.body.classList.toggle("settings-open",e)})),initExportCsv(),initTrashProgram(),initMapPopup(),document.addEventListener("hide-spectrogram-hover",(()=>{freqHoverControl?.hideHover()})),document.addEventListener("map-file-selected",(e=>{const t=e.detail?.index;"number"==typeof t&&fileLoaderControl.loadFileAtIndex(t)})),expandBackBtn.addEventListener("click",(async()=>{if(0===expandHistory.length)return;const e=1===expandHistory.length,t=expandHistory.pop();t&&void 0!==t.name?e?(await getWavesurfer().loadBlob(t),duration=getWavesurfer().getDuration(),currentExpandBlob=null,selectionExpandMode=!1,sampleRateBtn.disabled=!1,zoomControl.setZoomLevel(0),renderAxes(),freqHoverControl?.clearSelections(),expandHistory=[]):(currentExpandBlob=null,await fileLoaderControl.loadFileAtIndex(getCurrentIndex())):t&&(await getWavesurfer().loadBlob(t),currentExpandBlob=t,selectionExpandMode=!0,zoomControl.setZoomLevel(0),sampleRateBtn.disabled=!0,renderAxes(),freqHoverControl?.clearSelections()),updateExpandBackBtn()})),document.addEventListener("keydown",(e=>{"Backspace"===e.key&&expandHistory.length>0&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&!e.target.isContentEditable&&(e.preventDefault(),expandBackBtn.click())})),document.addEventListener("file-loaded",(async()=>{const e=getCurrentFile();if(duration=getWavesurfer().getDuration(),zoomControl.setZoomLevel(0),playPauseBtn.classList.remove("playing","paused"),progressLineElem.style.display="none",progressLineElem.style.pointerEvents="none",manualSeekTime=null,playPauseBtn.disabled=!1,hideStopButton(),updateProgressLine(0),lastLoadedFileName=e?e.name:null,selectionExpandMode=!1,sampleRateBtn.disabled=!1,expandHistory=[],currentExpandBlob=null,updateExpandBackBtn(),e){const t=await e.arrayBuffer(),r=new(window.AudioContext||window.webkitAudioContext),n=await r.decodeAudioData(t.slice(0));specWorker.postMessage({type:"render",buffer:n.getChannelData(0),sampleRate:n.sampleRate,fftSize:currentFftSize,overlap:getOverlapPercent()},[n.getChannelData(0).buffer])}})),document.addEventListener("file-list-cleared",(()=>{selectionExpandMode=!1,sampleRateBtn.disabled=!1,expandHistory=[],currentExpandBlob=null,updateExpandBackBtn(),playPauseBtn.disabled=!0,hideStopButton()})),window.addEventListener("resize",(()=>{const e=container.clientWidth;zoomControl.applyZoom(),container.clientWidth!==e&&(renderAxes(),freqHoverControl?.refreshHover())}));