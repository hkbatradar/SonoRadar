import{initWavesurfer,getWavesurfer,getPlugin,replacePlugin,createSpectrogramPlugin,getCurrentColorMap,initScrollSync}from"./modules/wsManager.js";import{initZoomControls}from"./modules/zoomControl.js";import{initFileLoader,getWavSampleRate}from"./modules/fileLoader.js";import{initBrightnessControl}from"./modules/brightnessControl.js";import{initFrequencyHover}from"./modules/frequencyHover.js";import{cropWavBlob}from"./modules/cropAudio.js";import{drawTimeAxis,drawFrequencyGrid}from"./modules/axisRenderer.js";import{initExportCsv}from"./modules/exportCsv.js";import{initTrashProgram}from"./modules/trashProgram.js";import{initDragDropLoader}from"./modules/dragDropLoader.js";import{initMapPopup}from"./modules/mapPopup.js";import{initSidebar}from"./modules/sidebar.js";import{initTagControl}from"./modules/tagControl.js";import{initDropdown}from"./modules/dropdown.js";import{showMessageBox}from"./modules/messageBox.js";import{getCurrentIndex,getFileList,toggleFileIcon,setFileList,clearFileList,getFileIconState,getFileNote,setFileNote,getFileMetadata,setFileMetadata,clearTrashFiles,getTrashFileCount,getCurrentFile}from"./modules/fileState.js";const spectrogramHeight=800;let sidebarControl,fileLoaderControl;const container=document.getElementById("spectrogram-only"),viewer=document.getElementById("viewer-container"),timeAxis=document.getElementById("time-axis"),timeWrapper=document.getElementById("time-axis-wrapper"),timeLabel=document.getElementById("time-label"),freqGrid=document.getElementById("freq-grid"),freqLabelContainer=document.getElementById("freq-labels"),hoverLineElem=document.getElementById("hover-line"),hoverLineVElem=document.getElementById("hover-line-vertical"),hoverLabelElem=document.getElementById("hover-label"),zoomControlsElem=document.getElementById("zoom-controls");let duration=0,lastLoadedFileName=null,currentFreqMin=10,currentFreqMax=128,currentSampleRate=256e3,selectedSampleRate="auto",currentFftSize=1024,currentOverlap="auto",overlapWarningShown=!1,freqHoverControl=null;const sampleRateBtn=document.getElementById("sampleRateInput");let selectionExpandMode=!1,expandHistory=[],currentExpandBlob=null;const expandBackBtn=document.getElementById("expandBackBtn"),canvasElem=document.getElementById("spectrogram-canvas"),offscreen=canvasElem.transferControlToOffscreen(),specWorker=new Worker("./spectrogramWorker.js",{type:"module"});function updateExpandBackBtn(){expandBackBtn.style.display=expandHistory.length>0?"inline-flex":"none"}specWorker.postMessage({type:"init",canvas:offscreen},[offscreen]);const getDuration=()=>duration,guanoOutput=document.getElementById("guano-output"),metadataDiv=document.getElementById("Metadata"),fileListElem=document.getElementById("fileList"),metadataToggle=document.getElementById("metadata-toggle");metadataToggle.addEventListener("click",(()=>{const e=metadataDiv.classList.toggle("collapsed");fileListElem.classList.toggle("metadata-collapsed",e),metadataToggle.classList.toggle("fa-caret-down",!e),metadataToggle.classList.toggle("fa-caret-up",e)})),initWavesurfer({container:container,sampleRate:currentSampleRate});const overlay=document.getElementById("drop-overlay"),loadingOverlay=document.getElementById("loading-overlay"),uploadOverlay=document.getElementById("upload-overlay");function showDropOverlay(){overlay.style.display="flex",overlay.style.pointerEvents="auto",hoverLineElem.style.display="none",hoverLineVElem.style.display="none",hoverLabelElem.style.display="none",viewer.classList.remove("hide-cursor"),freqHoverControl?.setPersistentLinesEnabled(!1)}function hideDropOverlay(){overlay.style.display="none",overlay.style.pointerEvents="none",hoverLineElem.style.display="block",hoverLineVElem.style.display="block",freqHoverControl?.setPersistentLinesEnabled(!0),freqHoverControl?.refreshHover()}showDropOverlay(),document.addEventListener("drop-overlay-show",showDropOverlay),document.addEventListener("drop-overlay-hide",hideDropOverlay),updateSpectrogramSettingsText(),fileLoaderControl=initFileLoader({fileInputId:"fileInput",wavesurfer:getWavesurfer(),spectrogramHeight:spectrogramHeight,colorMap:[],onPluginReplaced:()=>{},onFileLoaded:e=>{hideDropOverlay(),zoomControlsElem.style.display="flex",sidebarControl.refresh(e.name)},onBeforeLoad:()=>{"flex"!==uploadOverlay.style.display&&(loadingOverlay.style.display="flex"),freqHoverControl?.hideHover(),freqHoverControl?.clearSelections(),selectionExpandMode&&(selectionExpandMode=!1,sampleRateBtn.disabled=!1,expandHistory=[],currentExpandBlob=null,updateExpandBackBtn())},onAfterLoad:()=>{"flex"!==uploadOverlay.style.display&&(loadingOverlay.style.display="none"),freqHoverControl?.refreshHover(),updateSpectrogramSettingsText()},onSampleRateDetected:autoSetSampleRate}),sidebarControl=initSidebar({onFileSelected:e=>{fileLoaderControl.loadFileAtIndex(e),hideDropOverlay()}});const tagControl=initTagControl();(async()=>{try{const e=await fetch("https://raw.githubusercontent.com/hkbatradar/SonoRadar/main/recording/demo_recording.wav"),t=await e.blob(),r=new File([t],"demo_recording.wav",{type:"audio/wav"});setFileList([r],-1),toggleFileIcon(0,"trash"),toggleFileIcon(0,"star"),toggleFileIcon(0,"question"),sidebarControl.refresh(r.name)}catch(e){console.error("Failed to preload demo file",e)}})(),document.addEventListener("keydown",(e=>{const t=getCurrentIndex();t<0||("Delete"===e.key?(toggleFileIcon(t,"trash"),sidebarControl.refresh(getFileList()[t].name,!1)):"*"===e.key?(toggleFileIcon(t,"star"),sidebarControl.refresh(getFileList()[t].name,!1)):"?"===e.key&&(toggleFileIcon(t,"question"),sidebarControl.refresh(getFileList()[t].name,!1)))}));const toggleGridSwitch=document.getElementById("toggleGridSwitch");async function applySampleRate(e,t=!0){const r=currentSampleRate;currentSampleRate=e;const o=currentSampleRate/2e3;freqMaxInput.max=o,freqMinInput.max=o;if(("auto"!==selectedSampleRate&&e<r||parseFloat(freqMaxInput.value)>o)&&(freqMaxInput.value=o),parseFloat(freqMinInput.value)>o&&(freqMinInput.value=o),currentFreqMax=parseFloat(freqMaxInput.value),currentFreqMin=parseFloat(freqMinInput.value),getWavesurfer()&&(getWavesurfer().options.sampleRate=currentSampleRate,t)){const e=getCurrentIndex();e>=0&&await fileLoaderControl.loadFileAtIndex(e)}freqHoverControl?.hideHover(),replacePlugin(getCurrentColorMap(),spectrogramHeight,currentFreqMin,currentFreqMax,getOverlapPercent(),(()=>{duration=getWavesurfer().getDuration(),zoomControl.applyZoom(),renderAxes(),freqHoverControl?.refreshHover()})),updateSpectrogramSettingsText()}async function handleSampleRate(e){if(selectedSampleRate=e,"auto"!==e)await applySampleRate(e);else{const e=getCurrentFile();if(e){const t=await getWavSampleRate(e);await autoSetSampleRate(t)}else updateSpectrogramSettingsText()}}async function autoSetSampleRate(e,t=!1){"auto"===selectedSampleRate&&e?await applySampleRate(e,!t):"auto"===selectedSampleRate&&updateSpectrogramSettingsText()}freqGrid.style.display="none",toggleGridSwitch.checked=!1,toggleGridSwitch.addEventListener("change",(()=>{freqGrid.style.display=toggleGridSwitch.checked?"block":"none"}));const renderAxes=()=>{drawTimeAxis({containerWidth:container.scrollWidth,duration:duration,zoomLevel:zoomControl.getZoomLevel(),axisElement:timeAxis,labelElement:timeLabel}),drawFrequencyGrid({gridCanvas:freqGrid,labelContainer:freqLabelContainer,containerElement:container,spectrogramHeight:spectrogramHeight,maxFrequency:currentFreqMax-currentFreqMin,offsetKHz:currentFreqMin}),freqHoverControl?freqHoverControl.setFrequencyRange(currentFreqMin,currentFreqMax):freqHoverControl=initFrequencyHover({viewerId:"viewer-container",wrapperId:"viewer-wrapper",hoverLineId:"hover-line",hoverLineVId:"hover-line-vertical",freqLabelId:"hover-label",spectrogramHeight:spectrogramHeight,spectrogramWidth:container.scrollWidth,maxFrequency:currentFreqMax,minFrequency:currentFreqMin,totalDuration:duration,getZoomLevel:()=>zoomControl.getZoomLevel(),getDuration:()=>duration,isExpandMode:()=>zoomControl.isExpandMode()})},wrapper=document.getElementById("viewer-wrapper"),zoomControl=initZoomControls(getWavesurfer(),container,getDuration,renderAxes,wrapper,(()=>{freqHoverControl?.hideHover()}),(()=>{freqHoverControl?.refreshHover()}),(()=>selectionExpandMode));viewer.addEventListener("expand-selection",(async e=>{const{startTime:t,endTime:r}=e.detail;if(r>t){const e=currentExpandBlob||getCurrentFile(),o=await cropWavBlob(e,t,r);o&&(expandHistory.push(e),await getWavesurfer().loadBlob(o),currentExpandBlob=o,selectionExpandMode=!0,zoomControl.setZoomLevel(0),sampleRateBtn.disabled=!0,renderAxes(),freqHoverControl?.clearSelections(),updateExpandBackBtn())}})),initBrightnessControl({brightnessSliderId:"brightnessSlider",gainSliderId:"gainSlider",brightnessValId:"brightnessVal",gainValId:"gainVal",resetBtnId:"resetButton",onColorMapUpdated:e=>{freqHoverControl?.hideHover(),replacePlugin(e,spectrogramHeight,currentFreqMin,currentFreqMax,getOverlapPercent(),(()=>{duration=getWavesurfer().getDuration(),zoomControl.applyZoom(),renderAxes(),freqHoverControl?.refreshHover()}))}}),initDragDropLoader({targetElementId:"viewer-wrapper",wavesurfer:getWavesurfer(),spectrogramHeight:spectrogramHeight,colorMap:[],onPluginReplaced:()=>{},onFileLoaded:e=>{hideDropOverlay(),zoomControlsElem.style.display="flex",sidebarControl.refresh(e.name)},onBeforeLoad:()=>{"flex"!==uploadOverlay.style.display&&(loadingOverlay.style.display="flex"),freqHoverControl?.hideHover(),freqHoverControl?.clearSelections()},onAfterLoad:()=>{"flex"!==uploadOverlay.style.display&&(loadingOverlay.style.display="none"),freqHoverControl?.refreshHover(),updateSpectrogramSettingsText()},onSampleRateDetected:autoSetSampleRate}),initScrollSync({scrollSourceId:"viewer-container",scrollTargetId:"time-axis-wrapper"}),getWavesurfer().on("ready",(()=>{duration=getWavesurfer().getDuration(),zoomControl.isExpandMode()?zoomControl.forceExpandMode():zoomControl.setZoomLevel(0),getPlugin()?.render(),requestAnimationFrame((()=>{renderAxes(),freqHoverControl?.refreshHover()}))})),getWavesurfer().on("decode",(()=>{duration=getWavesurfer().getDuration(),zoomControl.setZoomLevel(0),renderAxes(),freqHoverControl?.refreshHover()})),document.body.addEventListener("touchstart",(()=>{"suspended"===getWavesurfer()?.backend?.ac?.state&&getWavesurfer().backend.ac.resume()}),{once:!0});const freqMinInput=document.getElementById("freqMinInput"),freqMaxInput=document.getElementById("freqMaxInput"),applyFreqRangeBtn=document.getElementById("applyFreqRangeBtn");freqMaxInput.max=currentSampleRate/2e3,freqMinInput.max=freqMaxInput.max;const sampleRateDropdown=initDropdown("sampleRateInput",[{label:"Auto",value:"auto"},{label:"96",value:96e3},{label:"192",value:192e3},{label:"256",value:256e3},{label:"384",value:384e3},{label:"500",value:5e5}],{onChange:e=>handleSampleRate(e.value)});sampleRateDropdown.select(0);const fftSizeDropdown=initDropdown("fftSizeInput",[{label:"512",value:512},{label:"1024",value:1024},{label:"2048",value:2048}],{onChange:e=>handleFftSize(e.value)});fftSizeDropdown.select(1);const overlapInput=document.getElementById("overlapInput");function updateSpectrogramSettingsText(){const e=document.getElementById("spectrogram-settings"),t=currentSampleRate,r=currentFftSize,o=getOverlapPercent(),n=null!==o?`${o}%`:"Auto";e.textContent=`Sampling rate: ${t/1e3}kHz, FFT size: ${r}, Overlap size: ${n}, Hanning window`}function getOverlapPercent(){if("auto"===currentOverlap)return null;const e=parseInt(currentOverlap,10);return isNaN(e)?null:e}function handleFftSize(e){currentFftSize=e;const t=getCurrentColorMap();freqHoverControl?.hideHover(),replacePlugin(t,spectrogramHeight,currentFreqMin,currentFreqMax,getOverlapPercent(),(()=>{duration=getWavesurfer().getDuration(),zoomControl.applyZoom(),renderAxes(),freqHoverControl?.refreshHover()}),currentFftSize),updateSpectrogramSettingsText()}function handleOverlapChange(){const e=getCurrentColorMap();freqHoverControl?.hideHover(),replacePlugin(e,spectrogramHeight,currentFreqMin,currentFreqMax,getOverlapPercent()),freqHoverControl?.refreshHover(),duration=getWavesurfer().getDuration(),zoomControl.applyZoom(),renderAxes(),updateSpectrogramSettingsText()}function updateFrequencyRange(e,t){const r=getCurrentColorMap();currentFreqMin=e,currentFreqMax=t,freqHoverControl?.hideHover(),replacePlugin(r,spectrogramHeight,e,t,getOverlapPercent()),freqHoverControl?.refreshHover(),duration=getWavesurfer().getDuration(),zoomControl.applyZoom(),renderAxes(),freqHoverControl&&freqHoverControl.setFrequencyRange(currentFreqMin,currentFreqMax),updateSpectrogramSettingsText()}overlapInput.value="",overlapInput.addEventListener("change",(()=>{const e=overlapInput.value.trim();if(""===e)currentOverlap="auto";else{const t=parseInt(e,10);!isNaN(t)&&t>=1&&t<=99?(currentOverlap=t,t>=80&&!overlapWarningShown&&(showMessageBox({title:"Reminder",message:"Using an overlap size above 80% can significantly increase rendering time. If the .wav file is longer than 8 seconds or high-level zoom-in is enabled, large overlap sizes are not recommended."}),overlapWarningShown=!0)):(alert("Overlap must be between 1 and 99."),overlapInput.value="",currentOverlap="auto")}handleOverlapChange()})),applyFreqRangeBtn.addEventListener("click",(()=>{const e=Math.max(0,parseFloat(freqMinInput.value)),t=currentSampleRate/2e3,r=Math.min(t,parseFloat(freqMaxInput.value));isNaN(e)||isNaN(r)||e>=r?alert("Please enter valid frequency values. Min must be less than Max."):updateFrequencyRange(e,r)})),document.getElementById("fileInputBtn").addEventListener("click",(()=>{document.getElementById("fileInput").click()}));const clearAllBtn=document.getElementById("clearAllBtn");clearAllBtn.addEventListener("click",(()=>{clearFileList(),sidebarControl.refresh(""),replacePlugin(getCurrentColorMap(),spectrogramHeight,currentFreqMin,currentFreqMax,getOverlapPercent()),showDropOverlay(),loadingOverlay.style.display="none",zoomControlsElem.style.display="none",guanoOutput.textContent="(no file selected)",tagControl.updateTagButtonStates(),document.dispatchEvent(new Event("file-list-cleared"))}));const clearTrashBtn=document.getElementById("clearTrashBtn");clearTrashBtn.addEventListener("click",(()=>{const e=getTrashFileCount();if(0===e)return;if(!confirm(`Confirm to clear ${e} trash flagged file(s) from the list?`))return;const t=getCurrentIndex(),r=getFileList();let o=null;if(t>=0&&getFileIconState(t).trash){for(let e=t+1;e<r.length;e++)if(!getFileIconState(e).trash){o=r[e];break}if(!o)for(let e=t-1;e>=0;e--)if(!getFileIconState(e).trash){o=r[e];break}}if(clearTrashFiles()>0){const e=getFileList();if(0===e.length)sidebarControl.refresh(""),replacePlugin(getCurrentColorMap(),spectrogramHeight,currentFreqMin,currentFreqMax,getOverlapPercent()),showDropOverlay(),loadingOverlay.style.display="none",zoomControlsElem.style.display="none",guanoOutput.textContent="(no file selected)";else{let t="";if(o)t=o.name;else{const e=getCurrentFile();t=e?e.name:""}if(sidebarControl.refresh(t),o){const t=e.findIndex((e=>e===o));t>=0&&fileLoaderControl.loadFileAtIndex(t)}}tagControl.updateTagButtonStates()}}));const settingBtn=document.getElementById("setting"),toolBar=document.getElementById("tool-bar");settingBtn.addEventListener("click",(()=>{const e=toolBar.classList.toggle("open");document.body.classList.toggle("settings-open",e)})),initExportCsv(),initTrashProgram(),initMapPopup(),document.addEventListener("map-file-selected",(e=>{const t=e.detail?.index;"number"==typeof t&&fileLoaderControl.loadFileAtIndex(t)})),expandBackBtn.addEventListener("click",(async()=>{if(0===expandHistory.length)return;const e=1===expandHistory.length,t=expandHistory.pop();t&&void 0!==t.name?e?(await getWavesurfer().loadBlob(t),duration=getWavesurfer().getDuration(),currentExpandBlob=null,selectionExpandMode=!1,sampleRateBtn.disabled=!1,zoomControl.setZoomLevel(0),renderAxes(),freqHoverControl?.clearSelections(),expandHistory=[]):(currentExpandBlob=null,await fileLoaderControl.loadFileAtIndex(getCurrentIndex())):t&&(await getWavesurfer().loadBlob(t),currentExpandBlob=t,selectionExpandMode=!0,zoomControl.setZoomLevel(0),sampleRateBtn.disabled=!0,renderAxes(),freqHoverControl?.clearSelections()),updateExpandBackBtn()})),document.addEventListener("keydown",(e=>{"Backspace"===e.key&&expandHistory.length>0&&"INPUT"!==e.target.tagName&&"TEXTAREA"!==e.target.tagName&&!e.target.isContentEditable&&(e.preventDefault(),expandBackBtn.click())})),document.addEventListener("file-loaded",(async()=>{const e=getCurrentFile();if(duration=getWavesurfer().getDuration(),zoomControl.setZoomLevel(0),lastLoadedFileName=e?e.name:null,selectionExpandMode=!1,sampleRateBtn.disabled=!1,expandHistory=[],currentExpandBlob=null,updateExpandBackBtn(),e){const t=await e.arrayBuffer(),r=new(window.AudioContext||window.webkitAudioContext),o=await r.decodeAudioData(t.slice(0));specWorker.postMessage({type:"render",buffer:o.getChannelData(0),sampleRate:o.sampleRate,fftSize:currentFftSize,overlap:getOverlapPercent()},[o.getChannelData(0).buffer])}})),document.addEventListener("file-list-cleared",(()=>{selectionExpandMode=!1,sampleRateBtn.disabled=!1,expandHistory=[],currentExpandBlob=null,updateExpandBackBtn()}));