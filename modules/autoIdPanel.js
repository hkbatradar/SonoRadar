import{initDropdown}from"./dropdown.js";import{autoIdHK}from"./autoid_HK.js";export function initAutoIdPanel({buttonId:e="autoIdBtn",panelId:t="auto-id-panel",viewerId:n="viewer-container",containerId:l="spectrogram-only",overlayId:o="fixed-overlay",spectrogramHeight:i=800,getDuration:s=(()=>0),getFreqRange:a=(()=>({min:0,max:0})),hideHover:r=(()=>{}),refreshHover:d=(()=>{})}={}){const c=document.getElementById(e),u=document.getElementById(t),m=u.querySelector(".popup-drag-bar"),p=u.querySelector(".popup-close-btn"),f=document.getElementById(n),h=document.getElementById(l),y=document.getElementById(o),v=document.getElementById("layout");v&&u&&u.parentElement!==v&&v.appendChild(u);const g=document.getElementById("autoIdTabResetBtn"),E=document.getElementById("autoid-tabs"),k=[],I=Array.from({length:5},(()=>({callType:0,harmonic:0,inputs:{start:"",end:"",high:"",low:"",knee:"",heel:""},startTime:null,endTime:null,markers:{start:{el:null,freq:null,time:null},end:{el:null,freq:null,time:null},high:{el:null,freq:null,time:null},low:{el:null,freq:null,time:null},knee:{el:null,freq:null,time:null},heel:{el:null,freq:null,time:null}}})));let F=0;if(!c||!u||!f)return;function L(){const e="block"===u.style.display;u.style.display=e?"none":"block",document.body.classList.toggle("autoid-open",!e)}c.addEventListener("click",L),p?.addEventListener("click",L);let b=!1,x=0,q=0;function C(e){b&&(u.style.left=e.clientX-x+"px",u.style.top=e.clientY-q+"px")}function B(){b=!1,document.removeEventListener("mousemove",C),d()}m?.addEventListener("mousedown",(e=>{b=!0,x=e.clientX-u.offsetLeft,q=e.clientY-u.offsetTop,r(),document.addEventListener("mousemove",C,{passive:!0}),document.addEventListener("mouseup",B,{once:!0}),e.preventDefault()})),g?.addEventListener("click",te);const T=initDropdown("callTypeInput",["CF-FM","FM-CF-FM","FM","FM-QCF","QCF"]),w=initDropdown("harmonicInput",["0","1","2","3"]);if(E)for(let e=0;e<5;e++){const t=document.createElement("button");t.textContent=`${e+1}`,t.className="tab-btn",0===e&&t.classList.add("active"),t.addEventListener("click",(()=>V(e))),E.appendChild(t),k.push(t)}const N={start:document.getElementById("startFreqInput"),end:document.getElementById("endFreqInput"),high:document.getElementById("highFreqInput"),low:document.getElementById("lowFreqInput"),knee:document.getElementById("kneeFreqInput"),heel:document.getElementById("heelFreqInput")},j=document.getElementById("bandwidthVal"),M=document.getElementById("durationVal"),O=document.getElementById("pulseIdBtn"),H=document.getElementById("sequenceIdBtn"),R=document.getElementById("autoIdResult"),D=document.getElementById("bandwidth-warning"),$=document.getElementById("freq-order-warning");const Q={start:"#e74c3c",end:"#27ae60",high:"#3498db",low:"#9b59b6",knee:"#f39c12",heel:"#16a085"};let A=I[F].markers,S=null,X=null,Y=null,K=null,P=!0;function W(e){const t=I[e];A=t.markers,T.select(t.callType),w.select(t.harmonic),Object.keys(N).forEach((e=>{N[e].value=t.inputs[e]||"",null!=t.markers[e].time?N[e].dataset.time=t.markers[e].time:delete N[e].dataset.time})),X=t.startTime,Y=t.endTime,G(),J()}function V(e){e!==F&&(!function(){const e=I[F];e.callType=T.selectedIndex,e.harmonic=w.selectedIndex,e.startTime=X,e.endTime=Y,Object.keys(N).forEach((t=>{e.inputs[t]=N[t].value}))}(),k[F]&&k[F].classList.remove("active"),F=e,k[F]&&k[F].classList.add("active"),W(e))}function U(e){P=e,document.body.classList.toggle("markers-disabled",!e)}function _(e){const t=N[e];t&&(t.value="",delete t.dataset.time,t.classList.remove("active-get"),A[e].freq=null,A[e].time=null,A[e].el&&(A[e].el.style.display="none"),"start"===e&&(X=null),"end"===e&&(Y=null),I[F].inputs[e]="",I[F].markers[e].freq=null,I[F].markers[e].time=null,I[F].startTime=X,I[F].endTime=Y,G(),J())}U(!0),Object.entries(N).forEach((([e,t])=>{t&&(t.dataset.key=e,t.readOnly=!0,t.addEventListener("click",(()=>{S&&S.classList.remove("active-get"),S=t,t.classList.add("active-get"),U(!1)})))}));const z={};function G(){const e=parseFloat(N.high.value),t=parseFloat(N.low.value);let n=null;isNaN(e)||isNaN(t)?j.textContent="-":(n=e-t,j.textContent=n.toFixed(1)),null!=X&&null!=Y?M.textContent=(1e3*(Y-X)).toFixed(1):null!=A.high.time&&null!=A.low.time?M.textContent=(1e3*(A.low.time-A.high.time)).toFixed(1):M.textContent="-",function(e,t,n){const l="QCF"===T.items[T.selectedIndex]&&null!=n&&n>5,o=!isNaN(e)&&!isNaN(t)&&t>e,i=l||o;["high","low"].forEach((e=>{N[e]&&N[e].classList.toggle("invalid",i)})),D&&(D.style.display=l?"flex":"none"),$&&($.style.display=o?"flex":"none")}(e,t,n)}function J(){const{min:e,max:t}=a(),n=h.scrollWidth;I.forEach(((l,o)=>{Object.entries(l.markers).forEach((([l,a])=>{if(a.el||(a.el=function(e,t){const n=document.createElement("i");return n.className=`fa-solid fa-xmark freq-marker marker-${e}`,n.style.color=Q[e],n.dataset.key=e,n.dataset.tab=t,n.title=`${e.charAt(0).toUpperCase()+e.slice(1)} freq. marker`,n.addEventListener("mouseenter",r),n.addEventListener("mouseleave",d),n.addEventListener("mousedown",(t=>{P&&(t.stopPropagation(),r(),K=e,document.addEventListener("mousemove",Z,{passive:!0}),document.addEventListener("mouseup",ee,{once:!0}))})),n.addEventListener("click",(e=>e.stopPropagation())),y.appendChild(n),n}(l,o)),null==a.freq||null==a.time)return void(a.el.style.display="none");const c=a.time/s()*n-f.scrollLeft,u=(1-(a.freq-e)/(t-e))*i;a.el.style.left=`${c}px`,a.el.style.top=`${u}px`,a.el.style.display="block",a.el.style.pointerEvents=o===F?"auto":"none",a.el.style.opacity=o===F?"1":"0.5"}))}))}function Z(e){if(!K||!P)return;const t=f.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,o=f.scrollLeft||0,{min:r,max:d}=a(),c=(1-l/i)*(d-r)+r,u=(n+o)/h.scrollWidth*s(),m=N[K];m&&(m.value=c.toFixed(1),m.dataset.time=u,m===N.start&&(X=u),m===N.end&&(Y=u)),I[F].startTime=X,I[F].endTime=Y,A[K].freq=c,A[K].time=u,G(),J()}function ee(){K=null,document.removeEventListener("mousemove",Z),d()}function te(){var e;(e=I[F]).callType=0,e.harmonic=0,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")})),T.select(0),w.select(0),Object.values(N).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"))})),j.textContent="-",M.textContent="-",X=null,Y=null,S=null,U(!0),W(F)}return u.querySelectorAll(".autoid-marker[data-key]").forEach((e=>{const t=e.dataset.key;z[t]=e,e.addEventListener("click",(e=>{e.preventDefault(),_(t)}))})),T.onChange=function(e,t){const n=["CF-FM","FM-CF-FM","QCF"].includes(e);["knee","heel"].forEach((e=>{if(!N[e])return;N[e].disabled=n;const t=z[e];t&&(t.disabled=n),n&&_(e)})),G()},w.select(0),T.select(0),W(0),f.addEventListener("click",(e=>{if(!S)return;const t=f.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,o=f.scrollLeft||0,{min:r,max:d}=a(),c=(1-l/i)*(d-r)+r,u=(n+o)/h.scrollWidth*s(),m=S.dataset.key;S.value=c.toFixed(1),S.dataset.time=u,A[m].freq=c,A[m].time=u,S===N.start&&(X=u),S===N.end&&(Y=u),I[F].startTime=X,I[F].endTime=Y,S.classList.remove("active-get"),S=null,U(!0),G(),J()})),f.addEventListener("scroll",J),O?.addEventListener("click",(function(){const e=T.items[T.selectedIndex],t=parseFloat(N.high.value),n=parseFloat(N.low.value);let l=!0;if("CF-FM"===e||"FM-CF-FM"===e?l=!isNaN(t):"QCF"===e&&(l=!isNaN(n)),!l)return void(R&&(R.textContent="-"));const o=autoIdHK({callType:e,highFreq:t,lowFreq:n});R&&(R.innerHTML=function(e){return new Set(["Hipposideros armiger","Hipposideros gentilis","Rhinolophus affinis","Rhinolophus pusillus","Rhinolophus sinicus"]).has(e)?`<i>${e}</i>`:"Hipposideros sp."===e?"<i>Hipposideros</i> sp.":"Rhinolophus sp."===e?"<i>Rhinolophus</i> sp.":e}(o))})),H?.addEventListener("click",(function(){R&&(R.textContent="-")})),{updateMarkers:J,reset:function(){I.forEach((e=>{e.callType=0,e.harmonic=0,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.keys(e.markers).forEach((t=>{e.markers[t].freq=null,e.markers[t].time=null}))})),T.select(0),w.select(0),Object.values(N).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"))})),j.textContent="-",M.textContent="-",X=null,Y=null,I.forEach((e=>{Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")}))})),S=null,U(!0),W(F)},resetCurrentTab:te}}