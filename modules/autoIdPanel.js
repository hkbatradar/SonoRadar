import{initDropdown}from"./dropdown.js";import{autoIdHK}from"./autoid_HK.js";import{getTimeExpansionMode}from"./fileState.js";export function initAutoIdPanel({buttonId:e="autoIdBtn",panelId:t="auto-id-panel",viewerId:n="viewer-container",containerId:l="spectrogram-only",overlayId:i="fixed-overlay",spectrogramHeight:s=800,getDuration:o=(()=>0),getFreqRange:a=(()=>({min:0,max:0})),hideHover:r=(()=>{}),refreshHover:c=(()=>{})}={}){const d=document.getElementById(e),u=document.getElementById(t),m=u.querySelector(".popup-drag-bar"),f=u.querySelector(".popup-close-btn"),p=document.getElementById(n),h=document.getElementById(l),y=document.getElementById(i),E="http://www.w3.org/2000/svg",v=document.createElementNS(E,"svg");function g(){return getTimeExpansionMode()?10:1}function L(e){if(null==e||isNaN(e))return"";const t=e*g();return Math.abs(t-Math.round(t))<.001?String(Math.round(t)):t.toFixed(1)}function k(e){if(!e)return NaN;const t=""===e.value?NaN:parseFloat(e.value);return isNaN(t)?NaN:t/g()}v.id="autoid-lines",y.appendChild(v);const x=document.getElementById("layout");x&&u&&u.parentElement!==x&&x.appendChild(u);const F=document.getElementById("autoIdTabResetBtn"),b=document.getElementById("autoid-tabs"),w=[],q=Array.from({length:8},(()=>({callType:3,harmonic:0,autoIdResult:null,showValidation:!1,inputs:{start:"",end:"",high:"",low:"",knee:"",heel:"",cfStart:"",cfEnd:""},startTime:null,endTime:null,markers:{start:{el:null,freq:null,time:null},end:{el:null,freq:null,time:null},high:{el:null,freq:null,time:null},low:{el:null,freq:null,time:null},knee:{el:null,freq:null,time:null},heel:{el:null,freq:null,time:null},cfStart:{el:null,freq:null,time:null},cfEnd:{el:null,freq:null,time:null}},line:null,resultEl:null,curves:{}})));let N=0;if(!d||!u||!p)return;function I(){const e="block"===u.style.display;u.style.display=e?"none":"block",document.body.classList.toggle("autoid-open",!e),document.dispatchEvent(new Event(e?"autoid-close":"autoid-open"))}d.addEventListener("click",I),f?.addEventListener("click",I);let M=!1,C=0,B=0;function T(e){M&&(u.style.left=e.clientX-C+"px",u.style.top=e.clientY-B+"px")}function S(){M=!1,document.removeEventListener("mousemove",T),r()}m?.addEventListener("mousedown",(e=>{M=!0,C=e.clientX-u.offsetLeft,B=e.clientY-u.offsetTop,r(),document.addEventListener("mousemove",T,{passive:!0}),document.addEventListener("mouseup",S,{once:!0}),e.preventDefault()})),F?.addEventListener("click",qe);const j=initDropdown("callTypeInput",["CF-FM","FM-CF-FM","FM","FM-QCF","FM-QCF-FM","QCF"]),A=initDropdown("harmonicInput",["0","1","2","3"]);if(A.onChange=function(e,t){q[N].harmonic=t,ee||oe()},window.handleCallTypeChange=function(e,t){const n=["CF-FM","FM-CF-FM"].includes(e),l=["CF-FM","FM-CF-FM","QCF"].includes(e),i=["QCF","FM-QCF","FM","FM-QCF-FM"].includes(e);me("high",!n),me("low",!n),me("knee",!l),me("heel",!l),me("cfStart",!i),me("cfEnd",!i),q[N].callType=t,ee||oe(),fe(),Le(),q[N].showValidation=!1,Ie()},j.onChange=window.handleCallTypeChange,b){b.title="Prev pulse (Ctrl + ←), Next pulse (Ctrl + →)";for(let e=0;e<8;e++){const t=document.createElement("button");t.textContent=`${e+1}`,t.className="tab-btn",t.title=`Pulse ${e+1}`,0===e&&t.classList.add("active"),t.addEventListener("click",(()=>re(e))),b.appendChild(t),w.push(t)}}const O={start:document.getElementById("startFreqInput"),end:document.getElementById("endFreqInput"),high:document.getElementById("highFreqInput"),low:document.getElementById("lowFreqInput"),knee:document.getElementById("kneeFreqInput"),heel:document.getElementById("heelFreqInput"),cfStart:document.getElementById("cfStartFreqInput"),cfEnd:document.getElementById("cfEndFreqInput")},$={start:document.getElementById("startFreqRow"),end:document.getElementById("endFreqRow"),high:document.getElementById("highFreqRow"),low:document.getElementById("lowFreqRow"),knee:document.getElementById("kneeFreqRow"),heel:document.getElementById("heelFreqRow"),cfStart:document.getElementById("cfStartFreqRow"),cfEnd:document.getElementById("cfEndFreqRow")},R=document.getElementById("bandwidthVal"),Q=document.getElementById("durationVal"),K=document.getElementById("pulseIdBtn"),H=document.getElementById("sequenceIdBtn"),D=document.getElementById("autoIdResult");document.getElementById("bandwidth-warning"),document.getElementById("freq-order-warning"),document.getElementById("knee-order-warning"),document.getElementById("time-order-warning");const P={start:"#e74c3c",end:"#004cff",high:"#3498db",low:"#9b59b6",knee:"#f39c12",heel:"#16a085",cfStart:"#e67e22",cfEnd:"#1abc9c"},V={start:"Start freq.",end:"End freq.",high:"High freq.",low:"Low freq.",knee:"Knee freq.",heel:"Heel freq.",cfStart:"CF start",cfEnd:"CF end"};let W=q[N].markers,X=null,Y=null,z=null,U=null,_=null,G=null,J=null,Z=!0,ee=!1,te=!1,ne=!1;function le(){J=null,ie()}function ie(){q.forEach(((e,t)=>{Object.values(e.curves||{}).forEach((e=>{const n=t===N&&J===e.p1Key,l=t===N&&J===e.p2Key;e.cp1El&&(e.cp1El.style.display=n?"block":"none"),e.cp1LineEl&&(e.cp1LineEl.style.display=n?"block":"none"),e.cp2El&&(e.cp2El.style.display=l?"block":"none"),e.cp2LineEl&&(e.cp2LineEl.style.display=l?"block":"none")}))}))}function se(){const e=q[N].autoIdResult;D&&(e?D.innerHTML=Ne(e):D.textContent="-")}function oe(){null!=q[N].autoIdResult&&(q[N].autoIdResult=null,se(),Ee())}function ae(e){const t=q[e];W=t.markers,ee=!0,j.select(t.callType),A.select(t.harmonic),ee=!1,Object.keys(O).forEach((e=>{const n=O[e];if(!n)return;const l=t.inputs[e];if(null==l||""===l)n.value="";else{const e=parseFloat(l);n.value=isNaN(e)?"":L(e)}null!=t.markers[e].time?n.dataset.time=t.markers[e].time:delete n.dataset.time})),Y=t.startTime,z=t.endTime,fe(),Ee(),se(),Ie()}function re(e){e!==N&&(!function(){const e=q[N];e.callType=j.selectedIndex,e.harmonic=A.selectedIndex,e.startTime=Y,e.endTime=z,Object.keys(O).forEach((t=>{const n=O[t];if(!n)return void(e.inputs[t]="");const l=""===n.value?"":String(k(n));e.inputs[t]=l}))}(),w[N]&&w[N].classList.remove("active"),N=e,w[N]&&w[N].classList.add("active"),J=null,ae(e))}function ce(e){Z=e,document.body.classList.toggle("markers-disabled",!e)}function de(e){const t=O[e];t&&(t.value="",delete t.dataset.time,t.classList.remove("active-get"),t.classList.remove("invalid"),t.classList.remove("warning"),W[e].freq=null,W[e].time=null,W[e].el&&(W[e].el.style.display="none"),"start"===e&&(Y=null),"end"===e&&(z=null),q[N].inputs[e]="",q[N].markers[e].freq=null,q[N].markers[e].time=null,q[N].startTime=Y,q[N].endTime=z,fe(),Ee(),ee||oe(),Ie())}document.addEventListener("click",le),ce(!0),Object.entries(O).forEach((([e,t])=>{t&&(t.dataset.key=e,t.readOnly=!0,t.addEventListener("click",(()=>{if(X===t)return t.classList.remove("active-get"),X=null,void ce(!0);X&&X.classList.remove("active-get"),X=t,t.classList.add("active-get"),ce(!1)})))}));const ue={};function me(e,t){const n=$[e];if(!n)return;n.style.display=t?"flex":"none",O[e]&&(O[e].disabled=!t);const l=ue[e];l&&(l.disabled=!t),t||de(e),Ie()}function fe(){j.items[j.selectedIndex];const e=getTimeExpansionMode()?10:1,t=t=>{if(!t)return NaN;const n=""===t.value?NaN:parseFloat(t.value);return isNaN(n)?NaN:n/e};t(O.high),t(O.low),t(O.knee),t(O.cfStart),t(O.end);let n=null;const l=Object.values(W).filter((e=>null!=e.freq&&!isNaN(e.freq)&&e.el&&""!==e.el.value)).map((e=>e.freq));if(l.length>=2){n=Math.max(...l)-Math.min(...l);const e=n*(getTimeExpansionMode()?10:1);R.textContent=e.toFixed(1)}else R.textContent="-";const i=Object.values(W).filter((e=>null!=e.time&&!isNaN(e.freq))).map((e=>e.time));if(i.length>=2){const e=1e3*(Math.max(...i)-Math.min(...i));Q.textContent=function(e){if(null==e||isNaN(e))return"";const t=e/(getTimeExpansionMode()?10:1);return Math.abs(t-Math.round(t))<.001?String(Math.round(t)):t.toFixed(1)}(e)}else Q.textContent="-";!function(e,t,n,l,i,s){const o=document.getElementById("QCF-duration-warning"),a=document.getElementById("QCF-slope-warning"),r=document.getElementById("highfreq-warning"),c=document.getElementById("lowfreq-warning"),d=document.getElementById("startfreq-warning"),u=document.getElementById("endfreq-warning"),m=j.items[j.selectedIndex],f=document.getElementById("highknee-time-warning"),p=document.getElementById("lowknee-time-warning"),h=document.getElementById("highheel-time-warning"),y=document.getElementById("lowheel-time-warning");let E=!1,v=!1;if("FM-QCF"===m){const e=W.knee,t=W.heel,n=W.low;if(null!=e?.freq&&null!=e?.time&&null!=t?.freq&&null!=t?.time&&null!=n?.freq&&null!=n?.time){const n=1e3*(t.time-e.time);E=n<1;const l=Math.abs(t.freq-e.freq);if(n>0){const e=g(),t=n/(getTimeExpansionMode()?10:1);if(t>0){const n=l*e/t;v=!(n<1&&n>=.1)}}}else if(null!=e?.freq&&null!=e?.time&&null!=n?.freq&&null!=n?.time&&(null==t?.freq||null==t?.time)){const t=1e3*(n.time-e.time);E=t<1;const l=Math.abs(n.freq-e.freq);if(t>0){const e=g(),n=t/(getTimeExpansionMode()?10:1);if(n>0){const t=l*e/n;v=!(t<1&&t>=.1)}}}}if("QCF"===m){let e=null;const t=Object.values(W).filter((e=>null!=e.time&&!isNaN(e.time))).map((e=>e.time));if(t.length>=2){const n=Math.max(...t),l=Math.min(...t);e=1e3*Math.abs(n-l),E=e<1}if(null!=l&&null!=e&&e>0){const t=g(),n=e/(getTimeExpansionMode()?10:1);if(n>0){const e=l*t/n;v=!(e<1&&e>=.1)}}}const L=Object.values(W).filter((e=>null!=e.freq&&!isNaN(e.freq))).map((e=>e.freq));let k=!1,x=!1;if(L.length>1){const e=Math.max(...L),t=Math.min(...L);if(""!==O.high.value){const t=W.high?.freq;isNaN(t)||t===e||(k=!0)}if(""!==O.low.value){const e=W.low?.freq;isNaN(e)||e===t||(x=!0)}}let F=!1,b=!1;const w=Object.values(W).filter((e=>null!=e.time&&!isNaN(e.time))).map((e=>e.time));if(w.length>0){const e=Math.min(...w),t=Math.max(...w);""!==O.start.value&&null!==W.start?.time&&W.start.time>e&&(F=!0),""!==O.end.value&&null!==W.end?.time&&W.end.time<t&&(b=!0)}let q=E||v||k||x||F||b,N=!1,I=!1,M=!1,C=!1;""!==O.knee.value&&null!=W.knee?.time&&(""!==O.high.value&&null!=W.high?.time&&W.knee.time<=W.high.time&&(N=!0),""!==O.low.value&&null!=W.low?.time&&W.knee.time>=W.low.time&&(I=!0)),""!==O.heel.value&&null!=W.heel?.time&&(""!==O.high.value&&null!=W.high?.time&&W.heel.time<=W.high.time&&(M=!0),""!==O.low.value&&null!=W.low?.time&&W.heel.time>=W.low.time&&(C=!0)),q=q||N||I||M||C,O.high&&O.high.classList.toggle("warning",k),O.low&&O.low.classList.toggle("warning",x||"FM-QCF"===m&&(E||v)&&!W.heel?.time),O.knee&&O.knee.classList.toggle("warning",N||I||"FM-QCF"===m&&(E||v)),O.heel&&O.heel.classList.toggle("warning",M||C||"FM-QCF"===m&&W.heel?.time&&(E||v)),O.start&&O.start.classList.toggle("warning",F||"QCF"===m&&(E||v)),O.end&&O.end.classList.toggle("warning",b||"QCF"===m&&(E||v)),o&&(o.style.display=E?"flex":"none",o.textContent="Duration of QCF should be >= 1ms"),a&&(a.style.display=v?"flex":"none",a.textContent="Slope of QCF should be <1 and >=0.1kHz/ms"),r&&(r.style.display=k?"flex":"none",r.textContent="High frequency should be the highest one"),c&&(c.style.display=x?"flex":"none",c.textContent="Low frequency should be the lowest one"),f&&(f.style.display=N?"flex":"none",f.textContent="Knee frequency should come after High frequency"),p&&(p.style.display=I?"flex":"none",p.textContent="Knee frequency should come before Low frequency"),h&&(h.style.display=M?"flex":"none",h.textContent="Heel frequency should come after High frequency"),y&&(y.style.display=C?"flex":"none",y.textContent="Heel frequency should come before Low frequency"),d&&(d.style.display=F?"flex":"none",d.textContent="Start frequency should be the first one"),u&&(u.style.display=b?"flex":"none",u.textContent="End frequency should be the last one"),K&&(K.disabled=q),H&&(H.disabled=q)}(0,0,0,n)}function pe(e,t){const n=document.createElement("i");n.className=`fa-solid fa-xmark freq-marker marker-${e}`,n.style.color=P[e],n.dataset.key=e,n.dataset.tab=t;const l=V[e]||e;return n.dataset.title=l,n.setAttribute("aria-label",l),n.addEventListener("mouseenter",r),n.addEventListener("mouseleave",c),n.addEventListener("mousedown",(t=>{Z&&(t.stopPropagation(),r(),p.classList.add("hide-cursor"),n.classList.add("hide-cursor"),U=e,_=n,te=!1,document.addEventListener("mousemove",xe,{passive:!0}),document.addEventListener("mouseup",Fe,{once:!0}))})),n.addEventListener("click",(n=>{if(n.stopPropagation(),te)return void(te=!1);const l=q[t];let i=!1;Object.values(l.curves||{}).forEach((t=>{t.p1Key!==e&&t.p2Key!==e||!t.cp1El&&!t.cp2El||(i=!0)})),i||Le(),function(e){J=e,ie()}(e)})),y.appendChild(n),n}function he(e,t,n){const l=document.createElement("div");return l.className="path-handle",l.dataset.tab=e,l.dataset.seg=t,l.dataset.handle=n,l.addEventListener("mousedown",(i=>{Z&&(i.stopPropagation(),r(),p.classList.add("hide-cursor"),l.classList.add("hide-cursor"),document.querySelectorAll(".freq-marker").forEach((e=>e.classList.add("hide-cursor"))),document.querySelectorAll(".path-handle").forEach((e=>e.classList.add("dragging"))),document.querySelectorAll(".handle-connector").forEach((e=>e.classList.add("dragging"))),G={tabIdx:e,segKey:t,handleKey:n,el:l},document.addEventListener("mousemove",be,{passive:!0}),document.addEventListener("mouseup",we,{once:!0}))})),l.addEventListener("mouseenter",r),l.addEventListener("mouseleave",c),l.addEventListener("contextmenu",(e=>{e.preventDefault(),e.stopPropagation()})),l.addEventListener("click",(e=>e.stopPropagation())),l.style.display="none",y.appendChild(l),l}function ye(e){const t=document.createElement("div");return t.className="pulseid-result",t.dataset.tab=e,y.appendChild(t),t.addEventListener("click",(t=>{t.stopPropagation(),"block"!==u.style.display&&(u.style.display="block",document.body.classList.add("autoid-open"),document.dispatchEvent(new Event("autoid-open"))),re(e)})),t.addEventListener("mouseenter",r),t.addEventListener("mouseleave",c),t.addEventListener("contextmenu",(e=>{e.preventDefault(),e.stopPropagation()})),t}function Ee(){const{min:e,max:t}=a(),n=h.scrollWidth;q.forEach(((l,i)=>{let a=1/0,r=-1/0,c=-1/0,d=!1;Object.entries(l.markers).forEach((([l,u])=>{if(u.el||(u.el=pe(l,i)),null==u.freq||null==u.time)return void(u.el.style.display="none");const m=u.time/o()*n-p.scrollLeft,f=(1-(u.freq-e)/(t-e))*s;u.el.style.left=`${m}px`,u.el.style.top=`${f}px`,u.el.style.display="block",u.el.style.pointerEvents=i!==N||ne?"none":"auto",u.el.style.opacity=i===N?"1":"0.5",u.el.dataset.freq=u.freq,u.el.dataset.time=u.time;const h=`${V[l]||l} (${L(Number(u.freq))} kHz)`;u.el.dataset.title=h,u.el.setAttribute("aria-label",h),a=Math.min(a,m),r=Math.max(r,m),c=Math.max(c,f),d=!0})),l.resultEl||(l.resultEl=ye(i));const u=l.resultEl;l.autoIdResult&&d?(u.innerHTML=Ne(l.autoIdResult),u.style.left=(a+r)/2+"px",u.style.top=`${c+20}px`,u.style.display="block",u.classList.toggle("inactive",i!==N)):u.style.display="none"})),Le()}function ve(e,t){const n=p.scrollLeft||0,{min:l,max:i}=a();return{time:(e+n)/h.scrollWidth*o(),freq:(1-t/s)*(i-l)+l}}function ge(e,t){const n=h.scrollWidth,{min:l,max:i}=a();return{x:e/o()*n-p.scrollLeft,y:(1-(t-l)/(i-l))*s}}function Le(){const{min:e,max:t}=a(),n=h.scrollWidth;q.forEach(((l,i)=>{l.line||(l.line=document.createElementNS(E,"path"),l.line.dataset.tab=i,v.appendChild(l.line));const a=Object.entries(l.markers).filter((([e,t])=>null!=t.freq&&null!=t.time)).sort(((e,t)=>e[1].time-t[1].time)).map((([l,i])=>({x:i.time/o()*n-p.scrollLeft,y:(1-(i.freq-e)/(t-e))*s,key:l})));if(a.length<2)return l.line.setAttribute("d",""),l.line.style.display="none",Object.values(l.curves||{}).forEach((e=>{e.cp1El?.remove(),e.cp2El?.remove(),e.cp1LineEl?.remove(),e.cp2LineEl?.remove()})),void(l.curves={});const r=function(e,t,n,l=.5){if(e.length<2)return"";let i=`M ${e[0].x} ${e[0].y}`;const s=10,o=[];for(let a=0;a<e.length-1;a++){const r=e[a-1]||e[a],c=e[a],d=e[a+1],u=e[a+2]||d,m=`${c.key}-${d.key}`;o.push(m);const f=a===e.length-2,p=Math.abs(c.y-d.y);if("cfStart"===c.key&&"cfEnd"===d.key){t.curves[m]&&(t.curves[m].cp1El?.remove(),t.curves[m].cp2El?.remove(),t.curves[m].cp1LineEl?.remove(),t.curves[m].cp2LineEl?.remove(),delete t.curves[m]),i+=` L ${d.x} ${d.y}`;continue}if(f&&p<5){t.curves[m]&&(t.curves[m].cp1El?.remove(),t.curves[m].cp2El?.remove(),t.curves[m].cp1LineEl?.remove(),t.curves[m].cp2LineEl?.remove(),delete t.curves[m]),i+=` L ${c.x} ${d.y} L ${d.x} ${d.y}`;continue}t.curves[m]||(t.curves[m]={});const h=t.curves[m];let y,g,L,k;h.p1Key=c.key,h.p2Key=d.key;const x=U&&(c.key===U||d.key===U);if(!x&&h.cp1&&h.cp2)({x:y,y:g}=ge(h.cp1.time,h.cp1.freq)),({x:L,y:k}=ge(h.cp2.time,h.cp2.freq));else{if(y=c.x+(d.x-r.x)*l/6,g=c.y+(d.y-r.y)*l/6,L=d.x-(u.x-c.x)*l/6,k=d.y-(u.y-c.y)*l/6,"high"===c.key&&"knee"===d.key){const e=Math.hypot(d.x-c.x,d.y-c.y),t=Math.hypot(u.x-d.x,u.y-d.y),n=e?1+t/e*2:1;L=d.x-(u.x-c.x)*l/6*n,k=d.y-(u.y-c.y)*l/6*n}if("cfStart"!==d.key&&"end"!==d.key){const e=Math.abs(c.y-d.y),t=Math.min(s,.6*e);k=Math.min(k,d.y+t),L=Math.min(L,d.x)}const e=ve(y,g),t=ve(L,k);h.cp1=e,h.cp2=t}if(x)h.cp1El?.remove(),h.cp2El?.remove(),h.cp1LineEl?.remove(),h.cp2LineEl?.remove(),delete h.cp1El,delete h.cp2El,delete h.cp1LineEl,delete h.cp2LineEl;else{h.cp1El||(h.cp1El=he(n,m,"cp1")),h.cp2El||(h.cp2El=he(n,m,"cp2")),h.cp1LineEl||(h.cp1LineEl=document.createElementNS(E,"line"),h.cp1LineEl.classList.add("handle-connector"),h.cp1LineEl.style.display="none",h.cp1LineEl.setAttribute("stroke","#4b0082"),h.cp1LineEl.setAttribute("stroke-width","1"),v.appendChild(h.cp1LineEl)),h.cp2LineEl||(h.cp2LineEl=document.createElementNS(E,"line"),h.cp2LineEl.classList.add("handle-connector"),h.cp2LineEl.style.display="none",h.cp2LineEl.setAttribute("stroke","#4b0082"),h.cp2LineEl.setAttribute("stroke-width","1"),v.appendChild(h.cp2LineEl)),h.cp1El.style.left=`${y}px`,h.cp1El.style.top=`${g}px`,h.cp2El.style.left=`${L}px`,h.cp2El.style.top=`${k}px`;const e=5;h.cp1LineEl.setAttribute("x1",c.x),h.cp1LineEl.setAttribute("y1",c.y);const t=y-c.x,l=g-c.y,i=Math.hypot(t,l)||1,s=y-t/i*e,o=g-l/i*e;h.cp1LineEl.setAttribute("x2",s),h.cp1LineEl.setAttribute("y2",o),h.cp2LineEl.setAttribute("x1",d.x),h.cp2LineEl.setAttribute("y1",d.y);const a=L-d.x,r=k-d.y,u=Math.hypot(a,r)||1,f=L-a/u*e,p=k-r/u*e;h.cp2LineEl.setAttribute("x2",f),h.cp2LineEl.setAttribute("y2",p)}i+=` C ${y} ${g} ${L} ${k} ${d.x} ${d.y}`}return Object.keys(t.curves).forEach((e=>{if(!o.includes(e)){const n=t.curves[e];n.cp1El?.remove(),n.cp2El?.remove(),n.cp1LineEl?.remove(),n.cp2LineEl?.remove(),delete t.curves[e]}})),i}(a,l,i);l.line.setAttribute("stroke-linejoin","round"),l.line.setAttribute("d",r),l.line.style.display="block",l.line.style.opacity=i===N?"1":"0.5"})),ie()}function ke(e,t=N){const n=q[t];Object.entries(n.curves||{}).forEach((([t,l])=>{l.p1Key!==e&&l.p2Key!==e||(l.cp1El?.remove(),l.cp2El?.remove(),l.cp1LineEl?.remove(),l.cp2LineEl?.remove(),delete n.curves[t])})),le()}function xe(e){if(!U||!Z)return;te||(te=!0);const t=p.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,i=p.scrollLeft||0,{min:r,max:c}=a(),d=(1-l/s)*(c-r)+r,u=(n+i)/h.scrollWidth*o(),m=O[U];m&&(m.value=L(d),m.dataset.time=u,m===O.start&&(Y=u),m===O.end&&(z=u)),q[N].startTime=Y,q[N].endTime=z,W[U].freq=d,W[U].time=u;const f=Object.entries(W).filter((([e,t])=>null!=t.freq&&null!=t.time)).sort(((e,t)=>e[1].time-t[1].time)),y=f.findIndex((([e])=>e===U));y>0&&ke(f[y-1][0]),ke(U),y<f.length-1&&ke(f[y+1][0]),fe(),Ee()}function Fe(){const e=U;if(U=null,_&&(_.classList.remove("hide-cursor"),_=null),document.removeEventListener("mousemove",xe),p.classList.remove("hide-cursor"),c(),Ie(),oe(),e&&te){const t=Object.entries(W).filter((([e,t])=>null!=t.freq&&null!=t.time)).sort(((e,t)=>e[1].time-t[1].time)),n=t.findIndex((([t])=>t===e));n>0&&ke(t[n-1][0]),ke(e),n<t.length-1&&ke(t[n+1][0]),Le()}}function be(e){if(!G||!Z)return;const t=p.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,{time:i,freq:s}=ve(n,l),{tabIdx:o,segKey:a,handleKey:r}=G,c=q[o].curves[a];c&&(c[r]={time:i,freq:s}),Le()}function we(){G&&(G.el.classList.remove("hide-cursor"),document.querySelectorAll(".path-handle").forEach((e=>e.classList.remove("dragging"))),document.querySelectorAll(".handle-connector").forEach((e=>e.classList.remove("dragging"))),document.querySelectorAll(".freq-marker").forEach((e=>e.classList.remove("hide-cursor"))),G=null,document.removeEventListener("mousemove",be),p.classList.remove("hide-cursor"),c(),oe())}function qe(){var e;q[N].showValidation=!1,(e=q[N]).callType=3,e.harmonic=0,e.autoIdResult=null,e.showValidation=!1,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")})),Object.values(e.curves||{}).forEach((e=>{e.cp1El?.remove(),e.cp2El?.remove(),e.cp1LineEl?.remove(),e.cp2LineEl?.remove()})),e.curves={},e.line&&(e.line.setAttribute("d",""),e.line.style.display="none"),j.select(3),A.select(0),Object.values(O).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"),e.classList.remove("invalid"),e.classList.remove("warning"))})),R.textContent="-",Q.textContent="-",Y=null,z=null,X=null,q[N].autoIdResult=null,J=null,ce(!0),ae(N)}function Ne(e){return e.split(" / ").map((e=>{if(e.endsWith("sp.")){return`<i>${e.replace(" sp.","")}</i> sp.`}return"TBC"===e||"-"===e||"No species matched"===e?e:`<i>${e}</i>`})).join(" / ")}function Ie(e=!1){const t=q[N];e&&(t.showValidation=!0);const n=t.showValidation,l={"CF-FM":["cfStart","cfEnd"],"FM-CF-FM":["cfStart","cfEnd"],FM:["high","low"],"FM-QCF":["high","low","knee"],"FM-QCF-FM":["high","knee","heel","low"],QCF:["high","low"]}[j.items[j.selectedIndex]]||[];let i=!0;const s=["start","end","high","low","knee","heel","cfStart","cfEnd"];return Object.entries(O).forEach((([e,t])=>{if(t)if(l.includes(e)){const l=s.includes(e)?k(t):parseFloat(t.value),o=!isNaN(l);n?t.classList.toggle("invalid",!o):t.classList.remove("invalid"),o||(i=!1)}else t.classList.remove("invalid")})),i}function Me(){if(!Ie(!0))return q[N].autoIdResult=null,D&&(D.textContent="-"),void Ee();const e=j.items[j.selectedIndex],t=k(O.high),n=k(O.low),l=k(O.knee),i=k(O.heel),s=k(O.start),o=k(O.end),a=k(O.cfStart),r=k(O.cfEnd);let c=null;const d=Object.values(W).filter((e=>null!=e.time&&!isNaN(e.freq))).map((e=>e.time));if(d.length>=2){c=1e3*(Math.max(...d)-Math.min(...d))}let u=null;["FM-CF-FM","CF-FM"].includes(e)?isNaN(a)||isNaN(o)||(u=a-o):isNaN(t)||isNaN(n)||(u=t-n);const m=null!=W.knee.time&&null!=W.low.time?1e3*(W.knee.time-W.low.time):null,f=isNaN(l)||isNaN(n)?null:l-n,p=isNaN(i)||isNaN(n)?null:i-n,h=isNaN(l)||isNaN(i)?null:l-i,y=parseInt(A.items[A.selectedIndex],10),E=getTimeExpansionMode()?10:1,v=getTimeExpansionMode()?10:1,g={callType:e,harmonic:y,highestFreq:isNaN(t)?t:t*E,lowestFreq:isNaN(n)?n:n*E,kneeFreq:isNaN(l)?l:l*E,heelFreq:isNaN(i)?i:i*E,startFreq:isNaN(s)?s:s*E,endFreq:isNaN(o)?o:o*E,cfStart:isNaN(a)?a:a*E,cfEnd:isNaN(r)?r:r*E,duration:null==c||isNaN(c)?c:c/v,bandwidth:null==u||isNaN(u)?u:u*E,kneeLowTime:null==m||isNaN(m)?m:m/v,kneeLowBandwidth:null==f||isNaN(f)?f:f*E,heelLowBandwidth:null==p||isNaN(p)?p:p*E,kneeHeelBandwidth:null==h||isNaN(h)?h:h*E},L=autoIdHK(g);q[N].autoIdResult=L,se(),Ee()}return u.querySelectorAll(".autoid-marker[data-key]").forEach((e=>{const t=e.dataset.key;ue[t]=e,e.addEventListener("click",(e=>{e.preventDefault(),de(t)}))})),j.onChange=function(e,t){const n=["CF-FM","FM-CF-FM"].includes(e),l=["CF-FM","FM-CF-FM","QCF"].includes(e),i=["QCF","FM-QCF","FM","FM-QCF-FM"].includes(e);me("high",!n),me("low",!n),me("knee",!l),me("heel",!l),me("cfStart",!i),me("cfEnd",!i),q[N].callType=t,ee||oe(),fe(),Le(),q[N].showValidation=!1,Ie()},A.select(0),j.select(3),ae(0),document.addEventListener("keydown",(e=>{"Control"!==e.key||ne||(ne=!0,Ee())})),document.addEventListener("keyup",(e=>{"Control"===e.key&&ne&&(ne=!1,Ee())})),p.addEventListener("click",(e=>{if(!X)return;const t=p.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,i=p.scrollLeft||0,{min:r,max:c}=a(),d=(1-l/s)*(c-r)+r,u=(n+i)/h.scrollWidth*o(),m=X.dataset.key;X.value=L(d),X.dataset.time=u,W[m].freq=d,W[m].time=u,X===O.start&&(Y=u),X===O.end&&(z=u),q[N].startTime=Y,q[N].endTime=z,X.classList.remove("active-get"),X=null,ce(!0),fe(),Ee(),oe()})),p.addEventListener("scroll",Ee),K?.addEventListener("click",Me),H?.addEventListener("click",(function(){Me()})),document.addEventListener("keydown",(e=>{document.body.classList.contains("autoid-open")&&("INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName||e.target.isContentEditable||("Enter"===e.key&&e.ctrlKey?(e.preventDefault(),K?.click()):"Enter"===e.key&&e.shiftKey?(e.preventDefault(),H?.click()):e.ctrlKey&&"ArrowLeft"===e.key?(e.preventDefault(),N>0&&re(N-1)):e.ctrlKey&&"ArrowRight"===e.key&&(e.preventDefault(),N<7&&re(N+1))))})),{updateMarkers:Ee,reset:function(){q.forEach((e=>{e.showValidation=!1,e.callType=3,e.harmonic=0,e.autoIdResult=null,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.keys(e.markers).forEach((t=>{e.markers[t].freq=null,e.markers[t].time=null})),Object.values(e.curves||{}).forEach((e=>{e.cp1El?.remove(),e.cp2El?.remove(),e.cp1LineEl?.remove(),e.cp2LineEl?.remove()})),e.curves={},e.line&&(e.line.setAttribute("d",""),e.line.style.display="none")})),j.select(3),A.select(0),Object.values(O).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"),e.classList.remove("invalid"),e.classList.remove("warning"))})),R.textContent="-",Q.textContent="-",Y=null,z=null,q.forEach((e=>{Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")}))})),X=null,J=null,ce(!0),ae(N)},resetCurrentTab:qe,setMarkerAt:function(e,t,n){const l=O[e];if(!l)return;l.value=L(t),l.dataset.time=n,W[e].freq=t,W[e].time=n,"start"===e&&(Y=n),"end"===e&&(z=n),q[N].startTime=Y,q[N].endTime=z;const i=Object.entries(W).filter((([e,t])=>null!=t.freq&&null!=t.time)).sort(((e,t)=>e[1].time-t[1].time)),s=i.findIndex((([t])=>t===e)),o=[e];s>0&&o.push(i[s-1][0]),s<i.length-1&&o.push(i[s+1][0]),o.forEach((e=>ke(e,N))),fe(),Ee(),oe(),Ie()},removeMarker:function(e){de(e)},isFieldEnabled:function(e){const t=O[e];return t&&!t.disabled},getFreqRange:a,getDuration:()=>o(),spectrogramHeight:s}}