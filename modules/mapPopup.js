import{getCurrentIndex,getFileMetadata,getFileList,getFileIconState}from"./fileState.js";let importKmlFileFn=null;export function initMapPopup({buttonId:t="mapBtn",popupId:e="mapPopup",mapId:o="map"}={}){const n=document.getElementById(t),i=document.getElementById(e),a=document.getElementById(o),r=document.getElementById("viewer-container"),l=document.getElementById("control-bar"),s=document.getElementById("sidebar"),c=i.querySelector(".popup-drag-bar"),d=i.querySelector(".popup-close-btn");if(!n||!i||!a)return;a.style.cursor="default";function p(t,e){const o=i.getBoundingClientRect(),n=t-o.left,a=e-o.top,r=a>=-5&&a<=o.height+5,l=n>=-5&&n<=o.width+5;return{onLeft:Math.abs(n-0)<=5&&r,onRight:Math.abs(n-o.width)<=5&&r,onTop:Math.abs(a-0)<=5&&l,onBottom:Math.abs(a-o.height)<=5&&l}}function u(t){const{onLeft:e,onRight:o,onTop:n,onBottom:i}=t;let a="";return e&&n||o&&i?a="nwse-resize":o&&n||e&&i?a="nesw-resize":e||o?a="ew-resize":(n||i)&&(a="ns-resize"),a}let m=parseInt(localStorage.getItem("mapPopupWidth"),10),g=parseInt(localStorage.getItem("mapPopupHeight"),10);(isNaN(m)||m<=0)&&(m=500),(isNaN(g)||g<=0)&&(g=500),i.style.width=`${m}px`,i.style.height=`${g}px`;let f=null,y=[],h=[],v=null,x=[],E=null,b=null,w=null,k=null,T=!1,C=[],D=null,F=!1,I=null,S=null,N=!1,$=null,z=null;const M=a.querySelector(".coord-scale-wrapper"),P=a.querySelector("#coord-display"),B=a.querySelector("#no-coord-message"),A=a.querySelector("#copy-coord-message");let H=null,R=null,G=!1;const K=document.createElement("input");K.type="file",K.accept=".kml",K.style.display="none",i.appendChild(K);const O=document.getElementById("map-drop-overlay");let U=0;function X(){a.style.cursor=G?"grabbing":T?"text":"default"}function Y(){O&&(O.style.display="none",O.style.pointerEvents="none"),f?.dragging.enable()}function q(){B&&(B.style.display="none")}function W(t,e){if(f=L.map(a).setView([t,e],13),f.on("dragstart",(()=>{G=!0,X()})),f.on("dragend",(()=>{G=!1,X()})),X(),R=L.control.scale({position:"bottomleft",metric:!0,imperial:!1}).addTo(f),M){const t=R.getContainer();t.style.position="static",M.appendChild(t)}function o(t){if(!P)return;const{lat:e,lng:o}=t;P.textContent=`${e.toFixed(4)} ${o.toFixed(4)}`}f.on("mousemove",(t=>o(t.latlng))),f.on("move",(()=>o(f.getCenter()))),o(f.getCenter()),f.on("contextmenu",(t=>{const{lat:e,lng:o}=t.latlng,n=`${e.toFixed(6)}\t${o.toFixed(6)}`;navigator.clipboard?.writeText(n).catch((()=>{})),A&&(A.style.display="flex",clearTimeout(H),H=setTimeout((()=>{A.style.display="none"}),3e3))}));const n={attribution:"&copy; CARTO"},i={attribution:"&copy; Google"},r=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(f),l=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; Esri"}),s=L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",n),c=L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",n),d=L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",i),p=L.tileLayer("https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",i),u=L.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",i),m=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/imagery/wgs84/{z}/{x}/{y}.png",{attribution:"&copy; HKSAR Government",minZoom:0,maxZoom:19}),g=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/basemap/wgs84/{z}/{x}/{y}.png",{attribution:"&copy; HKSAR Government",maxZoom:20,minZoom:10}),y=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/label/hk/tc/wgs84/{z}/{x}/{y}.png",{attribution:!1,maxZoom:20,minZoom:0}),h={OpenStreetMap:r,"Esri Satellite":l,"Carto Light":s,"Carto Dark":c,"Google Streets":d,"Google Satellite":p,"Google Hybrid":u,"HK Vector":L.layerGroup([g,y]),"HK Imagery":L.layerGroup([m,y])};$=L.control.layers(h,null,{position:"topright"}).addTo(f),fetch("https://raw.githubusercontent.com/PanTong55/spectrogram/main/hkgrid.geojson").then((t=>t.json())).then((t=>{z=L.geoJSON(t,{interactive:!1,style:{color:"#3388ff",weight:2,fillColor:"#3388ff",fillOpacity:0}}),$.addOverlay(z,"1km Grid")})),S=(new L.FeatureGroup).addTo(f),I=new L.Control.Draw({position:"topleft",edit:{featureGroup:S},draw:{circlemarker:!1}}),f.on(L.Draw.Event.CREATED,(t=>{S.addLayer(t.layer)}));const x=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-route-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Route",e.innerHTML='<i class="fa-solid fa-route"></i>',v=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",J),t}});f.addControl(new x);const T=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-import-kml-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Import KML",e.innerHTML='<i class="fa-solid fa-file-import"></i>',E=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",(()=>{K.value="",K.click()})),t}});f.addControl(new T);const C=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-clear-kml-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Clear KML",e.innerHTML='<i class="fa-solid fa-trash"></i>',b=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",V),t}});f.addControl(new C);const D=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-text-toggle-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Text",e.innerHTML='<i class="fa-solid fa-font"></i>',k=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",nt),t}});f.addControl(new D);const F=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-draw-toggle-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Draw",e.innerHTML='<i class="fa-solid fa-pen-to-square"></i>',w=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",Q),t}});f.addControl(new F)}function Z(){if(!f)return;y.forEach((t=>t.remove())),y=[];const t=getFileList(),e=getCurrentIndex(),o={};function n(t){if(!t)return"";return`${(t.date||"").replace(/\D/g,"")}${t.time||""}`}t.forEach(((t,e)=>{const n=getFileMetadata(e),i=parseFloat(n.latitude),a=parseFloat(n.longitude);if(isNaN(i)||isNaN(a))return;const r=`${i.toFixed(6)},${a.toFixed(6)}`;o[r]||(o[r]=[]),o[r].push({file:t,idx:e,meta:n,lat:i,lon:a})})),Object.values(o).forEach((t=>{t.sort(((t,e)=>n(t.meta).localeCompare(n(e.meta))));const o=t[0],{lat:i,lon:a}=o,r=t.some((t=>t.idx===e)),l=t.every((t=>getFileIconState(t.idx).trash));let s="map-marker-other";r?s="map-marker-current":l&&(s="map-marker-trash");const c=L.divIcon({html:'<i class="fa-solid fa-location-dot"></i>',className:s,iconSize:[28,28],iconAnchor:[14,28]}),d=t.map((t=>t.file.name.replace(/\.wav$/i,""))),p=d.length<=5?d.join("<br>"):`${d[0]}<br>â‹®<br>${d[d.length-1]}`,u=r?1e3:0,m=L.marker([i,a],{icon:c,zIndexOffset:u});m.on("click",(()=>{document.dispatchEvent(new CustomEvent("map-file-selected",{detail:{index:o.idx}}))})),m.bindTooltip(p,{direction:"top",offset:[-3,-32],className:"map-tooltip"}),m.addTo(f),y.push(m)}))}function j(){h.forEach((t=>t.remove())),h=[],v?.classList.remove("active")}function V(){x.forEach((t=>t.remove())),x=[]}async function _(t){if(!t)return;const e=function(t){const e=(new DOMParser).parseFromString(t,"text/xml"),o=[],n=e.getElementsByTagName("LineString");for(let t=0;t<n.length;t++){const e=n[t].getElementsByTagName("coordinates")[0];if(!e)continue;const i=e.textContent.trim().split(/\s+/).map((t=>{const[e,o]=t.split(",").map(Number);return isNaN(o)||isNaN(e)?null:[o,e]})).filter(Boolean);i.length>1&&o.push(i)}return o}(await t.text());V();const o=[];e.forEach((t=>{const e=L.polyline(t,{color:"deeppink",weight:2,opacity:.8}).addTo(f);x.push(e),o.push(...t)})),o.length>0&&(f.fitBounds(o),at())}function J(){h.length>0?j():(!function(){if(!f)return;j();const t=getFileList(),e=[];t.forEach(((t,o)=>{const n=getFileMetadata(o),i=parseFloat(n.latitude),a=parseFloat(n.longitude),r=`${(n.date||"").replace(/\D/g,"")}${n.time||""}`;isNaN(i)||isNaN(a)||!r||e.push({lat:i,lon:a,ts:r})})),e.sort(((t,e)=>t.ts.localeCompare(e.ts)));let o=[],n=null;e.forEach((t=>{n&&f.distance([n.lat,n.lon],[t.lat,t.lon])>=1e3&&(o.length>1&&h.push(L.polyline(o,{color:"black",weight:2,opacity:.8}).addTo(f)),o=[]),o.push([t.lat,t.lon]),n=t})),o.length>1&&h.push(L.polyline(o,{color:"black",weight:2,opacity:.8}).addTo(f))}(),v?.classList.add("active"))}function Q(){if(!I)return;!N&&T&&nt(),N?(f.removeControl(I),w?.classList.remove("active"),N=!1):(I.addTo(f),w?.classList.add("active"),N=!0)}function tt(t,e=!1){const o=e?' title="Left click to edit\nRight click to delete"':"";return L.divIcon({className:"map-text-icon",html:`<span class="map-text-label"${o}>${n=t,n.replace(/[&<>"]/g,(t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[t])))}</span>`,iconSize:null,iconAnchor:[0,0],popupAnchor:[0,0]});var n}function et(t){if(!f||D)return;const e=t.getLatLng(),o=f.latLngToContainerPoint(e),n=document.createElement("textarea");n.value=t.text||"",n.className="map-text-input",n.rows=1,n.style.left=`${o.x}px`,n.style.top=`${o.y}px`,f.getContainer().appendChild(n),D=n,f.dragging.disable(),n.focus();const i=()=>{n.style.height="auto",n.style.height=`${n.scrollHeight}px`};i(),n.addEventListener("input",i);const a=()=>{if(!D)return;const e=n.value.trim();f.getContainer().removeChild(n),D=null,f.dragging.enable(),e?(t.text=e,t.setIcon(tt(e,T))):(f.removeLayer(t),C=C.filter((e=>e!==t)))};n.addEventListener("keydown",(t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),a())})),n.addEventListener("pointerdown",(t=>t.stopPropagation())),n.addEventListener("blur",(()=>{F=!0,setTimeout((()=>{document.activeElement!==n&&a()}))}))}function ot(t){if(F)return void(F=!1);if(D)return;const e=function(t,e){const o=L.marker(t,{icon:tt(e,T),draggable:T});return o.text=e,o.on("dblclick",(()=>{T&&et(o)})),o.on("click",(t=>{T&&!D&&(t.originalEvent.stopPropagation(),et(o))})),o.on("contextmenu",(()=>{T&&!D&&(f.removeLayer(o),C=C.filter((t=>t!==o)))})),o}(t.latlng,"");e.addTo(f),C.push(e),et(e)}function nt(){const t=!T;t&&N&&Q(),T=t,k?.classList.toggle("active",T),T?f.on("click",ot):(f.off("click",ot),D&&D.blur()),C.forEach((t=>{T?t.dragging.enable():t.dragging.disable();const e=t.text||"";t.setIcon(tt(e,T))})),X()}a.addEventListener("dragenter",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),U++,O&&(O.style.display="flex",O.style.pointerEvents="auto"),f?.dragging.disable())})),a.addEventListener("dragover",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),t.dataTransfer.dropEffect="copy")})),a.addEventListener("dragleave",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),U--,U<=0&&Y())})),a.addEventListener("drop",(async t=>{t.preventDefault(),U=0,Y();const e=Array.from(t.dataTransfer.files).find((t=>t.name.endsWith(".kml")));e&&await _(e)})),importKmlFileFn=_,K.addEventListener("change",(async()=>{const t=K.files[0];t&&await _(t)}));const it=13;function at(){const t=getCurrentIndex();if(t<0)return Z(),navigator.geolocation&&navigator.geolocation.getCurrentPosition((t=>{const{latitude:e,longitude:o}=t.coords,n=L.divIcon({html:'<i class="fa-solid fa-location-crosshairs"></i>',className:"map-marker-device",iconSize:[28,28],iconAnchor:[14,28]});f?f.setView([e,o]):W(e,o);const i=L.marker([e,o],{icon:n,zIndexOffset:1001});i.addTo(f),y.push(i)})),void q();const e=getFileMetadata(t),o=parseFloat(e.latitude),n=parseFloat(e.longitude);if(isNaN(o)||isNaN(n))return Z(),void(B&&(B.style.display="flex"));q(),f?"block"!==i.style.display?f.setView([o,n],it):f.setView([o,n]):W(o,n),Z()}function rt(){"block"===i.style.display?(i.style.display="none",document.body.classList.remove("map-open"),T&&nt()):(i.style.display="block",document.body.classList.add("map-open"),i.style.width=`${m}px`,i.style.height=`${g}px`,f&&f.invalidateSize(),at(),X())}let lt=!1,st=0,ct=0,dt=!1,pt=!1,ut=!1,mt=!1,gt=!1,ft=0,yt=0,ht=0,vt=0,Lt=0,xt=0;function Et(){r&&(r.style.pointerEvents="none",r.classList.remove("hide-cursor")),l&&(l.style.pointerEvents="none"),s&&(s.style.pointerEvents="none")}function bt(){r&&(r.style.pointerEvents=""),l&&(l.style.pointerEvents=""),s&&(s.style.pointerEvents="")}c&&c.addEventListener("mousedown",(t=>{lt=!0,st=t.clientX-i.offsetLeft,ct=t.clientY-i.offsetTop,f?.dragging.disable(),Et(),document.dispatchEvent(new Event("hide-spectrogram-hover")),t.preventDefault(),t.stopPropagation()})),i.addEventListener("mousemove",(t=>{if(lt||dt)return void t.stopPropagation();const e=u(p(t.clientX,t.clientY))||"default";i.style.cursor=e,"default"!==e?(a.style.cursor=e,document.body.style.cursor=e,Et(),document.dispatchEvent(new Event("hide-spectrogram-hover")),t.stopPropagation()):(a.style.cursor="",document.body.style.cursor="",bt(),X())})),i.addEventListener("mousedown",(t=>{if(t.target===c||c.contains(t.target))return;const e=p(t.clientX,t.clientY);if(e.onLeft||e.onRight||e.onTop||e.onBottom){dt=!0,pt=e.onLeft,ut=e.onRight,mt=e.onTop,gt=e.onBottom;const o=u(e)||"default";i.style.cursor=o,a.style.cursor=o,document.body.style.cursor=o,Et(),document.dispatchEvent(new Event("hide-spectrogram-hover")),ft=t.clientX,yt=t.clientY,ht=i.offsetWidth,vt=i.offsetHeight,Lt=i.offsetLeft,xt=i.offsetTop,f?.dragging.disable(),t.preventDefault(),t.stopPropagation()}})),document.addEventListener("mousemove",(t=>{if("block"!==i.style.display)return;if(lt||dt)return void t.stopPropagation();const e=u(p(t.clientX,t.clientY));e?(document.body.style.cursor=e,a.style.cursor=e,Et(),document.dispatchEvent(new Event("hide-spectrogram-hover")),t.stopPropagation()):(document.body.style.cursor="",a.style.cursor="",bt(),X())}),!0),document.addEventListener("mousedown",(t=>{if("block"!==i.style.display)return;if(lt||dt)return t.stopPropagation(),void t.preventDefault();if(t.target===c||c.contains(t.target))return;const e=p(t.clientX,t.clientY);if(e.onLeft||e.onRight||e.onTop||e.onBottom){dt=!0,pt=e.onLeft,ut=e.onRight,mt=e.onTop,gt=e.onBottom;const o=u(e)||"default";i.style.cursor=o,a.style.cursor=o,document.body.style.cursor=o,Et(),document.dispatchEvent(new Event("hide-spectrogram-hover")),ft=t.clientX,yt=t.clientY,ht=i.offsetWidth,vt=i.offsetHeight,Lt=i.offsetLeft,xt=i.offsetTop,f?.dragging.disable(),t.preventDefault(),t.stopPropagation()}}),!0),window.addEventListener("mousemove",(t=>{if(lt)return i.style.left=t.clientX-st+"px",i.style.top=t.clientY-ct+"px",void t.stopPropagation();if(dt){const e=t.clientX-ft,o=t.clientY-yt;a.style.cursor=i.style.cursor,document.body.style.cursor=i.style.cursor,Et(),document.dispatchEvent(new Event("hide-spectrogram-hover")),ut&&(m=Math.max(200,ht+e),i.style.width=`${m}px`),gt&&(g=Math.max(200,vt+o),i.style.height=`${g}px`),pt&&(m=Math.max(200,ht-e),i.style.width=`${m}px`,i.style.left=`${Lt+e}px`),mt&&(g=Math.max(200,vt-o),i.style.height=`${g}px`,i.style.top=`${xt+o}px`),t.stopPropagation()}}),!0),window.addEventListener("mouseup",(t=>{lt&&(lt=!1,f?.dragging.enable(),bt(),t.stopPropagation()),dt&&(dt=!1,f?.dragging.enable(),localStorage.setItem("mapPopupWidth",m),localStorage.setItem("mapPopupHeight",g),f?.invalidateSize(),document.body.style.cursor="",i.style.cursor="",a.style.cursor="",bt(),X(),t.stopPropagation())}),!0),n.addEventListener("click",rt),d&&d.addEventListener("click",rt),document.addEventListener("file-loaded",at),document.addEventListener("file-list-cleared",(()=>Z())),document.addEventListener("file-list-changed",(()=>Z())),document.addEventListener("file-icon-toggled",(()=>Z()))}export async function importKmlFile(t){importKmlFileFn&&t&&await importKmlFileFn(t)}