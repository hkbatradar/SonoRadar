import{initDropdown}from"./dropdown.js";import{autoIdHK}from"./autoid_HK.js";export function initAutoIdPanel({buttonId:e="autoIdBtn",panelId:t="auto-id-panel",viewerId:n="viewer-container",containerId:l="spectrogram-only",overlayId:i="fixed-overlay",spectrogramHeight:a=800,getDuration:s=(()=>0),getFreqRange:o=(()=>({min:0,max:0})),hideHover:r=(()=>{}),refreshHover:d=(()=>{})}={}){const c=document.getElementById(e),u=document.getElementById(t),m=u.querySelector(".popup-drag-bar"),f=u.querySelector(".popup-close-btn"),y=document.getElementById(n),p=document.getElementById(l),h=document.getElementById(i),g="http://www.w3.org/2000/svg",v=document.createElementNS(g,"svg");v.id="autoid-lines",h.appendChild(v);const E=document.getElementById("layout");E&&u&&u.parentElement!==E&&E.appendChild(u);const F=document.getElementById("autoIdTabResetBtn"),k=document.getElementById("autoid-tabs"),w=[],I=Array.from({length:5},(()=>({callType:3,harmonic:0,result:null,showValidation:!1,inputs:{start:"",end:"",high:"",low:"",knee:"",heel:"",cfStart:"",cfEnd:""},startTime:null,endTime:null,markers:{start:{el:null,freq:null,time:null},end:{el:null,freq:null,time:null},high:{el:null,freq:null,time:null},low:{el:null,freq:null,time:null},knee:{el:null,freq:null,time:null},heel:{el:null,freq:null,time:null},cfStart:{el:null,freq:null,time:null},cfEnd:{el:null,freq:null,time:null}},line:null})));let L=0;if(!c||!u||!y)return;function q(){const e="block"===u.style.display;u.style.display=e?"none":"block",document.body.classList.toggle("autoid-open",!e),document.dispatchEvent(new Event(e?"autoid-close":"autoid-open"))}c.addEventListener("click",q),f?.addEventListener("click",q);let x=!1,b=0,C=0;function B(e){x&&(u.style.left=e.clientX-b+"px",u.style.top=e.clientY-C+"px")}function N(){x=!1,document.removeEventListener("mousemove",B),r()}m?.addEventListener("mousedown",(e=>{x=!0,b=e.clientX-u.offsetLeft,C=e.clientY-u.offsetTop,r(),document.addEventListener("mousemove",B,{passive:!0}),document.addEventListener("mouseup",N,{once:!0}),e.preventDefault()})),F?.addEventListener("click",me);const M=initDropdown("callTypeInput",["CF-FM","FM-CF-FM","FM","FM-QCF","QCF"]),T=initDropdown("harmonicInput",["0","1","2","3"]);if(T.onChange=function(e,t){I[L].harmonic=t,U||ee()},k)for(let e=0;e<5;e++){const t=document.createElement("button");t.textContent=`${e+1}`,t.className="tab-btn",0===e&&t.classList.add("active"),t.addEventListener("click",(()=>ne(e))),k.appendChild(t),w.push(t)}const S={start:document.getElementById("startFreqInput"),end:document.getElementById("endFreqInput"),high:document.getElementById("highFreqInput"),low:document.getElementById("lowFreqInput"),knee:document.getElementById("kneeFreqInput"),heel:document.getElementById("heelFreqInput"),cfStart:document.getElementById("cfStartFreqInput"),cfEnd:document.getElementById("cfEndFreqInput")},$={start:document.getElementById("startFreqRow"),end:document.getElementById("endFreqRow"),high:document.getElementById("highFreqRow"),low:document.getElementById("lowFreqRow"),knee:document.getElementById("kneeFreqRow"),heel:document.getElementById("heelFreqRow"),cfStart:document.getElementById("cfStartFreqRow"),cfEnd:document.getElementById("cfEndFreqRow")},j=document.getElementById("bandwidthVal"),O=document.getElementById("durationVal"),R=document.getElementById("pulseIdBtn"),H=document.getElementById("sequenceIdBtn"),A=document.getElementById("autoIdResult"),Q=document.getElementById("bandwidth-warning"),V=document.getElementById("freq-order-warning"),D=document.getElementById("knee-order-warning"),W=document.getElementById("time-order-warning");const K={start:"#e74c3c",end:"#004cff",high:"#3498db",low:"#9b59b6",knee:"#f39c12",heel:"#16a085",cfStart:"#e67e22",cfEnd:"#1abc9c"},X={start:"Start freq.",end:"End freq.",high:"High freq.",low:"Low freq.",knee:"Knee freq.",heel:"Heel freq.",cfStart:"CF start",cfEnd:"CF end"};let Y=I[L].markers,P=null,_=null,z=null,G=null,J=!0,U=!1;function Z(){const e=I[L].result;A&&(e?A.innerHTML=function(e){return e.split(" / ").map((e=>{if(e.endsWith("sp.")){return`<i>${e.replace(" sp.","")}</i> sp.`}return"TBC"===e||"-"===e||"No species matched"===e?e:`<i>${e}</i>`})).join(" / ")}(e):A.textContent="-")}function ee(){null!=I[L].result&&(I[L].result=null,Z())}function te(e){const t=I[e];Y=t.markers,U=!0,M.select(t.callType),T.select(t.harmonic),U=!1,Object.keys(S).forEach((e=>{S[e].value=t.inputs[e]||"",null!=t.markers[e].time?S[e].dataset.time=t.markers[e].time:delete S[e].dataset.time})),_=t.startTime,z=t.endTime,oe(),re(),Z(),fe()}function ne(e){e!==L&&(!function(){const e=I[L];e.callType=M.selectedIndex,e.harmonic=T.selectedIndex,e.startTime=_,e.endTime=z,Object.keys(S).forEach((t=>{e.inputs[t]=S[t].value}))}(),w[L]&&w[L].classList.remove("active"),L=e,w[L]&&w[L].classList.add("active"),te(e))}function le(e){J=e,document.body.classList.toggle("markers-disabled",!e)}function ie(e){const t=S[e];t&&(t.value="",delete t.dataset.time,t.classList.remove("active-get"),t.classList.remove("invalid"),t.classList.remove("warning"),Y[e].freq=null,Y[e].time=null,Y[e].el&&(Y[e].el.style.display="none"),"start"===e&&(_=null),"end"===e&&(z=null),I[L].inputs[e]="",I[L].markers[e].freq=null,I[L].markers[e].time=null,I[L].startTime=_,I[L].endTime=z,oe(),re(),ee(),fe())}le(!0),Object.entries(S).forEach((([e,t])=>{t&&(t.dataset.key=e,t.readOnly=!0,t.addEventListener("click",(()=>{if(P===t)return t.classList.remove("active-get"),P=null,void le(!0);P&&P.classList.remove("active-get"),P=t,t.classList.add("active-get"),le(!1)})))}));const ae={};function se(e,t){const n=$[e];if(!n)return;n.style.display=t?"flex":"none",S[e]&&(S[e].disabled=!t);const l=ae[e];l&&(l.disabled=!t),t||ie(e),fe()}function oe(){const e=M.items[M.selectedIndex],t=parseFloat(S.high.value),n=parseFloat(S.low.value),l=parseFloat(S.knee.value),i=parseFloat(S.cfStart.value),a=parseFloat(S.end.value);let s=null;["FM-CF-FM","CF-FM"].includes(e)?isNaN(i)||isNaN(a)?j.textContent="-":(s=i-a,j.textContent=s.toFixed(1)):isNaN(t)||isNaN(n)?j.textContent="-":(s=t-n,j.textContent=s.toFixed(1)),null!=_&&null!=z?O.textContent=(1e3*(z-_)).toFixed(1):null!=Y.high.time&&null!=Y.low.time?O.textContent=(1e3*(Y.low.time-Y.high.time)).toFixed(1):O.textContent="-",function(e,t,n,l,i,a){const s="QCF"===M.items[M.selectedIndex]&&null!=l&&l>5,o=!isNaN(e)&&!isNaN(t)&&t>e,r=!isNaN(n)&&!isNaN(t)&&n<t,d=null!=i&&null!=a&&a<i,c=s||o||r||d;S.high&&S.high.classList.toggle("warning",s||o),S.low&&S.low.classList.toggle("warning",s||o||r),S.knee&&S.knee.classList.toggle("warning",r),S.start&&S.start.classList.toggle("warning",d),S.end&&S.end.classList.toggle("warning",d),Q&&(Q.style.display=s?"flex":"none"),V&&(V.style.display=o?"flex":"none"),D&&(D.style.display=r?"flex":"none"),W&&(W.style.display=d?"flex":"none"),R&&(R.disabled=c),H&&(H.disabled=c)}(t,n,l,s,_,z)}function re(){const{min:e,max:t}=o(),n=p.scrollWidth;I.forEach(((l,i)=>{Object.entries(l.markers).forEach((([l,o])=>{if(o.el||(o.el=function(e,t){const n=document.createElement("i");n.className=`fa-solid fa-xmark freq-marker marker-${e}`,n.style.color=K[e],n.dataset.key=e,n.dataset.tab=t;const l=X[e]||e;return n.dataset.title=l,n.setAttribute("aria-label",l),n.addEventListener("mouseenter",r),n.addEventListener("mouseleave",d),n.addEventListener("mousedown",(t=>{J&&(t.stopPropagation(),r(),G=e,document.addEventListener("mousemove",ce,{passive:!0}),document.addEventListener("mouseup",ue,{once:!0}))})),n.addEventListener("click",(e=>e.stopPropagation())),h.appendChild(n),n}(l,i)),null==o.freq||null==o.time)return void(o.el.style.display="none");const c=o.time/s()*n-y.scrollLeft,u=(1-(o.freq-e)/(t-e))*a;o.el.style.left=`${c}px`,o.el.style.top=`${u}px`,o.el.style.display="block",o.el.style.pointerEvents=i===L?"auto":"none",o.el.style.opacity=i===L?"1":"0.5",o.el.dataset.freq=o.freq,o.el.dataset.time=o.time}))})),de()}function de(){const{min:e,max:t}=o(),n=p.scrollWidth;I.forEach(((l,i)=>{l.line||(l.line=document.createElementNS(g,"path"),l.line.dataset.tab=i,v.appendChild(l.line));const o=Object.entries(l.markers).filter((([e,t])=>null!=t.freq&&null!=t.time)).sort(((e,t)=>e[1].time-t[1].time)).map((([l,i])=>({x:i.time/s()*n-y.scrollLeft,y:(1-(i.freq-e)/(t-e))*a,key:l})));if(o.length<2)return l.line.setAttribute("d",""),void(l.line.style.display="none");const r=function(e,t=.5){if(e.length<2)return"";let n=`M ${e[0].x} ${e[0].y}`;const l=10;for(let i=0;i<e.length-1;i++){const a=e[i-1]||e[i],s=e[i],o=e[i+1],r=e[i+2]||o,d=i===e.length-2,c=Math.abs(s.y-o.y);if("cfStart"===s.key&&"cfEnd"===o.key)n+=` L ${o.x} ${o.y}`;else if(d&&c<5)n+=` L ${s.x} ${o.y} L ${o.x} ${o.y}`;else{const e=s.x+(o.x-a.x)*t/6,i=s.y+(o.y-a.y)*t/6;let d=o.x-(r.x-s.x)*t/6,c=o.y-(r.y-s.y)*t/6;if("cfStart"!==o.key&&"end"!==o.key){const e=Math.abs(s.y-o.y),t=Math.min(l,.6*e);c=Math.min(c,o.y+t),d=Math.min(d,o.x)}n+=` C ${e} ${i} ${d} ${c} ${o.x} ${o.y}`}}return n}(o);l.line.setAttribute("stroke-linejoin","round"),l.line.setAttribute("d",r),l.line.style.display="block",l.line.style.opacity=i===L?"1":"0.5"}))}function ce(e){if(!G||!J)return;const t=y.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,i=y.scrollLeft||0,{min:r,max:d}=o(),c=(1-l/a)*(d-r)+r,u=(n+i)/p.scrollWidth*s(),m=S[G];m&&(m.value=c.toFixed(1),m.dataset.time=u,m===S.start&&(_=u),m===S.end&&(z=u)),I[L].startTime=_,I[L].endTime=z,Y[G].freq=c,Y[G].time=u,oe(),re()}function ue(){G=null,document.removeEventListener("mousemove",ce),d(),fe(),ee()}function me(){var e;I[L].showValidation=!1,(e=I[L]).callType=3,e.harmonic=0,e.result=null,e.showValidation=!1,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")})),e.line&&(e.line.setAttribute("d",""),e.line.style.display="none"),M.select(3),T.select(0),Object.values(S).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"),e.classList.remove("invalid"),e.classList.remove("warning"))})),j.textContent="-",O.textContent="-",_=null,z=null,P=null,I[L].result=null,le(!0),te(L)}function fe(e=!1){const t=I[L];e&&(t.showValidation=!0);const n=t.showValidation,l={"CF-FM":["cfStart","cfEnd"],"FM-CF-FM":["cfStart","cfEnd"],FM:["high","low"],"FM-QCF":["high","low","knee"],QCF:["high","low"]}[M.items[M.selectedIndex]]||[];let i=!0;return Object.entries(S).forEach((([e,t])=>{if(t)if(l.includes(e)){const e=parseFloat(t.value),l=!isNaN(e);n?t.classList.toggle("invalid",!l):t.classList.remove("invalid"),l||(i=!1)}else t.classList.remove("invalid")})),i}function ye(){if(!fe(!0))return void(A&&(A.textContent="-"));const e=M.items[M.selectedIndex],t=parseFloat(S.high.value),n=parseFloat(S.low.value),l=parseFloat(S.knee.value),i=parseFloat(S.heel.value),a=parseFloat(S.start.value),s=parseFloat(S.end.value),o=parseFloat(S.cfStart.value),r=parseFloat(S.cfEnd.value);let d=null;null!=_&&null!=z?d=1e3*(z-_):null!=Y.high.time&&null!=Y.low.time&&(d=1e3*(Y.low.time-Y.high.time));let c=null;["FM-CF-FM","CF-FM"].includes(e)?isNaN(o)||isNaN(s)||(c=o-s):isNaN(t)||isNaN(n)||(c=t-n);const u=null!=Y.knee.time&&null!=Y.low.time?1e3*(Y.knee.time-Y.low.time):null,m=isNaN(l)||isNaN(n)?null:l-n,f=isNaN(i)||isNaN(n)?null:i-n,y=isNaN(l)||isNaN(i)?null:l-i,p=parseInt(T.items[T.selectedIndex],10),h=autoIdHK({callType:e,harmonic:p,highestFreq:t,lowestFreq:n,kneeFreq:l,heelFreq:i,startFreq:a,endFreq:s,cfStart:o,cfEnd:r,duration:d,bandwidth:c,kneeLowTime:u,kneeLowBandwidth:m,heelLowBandwidth:f,kneeHeelBandwidth:y});I[L].result=h,Z()}return u.querySelectorAll(".autoid-marker[data-key]").forEach((e=>{const t=e.dataset.key;ae[t]=e,e.addEventListener("click",(e=>{e.preventDefault(),ie(t)}))})),M.onChange=function(e,t){const n=["CF-FM","FM-CF-FM"].includes(e),l=["CF-FM","FM-CF-FM","QCF"].includes(e),i=["QCF","FM-QCF","FM"].includes(e);se("high",!n),se("low",!n),se("knee",!l),se("heel",!l),se("cfStart",!i),se("cfEnd",!i),I[L].callType=t,U||ee(),oe(),de(),fe()},T.select(0),M.select(3),te(0),y.addEventListener("click",(e=>{if(!P)return;const t=y.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,i=y.scrollLeft||0,{min:r,max:d}=o(),c=(1-l/a)*(d-r)+r,u=(n+i)/p.scrollWidth*s(),m=P.dataset.key;P.value=c.toFixed(1),P.dataset.time=u,Y[m].freq=c,Y[m].time=u,P===S.start&&(_=u),P===S.end&&(z=u),I[L].startTime=_,I[L].endTime=z,P.classList.remove("active-get"),P=null,le(!0),oe(),re(),ee()})),y.addEventListener("scroll",re),R?.addEventListener("click",ye),H?.addEventListener("click",(function(){ye()})),{updateMarkers:re,reset:function(){I.forEach((e=>{e.showValidation=!1,e.callType=3,e.harmonic=0,e.result=null,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.keys(e.markers).forEach((t=>{e.markers[t].freq=null,e.markers[t].time=null})),e.line&&(e.line.setAttribute("d",""),e.line.style.display="none")})),M.select(3),T.select(0),Object.values(S).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"),e.classList.remove("invalid"),e.classList.remove("warning"))})),j.textContent="-",O.textContent="-",_=null,z=null,I.forEach((e=>{Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")}))})),P=null,le(!0),te(L)},resetCurrentTab:me,setMarkerAt:function(e,t,n){const l=S[e];l&&(l.value=t.toFixed(1),l.dataset.time=n,Y[e].freq=t,Y[e].time=n,"start"===e&&(_=n),"end"===e&&(z=n),I[L].startTime=_,I[L].endTime=z,oe(),re(),ee(),fe())},removeMarker:function(e){ie(e)},isFieldEnabled:function(e){const t=S[e];return t&&!t.disabled},getFreqRange:o,getDuration:()=>s(),spectrogramHeight:a}}