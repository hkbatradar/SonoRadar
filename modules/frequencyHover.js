export function initFrequencyHover({viewerId:e,wrapperId:t="viewer-wrapper",hoverLineId:n,hoverLineVId:i,freqLabelId:o,spectrogramHeight:l=800,spectrogramWidth:s=1024,maxFrequency:d=128,minFrequency:a=10,totalDuration:r=1e3,getZoomLevel:c,getDuration:p}){const u=document.getElementById(e),m=document.getElementById(t),v=document.getElementById(n),h=document.getElementById(i),f=document.getElementById(o),g=document.getElementById("fixed-overlay"),x=document.getElementById("zoom-controls"),y=document.getElementById("spectrogram-only"),L=[],E=[];let b=!0,w=!1;const C=()=>y.scrollWidth>u.clientWidth?0:20,F=5;let $=!1,B=!1,T=!1,k=!1,I=0,q=0,H=null,Y=null,z=null;const M=()=>{v.style.display="none",h.style.display="none",f.style.display="none"},R=e=>{if(Y=e.clientX,z=e.clientY,$||T)return void M();const t=u.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top,o=C();if(i>u.clientHeight-o)return M(),u.classList.remove("hide-cursor"),void(w=!0);w=!1,u.classList.add("hide-cursor");const s=u.scrollLeft||0,r=(1-i/l)*(d-a)+a,c=(n+s)/y.scrollWidth*p();v.style.top=`${i}px`,v.style.display="block",h.style.left=`${n}px`,h.style.display="block";let m;u.clientWidth-n<120?(f.style.transform="translate(-100%, -50%)",m=n-12+"px"):(f.style.transform="translate(0, -50%)",m=`${n+12}px`),f.style.top=`${i}px`,f.style.left=m,f.style.display="block",f.textContent=`${r.toFixed(1)} kHz   ${(1e3*c).toFixed(1)} ms`};u.addEventListener("mousemove",R,{passive:!0}),m.addEventListener("mouseleave",M),u.addEventListener("mouseenter",(()=>u.classList.add("hide-cursor"))),u.addEventListener("mouseleave",(()=>u.classList.remove("hide-cursor")));function X(){const e=p()*c(),t=d-a;E.forEach((n=>{const{startTime:i,endTime:o,Flow:s,Fhigh:d}=n.data,r=i/p()*e,c=(o-i)/p()*e,m=(1-(d-a)/t)*l,v=(d-s)/t*l;n.rect.style.left=`${r}px`,n.rect.style.top=`${m}px`,n.rect.style.width=`${c}px`,n.rect.style.height=`${v}px`;if(1e3*(o-i)<=100)n.expandBtn&&(n.expandBtn.style.display="none"),n.closeBtn&&(n.closeBtn.style.display="none"),n.tooltip||function(e,t,n,i,o){const{Flow:l,Fhigh:s,startTime:d,endTime:a}=e.data,r=s-l,c=a-d,p=document.createElement("div");p.className="draggable-tooltip freq-tooltip",p.style.left=`${t+i+10}px`,p.style.top=`${n}px`,p.innerHTML=`\n      <div><b>F.high:</b> <span class="fhigh">${s.toFixed(1)}</span> kHz</div>\n      <div><b>F.Low:</b> <span class="flow">${l.toFixed(1)}</span> kHz</div>\n      <div><b>Bandwidth:</b> <span class="bandwidth">${r.toFixed(1)}</span> kHz</div>\n      <div><b>Duration:</b> <span class="duration">${(1e3*c).toFixed(1)}</span> ms</div>\n      <div class="tooltip-close-btn">×</div>\n    `,p.addEventListener("mouseenter",(()=>{B=!0,$=!0,M()})),p.addEventListener("mouseleave",(()=>{B=!1,$=!1})),u.appendChild(p),N(p),p.querySelector(".tooltip-close-btn").addEventListener("click",(()=>{const t=E.findIndex((t=>t===e));-1!==t&&(u.removeChild(E[t].rect),u.removeChild(E[t].tooltip),E.splice(t,1)),B=!1,$=!1})),e.tooltip=p}(n,r,m,c);else{if(n.tooltip&&(u.removeChild(n.tooltip),n.tooltip=null),n.expandBtn)n.expandBtn.style.display="";else{const e=document.createElement("i");e.className="fa-solid fa-arrows-left-right-to-line selection-expand-btn",e.title="Crop and expand this session",e.addEventListener("click",(e=>{e.stopPropagation(),u.dispatchEvent(new CustomEvent("expand-selection",{detail:{startTime:n.data.startTime,endTime:n.data.endTime}}))})),e.addEventListener("mouseenter",(()=>{$=!0,M()})),e.addEventListener("mouseleave",(()=>{$=!1})),n.rect.appendChild(e),n.expandBtn=e}if(n.closeBtn)n.closeBtn.style.display="";else{const e=document.createElement("i");e.className="fa-solid fa-xmark selection-close-btn",e.title="Close selection",e.addEventListener("click",(e=>{e.stopPropagation();const t=E.findIndex((e=>e.rect===n.rect));-1!==t&&(u.removeChild(E[t].rect),E[t].tooltip&&u.removeChild(E[t].tooltip),E.splice(t,1)),$=!1})),e.addEventListener("mousedown",(e=>{e.stopPropagation()})),e.addEventListener("mouseenter",(()=>{$=!0,M()})),e.addEventListener("mouseleave",(()=>{$=!1})),n.rect.appendChild(e),n.closeBtn=e}}if(n.tooltip){const e=r+c+10;n.tooltip.style.left=`${e}px`,n.tooltip.style.top=`${m}px`}!function(e,t,n,i,o){const{data:l,tooltip:s}=e,d=l.Flow,a=l.Fhigh,r=a-d,c=l.endTime-l.startTime;s?(e.durationLabel&&(e.durationLabel.textContent=`${(1e3*c).toFixed(1)} ms`),s.querySelector(".fhigh").textContent=a.toFixed(1),s.querySelector(".flow").textContent=d.toFixed(1),s.querySelector(".bandwidth").textContent=r.toFixed(1),s.querySelector(".duration").textContent=(1e3*c).toFixed(1)):e.durationLabel&&(e.durationLabel.textContent=`${(1e3*c).toFixed(1)} ms`)}(n)}))}function N(e){let t,n,i=!1;e.addEventListener("mousedown",(o=>{if(o.target.classList.contains("tooltip-close-btn"))return;i=!0;const l=e.getBoundingClientRect();t=o.clientX-l.left,n=o.clientY-l.top})),window.addEventListener("mousemove",(o=>{if(!i)return;const l=u.getBoundingClientRect(),s=o.clientX-l.left+u.scrollLeft-t,d=o.clientY-l.top-n;e.style.left=`${s}px`,e.style.top=`${d}px`}),{passive:!0}),window.addEventListener("mouseup",(()=>{i=!1}))}return u.addEventListener("mouseleave",(e=>{k&&(k&&(k=!1,H&&u.contains(H)&&u.removeChild(H),H=null,$=!1),M())})),x&&(x.addEventListener("mouseenter",(()=>{$=!0,M()})),x.addEventListener("mouseleave",(()=>{$=!1}))),u.addEventListener("mousedown",(e=>{if(B||T)return;if(0!==e.button)return;const t=u.getBoundingClientRect();I=e.clientX-t.left+u.scrollLeft,q=e.clientY-t.top,q>u.clientHeight-C()||(k=!0,$=!0,M(),H=document.createElement("div"),H.className="selection-rect",u.appendChild(H))})),u.addEventListener("mousemove",(e=>{if(!k)return;const t=u.getBoundingClientRect(),n=e.clientX>=t.left&&e.clientX<=t.right,i=e.clientY>=t.top&&e.clientY<=t.bottom-C();if(!n||!i)return u.removeChild(H),H=null,k=!1,$=!1,void M();const o=e.clientX-t.left+u.scrollLeft,l=e.clientY-t.top,s=Math.min(o,I),d=Math.min(l,q),a=Math.abs(o-I),r=Math.abs(l-q);H.style.left=`${s}px`,H.style.top=`${d}px`,H.style.width=`${a}px`,H.style.height=`${r}px`}),{passive:!0}),u.addEventListener("mouseup",(e=>{if(!k)return;k=!1;const t=H.getBoundingClientRect(),n=u.getBoundingClientRect(),i=t.left-n.left+u.scrollLeft,o=t.top-n.top,s=t.width,r=t.height;if(s<=3||r<=3)return u.removeChild(H),H=null,$=!1,void R(e);const m=(1-(o+r)/l)*(d-a)+a,v=(1-o/l)*(d-a)+a,h=v-m,f=p()*c(),g=i/f*p(),x=(i+s)/f*p();!function(e,t,n,i,o,s,r,m,v,h,f){let g=null;1e3*m<=100&&(g=document.createElement("div"),g.className="draggable-tooltip freq-tooltip",g.style.left=`${e+n+10}px`,g.style.top=`${t}px`,g.innerHTML=`\n        <div><b>F.high:</b> <span class="fhigh">${o.toFixed(1)}</span> kHz</div>\n        <div><b>F.Low:</b> <span class="flow">${s.toFixed(1)}</span> kHz</div>\n        <div><b>Bandwidth:</b> <span class="bandwidth">${r.toFixed(1)}</span> kHz</div>\n        <div><b>Duration:</b> <span class="duration">${(1e3*m).toFixed(1)}</span> ms</div>\n        <div class="tooltip-close-btn">×</div>\n      `,g.addEventListener("mouseenter",(()=>{B=!0,$=!0,M()})),g.addEventListener("mouseleave",(()=>{B=!1,$=!1})),u.appendChild(g));let x=null,y=null,L=null;1e3*m>100&&(x=document.createElement("i"),x.className="fa-solid fa-arrows-left-right-to-line selection-expand-btn",x.title="Crop and expand this session",x.addEventListener("click",(e=>{e.stopPropagation(),u.dispatchEvent(new CustomEvent("expand-selection",{detail:{startTime:h,endTime:f}}))})),x.addEventListener("mouseenter",(()=>{$=!0,M()})),x.addEventListener("mouseleave",(()=>{$=!1})),v.appendChild(x),y=document.createElement("i"),y.className="fa-solid fa-xmark selection-close-btn",y.title="Close selection",y.addEventListener("click",(e=>{e.stopPropagation();const t=E.findIndex((e=>e.rect===v));-1!==t&&(u.removeChild(E[t].rect),E[t].tooltip&&u.removeChild(E[t].tooltip),E.splice(t,1)),$=!1})),y.addEventListener("mousedown",(e=>{e.stopPropagation()})),y.addEventListener("mouseenter",(()=>{$=!0,M()})),y.addEventListener("mouseleave",(()=>{$=!1})),v.appendChild(y));L=document.createElement("div"),L.className="selection-duration",L.textContent=`${(1e3*m).toFixed(1)} ms`,v.appendChild(L);const b={data:{startTime:h,endTime:f,Flow:s,Fhigh:o},rect:v,tooltip:g,expandBtn:x,closeBtn:y,durationLabel:L};E.push(b),g&&(N(g),g.querySelector(".tooltip-close-btn").addEventListener("click",(()=>{const e=E.findIndex((e=>e.tooltip===g));-1!==e&&(u.removeChild(E[e].rect),u.removeChild(E[e].tooltip),E.splice(e,1)),B=!1,$=!1})));!function(e){const t=e.rect;let n=!1,i=null,o=null;t.addEventListener("mousemove",(e=>{if(k||n)return;if(e.target.closest(".selection-close-btn")||e.target.closest(".selection-expand-btn"))return void(t.style.cursor="default");const i=t.getBoundingClientRect(),o=e.clientX-i.left,l=e.clientY-i.top;let s="default";const d=o<F,a=o>i.width-F,r=l<F,c=l>i.height-F;d&&r||a&&c?s="nwse-resize":a&&r||d&&c?s="nesw-resize":d||a?s="ew-resize":(r||c)&&(s="ns-resize"),t.style.cursor=s}),{passive:!0}),t.addEventListener("mousedown",(s=>{if(n)return;if(s.target.closest(".selection-close-btn")||s.target.closest(".selection-expand-btn"))return;const r=t.getBoundingClientRect(),m=s.clientX-r.left,v=s.clientY-r.top,h=m<F,f=m>r.width-F,g=v<F,x=v>r.height-F;if(i=h?"left":f?"right":null,o=g?"top":x?"bottom":null,!i&&!o)return;n=!0,T=!0,s.preventDefault();const y=t=>{if(!n)return;const s=u.getBoundingClientRect(),r=u.scrollLeft||0,m=t.clientX-s.left+r,v=t.clientY-s.top,h=p()*c(),f=d-a;if("left"===i){let t=m/h*p();t=Math.min(t,e.data.endTime-.001),e.data.startTime=t}if("right"===i){let t=m/h*p();t=Math.max(t,e.data.startTime+.001),e.data.endTime=t}if("top"===o){let t=(1-v/l)*f+a;t=Math.max(t,e.data.Flow+.1),e.data.Fhigh=t}if("bottom"===o){let t=(1-v/l)*f+a;t=Math.min(t,e.data.Fhigh-.1),e.data.Flow=t}X()},L=()=>{n=!1,T=!1,i=null,o=null,window.removeEventListener("mousemove",y),window.removeEventListener("mouseup",L)};window.addEventListener("mousemove",y,{passive:!0}),window.addEventListener("mouseup",L)}))}(b)}(i,o,s,0,v,m,h,x-g,H,g,x),H=null,$=!1})),u.addEventListener("contextmenu",(e=>{if(!b||w||B)return;if(e.target.closest(".selection-expand-btn"))return;e.preventDefault();const t=g.getBoundingClientRect(),n=(1-(e.clientY-t.top)/l)*(d-a)+a,i=L.findIndex((e=>Math.abs(e.freq-n)<1));if(-1!==i)g.removeChild(L[i].div),L.splice(i,1);else{if(L.length>=5)return;const e=Math.round((1-(n-a)/(d-a))*l),t=document.createElement("div");t.className="persistent-line",t.style.top=`${e}px`,g.appendChild(t),L.push({freq:n,div:t})}})),{updateSelections:X,clearSelections:function(){E.forEach((e=>{u.removeChild(e.rect),e.tooltip&&u.removeChild(e.tooltip)})),E.length=0},setFrequencyRange:(e,t)=>{a=e,d=t,X()},hideHover:M,refreshHover:()=>{null!==Y&&null!==z&&R({clientX:Y,clientY:z})},setPersistentLinesEnabled:e=>{b=e}}}