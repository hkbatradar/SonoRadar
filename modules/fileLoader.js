import{extractGuanoMetadata,parseGuanoMetadata}from"./guanoReader.js";import{addFilesToList,getFileList,getCurrentIndex,setCurrentIndex,removeFilesByName,setFileMetadata}from"./fileState.js";export async function getWavSampleRate(e){if(!e)return 256e3;const t=await e.arrayBuffer(),n=new DataView(t);let a=12;for(;a<n.byteLength-8;){const e=String.fromCharCode(n.getUint8(a),n.getUint8(a+1),n.getUint8(a+2),n.getUint8(a+3)),t=n.getUint32(a+4,!0);if("fmt "===e)return n.getUint32(a+12,!0);a+=8+t,t%2==1&&(a+=1)}return 256e3}let lastObjectUrl=null;export function initFileLoader({fileInputId:e,wavesurfer:t,spectrogramHeight:n,colorMap:a,onPluginReplaced:o,onFileLoaded:r,onBeforeLoad:i,onAfterLoad:d,onSampleRateDetected:c}){const l=document.getElementById(e),s=document.getElementById("prevBtn"),u=document.getElementById("nextBtn"),m=document.getElementById("fileNameText"),f=document.getElementById("guano-output"),g=document.getElementById("spectrogram-settings");async function p(e){if(!e)return;const n=await getWavSampleRate(e);"function"==typeof i&&i(),"function"==typeof r&&r(e),"function"==typeof c&&await c(n,!0),m&&(m.textContent=e.name);try{const t=await extractGuanoMetadata(e);f.textContent=t||"(No GUANO metadata found)";const n=parseGuanoMetadata(t),a=getCurrentIndex();setFileMetadata(a,n)}catch(e){f.textContent="(Error reading GUANO metadata)"}const a=URL.createObjectURL(e);lastObjectUrl&&URL.revokeObjectURL(lastObjectUrl),lastObjectUrl=a,await t.load(a),"function"==typeof o&&o();const l=n||t?.options?.sampleRate||256e3;g&&(g.textContent=`Sampling rate: ${l/1e3}kHz`),"function"==typeof d&&d(),document.dispatchEvent(new Event("file-loaded"))}return l.addEventListener("change",(async e=>{const t=Array.from(e.target.files),n=t[0];if(!n)return;"function"==typeof i&&i();const a=t.filter((e=>e.name.endsWith(".wav"))).sort(((e,t)=>e.name.localeCompare(t.name))),o=a.findIndex((e=>e.name===n.name));removeFilesByName("demo_recording.wav");const r=getFileList().length;addFilesToList(a,o);for(let e=0;e<a.length;e++)try{const t=await extractGuanoMetadata(a[e]),n=parseGuanoMetadata(t);setFileMetadata(r+e,n)}catch(t){setFileMetadata(r+e,{date:"",time:"",latitude:"",longitude:""})}await p(n)})),s.addEventListener("click",(()=>{const e=getCurrentIndex();if(e>0){setCurrentIndex(e-1);p(getFileList()[e-1])}})),u.addEventListener("click",(()=>{const e=getCurrentIndex(),t=getFileList();if(e<t.length-1){setCurrentIndex(e+1);p(t[e+1])}})),document.addEventListener("keydown",(e=>{"ArrowUp"===e.key?(e.preventDefault(),s.click()):"ArrowDown"===e.key&&(e.preventDefault(),u.click())})),{loadFileAtIndex:async e=>{const t=getFileList();e>=0&&e<t.length&&(setCurrentIndex(e),await p(t[e]))}}}