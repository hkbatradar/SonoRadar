import{initDropdown}from"./dropdown.js";import{autoIdHK}from"./autoid_HK.js";export function initAutoIdPanel({buttonId:e="autoIdBtn",panelId:t="auto-id-panel",viewerId:n="viewer-container",containerId:l="spectrogram-only",overlayId:s="fixed-overlay",spectrogramHeight:i=800,getDuration:a=(()=>0),getFreqRange:o=(()=>({min:0,max:0})),hideHover:c=(()=>{}),refreshHover:r=(()=>{})}={}){const d=document.getElementById(e),u=document.getElementById(t),m=u.querySelector(".popup-drag-bar"),p=u.querySelector(".popup-close-btn"),f=document.getElementById(n),v=document.getElementById(l),y=document.getElementById(s),E="http://www.w3.org/2000/svg",h=document.createElementNS(E,"svg");h.id="autoid-lines",y.appendChild(h);const g=document.getElementById("layout");g&&u&&u.parentElement!==g&&g.appendChild(u);const L=document.getElementById("autoIdTabResetBtn"),k=document.getElementById("autoid-tabs"),F=[],b=Array.from({length:8},(()=>({callType:3,harmonic:0,autoIdResult:null,showValidation:!1,inputs:{start:"",end:"",high:"",low:"",knee:"",heel:"",cfStart:"",cfEnd:""},startTime:null,endTime:null,markers:{start:{el:null,freq:null,time:null},end:{el:null,freq:null,time:null},high:{el:null,freq:null,time:null},low:{el:null,freq:null,time:null},knee:{el:null,freq:null,time:null},heel:{el:null,freq:null,time:null},cfStart:{el:null,freq:null,time:null},cfEnd:{el:null,freq:null,time:null}},line:null,resultEl:null,curves:{}})));let x=0;if(!d||!u||!f)return;function w(){const e="block"===u.style.display;u.style.display=e?"none":"block",document.body.classList.toggle("autoid-open",!e),document.dispatchEvent(new Event(e?"autoid-close":"autoid-open"))}d.addEventListener("click",w),p?.addEventListener("click",w);let I=!1,q=0,C=0;function M(e){I&&(u.style.left=e.clientX-q+"px",u.style.top=e.clientY-C+"px")}function N(){I=!1,document.removeEventListener("mousemove",M),c()}m?.addEventListener("mousedown",(e=>{I=!0,q=e.clientX-u.offsetLeft,C=e.clientY-u.offsetTop,c(),document.addEventListener("mousemove",M,{passive:!0}),document.addEventListener("mouseup",N,{once:!0}),e.preventDefault()})),L?.addEventListener("click",qe);const B=initDropdown("callTypeInput",["CF-FM","FM-CF-FM","FM","FM-QCF","FM-QCF-FM","QCF"]),T=initDropdown("harmonicInput",["0","1","2","3"]);if(T.onChange=function(e,t){b[x].harmonic=t,te||oe()},k){k.title="Prev pulse (Ctrl + ←), Next pulse (Ctrl + →)";for(let e=0;e<8;e++){const t=document.createElement("button");t.textContent=`${e+1}`,t.className="tab-btn",t.title=`Pulse ${e+1}`,0===e&&t.classList.add("active"),t.addEventListener("click",(()=>re(e))),k.appendChild(t),F.push(t)}}const A={start:document.getElementById("startFreqInput"),end:document.getElementById("endFreqInput"),high:document.getElementById("highFreqInput"),low:document.getElementById("lowFreqInput"),knee:document.getElementById("kneeFreqInput"),heel:document.getElementById("heelFreqInput"),cfStart:document.getElementById("cfStartFreqInput"),cfEnd:document.getElementById("cfEndFreqInput")},S={start:document.getElementById("startFreqRow"),end:document.getElementById("endFreqRow"),high:document.getElementById("highFreqRow"),low:document.getElementById("lowFreqRow"),knee:document.getElementById("kneeFreqRow"),heel:document.getElementById("heelFreqRow"),cfStart:document.getElementById("cfStartFreqRow"),cfEnd:document.getElementById("cfEndFreqRow")},R=document.getElementById("bandwidthVal"),$=document.getElementById("durationVal"),j=document.getElementById("pulseIdBtn"),O=document.getElementById("sequenceIdBtn"),K=document.getElementById("autoIdResult"),D=document.getElementById("bandwidth-warning"),H=document.getElementById("freq-order-warning"),P=document.getElementById("knee-order-warning"),Q=document.getElementById("time-order-warning");const V={start:"#e74c3c",end:"#004cff",high:"#3498db",low:"#9b59b6",knee:"#f39c12",heel:"#16a085",cfStart:"#e67e22",cfEnd:"#1abc9c"},W={start:"Start freq.",end:"End freq.",high:"High freq.",low:"Low freq.",knee:"Knee freq.",heel:"Heel freq.",cfStart:"CF start",cfEnd:"CF end"};let X=b[x].markers,Y=null,U=null,_=null,z=null,G=null,J=null,Z=null,ee=!0,te=!1,ne=!1,le=!1;function se(){Z=null,ie()}function ie(){b.forEach(((e,t)=>{Object.values(e.curves||{}).forEach((e=>{const n=t===x&&Z===e.p1Key,l=t===x&&Z===e.p2Key;e.cp1El&&(e.cp1El.style.display=n?"block":"none"),e.cp1LineEl&&(e.cp1LineEl.style.display=n?"block":"none"),e.cp2El&&(e.cp2El.style.display=l?"block":"none"),e.cp2LineEl&&(e.cp2LineEl.style.display=l?"block":"none")}))}))}function ae(){const e=b[x].autoIdResult;K&&(e?K.innerHTML=Ce(e):K.textContent="-")}function oe(){null!=b[x].autoIdResult&&(b[x].autoIdResult=null,ae(),he())}function ce(e){const t=b[e];X=t.markers,te=!0,B.select(t.callType),T.select(t.harmonic),te=!1,Object.keys(A).forEach((e=>{A[e].value=t.inputs[e]||"",null!=t.markers[e].time?A[e].dataset.time=t.markers[e].time:delete A[e].dataset.time})),U=t.startTime,_=t.endTime,fe(),he(),ae(),Me()}function re(e){e!==x&&(!function(){const e=b[x];e.callType=B.selectedIndex,e.harmonic=T.selectedIndex,e.startTime=U,e.endTime=_,Object.keys(A).forEach((t=>{e.inputs[t]=A[t].value}))}(),F[x]&&F[x].classList.remove("active"),x=e,F[x]&&F[x].classList.add("active"),Z=null,ce(e))}function de(e){ee=e,document.body.classList.toggle("markers-disabled",!e)}function ue(e){const t=A[e];t&&(t.value="",delete t.dataset.time,t.classList.remove("active-get"),t.classList.remove("invalid"),t.classList.remove("warning"),X[e].freq=null,X[e].time=null,X[e].el&&(X[e].el.style.display="none"),"start"===e&&(U=null),"end"===e&&(_=null),b[x].inputs[e]="",b[x].markers[e].freq=null,b[x].markers[e].time=null,b[x].startTime=U,b[x].endTime=_,fe(),he(),te||oe(),Me())}document.addEventListener("click",se),de(!0),Object.entries(A).forEach((([e,t])=>{t&&(t.dataset.key=e,t.readOnly=!0,t.addEventListener("click",(()=>{if(Y===t)return t.classList.remove("active-get"),Y=null,void de(!0);Y&&Y.classList.remove("active-get"),Y=t,t.classList.add("active-get"),de(!1)})))}));const me={};function pe(e,t){const n=S[e];if(!n)return;n.style.display=t?"flex":"none",A[e]&&(A[e].disabled=!t);const l=me[e];l&&(l.disabled=!t),t||ue(e),Me()}function fe(){B.items[B.selectedIndex];const e=parseFloat(A.high.value),t=parseFloat(A.low.value),n=parseFloat(A.knee.value);parseFloat(A.cfStart.value),parseFloat(A.end.value);let l=null;const s=Object.values(X).filter((e=>null!=e.freq&&!isNaN(e.freq)&&e.el&&""!==e.el.value)).map((e=>e.freq));if(s.length>=2){l=Math.max(...s)-Math.min(...s),R.textContent=l.toFixed(1)}else R.textContent="-";const i=Object.values(X).filter((e=>null!=e.time&&!isNaN(e.freq))).map((e=>e.time));if(i.length>=2){const e=Math.max(...i),t=Math.min(...i);$.textContent=(1e3*(e-t)).toFixed(1)}else $.textContent="-";!function(e,t,n,l,s,i){const a="QCF"===B.items[B.selectedIndex]&&null!=l&&l>5,o=!isNaN(e)&&!isNaN(t)&&t>e,c=!isNaN(n)&&!isNaN(t)&&n<t,r=null!=s&&null!=i&&i<s,d=a||o||c||r;A.high&&A.high.classList.toggle("warning",a||o),A.low&&A.low.classList.toggle("warning",a||o||c),A.knee&&A.knee.classList.toggle("warning",c),A.start&&A.start.classList.toggle("warning",r),A.end&&A.end.classList.toggle("warning",r),D&&(D.style.display=a?"flex":"none"),H&&(H.style.display=o?"flex":"none"),P&&(P.style.display=c?"flex":"none"),Q&&(Q.style.display=r?"flex":"none"),j&&(j.disabled=d),O&&(O.disabled=d)}(e,t,n,l,U,_)}function ve(e,t){const n=document.createElement("i");n.className=`fa-solid fa-xmark freq-marker marker-${e}`,n.style.color=V[e],n.dataset.key=e,n.dataset.tab=t;const l=W[e]||e;return n.dataset.title=l,n.setAttribute("aria-label",l),n.addEventListener("mouseenter",c),n.addEventListener("mouseleave",r),n.addEventListener("mousedown",(t=>{ee&&(t.stopPropagation(),c(),f.classList.add("hide-cursor"),n.classList.add("hide-cursor"),z=e,G=n,ne=!1,document.addEventListener("mousemove",be,{passive:!0}),document.addEventListener("mouseup",xe,{once:!0}))})),n.addEventListener("click",(n=>{if(n.stopPropagation(),ne)return void(ne=!1);const l=b[t];let s=!1;Object.values(l.curves||{}).forEach((t=>{t.p1Key!==e&&t.p2Key!==e||!t.cp1El&&!t.cp2El||(s=!0)})),s||ke(),function(e){Z=e,ie()}(e)})),y.appendChild(n),n}function ye(e,t,n){const l=document.createElement("div");return l.className="path-handle",l.dataset.tab=e,l.dataset.seg=t,l.dataset.handle=n,l.addEventListener("mousedown",(s=>{ee&&(s.stopPropagation(),c(),f.classList.add("hide-cursor"),l.classList.add("hide-cursor"),document.querySelectorAll(".freq-marker").forEach((e=>e.classList.add("hide-cursor"))),document.querySelectorAll(".path-handle").forEach((e=>e.classList.add("dragging"))),document.querySelectorAll(".handle-connector").forEach((e=>e.classList.add("dragging"))),J={tabIdx:e,segKey:t,handleKey:n,el:l},document.addEventListener("mousemove",we,{passive:!0}),document.addEventListener("mouseup",Ie,{once:!0}))})),l.addEventListener("mouseenter",c),l.addEventListener("mouseleave",r),l.addEventListener("contextmenu",(e=>{e.preventDefault(),e.stopPropagation()})),l.addEventListener("click",(e=>e.stopPropagation())),l.style.display="none",y.appendChild(l),l}function Ee(e){const t=document.createElement("div");return t.className="pulseid-result",t.dataset.tab=e,y.appendChild(t),t.addEventListener("click",(t=>{t.stopPropagation(),"block"!==u.style.display&&(u.style.display="block",document.body.classList.add("autoid-open"),document.dispatchEvent(new Event("autoid-open"))),re(e)})),t.addEventListener("mouseenter",c),t.addEventListener("mouseleave",r),t.addEventListener("contextmenu",(e=>{e.preventDefault(),e.stopPropagation()})),t}function he(){const{min:e,max:t}=o(),n=v.scrollWidth;b.forEach(((l,s)=>{let o=1/0,c=-1/0,r=-1/0,d=!1;Object.entries(l.markers).forEach((([l,u])=>{if(u.el||(u.el=ve(l,s)),null==u.freq||null==u.time)return void(u.el.style.display="none");const m=u.time/a()*n-f.scrollLeft,p=(1-(u.freq-e)/(t-e))*i;u.el.style.left=`${m}px`,u.el.style.top=`${p}px`,u.el.style.display="block",u.el.style.pointerEvents=s!==x||le?"none":"auto",u.el.style.opacity=s===x?"1":"0.5",u.el.dataset.freq=u.freq,u.el.dataset.time=u.time,o=Math.min(o,m),c=Math.max(c,m),r=Math.max(r,p),d=!0})),l.resultEl||(l.resultEl=Ee(s));const u=l.resultEl;l.autoIdResult&&d?(u.innerHTML=Ce(l.autoIdResult),u.style.left=(o+c)/2+"px",u.style.top=`${r+20}px`,u.style.display="block",u.classList.toggle("inactive",s!==x)):u.style.display="none"})),ke()}function ge(e,t){const n=f.scrollLeft||0,{min:l,max:s}=o();return{time:(e+n)/v.scrollWidth*a(),freq:(1-t/i)*(s-l)+l}}function Le(e,t){const n=v.scrollWidth,{min:l,max:s}=o();return{x:e/a()*n-f.scrollLeft,y:(1-(t-l)/(s-l))*i}}function ke(){const{min:e,max:t}=o(),n=v.scrollWidth;b.forEach(((l,s)=>{l.line||(l.line=document.createElementNS(E,"path"),l.line.dataset.tab=s,h.appendChild(l.line));const o=Object.entries(l.markers).filter((([e,t])=>null!=t.freq&&null!=t.time)).sort(((e,t)=>e[1].time-t[1].time)).map((([l,s])=>({x:s.time/a()*n-f.scrollLeft,y:(1-(s.freq-e)/(t-e))*i,key:l})));if(o.length<2)return l.line.setAttribute("d",""),l.line.style.display="none",Object.values(l.curves||{}).forEach((e=>{e.cp1El?.remove(),e.cp2El?.remove(),e.cp1LineEl?.remove(),e.cp2LineEl?.remove()})),void(l.curves={});const c=function(e,t,n,l=.5){if(e.length<2)return"";let s=`M ${e[0].x} ${e[0].y}`;const i=10,a=[];for(let o=0;o<e.length-1;o++){const c=e[o-1]||e[o],r=e[o],d=e[o+1],u=e[o+2]||d,m=`${r.key}-${d.key}`;a.push(m);const p=o===e.length-2,f=Math.abs(r.y-d.y);if("cfStart"===r.key&&"cfEnd"===d.key){t.curves[m]&&(t.curves[m].cp1El?.remove(),t.curves[m].cp2El?.remove(),t.curves[m].cp1LineEl?.remove(),t.curves[m].cp2LineEl?.remove(),delete t.curves[m]),s+=` L ${d.x} ${d.y}`;continue}if(p&&f<5){t.curves[m]&&(t.curves[m].cp1El?.remove(),t.curves[m].cp2El?.remove(),t.curves[m].cp1LineEl?.remove(),t.curves[m].cp2LineEl?.remove(),delete t.curves[m]),s+=` L ${r.x} ${d.y} L ${d.x} ${d.y}`;continue}t.curves[m]||(t.curves[m]={});const v=t.curves[m];let y,g,L,k;v.p1Key=r.key,v.p2Key=d.key;const F=z&&(r.key===z||d.key===z);if(!F&&v.cp1&&v.cp2)({x:y,y:g}=Le(v.cp1.time,v.cp1.freq)),({x:L,y:k}=Le(v.cp2.time,v.cp2.freq));else{if(y=r.x+(d.x-c.x)*l/6,g=r.y+(d.y-c.y)*l/6,L=d.x-(u.x-r.x)*l/6,k=d.y-(u.y-r.y)*l/6,"high"===r.key&&"knee"===d.key){const e=Math.hypot(d.x-r.x,d.y-r.y),t=Math.hypot(u.x-d.x,u.y-d.y),n=e?1+t/e*2:1;L=d.x-(u.x-r.x)*l/6*n,k=d.y-(u.y-r.y)*l/6*n}if("cfStart"!==d.key&&"end"!==d.key){const e=Math.abs(r.y-d.y),t=Math.min(i,.6*e);k=Math.min(k,d.y+t),L=Math.min(L,d.x)}const e=ge(y,g),t=ge(L,k);v.cp1=e,v.cp2=t}if(F)v.cp1El?.remove(),v.cp2El?.remove(),v.cp1LineEl?.remove(),v.cp2LineEl?.remove(),delete v.cp1El,delete v.cp2El,delete v.cp1LineEl,delete v.cp2LineEl;else{v.cp1El||(v.cp1El=ye(n,m,"cp1")),v.cp2El||(v.cp2El=ye(n,m,"cp2")),v.cp1LineEl||(v.cp1LineEl=document.createElementNS(E,"line"),v.cp1LineEl.classList.add("handle-connector"),v.cp1LineEl.style.display="none",v.cp1LineEl.setAttribute("stroke","#4b0082"),v.cp1LineEl.setAttribute("stroke-width","1"),h.appendChild(v.cp1LineEl)),v.cp2LineEl||(v.cp2LineEl=document.createElementNS(E,"line"),v.cp2LineEl.classList.add("handle-connector"),v.cp2LineEl.style.display="none",v.cp2LineEl.setAttribute("stroke","#4b0082"),v.cp2LineEl.setAttribute("stroke-width","1"),h.appendChild(v.cp2LineEl)),v.cp1El.style.left=`${y}px`,v.cp1El.style.top=`${g}px`,v.cp2El.style.left=`${L}px`,v.cp2El.style.top=`${k}px`;const e=5;v.cp1LineEl.setAttribute("x1",r.x),v.cp1LineEl.setAttribute("y1",r.y);const t=y-r.x,l=g-r.y,s=Math.hypot(t,l)||1,i=y-t/s*e,a=g-l/s*e;v.cp1LineEl.setAttribute("x2",i),v.cp1LineEl.setAttribute("y2",a),v.cp2LineEl.setAttribute("x1",d.x),v.cp2LineEl.setAttribute("y1",d.y);const o=L-d.x,c=k-d.y,u=Math.hypot(o,c)||1,p=L-o/u*e,f=k-c/u*e;v.cp2LineEl.setAttribute("x2",p),v.cp2LineEl.setAttribute("y2",f)}s+=` C ${y} ${g} ${L} ${k} ${d.x} ${d.y}`}return Object.keys(t.curves).forEach((e=>{if(!a.includes(e)){const n=t.curves[e];n.cp1El?.remove(),n.cp2El?.remove(),n.cp1LineEl?.remove(),n.cp2LineEl?.remove(),delete t.curves[e]}})),s}(o,l,s);l.line.setAttribute("stroke-linejoin","round"),l.line.setAttribute("d",c),l.line.style.display="block",l.line.style.opacity=s===x?"1":"0.5"})),ie()}function Fe(e,t=x){const n=b[t];Object.entries(n.curves||{}).forEach((([t,l])=>{l.p1Key!==e&&l.p2Key!==e||(l.cp1El?.remove(),l.cp2El?.remove(),l.cp1LineEl?.remove(),l.cp2LineEl?.remove(),delete n.curves[t])})),se()}function be(e){if(!z||!ee)return;ne||(Fe(z),ke()),ne=!0;const t=f.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,s=f.scrollLeft||0,{min:c,max:r}=o(),d=(1-l/i)*(r-c)+c,u=(n+s)/v.scrollWidth*a(),m=A[z];m&&(m.value=d.toFixed(1),m.dataset.time=u,m===A.start&&(U=u),m===A.end&&(_=u)),b[x].startTime=U,b[x].endTime=_,X[z].freq=d,X[z].time=u,fe(),he()}function xe(){const e=z;z=null,G&&(G.classList.remove("hide-cursor"),G=null),document.removeEventListener("mousemove",be),f.classList.remove("hide-cursor"),r(),Me(),oe(),e&&ne&&(Fe(e),ke())}function we(e){if(!J||!ee)return;const t=f.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,{time:s,freq:i}=ge(n,l),{tabIdx:a,segKey:o,handleKey:c}=J,r=b[a].curves[o];r&&(r[c]={time:s,freq:i}),ke()}function Ie(){J&&(J.el.classList.remove("hide-cursor"),document.querySelectorAll(".path-handle").forEach((e=>e.classList.remove("dragging"))),document.querySelectorAll(".handle-connector").forEach((e=>e.classList.remove("dragging"))),document.querySelectorAll(".freq-marker").forEach((e=>e.classList.remove("hide-cursor"))),J=null,document.removeEventListener("mousemove",we),f.classList.remove("hide-cursor"),r(),oe())}function qe(){var e;b[x].showValidation=!1,(e=b[x]).callType=3,e.harmonic=0,e.autoIdResult=null,e.showValidation=!1,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")})),Object.values(e.curves||{}).forEach((e=>{e.cp1El?.remove(),e.cp2El?.remove(),e.cp1LineEl?.remove(),e.cp2LineEl?.remove()})),e.curves={},e.line&&(e.line.setAttribute("d",""),e.line.style.display="none"),B.select(3),T.select(0),Object.values(A).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"),e.classList.remove("invalid"),e.classList.remove("warning"))})),R.textContent="-",$.textContent="-",U=null,_=null,Y=null,b[x].autoIdResult=null,Z=null,de(!0),ce(x)}function Ce(e){return e.split(" / ").map((e=>{if(e.endsWith("sp.")){return`<i>${e.replace(" sp.","")}</i> sp.`}return"TBC"===e||"-"===e||"No species matched"===e?e:`<i>${e}</i>`})).join(" / ")}function Me(e=!1){const t=b[x];e&&(t.showValidation=!0);const n=t.showValidation,l={"CF-FM":["cfStart","cfEnd"],"FM-CF-FM":["cfStart","cfEnd"],FM:["high","low"],"FM-QCF":["high","low","knee"],"FM-QCF-FM":["high","knee","heel","low"],QCF:["high","low"]}[B.items[B.selectedIndex]]||[];let s=!0;return Object.entries(A).forEach((([e,t])=>{if(t)if(l.includes(e)){const e=parseFloat(t.value),l=!isNaN(e);n?t.classList.toggle("invalid",!l):t.classList.remove("invalid"),l||(s=!1)}else t.classList.remove("invalid")})),s}function Ne(){if(!Me(!0))return b[x].autoIdResult=null,K&&(K.textContent="-"),void he();const e=B.items[B.selectedIndex],t=parseFloat(A.high.value),n=parseFloat(A.low.value),l=parseFloat(A.knee.value),s=parseFloat(A.heel.value),i=parseFloat(A.start.value),a=parseFloat(A.end.value),o=parseFloat(A.cfStart.value),c=parseFloat(A.cfEnd.value);let r=null;const d=Object.values(X).filter((e=>null!=e.time&&!isNaN(e.freq))).map((e=>e.time));if(d.length>=2){r=1e3*(Math.max(...d)-Math.min(...d))}let u=null;["FM-CF-FM","CF-FM"].includes(e)?isNaN(o)||isNaN(a)||(u=o-a):isNaN(t)||isNaN(n)||(u=t-n);const m=null!=X.knee.time&&null!=X.low.time?1e3*(X.knee.time-X.low.time):null,p=isNaN(l)||isNaN(n)?null:l-n,f=isNaN(s)||isNaN(n)?null:s-n,v=isNaN(l)||isNaN(s)?null:l-s,y=parseInt(T.items[T.selectedIndex],10),E=autoIdHK({callType:e,harmonic:y,highestFreq:t,lowestFreq:n,kneeFreq:l,heelFreq:s,startFreq:i,endFreq:a,cfStart:o,cfEnd:c,duration:r,bandwidth:u,kneeLowTime:m,kneeLowBandwidth:p,heelLowBandwidth:f,kneeHeelBandwidth:v});b[x].autoIdResult=E,ae(),he()}return u.querySelectorAll(".autoid-marker[data-key]").forEach((e=>{const t=e.dataset.key;me[t]=e,e.addEventListener("click",(e=>{e.preventDefault(),ue(t)}))})),B.onChange=function(e,t){const n=["CF-FM","FM-CF-FM"].includes(e),l=["CF-FM","FM-CF-FM","QCF"].includes(e),s=["QCF","FM-QCF","FM","FM-QCF-FM"].includes(e);pe("high",!n),pe("low",!n),pe("knee",!l),pe("heel",!l),pe("cfStart",!s),pe("cfEnd",!s),b[x].callType=t,te||oe(),fe(),ke(),b[x].showValidation=!1,Me()},T.select(0),B.select(3),ce(0),document.addEventListener("keydown",(e=>{"Control"!==e.key||le||(le=!0,he())})),document.addEventListener("keyup",(e=>{"Control"===e.key&&le&&(le=!1,he())})),f.addEventListener("click",(e=>{if(!Y)return;const t=f.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,s=f.scrollLeft||0,{min:c,max:r}=o(),d=(1-l/i)*(r-c)+c,u=(n+s)/v.scrollWidth*a(),m=Y.dataset.key;Y.value=d.toFixed(1),Y.dataset.time=u,X[m].freq=d,X[m].time=u,Y===A.start&&(U=u),Y===A.end&&(_=u),b[x].startTime=U,b[x].endTime=_,Y.classList.remove("active-get"),Y=null,de(!0),fe(),he(),oe()})),f.addEventListener("scroll",he),j?.addEventListener("click",Ne),O?.addEventListener("click",(function(){Ne()})),document.addEventListener("keydown",(e=>{document.body.classList.contains("autoid-open")&&("INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName||e.target.isContentEditable||("Enter"===e.key&&e.ctrlKey?(e.preventDefault(),j?.click()):"Enter"===e.key&&e.shiftKey?(e.preventDefault(),O?.click()):e.ctrlKey&&"ArrowLeft"===e.key?(e.preventDefault(),x>0&&re(x-1)):e.ctrlKey&&"ArrowRight"===e.key&&(e.preventDefault(),x<7&&re(x+1))))})),{updateMarkers:he,reset:function(){b.forEach((e=>{e.showValidation=!1,e.callType=3,e.harmonic=0,e.autoIdResult=null,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.keys(e.markers).forEach((t=>{e.markers[t].freq=null,e.markers[t].time=null})),Object.values(e.curves||{}).forEach((e=>{e.cp1El?.remove(),e.cp2El?.remove(),e.cp1LineEl?.remove(),e.cp2LineEl?.remove()})),e.curves={},e.line&&(e.line.setAttribute("d",""),e.line.style.display="none")})),B.select(3),T.select(0),Object.values(A).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"),e.classList.remove("invalid"),e.classList.remove("warning"))})),R.textContent="-",$.textContent="-",U=null,_=null,b.forEach((e=>{Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")}))})),Y=null,Z=null,de(!0),ce(x)},resetCurrentTab:qe,setMarkerAt:function(e,t,n){const l=A[e];l&&(l.value=t.toFixed(1),l.dataset.time=n,X[e].freq=t,X[e].time=n,"start"===e&&(U=n),"end"===e&&(_=n),b[x].startTime=U,b[x].endTime=_,Fe(e,x),fe(),he(),oe(),Me())},removeMarker:function(e){ue(e)},isFieldEnabled:function(e){const t=A[e];return t&&!t.disabled},getFreqRange:o,getDuration:()=>a(),spectrogramHeight:i}}