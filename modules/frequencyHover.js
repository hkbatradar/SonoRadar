export function initFrequencyHover({viewerId:e,wrapperId:t="viewer-wrapper",hoverLineId:n,hoverLineVId:o,freqLabelId:i,spectrogramHeight:l=800,spectrogramWidth:s=1024,maxFrequency:d=128,minFrequency:a=10,totalDuration:r=1e3,getZoomLevel:c,getDuration:u}){const p=document.getElementById(e),m=document.getElementById(t),v=document.getElementById(n),f=document.getElementById(o),h=document.getElementById(i),g=document.getElementById("fixed-overlay"),L=document.getElementById("zoom-controls"),y=document.getElementById("spectrogram-only"),E=[],x=[];let b=!0,w=!1;const C=()=>y.scrollWidth>p.clientWidth?0:20,F=5;let $=!1,B=!1,T=!1,I=!1,Y=!1,q=0,X=0,k=null,R=null,H=null;const M=()=>{v.style.display="none",f.style.display="none",h.style.display="none"},z=e=>{if(R=e.clientX,H=e.clientY,$||T||Y)return void M();const t=p.getBoundingClientRect(),n=e.clientX-t.left,o=e.clientY-t.top,i=C();if(o>p.clientHeight-i)return M(),p.classList.remove("hide-cursor"),void(w=!0);w=!1,p.classList.add("hide-cursor");const s=p.scrollLeft||0,r=(1-o/l)*(d-a)+a,c=(n+s)/y.scrollWidth*u();v.style.top=`${o}px`,v.style.display="block",f.style.left=`${n}px`,f.style.display="block";let m;p.clientWidth-n<120?(h.style.transform="translate(-100%, -50%)",m=n-12+"px"):(h.style.transform="translate(0, -50%)",m=`${n+12}px`),h.style.top=`${o}px`,h.style.left=m,h.style.display="block";const g=Number(r.toFixed(1)).toString();h.textContent=`${g} kHz  ${(1e3*c).toFixed(1)} ms`};p.addEventListener("mousemove",z,{passive:!0}),m.addEventListener("mouseleave",M),p.addEventListener("mouseenter",(()=>p.classList.add("hide-cursor"))),p.addEventListener("mouseleave",(()=>p.classList.remove("hide-cursor")));function N(e){const t=x.indexOf(e);-1!==t&&(p.removeChild(x[t].rect),x[t].tooltip&&p.removeChild(x[t].tooltip),x.splice(t,1))}function S(e,t,n,o){const{Flow:i,Fhigh:l,startTime:s,endTime:d}=e.data,a=l-i,r=d-s,c=document.createElement("div");return c.className="draggable-tooltip freq-tooltip",c.style.left=`${t+o+10}px`,c.style.top=`${n}px`,c.innerHTML=`\n      <div><b>F.high:</b> <span class="fhigh">${l.toFixed(1)}</span> kHz</div>\n      <div><b>F.Low:</b> <span class="flow">${i.toFixed(1)}</span> kHz</div>\n      <div><b>Bandwidth:</b> <span class="bandwidth">${a.toFixed(1)}</span> kHz</div>\n      <div><b>Duration:</b> <span class="duration">${(1e3*r).toFixed(1)}</span> ms</div>\n      <div class="tooltip-close-btn">Ã—</div>\n    `,c.addEventListener("mouseenter",(()=>{B=!0,$=!0,M()})),c.addEventListener("mouseleave",(()=>{B=!1,$=!1})),c.querySelector(".tooltip-close-btn").addEventListener("click",(()=>{N(e),B=!1,$=!1})),p.appendChild(c),function(e){let t,n,o=!1;e.addEventListener("mousedown",(i=>{if(i.target.classList.contains("tooltip-close-btn"))return;o=!0;const l=e.getBoundingClientRect();t=i.clientX-l.left,n=i.clientY-l.top})),window.addEventListener("mousemove",(i=>{if(!o)return;const l=p.getBoundingClientRect(),s=i.clientX-l.left+p.scrollLeft-t,d=i.clientY-l.top-n;e.style.left=`${s}px`,e.style.top=`${d}px`}),{passive:!0}),window.addEventListener("mouseup",(()=>{o=!1}))}(c),c}function G(e){const t=document.createElement("div");t.className="selection-btn-group";const n=document.createElement("i");n.className="fa-solid fa-xmark selection-close-btn",n.title="Close selection",n.addEventListener("click",(t=>{t.stopPropagation(),N(e),$=!1,Y=!1,null!==R&&null!==H&&z({clientX:R,clientY:H})})),n.addEventListener("mousedown",(e=>{e.stopPropagation()})),n.addEventListener("mouseenter",(()=>{$=!0,M()})),n.addEventListener("mouseleave",(()=>{$=!1}));const o=document.createElement("i");o.className="fa-solid fa-arrows-left-right-to-line selection-expand-btn",o.title="Crop and expand this session",o.addEventListener("click",(t=>{t.stopPropagation(),p.dispatchEvent(new CustomEvent("expand-selection",{detail:{startTime:e.data.startTime,endTime:e.data.endTime}})),$=!1,Y=!1})),o.addEventListener("mouseenter",(()=>{$=!0,M()})),o.addEventListener("mouseleave",(()=>{$=!1}));const i=document.createElement("i");i.className="fa-solid fa-up-right-and-down-left-from-center selection-fit-btn",i.title="Fit to window",i.addEventListener("click",(t=>{t.stopPropagation(),p.dispatchEvent(new CustomEvent("fit-window-selection",{detail:{startTime:e.data.startTime,endTime:e.data.endTime,Flow:e.data.Flow,Fhigh:e.data.Fhigh}})),$=!1,Y=!1})),i.addEventListener("mouseenter",(()=>{$=!0,M()})),i.addEventListener("mouseleave",(()=>{$=!1})),t.addEventListener("mouseenter",(()=>{Y=!0,M(),e.rect.style.cursor="default"})),t.addEventListener("mouseleave",(()=>{Y=!1})),t.addEventListener("mousedown",(e=>{e.stopPropagation()})),t.appendChild(n),t.appendChild(o),t.appendChild(i),e.rect.appendChild(t),e.btnGroup=t,e.closeBtn=n,e.expandBtn=o,e.fitBtn=i}function P(){const e=u()*c(),t=d-a;x.forEach((n=>{const{startTime:o,endTime:i,Flow:s,Fhigh:d}=n.data,r=o/u()*e,c=(i-o)/u()*e,m=(1-(d-a)/t)*l,v=(d-s)/t*l;n.rect.style.left=`${r}px`,n.rect.style.top=`${m}px`,n.rect.style.width=`${c}px`,n.rect.style.height=`${v}px`;if(1e3*(i-o)<=100?(n.btnGroup&&(n.btnGroup.style.display="none"),n.tooltip||(n.tooltip=S(n,r,m,c))):(n.tooltip&&(p.removeChild(n.tooltip),n.tooltip=null),n.btnGroup?n.btnGroup.style.display="":G(n)),n.tooltip){const e=r+c+10;n.tooltip.style.left=`${e}px`,n.tooltip.style.top=`${m}px`}!function(e,t,n,o,i){const{data:l,tooltip:s}=e,d=l.Flow,a=l.Fhigh,r=a-d,c=l.endTime-l.startTime;s?(e.durationLabel&&(e.durationLabel.textContent=`${(1e3*c).toFixed(1)} ms`),s.querySelector(".fhigh").textContent=a.toFixed(1),s.querySelector(".flow").textContent=d.toFixed(1),s.querySelector(".bandwidth").textContent=r.toFixed(1),s.querySelector(".duration").textContent=(1e3*c).toFixed(1)):e.durationLabel&&(e.durationLabel.textContent=`${(1e3*c).toFixed(1)} ms`)}(n)}))}return p.addEventListener("mouseleave",(e=>{I&&(I&&(I=!1,k&&p.contains(k)&&p.removeChild(k),k=null,$=!1),M())})),L&&(L.addEventListener("mouseenter",(()=>{$=!0,M()})),L.addEventListener("mouseleave",(()=>{$=!1}))),p.addEventListener("mousedown",(e=>{if(B||T)return;if(0!==e.button)return;const t=p.getBoundingClientRect();q=e.clientX-t.left+p.scrollLeft,X=e.clientY-t.top,X>p.clientHeight-C()||(I=!0,$=!0,M(),k=document.createElement("div"),k.className="selection-rect",p.appendChild(k))})),p.addEventListener("mousemove",(e=>{if(!I)return;const t=p.getBoundingClientRect(),n=e.clientX>=t.left&&e.clientX<=t.right,o=e.clientY>=t.top&&e.clientY<=t.bottom-C();if(!n||!o)return p.removeChild(k),k=null,I=!1,$=!1,void M();const i=e.clientX-t.left+p.scrollLeft,l=e.clientY-t.top,s=Math.min(i,q),d=Math.min(l,X),a=Math.abs(i-q),r=Math.abs(l-X);k.style.left=`${s}px`,k.style.top=`${d}px`,k.style.width=`${a}px`,k.style.height=`${r}px`}),{passive:!0}),p.addEventListener("mouseup",(e=>{if(!I)return;I=!1;const t=k.getBoundingClientRect(),n=p.getBoundingClientRect(),o=t.left-n.left+p.scrollLeft,i=t.top-n.top,s=t.width,r=t.height;if(s<=3||r<=3)return p.removeChild(k),k=null,$=!1,void z(e);const m=(1-(i+r)/l)*(d-a)+a,v=(1-i/l)*(d-a)+a,f=u()*c(),h=o/f*u(),g=(o+s)/f*u();!function(e,t,n,o,i,s,r,m,v,f,h){const g={data:{startTime:f,endTime:h,Flow:s,Fhigh:i},rect:v,tooltip:null,expandBtn:null,closeBtn:null,btnGroup:null,durationLabel:null};1e3*m<=100&&(g.tooltip=S(g,e,t,n));const L=document.createElement("div");L.className="selection-duration",L.textContent=`${(1e3*m).toFixed(1)} ms`,v.appendChild(L),g.durationLabel=L,x.push(g),1e3*m>100&&G(g);!function(e){const t=e.rect;let n=!1,o=null,i=null;t.addEventListener("mousemove",(e=>{if(I||n)return;if(Y||e.target.closest(".selection-close-btn")||e.target.closest(".selection-expand-btn")||e.target.closest(".selection-fit-btn")||e.target.closest(".selection-btn-group"))return void(t.style.cursor="default");const o=t.getBoundingClientRect(),i=e.clientX-o.left,l=e.clientY-o.top;let s="default";const d=i<F,a=i>o.width-F,r=l<F,c=l>o.height-F;d&&r||a&&c?s="nwse-resize":a&&r||d&&c?s="nesw-resize":d||a?s="ew-resize":(r||c)&&(s="ns-resize"),t.style.cursor=s}),{passive:!0}),t.addEventListener("mousedown",(s=>{if(n)return;if(Y||s.target.closest(".selection-close-btn")||s.target.closest(".selection-expand-btn")||s.target.closest(".selection-fit-btn")||s.target.closest(".selection-btn-group"))return;const r=t.getBoundingClientRect(),m=s.clientX-r.left,v=s.clientY-r.top,f=m<F,h=m>r.width-F,g=v<F,L=v>r.height-F;if(o=f?"left":h?"right":null,i=g?"top":L?"bottom":null,!o&&!i)return;n=!0,T=!0,s.preventDefault();const y=t=>{if(!n)return;const s=p.getBoundingClientRect(),r=p.scrollLeft||0,m=t.clientX-s.left+r,v=t.clientY-s.top,f=u()*c(),h=d-a;if("left"===o){let t=m/f*u();t=Math.min(t,e.data.endTime-.001),e.data.startTime=t}if("right"===o){let t=m/f*u();t=Math.max(t,e.data.startTime+.001),e.data.endTime=t}if("top"===i){let t=(1-v/l)*h+a;t=Math.max(t,e.data.Flow+.1),e.data.Fhigh=t}if("bottom"===i){let t=(1-v/l)*h+a;t=Math.min(t,e.data.Fhigh-.1),e.data.Flow=t}P()},E=()=>{n=!1,T=!1,o=null,i=null,window.removeEventListener("mousemove",y),window.removeEventListener("mouseup",E)};window.addEventListener("mousemove",y,{passive:!0}),window.addEventListener("mouseup",E)}))}(g)}(o,i,s,0,v,m,0,g-h,k,h,g),k=null,$=!1})),p.addEventListener("contextmenu",(e=>{if(!b||w||B)return;if(e.target.closest(".selection-expand-btn")||e.target.closest(".selection-fit-btn")||e.target.closest(".selection-btn-group"))return;e.preventDefault();const t=g.getBoundingClientRect(),n=(1-(e.clientY-t.top)/l)*(d-a)+a,o=E.findIndex((e=>Math.abs(e.freq-n)<1));if(-1!==o)g.removeChild(E[o].div),E.splice(o,1);else{if(E.length>=5)return;const e=Math.round((1-(n-a)/(d-a))*l),t=document.createElement("div");t.className="persistent-line",t.style.top=`${e}px`,g.appendChild(t),E.push({freq:n,div:t})}})),{updateSelections:P,clearSelections:function(){x.forEach((e=>{p.removeChild(e.rect),e.tooltip&&p.removeChild(e.tooltip)})),x.length=0},setFrequencyRange:(e,t)=>{a=e,d=t,P()},hideHover:M,refreshHover:()=>{null!==R&&null!==H&&z({clientX:R,clientY:H})},setPersistentLinesEnabled:e=>{b=e}}}