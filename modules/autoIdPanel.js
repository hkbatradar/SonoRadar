import{initDropdown}from"./dropdown.js";import{autoIdHK}from"./autoid_HK.js";export function initAutoIdPanel({buttonId:e="autoIdBtn",panelId:t="auto-id-panel",viewerId:n="viewer-container",containerId:l="spectrogram-only",overlayId:i="fixed-overlay",spectrogramHeight:s=800,getDuration:o=(()=>0),getFreqRange:a=(()=>({min:0,max:0})),hideHover:r=(()=>{}),refreshHover:c=(()=>{})}={}){const d=document.getElementById(e),u=document.getElementById(t),m=u.querySelector(".popup-drag-bar"),p=u.querySelector(".popup-close-btn"),f=document.getElementById(n),h=document.getElementById(l),y=document.getElementById(i),v="http://www.w3.org/2000/svg",E=document.createElementNS(v,"svg");E.id="autoid-lines",y.appendChild(E);const g=document.getElementById("layout");g&&u&&u.parentElement!==g&&g.appendChild(u);const L=document.getElementById("autoIdTabResetBtn"),F=document.getElementById("autoid-tabs"),k=[],x=Array.from({length:8},(()=>({callType:3,harmonic:0,autoIdResult:null,showValidation:!1,inputs:{start:"",end:"",high:"",low:"",knee:"",heel:"",cfStart:"",cfEnd:""},startTime:null,endTime:null,markers:{start:{el:null,freq:null,time:null},end:{el:null,freq:null,time:null},high:{el:null,freq:null,time:null},low:{el:null,freq:null,time:null},knee:{el:null,freq:null,time:null},heel:{el:null,freq:null,time:null},cfStart:{el:null,freq:null,time:null},cfEnd:{el:null,freq:null,time:null}},line:null,resultEl:null,curves:{}})));let b=0;if(!d||!u||!f)return;function q(){const e="block"===u.style.display;u.style.display=e?"none":"block",document.body.classList.toggle("autoid-open",!e),document.dispatchEvent(new Event(e?"autoid-close":"autoid-open"))}d.addEventListener("click",q),p?.addEventListener("click",q);let w=!1,I=0,C=0;function M(e){w&&(u.style.left=e.clientX-I+"px",u.style.top=e.clientY-C+"px")}function B(){w=!1,document.removeEventListener("mousemove",M),r()}m?.addEventListener("mousedown",(e=>{w=!0,I=e.clientX-u.offsetLeft,C=e.clientY-u.offsetTop,r(),document.addEventListener("mousemove",M,{passive:!0}),document.addEventListener("mouseup",B,{once:!0}),e.preventDefault()})),L?.addEventListener("click",xe);const N=initDropdown("callTypeInput",["CF-FM","FM-CF-FM","FM","FM-QCF","FM-QCF-FM","QCF"]),T=initDropdown("harmonicInput",["0","1","2","3"]);if(T.onChange=function(e,t){x[b].harmonic=t,G||le()},window.handleCallTypeChange=function(e,t){const n=["CF-FM","FM-CF-FM"].includes(e),l=["CF-FM","FM-CF-FM","QCF"].includes(e),i=["QCF","FM-QCF","FM","FM-QCF-FM"].includes(e);ce("high",!n),ce("low",!n),ce("knee",!l),ce("heel",!l),ce("cfStart",!i),ce("cfEnd",!i),x[b].callType=t,G||le(),de(),ve(),x[b].showValidation=!1,qe()},N.onChange=window.handleCallTypeChange,F){F.title="Prev pulse (Ctrl + ←), Next pulse (Ctrl + →)";for(let e=0;e<8;e++){const t=document.createElement("button");t.textContent=`${e+1}`,t.className="tab-btn",t.title=`Pulse ${e+1}`,0===e&&t.classList.add("active"),t.addEventListener("click",(()=>se(e))),F.appendChild(t),k.push(t)}}const j={start:document.getElementById("startFreqInput"),end:document.getElementById("endFreqInput"),high:document.getElementById("highFreqInput"),low:document.getElementById("lowFreqInput"),knee:document.getElementById("kneeFreqInput"),heel:document.getElementById("heelFreqInput"),cfStart:document.getElementById("cfStartFreqInput"),cfEnd:document.getElementById("cfEndFreqInput")},A={start:document.getElementById("startFreqRow"),end:document.getElementById("endFreqRow"),high:document.getElementById("highFreqRow"),low:document.getElementById("lowFreqRow"),knee:document.getElementById("kneeFreqRow"),heel:document.getElementById("heelFreqRow"),cfStart:document.getElementById("cfStartFreqRow"),cfEnd:document.getElementById("cfEndFreqRow")},S=document.getElementById("bandwidthVal"),O=document.getElementById("durationVal"),$=document.getElementById("pulseIdBtn"),R=document.getElementById("sequenceIdBtn"),Q=document.getElementById("autoIdResult");document.getElementById("bandwidth-warning"),document.getElementById("freq-order-warning"),document.getElementById("knee-order-warning"),document.getElementById("time-order-warning");const K={start:"#e74c3c",end:"#004cff",high:"#3498db",low:"#9b59b6",knee:"#f39c12",heel:"#16a085",cfStart:"#e67e22",cfEnd:"#1abc9c"},H={start:"Start freq.",end:"End freq.",high:"High freq.",low:"Low freq.",knee:"Knee freq.",heel:"Heel freq.",cfStart:"CF start",cfEnd:"CF end"};let D=x[b].markers,P=null,V=null,W=null,X=null,Y=null,z=null,U=null,_=!0,G=!1,J=!1,Z=!1;function ee(){U=null,te()}function te(){x.forEach(((e,t)=>{Object.values(e.curves||{}).forEach((e=>{const n=t===b&&U===e.p1Key,l=t===b&&U===e.p2Key;e.cp1El&&(e.cp1El.style.display=n?"block":"none"),e.cp1LineEl&&(e.cp1LineEl.style.display=n?"block":"none"),e.cp2El&&(e.cp2El.style.display=l?"block":"none"),e.cp2LineEl&&(e.cp2LineEl.style.display=l?"block":"none")}))}))}function ne(){const e=x[b].autoIdResult;Q&&(e?Q.innerHTML=be(e):Q.textContent="-")}function le(){null!=x[b].autoIdResult&&(x[b].autoIdResult=null,ne(),fe())}function ie(e){const t=x[e];D=t.markers,G=!0,N.select(t.callType),T.select(t.harmonic),G=!1,Object.keys(j).forEach((e=>{j[e].value=t.inputs[e]||"",null!=t.markers[e].time?j[e].dataset.time=t.markers[e].time:delete j[e].dataset.time})),V=t.startTime,W=t.endTime,de(),fe(),ne(),qe()}function se(e){e!==b&&(!function(){const e=x[b];e.callType=N.selectedIndex,e.harmonic=T.selectedIndex,e.startTime=V,e.endTime=W,Object.keys(j).forEach((t=>{e.inputs[t]=j[t].value}))}(),k[b]&&k[b].classList.remove("active"),b=e,k[b]&&k[b].classList.add("active"),U=null,ie(e))}function oe(e){_=e,document.body.classList.toggle("markers-disabled",!e)}function ae(e){const t=j[e];t&&(t.value="",delete t.dataset.time,t.classList.remove("active-get"),t.classList.remove("invalid"),t.classList.remove("warning"),D[e].freq=null,D[e].time=null,D[e].el&&(D[e].el.style.display="none"),"start"===e&&(V=null),"end"===e&&(W=null),x[b].inputs[e]="",x[b].markers[e].freq=null,x[b].markers[e].time=null,x[b].startTime=V,x[b].endTime=W,de(),fe(),G||le(),qe())}document.addEventListener("click",ee),oe(!0),Object.entries(j).forEach((([e,t])=>{t&&(t.dataset.key=e,t.readOnly=!0,t.addEventListener("click",(()=>{if(P===t)return t.classList.remove("active-get"),P=null,void oe(!0);P&&P.classList.remove("active-get"),P=t,t.classList.add("active-get"),oe(!1)})))}));const re={};function ce(e,t){const n=A[e];if(!n)return;n.style.display=t?"flex":"none",j[e]&&(j[e].disabled=!t);const l=re[e];l&&(l.disabled=!t),t||ae(e),qe()}function de(){N.items[N.selectedIndex],parseFloat(j.high.value),parseFloat(j.low.value),parseFloat(j.knee.value),parseFloat(j.cfStart.value),parseFloat(j.end.value);let e=null;const t=Object.values(D).filter((e=>null!=e.freq&&!isNaN(e.freq)&&e.el&&""!==e.el.value)).map((e=>e.freq));if(t.length>=2){e=Math.max(...t)-Math.min(...t),S.textContent=e.toFixed(1)}else S.textContent="-";const n=Object.values(D).filter((e=>null!=e.time&&!isNaN(e.freq))).map((e=>e.time));if(n.length>=2){const e=Math.max(...n),t=Math.min(...n);O.textContent=(1e3*(e-t)).toFixed(1)}else O.textContent="-";!function(e,t,n,l,i,s){const o=document.getElementById("QCF-duration-warning"),a=document.getElementById("QCF-slope-warning"),r=document.getElementById("highfreq-warning"),c=document.getElementById("lowfreq-warning"),d=document.getElementById("startfreq-warning"),u=document.getElementById("endfreq-warning"),m=N.items[N.selectedIndex],p=document.getElementById("highknee-time-warning"),f=document.getElementById("lowknee-time-warning"),h=document.getElementById("highheel-time-warning"),y=document.getElementById("lowheel-time-warning");let v=!1,E=!1;if("FM-QCF"===m){const e=D.knee,t=D.heel,n=D.low;if(null!=e?.freq&&null!=e?.time&&null!=t?.freq&&null!=t?.time&&null!=n?.freq&&null!=n?.time){const n=1e3*(t.time-e.time);v=n<1;const l=Math.abs(t.freq-e.freq);if(n>0){const e=l/n;E=!(e<1&&e>=.1)}}else if(null!=e?.freq&&null!=e?.time&&null!=n?.freq&&null!=n?.time&&(null==t?.freq||null==t?.time)){const t=1e3*(n.time-e.time);v=t<1;const l=Math.abs(n.freq-e.freq);if(t>0){const e=l/t;E=!(e<1&&e>=.1)}}}if("QCF"===m){let e=null;const t=Object.values(D).filter((e=>null!=e.time&&!isNaN(e.time))).map((e=>e.time));if(t.length>=2){const n=Math.max(...t),l=Math.min(...t);e=1e3*Math.abs(n-l),v=e<1}if(null!=l&&null!=e&&e>0){const t=l/e;E=!(t<1&&t>=.1)}}const g=Object.values(D).filter((e=>null!=e.freq&&!isNaN(e.freq))).map((e=>e.freq));let L=!1,F=!1;if(g.length>1){const e=Math.max(...g),t=Math.min(...g);if(""!==j.high.value){const t=D.high?.freq;isNaN(t)||t===e||(L=!0)}if(""!==j.low.value){const e=D.low?.freq;isNaN(e)||e===t||(F=!0)}}let k=!1,x=!1;const b=Object.values(D).filter((e=>null!=e.time&&!isNaN(e.time))).map((e=>e.time));if(b.length>0){const e=Math.min(...b),t=Math.max(...b);""!==j.start.value&&null!==D.start?.time&&D.start.time>e&&(k=!0),""!==j.end.value&&null!==D.end?.time&&D.end.time<t&&(x=!0)}let q=v||E||L||F||k||x,w=!1,I=!1,C=!1,M=!1;""!==j.knee.value&&null!=D.knee?.time&&(""!==j.high.value&&null!=D.high?.time&&D.knee.time<=D.high.time&&(w=!0),""!==j.low.value&&null!=D.low?.time&&D.knee.time>=D.low.time&&(I=!0)),""!==j.heel.value&&null!=D.heel?.time&&(""!==j.high.value&&null!=D.high?.time&&D.heel.time<=D.high.time&&(C=!0),""!==j.low.value&&null!=D.low?.time&&D.heel.time>=D.low.time&&(M=!0)),q=q||w||I||C||M,j.high&&j.high.classList.toggle("warning",L),j.low&&j.low.classList.toggle("warning",F||"FM-QCF"===m&&(v||E)&&!D.heel?.time),j.knee&&j.knee.classList.toggle("warning",w||I||"FM-QCF"===m&&(v||E)),j.heel&&j.heel.classList.toggle("warning",C||M||"FM-QCF"===m&&D.heel?.time&&(v||E)),j.start&&j.start.classList.toggle("warning",k||"QCF"===m&&(v||E)),j.end&&j.end.classList.toggle("warning",x||"QCF"===m&&(v||E)),o&&(o.style.display=v?"flex":"none",o.textContent="Duration of QCF should be >= 1ms"),a&&(a.style.display=E?"flex":"none",a.textContent="Slope of QCF should be <1 and >=0.1kHz/ms"),r&&(r.style.display=L?"flex":"none",r.textContent="High frequency should be the highest one"),c&&(c.style.display=F?"flex":"none",c.textContent="Low frequency should be the lowest one"),p&&(p.style.display=w?"flex":"none",p.textContent="Knee frequency should come after High frequency"),f&&(f.style.display=I?"flex":"none",f.textContent="Knee frequency should come before Low frequency"),h&&(h.style.display=C?"flex":"none",h.textContent="Heel frequency should come after High frequency"),y&&(y.style.display=M?"flex":"none",y.textContent="Heel frequency should come before Low frequency"),d&&(d.style.display=k?"flex":"none",d.textContent="Start frequency should be the first one"),u&&(u.style.display=x?"flex":"none",u.textContent="End frequency should be the last one"),$&&($.disabled=q),R&&(R.disabled=q)}(0,0,0,e)}function ue(e,t){const n=document.createElement("i");n.className=`fa-solid fa-xmark freq-marker marker-${e}`,n.style.color=K[e],n.dataset.key=e,n.dataset.tab=t;const l=H[e]||e;return n.dataset.title=l,n.setAttribute("aria-label",l),n.addEventListener("mouseenter",r),n.addEventListener("mouseleave",c),n.addEventListener("mousedown",(t=>{_&&(t.stopPropagation(),r(),f.classList.add("hide-cursor"),n.classList.add("hide-cursor"),X=e,Y=n,J=!1,document.addEventListener("mousemove",ge,{passive:!0}),document.addEventListener("mouseup",Le,{once:!0}))})),n.addEventListener("click",(n=>{if(n.stopPropagation(),J)return void(J=!1);const l=x[t];let i=!1;Object.values(l.curves||{}).forEach((t=>{t.p1Key!==e&&t.p2Key!==e||!t.cp1El&&!t.cp2El||(i=!0)})),i||ve(),function(e){U=e,te()}(e)})),y.appendChild(n),n}function me(e,t,n){const l=document.createElement("div");return l.className="path-handle",l.dataset.tab=e,l.dataset.seg=t,l.dataset.handle=n,l.addEventListener("mousedown",(i=>{_&&(i.stopPropagation(),r(),f.classList.add("hide-cursor"),l.classList.add("hide-cursor"),document.querySelectorAll(".freq-marker").forEach((e=>e.classList.add("hide-cursor"))),document.querySelectorAll(".path-handle").forEach((e=>e.classList.add("dragging"))),document.querySelectorAll(".handle-connector").forEach((e=>e.classList.add("dragging"))),z={tabIdx:e,segKey:t,handleKey:n,el:l},document.addEventListener("mousemove",Fe,{passive:!0}),document.addEventListener("mouseup",ke,{once:!0}))})),l.addEventListener("mouseenter",r),l.addEventListener("mouseleave",c),l.addEventListener("contextmenu",(e=>{e.preventDefault(),e.stopPropagation()})),l.addEventListener("click",(e=>e.stopPropagation())),l.style.display="none",y.appendChild(l),l}function pe(e){const t=document.createElement("div");return t.className="pulseid-result",t.dataset.tab=e,y.appendChild(t),t.addEventListener("click",(t=>{t.stopPropagation(),"block"!==u.style.display&&(u.style.display="block",document.body.classList.add("autoid-open"),document.dispatchEvent(new Event("autoid-open"))),se(e)})),t.addEventListener("mouseenter",r),t.addEventListener("mouseleave",c),t.addEventListener("contextmenu",(e=>{e.preventDefault(),e.stopPropagation()})),t}function fe(){const{min:e,max:t}=a(),n=h.scrollWidth;x.forEach(((l,i)=>{let a=1/0,r=-1/0,c=-1/0,d=!1;Object.entries(l.markers).forEach((([l,u])=>{if(u.el||(u.el=ue(l,i)),null==u.freq||null==u.time)return void(u.el.style.display="none");const m=u.time/o()*n-f.scrollLeft,p=(1-(u.freq-e)/(t-e))*s;u.el.style.left=`${m}px`,u.el.style.top=`${p}px`,u.el.style.display="block",u.el.style.pointerEvents=i!==b||Z?"none":"auto",u.el.style.opacity=i===b?"1":"0.5",u.el.dataset.freq=u.freq,u.el.dataset.time=u.time;const h=`${H[l]||l} (${Number(u.freq).toFixed(1)} kHz)`;u.el.dataset.title=h,u.el.setAttribute("aria-label",h),a=Math.min(a,m),r=Math.max(r,m),c=Math.max(c,p),d=!0})),l.resultEl||(l.resultEl=pe(i));const u=l.resultEl;l.autoIdResult&&d?(u.innerHTML=be(l.autoIdResult),u.style.left=(a+r)/2+"px",u.style.top=`${c+20}px`,u.style.display="block",u.classList.toggle("inactive",i!==b)):u.style.display="none"})),ve()}function he(e,t){const n=f.scrollLeft||0,{min:l,max:i}=a();return{time:(e+n)/h.scrollWidth*o(),freq:(1-t/s)*(i-l)+l}}function ye(e,t){const n=h.scrollWidth,{min:l,max:i}=a();return{x:e/o()*n-f.scrollLeft,y:(1-(t-l)/(i-l))*s}}function ve(){const{min:e,max:t}=a(),n=h.scrollWidth;x.forEach(((l,i)=>{l.line||(l.line=document.createElementNS(v,"path"),l.line.dataset.tab=i,E.appendChild(l.line));const a=Object.entries(l.markers).filter((([e,t])=>null!=t.freq&&null!=t.time)).sort(((e,t)=>e[1].time-t[1].time)).map((([l,i])=>({x:i.time/o()*n-f.scrollLeft,y:(1-(i.freq-e)/(t-e))*s,key:l})));if(a.length<2)return l.line.setAttribute("d",""),l.line.style.display="none",Object.values(l.curves||{}).forEach((e=>{e.cp1El?.remove(),e.cp2El?.remove(),e.cp1LineEl?.remove(),e.cp2LineEl?.remove()})),void(l.curves={});const r=function(e,t,n,l=.5){if(e.length<2)return"";let i=`M ${e[0].x} ${e[0].y}`;const s=10,o=[];for(let a=0;a<e.length-1;a++){const r=e[a-1]||e[a],c=e[a],d=e[a+1],u=e[a+2]||d,m=`${c.key}-${d.key}`;o.push(m);const p=a===e.length-2,f=Math.abs(c.y-d.y);if("cfStart"===c.key&&"cfEnd"===d.key){t.curves[m]&&(t.curves[m].cp1El?.remove(),t.curves[m].cp2El?.remove(),t.curves[m].cp1LineEl?.remove(),t.curves[m].cp2LineEl?.remove(),delete t.curves[m]),i+=` L ${d.x} ${d.y}`;continue}if(p&&f<5){t.curves[m]&&(t.curves[m].cp1El?.remove(),t.curves[m].cp2El?.remove(),t.curves[m].cp1LineEl?.remove(),t.curves[m].cp2LineEl?.remove(),delete t.curves[m]),i+=` L ${c.x} ${d.y} L ${d.x} ${d.y}`;continue}t.curves[m]||(t.curves[m]={});const h=t.curves[m];let y,g,L,F;h.p1Key=c.key,h.p2Key=d.key;const k=X&&(c.key===X||d.key===X);if(!k&&h.cp1&&h.cp2)({x:y,y:g}=ye(h.cp1.time,h.cp1.freq)),({x:L,y:F}=ye(h.cp2.time,h.cp2.freq));else{if(y=c.x+(d.x-r.x)*l/6,g=c.y+(d.y-r.y)*l/6,L=d.x-(u.x-c.x)*l/6,F=d.y-(u.y-c.y)*l/6,"high"===c.key&&"knee"===d.key){const e=Math.hypot(d.x-c.x,d.y-c.y),t=Math.hypot(u.x-d.x,u.y-d.y),n=e?1+t/e*2:1;L=d.x-(u.x-c.x)*l/6*n,F=d.y-(u.y-c.y)*l/6*n}if("cfStart"!==d.key&&"end"!==d.key){const e=Math.abs(c.y-d.y),t=Math.min(s,.6*e);F=Math.min(F,d.y+t),L=Math.min(L,d.x)}const e=he(y,g),t=he(L,F);h.cp1=e,h.cp2=t}if(k)h.cp1El?.remove(),h.cp2El?.remove(),h.cp1LineEl?.remove(),h.cp2LineEl?.remove(),delete h.cp1El,delete h.cp2El,delete h.cp1LineEl,delete h.cp2LineEl;else{h.cp1El||(h.cp1El=me(n,m,"cp1")),h.cp2El||(h.cp2El=me(n,m,"cp2")),h.cp1LineEl||(h.cp1LineEl=document.createElementNS(v,"line"),h.cp1LineEl.classList.add("handle-connector"),h.cp1LineEl.style.display="none",h.cp1LineEl.setAttribute("stroke","#4b0082"),h.cp1LineEl.setAttribute("stroke-width","1"),E.appendChild(h.cp1LineEl)),h.cp2LineEl||(h.cp2LineEl=document.createElementNS(v,"line"),h.cp2LineEl.classList.add("handle-connector"),h.cp2LineEl.style.display="none",h.cp2LineEl.setAttribute("stroke","#4b0082"),h.cp2LineEl.setAttribute("stroke-width","1"),E.appendChild(h.cp2LineEl)),h.cp1El.style.left=`${y}px`,h.cp1El.style.top=`${g}px`,h.cp2El.style.left=`${L}px`,h.cp2El.style.top=`${F}px`;const e=5;h.cp1LineEl.setAttribute("x1",c.x),h.cp1LineEl.setAttribute("y1",c.y);const t=y-c.x,l=g-c.y,i=Math.hypot(t,l)||1,s=y-t/i*e,o=g-l/i*e;h.cp1LineEl.setAttribute("x2",s),h.cp1LineEl.setAttribute("y2",o),h.cp2LineEl.setAttribute("x1",d.x),h.cp2LineEl.setAttribute("y1",d.y);const a=L-d.x,r=F-d.y,u=Math.hypot(a,r)||1,p=L-a/u*e,f=F-r/u*e;h.cp2LineEl.setAttribute("x2",p),h.cp2LineEl.setAttribute("y2",f)}i+=` C ${y} ${g} ${L} ${F} ${d.x} ${d.y}`}return Object.keys(t.curves).forEach((e=>{if(!o.includes(e)){const n=t.curves[e];n.cp1El?.remove(),n.cp2El?.remove(),n.cp1LineEl?.remove(),n.cp2LineEl?.remove(),delete t.curves[e]}})),i}(a,l,i);l.line.setAttribute("stroke-linejoin","round"),l.line.setAttribute("d",r),l.line.style.display="block",l.line.style.opacity=i===b?"1":"0.5"})),te()}function Ee(e,t=b){const n=x[t];Object.entries(n.curves||{}).forEach((([t,l])=>{l.p1Key!==e&&l.p2Key!==e||(l.cp1El?.remove(),l.cp2El?.remove(),l.cp1LineEl?.remove(),l.cp2LineEl?.remove(),delete n.curves[t])})),ee()}function ge(e){if(!X||!_)return;J||(J=!0);const t=f.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,i=f.scrollLeft||0,{min:r,max:c}=a(),d=(1-l/s)*(c-r)+r,u=(n+i)/h.scrollWidth*o(),m=j[X];m&&(m.value=d.toFixed(1),m.dataset.time=u,m===j.start&&(V=u),m===j.end&&(W=u)),x[b].startTime=V,x[b].endTime=W,D[X].freq=d,D[X].time=u;const p=Object.entries(D).filter((([e,t])=>null!=t.freq&&null!=t.time)).sort(((e,t)=>e[1].time-t[1].time)),y=p.findIndex((([e])=>e===X));y>0&&Ee(p[y-1][0]),Ee(X),y<p.length-1&&Ee(p[y+1][0]),de(),fe()}function Le(){const e=X;if(X=null,Y&&(Y.classList.remove("hide-cursor"),Y=null),document.removeEventListener("mousemove",ge),f.classList.remove("hide-cursor"),c(),qe(),le(),e&&J){const t=Object.entries(D).filter((([e,t])=>null!=t.freq&&null!=t.time)).sort(((e,t)=>e[1].time-t[1].time)),n=t.findIndex((([t])=>t===e));n>0&&Ee(t[n-1][0]),Ee(e),n<t.length-1&&Ee(t[n+1][0]),ve()}}function Fe(e){if(!z||!_)return;const t=f.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,{time:i,freq:s}=he(n,l),{tabIdx:o,segKey:a,handleKey:r}=z,c=x[o].curves[a];c&&(c[r]={time:i,freq:s}),ve()}function ke(){z&&(z.el.classList.remove("hide-cursor"),document.querySelectorAll(".path-handle").forEach((e=>e.classList.remove("dragging"))),document.querySelectorAll(".handle-connector").forEach((e=>e.classList.remove("dragging"))),document.querySelectorAll(".freq-marker").forEach((e=>e.classList.remove("hide-cursor"))),z=null,document.removeEventListener("mousemove",Fe),f.classList.remove("hide-cursor"),c(),le())}function xe(){var e;x[b].showValidation=!1,(e=x[b]).callType=3,e.harmonic=0,e.autoIdResult=null,e.showValidation=!1,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")})),Object.values(e.curves||{}).forEach((e=>{e.cp1El?.remove(),e.cp2El?.remove(),e.cp1LineEl?.remove(),e.cp2LineEl?.remove()})),e.curves={},e.line&&(e.line.setAttribute("d",""),e.line.style.display="none"),N.select(3),T.select(0),Object.values(j).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"),e.classList.remove("invalid"),e.classList.remove("warning"))})),S.textContent="-",O.textContent="-",V=null,W=null,P=null,x[b].autoIdResult=null,U=null,oe(!0),ie(b)}function be(e){return e.split(" / ").map((e=>{if(e.endsWith("sp.")){return`<i>${e.replace(" sp.","")}</i> sp.`}return"TBC"===e||"-"===e||"No species matched"===e?e:`<i>${e}</i>`})).join(" / ")}function qe(e=!1){const t=x[b];e&&(t.showValidation=!0);const n=t.showValidation,l={"CF-FM":["cfStart","cfEnd"],"FM-CF-FM":["cfStart","cfEnd"],FM:["high","low"],"FM-QCF":["high","low","knee"],"FM-QCF-FM":["high","knee","heel","low"],QCF:["high","low"]}[N.items[N.selectedIndex]]||[];let i=!0;return Object.entries(j).forEach((([e,t])=>{if(t)if(l.includes(e)){const e=parseFloat(t.value),l=!isNaN(e);n?t.classList.toggle("invalid",!l):t.classList.remove("invalid"),l||(i=!1)}else t.classList.remove("invalid")})),i}function we(){if(!qe(!0))return x[b].autoIdResult=null,Q&&(Q.textContent="-"),void fe();const e=N.items[N.selectedIndex],t=parseFloat(j.high.value),n=parseFloat(j.low.value),l=parseFloat(j.knee.value),i=parseFloat(j.heel.value),s=parseFloat(j.start.value),o=parseFloat(j.end.value),a=parseFloat(j.cfStart.value),r=parseFloat(j.cfEnd.value);let c=null;const d=Object.values(D).filter((e=>null!=e.time&&!isNaN(e.freq))).map((e=>e.time));if(d.length>=2){c=1e3*(Math.max(...d)-Math.min(...d))}let u=null;["FM-CF-FM","CF-FM"].includes(e)?isNaN(a)||isNaN(o)||(u=a-o):isNaN(t)||isNaN(n)||(u=t-n);const m=null!=D.knee.time&&null!=D.low.time?1e3*(D.knee.time-D.low.time):null,p=isNaN(l)||isNaN(n)?null:l-n,f=isNaN(i)||isNaN(n)?null:i-n,h=isNaN(l)||isNaN(i)?null:l-i,y=parseInt(T.items[T.selectedIndex],10),v=autoIdHK({callType:e,harmonic:y,highestFreq:t,lowestFreq:n,kneeFreq:l,heelFreq:i,startFreq:s,endFreq:o,cfStart:a,cfEnd:r,duration:c,bandwidth:u,kneeLowTime:m,kneeLowBandwidth:p,heelLowBandwidth:f,kneeHeelBandwidth:h});x[b].autoIdResult=v,ne(),fe()}return u.querySelectorAll(".autoid-marker[data-key]").forEach((e=>{const t=e.dataset.key;re[t]=e,e.addEventListener("click",(e=>{e.preventDefault(),ae(t)}))})),N.onChange=function(e,t){const n=["CF-FM","FM-CF-FM"].includes(e),l=["CF-FM","FM-CF-FM","QCF"].includes(e),i=["QCF","FM-QCF","FM","FM-QCF-FM"].includes(e);ce("high",!n),ce("low",!n),ce("knee",!l),ce("heel",!l),ce("cfStart",!i),ce("cfEnd",!i),x[b].callType=t,G||le(),de(),ve(),x[b].showValidation=!1,qe()},T.select(0),N.select(3),ie(0),document.addEventListener("keydown",(e=>{"Control"!==e.key||Z||(Z=!0,fe())})),document.addEventListener("keyup",(e=>{"Control"===e.key&&Z&&(Z=!1,fe())})),f.addEventListener("click",(e=>{if(!P)return;const t=f.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,i=f.scrollLeft||0,{min:r,max:c}=a(),d=(1-l/s)*(c-r)+r,u=(n+i)/h.scrollWidth*o(),m=P.dataset.key;P.value=d.toFixed(1),P.dataset.time=u,D[m].freq=d,D[m].time=u,P===j.start&&(V=u),P===j.end&&(W=u),x[b].startTime=V,x[b].endTime=W,P.classList.remove("active-get"),P=null,oe(!0),de(),fe(),le()})),f.addEventListener("scroll",fe),$?.addEventListener("click",we),R?.addEventListener("click",(function(){we()})),document.addEventListener("keydown",(e=>{document.body.classList.contains("autoid-open")&&("INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName||e.target.isContentEditable||("Enter"===e.key&&e.ctrlKey?(e.preventDefault(),$?.click()):"Enter"===e.key&&e.shiftKey?(e.preventDefault(),R?.click()):e.ctrlKey&&"ArrowLeft"===e.key?(e.preventDefault(),b>0&&se(b-1)):e.ctrlKey&&"ArrowRight"===e.key&&(e.preventDefault(),b<7&&se(b+1))))})),{updateMarkers:fe,reset:function(){x.forEach((e=>{e.showValidation=!1,e.callType=3,e.harmonic=0,e.autoIdResult=null,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.keys(e.markers).forEach((t=>{e.markers[t].freq=null,e.markers[t].time=null})),Object.values(e.curves||{}).forEach((e=>{e.cp1El?.remove(),e.cp2El?.remove(),e.cp1LineEl?.remove(),e.cp2LineEl?.remove()})),e.curves={},e.line&&(e.line.setAttribute("d",""),e.line.style.display="none")})),N.select(3),T.select(0),Object.values(j).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"),e.classList.remove("invalid"),e.classList.remove("warning"))})),S.textContent="-",O.textContent="-",V=null,W=null,x.forEach((e=>{Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")}))})),P=null,U=null,oe(!0),ie(b)},resetCurrentTab:xe,setMarkerAt:function(e,t,n){const l=j[e];if(!l)return;l.value=t.toFixed(1),l.dataset.time=n,D[e].freq=t,D[e].time=n,"start"===e&&(V=n),"end"===e&&(W=n),x[b].startTime=V,x[b].endTime=W;const i=Object.entries(D).filter((([e,t])=>null!=t.freq&&null!=t.time)).sort(((e,t)=>e[1].time-t[1].time)),s=i.findIndex((([t])=>t===e)),o=[e];s>0&&o.push(i[s-1][0]),s<i.length-1&&o.push(i[s+1][0]),o.forEach((e=>Ee(e,b))),de(),fe(),le(),qe()},removeMarker:function(e){ae(e)},isFieldEnabled:function(e){const t=j[e];return t&&!t.disabled},getFreqRange:a,getDuration:()=>o(),spectrogramHeight:s}}