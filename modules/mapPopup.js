import{getCurrentIndex,getFileMetadata,getFileList}from"./fileState.js";export function initMapPopup({buttonId:t="mapBtn",popupId:e="mapPopup",mapId:o="map"}={}){const n=document.getElementById(t),i=document.getElementById(e),a=document.getElementById(o),l=i.querySelector(".popup-drag-bar"),r=i.querySelector(".popup-close-btn");if(!n||!i||!a)return;a.style.cursor="grab";function s(t,e){const o=i.getBoundingClientRect(),n=t-o.left,a=e-o.top;return{onLeft:n>=-5&&n<5,onRight:n<=o.width+5&&n>o.width-5,onTop:a>=-5&&a<5,onBottom:a<=o.height+5&&a>o.height-5}}function c(t){const{onLeft:e,onRight:o,onTop:n,onBottom:i}=t;let a="";return e&&n||o&&i?a="nwse-resize":o&&n||e&&i?a="nesw-resize":e||o?a="ew-resize":(n||i)&&(a="ns-resize"),a}let p=parseInt(localStorage.getItem("mapPopupWidth"),10),d=parseInt(localStorage.getItem("mapPopupHeight"),10);(isNaN(p)||p<=0)&&(p=500),(isNaN(d)||d<=0)&&(d=500),i.style.width=`${p}px`,i.style.height=`${d}px`;let m=null,u=[],g=[],f=null,y=[],h=null,v=null;const x=document.createElement("input");function b(){g.forEach((t=>t.remove())),g=[],f?.classList.remove("active")}function E(){y.forEach((t=>t.remove())),y=[]}function w(){g.length>0?b():(!function(){if(!m)return;b();const t=getFileList(),e=[];t.forEach(((t,o)=>{const n=getFileMetadata(o),i=parseFloat(n.latitude),a=parseFloat(n.longitude),l=`${(n.date||"").replace(/\D/g,"")}${n.time||""}`;isNaN(i)||isNaN(a)||!l||e.push({lat:i,lon:a,ts:l})})),e.sort(((t,e)=>t.ts.localeCompare(e.ts)));let o=[],n=null;e.forEach((t=>{n&&m.distance([n.lat,n.lon],[t.lat,t.lon])>=1e3&&(o.length>1&&g.push(L.polyline(o,{color:"black",weight:2,opacity:.8}).addTo(m)),o=[]),o.push([t.lat,t.lon]),n=t})),o.length>1&&g.push(L.polyline(o,{color:"black",weight:2,opacity:.8}).addTo(m))}(),f?.classList.add("active"))}function k(){const t=getCurrentIndex();if(t<0)return;const e=getFileMetadata(t),o=parseFloat(e.latitude),n=parseFloat(e.longitude);isNaN(o)||isNaN(n)||(m?m.setView([o,n]):function(t,e){m=L.map(a).setView([t,e],13);const o={attribution:"&copy; CARTO"},n={attribution:"&copy; Google"},i=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(m),l=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; Esri"}),r=L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",o),s=L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",o),c=L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",n),p=L.tileLayer("https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",n),d=L.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",n),u=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/imagery/wgs84/{z}/{x}/{y}.png",{attribution:"&copy; HKSAR Government",minZoom:0,maxZoom:19}),g=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/basemap/wgs84/{z}/{x}/{y}.png",{attribution:"&copy; HKSAR Government",maxZoom:20,minZoom:10}),y=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/label/hk/tc/wgs84/{z}/{x}/{y}.png",{attribution:!1,maxZoom:20,minZoom:0}),b={OpenStreetMap:i,"Esri Satellite":l,"Carto Light":r,"Carto Dark":s,"Google Streets":c,"Google Satellite":p,"Google Hybrid":d,"HK Vector":L.layerGroup([g,y]),"HK Imagery":L.layerGroup([u,y])};L.control.layers(b,null,{position:"topright"}).addTo(m);const k=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-route-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Route",e.innerHTML='<i class="fa-solid fa-route"></i>',f=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",w),t}});m.addControl(new k);const N=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-import-kml-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Import KML",e.innerHTML='<i class="fa-solid fa-file-import"></i>',h=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",(()=>{x.value="",x.click()})),t}});m.addControl(new N);const z=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-clear-kml-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Clear KML",e.innerHTML='<i class="fa-solid fa-trash"></i>',v=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",E),t}});m.addControl(new z)}(o,n),function(){if(!m)return;u.forEach((t=>t.remove())),u=[];const t=getFileList(),e=getCurrentIndex(),o={};function n(t){return t?`${(t.date||"").replace(/\D/g,"")}${t.time||""}`:""}t.forEach(((t,e)=>{const n=getFileMetadata(e),i=parseFloat(n.latitude),a=parseFloat(n.longitude);if(isNaN(i)||isNaN(a))return;const l=`${i.toFixed(6)},${a.toFixed(6)}`;o[l]||(o[l]=[]),o[l].push({file:t,idx:e,meta:n,lat:i,lon:a})})),Object.values(o).forEach((t=>{t.sort(((t,e)=>n(t.meta).localeCompare(n(e.meta))));const o=t[0],{lat:i,lon:a}=o,l=t.some((t=>t.idx===e)),r=l?"map-marker-current":"map-marker-other",s=L.divIcon({html:'<i class="fa-solid fa-location-dot"></i>',className:r,iconSize:[28,28],iconAnchor:[14,28]}),c=t.map((t=>t.file.name.replace(/\.wav$/i,""))),p=c.length<=5?c.join("<br>"):`${c[0]}<br>â‹®<br>${c[c.length-1]}`,d=l?1e3:0,g=L.marker([i,a],{icon:s,zIndexOffset:d});g.on("click",(()=>{document.dispatchEvent(new CustomEvent("map-file-selected",{detail:{index:o.idx}}))})),g.bindTooltip(p,{direction:"top",offset:[-3,-32],className:"map-tooltip"}),g.addTo(m),u.push(g)}))}())}function N(){"block"===i.style.display?(i.style.display="none",document.body.classList.remove("map-open"),b(),E()):(i.style.display="block",document.body.classList.add("map-open"),i.style.width=`${p}px`,i.style.height=`${d}px`,m&&m.invalidateSize(),k())}x.type="file",x.accept=".kml",x.style.display="none",i.appendChild(x),x.addEventListener("change",(async()=>{const t=x.files[0];if(!t)return;const e=function(t){const e=[],o=(new DOMParser).parseFromString(t,"text/xml").getElementsByTagName("LineString");for(let t=0;t<o.length;t++){const n=o[t].getElementsByTagName("coordinates")[0];if(!n)continue;const i=n.textContent.trim().split(/\s+/).map((t=>{const[e,o]=t.split(",").map(Number);return isNaN(o)||isNaN(e)?null:[o,e]})).filter(Boolean);i.length>1&&e.push(i)}return e}(await t.text());E(),e.forEach((t=>{const e=L.polyline(t,{color:"deeppink",weight:2,opacity:.8}).addTo(m);y.push(e)}))}));let z=!1,T=0,I=0,S=!1,C=!1,D=!1,$=!1,M=!1,F=0,B=0,H=0,R=0,P=0,G=0;l&&l.addEventListener("mousedown",(t=>{z=!0,T=t.clientX-i.offsetLeft,I=t.clientY-i.offsetTop,m?.dragging.disable(),t.preventDefault(),t.stopPropagation()})),i.addEventListener("mousemove",(t=>{if(z||S)return;const e=c(s(t.clientX,t.clientY))||"default";i.style.cursor=e})),i.addEventListener("mousedown",(t=>{if(t.target===l||l.contains(t.target))return;const e=s(t.clientX,t.clientY);if(e.onLeft||e.onRight||e.onTop||e.onBottom){S=!0,C=e.onLeft,D=e.onRight,$=e.onTop,M=e.onBottom;const o=c(e)||"default";i.style.cursor=o,document.body.style.cursor=o,F=t.clientX,B=t.clientY,H=i.offsetWidth,R=i.offsetHeight,P=i.offsetLeft,G=i.offsetTop,m?.dragging.disable(),t.preventDefault(),t.stopPropagation()}})),document.addEventListener("mousemove",(t=>{if(z||S||"block"!==i.style.display)return;const e=c(s(t.clientX,t.clientY));document.body.style.cursor=e||""})),document.addEventListener("mousedown",(t=>{if(z||S||"block"!==i.style.display)return;if(t.target===l||l.contains(t.target))return;const e=s(t.clientX,t.clientY);if(e.onLeft||e.onRight||e.onTop||e.onBottom){S=!0,C=e.onLeft,D=e.onRight,$=e.onTop,M=e.onBottom;const o=c(e)||"default";document.body.style.cursor=o,F=t.clientX,B=t.clientY,H=i.offsetWidth,R=i.offsetHeight,P=i.offsetLeft,G=i.offsetTop,m?.dragging.disable(),t.preventDefault(),t.stopPropagation()}})),window.addEventListener("mousemove",(t=>{if(z)return i.style.left=t.clientX-T+"px",void(i.style.top=t.clientY-I+"px");if(S){const e=t.clientX-F,o=t.clientY-B;document.body.style.cursor=document.body.style.cursor||i.style.cursor,D&&(p=Math.max(200,H+e),i.style.width=`${p}px`),M&&(d=Math.max(200,R+o),i.style.height=`${d}px`),C&&(p=Math.max(200,H-e),i.style.width=`${p}px`,i.style.left=`${P+e}px`),$&&(d=Math.max(200,R-o),i.style.height=`${d}px`,i.style.top=`${G+o}px`)}})),window.addEventListener("mouseup",(()=>{z&&(z=!1,m?.dragging.enable()),S&&(S=!1,m?.dragging.enable(),localStorage.setItem("mapPopupWidth",p),localStorage.setItem("mapPopupHeight",d),m?.invalidateSize(),document.body.style.cursor="",i.style.cursor="")})),n.addEventListener("click",N),r&&r.addEventListener("click",N),document.addEventListener("file-loaded",k)}