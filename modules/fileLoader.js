import{extractGuanoMetadata}from"./guanoReader.js";import{addFilesToList,getFileList,getCurrentIndex,setCurrentIndex}from"./fileState.js";let lastObjectUrl=null;export function initFileLoader({fileInputId:e,wavesurfer:t,spectrogramHeight:n,colorMap:a,onPluginReplaced:o,onFileLoaded:r,onBeforeLoad:i,onAfterLoad:d}){const c=document.getElementById(e),l=document.getElementById("prevBtn"),s=document.getElementById("nextBtn"),u=document.getElementById("fileNameText"),m=document.getElementById("guano-output"),f=document.getElementById("spectrogram-settings");async function g(e){if(!e)return;"function"==typeof i&&i(),"function"==typeof r&&r(e),u&&(u.textContent=e.name);try{const t=await extractGuanoMetadata(e);m.textContent=t||"(No GUANO metadata found)"}catch(e){m.textContent="(Error reading GUANO metadata)"}const n=URL.createObjectURL(e);lastObjectUrl&&URL.revokeObjectURL(lastObjectUrl),lastObjectUrl=n,await t.load(n),"function"==typeof o&&o();const a=t?.options?.sampleRate||256e3;f&&(f.textContent=`Sampling rate: ${a/1e3}kHz, FFT size: 1024, Overlap size: Auto, Hanning window`),"function"==typeof d&&d()}return c.addEventListener("change",(async e=>{const t=Array.from(e.target.files),n=t[0];if(!n)return;const a=t.filter((e=>e.name.endsWith(".wav"))).sort(((e,t)=>e.name.localeCompare(t.name))),o=a.findIndex((e=>e.name===n.name));addFilesToList(a,o),await g(n)})),l.addEventListener("click",(()=>{const e=getCurrentIndex();if(e>0){setCurrentIndex(e-1);g(getFileList()[e-1])}})),s.addEventListener("click",(()=>{const e=getCurrentIndex(),t=getFileList();if(e<t.length-1){setCurrentIndex(e+1);g(t[e+1])}})),document.addEventListener("keydown",(e=>{"ArrowUp"===e.key?l.click():"ArrowDown"===e.key&&s.click()})),{loadFileAtIndex:async e=>{const t=getFileList();e>=0&&e<t.length&&(setCurrentIndex(e),await g(t[e]))}}}