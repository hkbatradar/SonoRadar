import{extractGuanoMetadata}from"./guanoReader.js";import{setFileList,getFileList,getCurrentIndex,setCurrentIndex}from"./fileState.js";let lastObjectUrl=null;export function initFileLoader({fileInputId:e,wavesurfer:t,spectrogramHeight:n,colorMap:a,onPluginReplaced:o,onFileLoaded:r,onBeforeLoad:i,onAfterLoad:c}){const d=document.getElementById(e),s=document.getElementById("prevBtn"),l=document.getElementById("nextBtn");async function u(e){if(!e)return;"function"==typeof i&&i(),"function"==typeof r&&r(e);const n=document.getElementById("fileNameText");n&&(n.textContent=e.name);const a=document.getElementById("guano-output");try{const t=await extractGuanoMetadata(e);a.textContent=t||"(No GUANO metadata found)"}catch(e){a.textContent="(Error reading GUANO metadata)"}const d=URL.createObjectURL(e);lastObjectUrl&&URL.revokeObjectURL(lastObjectUrl),lastObjectUrl=d,await t.load(d),"function"==typeof o&&o();const s=t?.options?.sampleRate||256e3;document.getElementById("spectrogram-settings").textContent=`Sampling rate: ${s/1e3}kHz, FFT size: 1024, Overlap size: Auto, Hanning window`,"function"==typeof c&&c()}return d.addEventListener("change",(async e=>{const t=Array.from(e.target.files),n=t[0];if(!n)return;const a=t.filter((e=>e.name.endsWith(".wav"))).sort(((e,t)=>e.name.localeCompare(t.name))),o=a.findIndex((e=>e.name===n.name));setFileList(a,o),await u(n)})),s.addEventListener("click",(()=>{const e=getCurrentIndex();if(e>0){setCurrentIndex(e-1);u(getFileList()[e-1])}})),l.addEventListener("click",(()=>{const e=getCurrentIndex(),t=getFileList();if(e<t.length-1){setCurrentIndex(e+1);u(t[e+1])}})),document.addEventListener("keydown",(e=>{"ArrowLeft"===e.key?s.click():"ArrowRight"===e.key&&l.click()})),{loadFileAtIndex:async e=>{const t=getFileList();e>=0&&e<t.length&&(setCurrentIndex(e),await u(t[e]))}}}