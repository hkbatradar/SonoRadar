import{initDropdown}from"./dropdown.js";import{autoIdHK}from"./autoid_HK.js";export function initAutoIdPanel({buttonId:e="autoIdBtn",panelId:t="auto-id-panel",viewerId:n="viewer-container",containerId:l="spectrogram-only",overlayId:i="fixed-overlay",spectrogramHeight:o=800,getDuration:s=(()=>0),getFreqRange:a=(()=>({min:0,max:0})),hideHover:r=(()=>{}),refreshHover:d=(()=>{})}={}){const c=document.getElementById(e),u=document.getElementById(t),m=u.querySelector(".popup-drag-bar"),f=u.querySelector(".popup-close-btn"),p=document.getElementById(n),y=document.getElementById(l),h=document.getElementById(i),v="http://www.w3.org/2000/svg",g=document.createElementNS(v,"svg");g.id="autoid-lines",h.appendChild(g);const E=document.getElementById("layout");E&&u&&u.parentElement!==E&&E.appendChild(u);const F=document.getElementById("autoIdTabResetBtn"),k=document.getElementById("autoid-tabs"),I=[],x=Array.from({length:5},(()=>({callType:3,harmonic:0,result:null,showValidation:!1,inputs:{start:"",end:"",high:"",low:"",knee:"",heel:"",cfStart:"",cfEnd:""},startTime:null,endTime:null,markers:{start:{el:null,freq:null,time:null},end:{el:null,freq:null,time:null},high:{el:null,freq:null,time:null},low:{el:null,freq:null,time:null},knee:{el:null,freq:null,time:null},heel:{el:null,freq:null,time:null},cfStart:{el:null,freq:null,time:null},cfEnd:{el:null,freq:null,time:null}},line:null})));let w=0;if(!c||!u||!p)return;function L(){const e="block"===u.style.display;u.style.display=e?"none":"block",document.body.classList.toggle("autoid-open",!e),document.dispatchEvent(new Event(e?"autoid-close":"autoid-open"))}c.addEventListener("click",L),f?.addEventListener("click",L);let b=!1,q=0,C=0;function B(e){b&&(u.style.left=e.clientX-q+"px",u.style.top=e.clientY-C+"px")}function M(){b=!1,document.removeEventListener("mousemove",B),r()}m?.addEventListener("mousedown",(e=>{b=!0,q=e.clientX-u.offsetLeft,C=e.clientY-u.offsetTop,r(),document.addEventListener("mousemove",B,{passive:!0}),document.addEventListener("mouseup",M,{once:!0}),e.preventDefault()})),F?.addEventListener("click",de);const T=initDropdown("callTypeInput",["CF-FM","FM-CF-FM","FM","FM-QCF","QCF"]),S=initDropdown("harmonicInput",["0","1","2","3"]);if(S.onChange=function(e,t){x[w].harmonic=t,_||G()},k)for(let e=0;e<5;e++){const t=document.createElement("button");t.textContent=`${e+1}`,t.className="tab-btn",0===e&&t.classList.add("active"),t.addEventListener("click",(()=>Z(e))),k.appendChild(t),I.push(t)}const $={start:document.getElementById("startFreqInput"),end:document.getElementById("endFreqInput"),high:document.getElementById("highFreqInput"),low:document.getElementById("lowFreqInput"),knee:document.getElementById("kneeFreqInput"),heel:document.getElementById("heelFreqInput"),cfStart:document.getElementById("cfStartFreqInput"),cfEnd:document.getElementById("cfEndFreqInput")},R={start:document.getElementById("startFreqRow"),end:document.getElementById("endFreqRow"),high:document.getElementById("highFreqRow"),low:document.getElementById("lowFreqRow"),knee:document.getElementById("kneeFreqRow"),heel:document.getElementById("heelFreqRow"),cfStart:document.getElementById("cfStartFreqRow"),cfEnd:document.getElementById("cfEndFreqRow")},N=document.getElementById("bandwidthVal"),j=document.getElementById("durationVal"),O=document.getElementById("pulseIdBtn"),H=document.getElementById("sequenceIdBtn"),A=document.getElementById("autoIdResult"),Q=document.getElementById("bandwidth-warning"),V=document.getElementById("freq-order-warning");const D={start:"#e74c3c",end:"#27ae60",high:"#3498db",low:"#9b59b6",knee:"#f39c12",heel:"#16a085",cfStart:"#e67e22",cfEnd:"#1abc9c"};let W=x[w].markers,X=null,Y=null,K=null,P=null,U=!0,_=!1;function z(){const e=x[w].result;A&&(e?A.innerHTML=function(e){if(new Set(["Hipposideros armiger","Hipposideros gentilis","Rhinolophus affinis","Rhinolophus pusillus","Rhinolophus sinicus"]).has(e))return`<i>${e}</i>`;if("Hipposideros sp."===e)return"<i>Hipposideros</i> sp.";if("Rhinolophus sp."===e)return"<i>Rhinolophus</i> sp.";return e}(e):A.textContent="-")}function G(){null!=x[w].result&&(x[w].result=null,z())}function J(e){const t=x[e];W=t.markers,_=!0,T.select(t.callType),S.select(t.harmonic),_=!1,Object.keys($).forEach((e=>{$[e].value=t.inputs[e]||"",null!=t.markers[e].time?$[e].dataset.time=t.markers[e].time:delete $[e].dataset.time})),Y=t.startTime,K=t.endTime,ie(),oe(),z(),ce()}function Z(e){e!==w&&(!function(){const e=x[w];e.callType=T.selectedIndex,e.harmonic=S.selectedIndex,e.startTime=Y,e.endTime=K,Object.keys($).forEach((t=>{e.inputs[t]=$[t].value}))}(),I[w]&&I[w].classList.remove("active"),w=e,I[w]&&I[w].classList.add("active"),J(e))}function ee(e){U=e,document.body.classList.toggle("markers-disabled",!e)}function te(e){const t=$[e];t&&(t.value="",delete t.dataset.time,t.classList.remove("active-get"),t.classList.remove("invalid"),W[e].freq=null,W[e].time=null,W[e].el&&(W[e].el.style.display="none"),"start"===e&&(Y=null),"end"===e&&(K=null),x[w].inputs[e]="",x[w].markers[e].freq=null,x[w].markers[e].time=null,x[w].startTime=Y,x[w].endTime=K,ie(),oe(),G(),ce())}ee(!0),Object.entries($).forEach((([e,t])=>{t&&(t.dataset.key=e,t.readOnly=!0,t.addEventListener("click",(()=>{if(X===t)return t.classList.remove("active-get"),X=null,void ee(!0);X&&X.classList.remove("active-get"),X=t,t.classList.add("active-get"),ee(!1)})))}));const ne={};function le(e,t){const n=R[e];if(!n)return;n.style.display=t?"flex":"none",$[e]&&($[e].disabled=!t);const l=ne[e];l&&(l.disabled=!t),t||te(e),ce()}function ie(){const e=T.items[T.selectedIndex],t=parseFloat($.high.value),n=parseFloat($.low.value),l=parseFloat($.cfStart.value),i=parseFloat($.end.value);let o=null;["FM-CF-FM","CF-FM"].includes(e)?isNaN(l)||isNaN(i)?N.textContent="-":(o=l-i,N.textContent=o.toFixed(1)):isNaN(t)||isNaN(n)?N.textContent="-":(o=t-n,N.textContent=o.toFixed(1)),null!=Y&&null!=K?j.textContent=(1e3*(K-Y)).toFixed(1):null!=W.high.time&&null!=W.low.time?j.textContent=(1e3*(W.low.time-W.high.time)).toFixed(1):j.textContent="-",function(e,t,n){const l="QCF"===T.items[T.selectedIndex]&&null!=n&&n>5,i=!isNaN(e)&&!isNaN(t)&&t>e,o=l||i;["high","low"].forEach((e=>{$[e]&&$[e].classList.toggle("invalid",o)})),Q&&(Q.style.display=l?"flex":"none"),V&&(V.style.display=i?"flex":"none")}(t,n,o)}function oe(){const{min:e,max:t}=a(),n=y.scrollWidth;x.forEach(((l,i)=>{Object.entries(l.markers).forEach((([l,a])=>{if(a.el||(a.el=function(e,t){const n=document.createElement("i");return n.className=`fa-solid fa-xmark freq-marker marker-${e}`,n.style.color=D[e],n.dataset.key=e,n.dataset.tab=t,n.title=`${e.charAt(0).toUpperCase()+e.slice(1)} freq. marker`,n.addEventListener("mouseenter",r),n.addEventListener("mouseleave",d),n.addEventListener("mousedown",(t=>{U&&(t.stopPropagation(),r(),P=e,document.addEventListener("mousemove",ae,{passive:!0}),document.addEventListener("mouseup",re,{once:!0}))})),n.addEventListener("click",(e=>e.stopPropagation())),h.appendChild(n),n}(l,i)),null==a.freq||null==a.time)return void(a.el.style.display="none");const c=a.time/s()*n-p.scrollLeft,u=(1-(a.freq-e)/(t-e))*o;a.el.style.left=`${c}px`,a.el.style.top=`${u}px`,a.el.style.display="block",a.el.style.pointerEvents=i===w?"auto":"none",a.el.style.opacity=i===w?"1":"0.5",a.el.dataset.freq=a.freq,a.el.dataset.time=a.time}))})),se()}function se(){const{min:e,max:t}=a(),n=y.scrollWidth;x.forEach(((l,i)=>{l.line||(l.line=document.createElementNS(v,"path"),l.line.dataset.tab=i,g.appendChild(l.line));const a=Object.entries(l.markers).filter((([e,t])=>null!=t.freq&&null!=t.time)).sort(((e,t)=>e[1].time-t[1].time)).map((([l,i])=>({x:i.time/s()*n-p.scrollLeft,y:(1-(i.freq-e)/(t-e))*o,key:l})));if(a.length<2)return l.line.setAttribute("d",""),void(l.line.style.display="none");const r=function(e,t=.5){if(e.length<2)return"";let n=`M ${e[0].x} ${e[0].y}`;const l=10;for(let i=0;i<e.length-1;i++){const o=e[i-1]||e[i],s=e[i],a=e[i+1],r=e[i+2]||a,d=i===e.length-2,c=Math.abs(s.y-a.y);if("cfStart"===s.key&&"cfEnd"===a.key)n+=` L ${a.x} ${a.y}`;else if(d&&c<5)n+=` L ${s.x} ${a.y} L ${a.x} ${a.y}`;else{const e=s.x+(a.x-o.x)*t/6,i=s.y+(a.y-o.y)*t/6;let d=a.x-(r.x-s.x)*t/6,c=a.y-(r.y-s.y)*t/6;if("cfStart"!==a.key&&"end"!==a.key){const e=Math.abs(s.y-a.y),t=Math.min(l,.6*e);c=Math.min(c,a.y+t),d=Math.min(d,a.x)}n+=` C ${e} ${i} ${d} ${c} ${a.x} ${a.y}`}}return n}(a);l.line.setAttribute("stroke-linejoin","round"),l.line.setAttribute("d",r),l.line.style.display="block",l.line.style.opacity=i===w?"1":"0.5"}))}function ae(e){if(!P||!U)return;const t=p.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,i=p.scrollLeft||0,{min:r,max:d}=a(),c=(1-l/o)*(d-r)+r,u=(n+i)/y.scrollWidth*s(),m=$[P];m&&(m.value=c.toFixed(1),m.dataset.time=u,m===$.start&&(Y=u),m===$.end&&(K=u)),x[w].startTime=Y,x[w].endTime=K,W[P].freq=c,W[P].time=u,ie(),oe()}function re(){P=null,document.removeEventListener("mousemove",ae),d(),ce(),G()}function de(){var e;x[w].showValidation=!1,(e=x[w]).callType=3,e.harmonic=0,e.result=null,e.showValidation=!1,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")})),e.line&&(e.line.setAttribute("d",""),e.line.style.display="none"),T.select(3),S.select(0),Object.values($).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"),e.classList.remove("invalid"))})),N.textContent="-",j.textContent="-",Y=null,K=null,X=null,x[w].result=null,ee(!0),J(w)}function ce(e=!1){const t=x[w];e&&(t.showValidation=!0);const n=t.showValidation,l={"CF-FM":["cfStart","cfEnd"],"FM-CF-FM":["cfStart","cfEnd"],FM:["high","low"],"FM-QCF":["high","low","knee"],QCF:["high","low"]}[T.items[T.selectedIndex]]||[];let i=!0;return Object.entries($).forEach((([e,t])=>{if(t)if(l.includes(e)){const e=parseFloat(t.value),l=!isNaN(e);n?t.classList.toggle("invalid",!l):t.classList.remove("invalid"),l||(i=!1)}else t.classList.remove("invalid")})),i}return u.querySelectorAll(".autoid-marker[data-key]").forEach((e=>{const t=e.dataset.key;ne[t]=e,e.addEventListener("click",(e=>{e.preventDefault(),te(t)}))})),T.onChange=function(e,t){const n=["CF-FM","FM-CF-FM"].includes(e),l=["CF-FM","FM-CF-FM","QCF"].includes(e),i=["QCF","FM-QCF","FM"].includes(e);le("high",!n),le("low",!n),le("knee",!l),le("heel",!l),le("cfStart",!i),le("cfEnd",!i),x[w].callType=t,_||G(),ie(),se(),ce()},S.select(0),T.select(3),J(0),p.addEventListener("click",(e=>{if(!X)return;const t=p.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,i=p.scrollLeft||0,{min:r,max:d}=a(),c=(1-l/o)*(d-r)+r,u=(n+i)/y.scrollWidth*s(),m=X.dataset.key;X.value=c.toFixed(1),X.dataset.time=u,W[m].freq=c,W[m].time=u,X===$.start&&(Y=u),X===$.end&&(K=u),x[w].startTime=Y,x[w].endTime=K,X.classList.remove("active-get"),X=null,ee(!0),ie(),oe(),G()})),p.addEventListener("scroll",oe),O?.addEventListener("click",(function(){if(!ce(!0))return void(A&&(A.textContent="-"));const e=T.items[T.selectedIndex],t=parseFloat($.low.value),n=parseFloat($.cfStart.value);let l=null;null!=Y&&null!=K?l=1e3*(K-Y):null!=W.high.time&&null!=W.low.time&&(l=1e3*(W.low.time-W.high.time));const i=autoIdHK({callType:e,cfStart:n,duration:l,lowFreq:t});x[w].result=i,z()})),H?.addEventListener("click",(function(){ce(!0)?(x[w].result=null,z()):A&&(A.textContent="-")})),{updateMarkers:oe,reset:function(){x.forEach((e=>{e.showValidation=!1,e.callType=3,e.harmonic=0,e.result=null,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.keys(e.markers).forEach((t=>{e.markers[t].freq=null,e.markers[t].time=null})),e.line&&(e.line.setAttribute("d",""),e.line.style.display="none")})),T.select(3),S.select(0),Object.values($).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"),e.classList.remove("invalid"))})),N.textContent="-",j.textContent="-",Y=null,K=null,x.forEach((e=>{Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")}))})),X=null,ee(!0),J(w)},resetCurrentTab:de,setMarkerAt:function(e,t,n){const l=$[e];l&&(l.value=t.toFixed(1),l.dataset.time=n,W[e].freq=t,W[e].time=n,"start"===e&&(Y=n),"end"===e&&(K=n),x[w].startTime=Y,x[w].endTime=K,ie(),oe(),G(),ce())},removeMarker:function(e){te(e)},isFieldEnabled:function(e){const t=$[e];return t&&!t.disabled},getFreqRange:a,getDuration:()=>s(),spectrogramHeight:o}}