import{getFileList,getFileIconState,getFileNote,getFileMetadata,setFileMetadata}from"./fileState.js";import{extractGuanoMetadata,parseGuanoMetadata}from"./guanoReader.js";import{showMessageBox}from"./messageBox.js";function strToU8(e){return(new TextEncoder).encode(e)}const crcTable=(()=>{const e=new Uint32Array(256);for(let t=0;t<256;t++){let n=t;for(let e=0;e<8;e++)n=1&n?3988292384^n>>>1:n>>>1;e[t]=n>>>0}return e})();function crc32(e){let t=-1;for(let n=0;n<e.length;n++)t=crcTable[255&(t^e[n])]^t>>>8;return(-1^t)>>>0}function createZip(e){const t=[],n=[];let o=0;for(const s of e){const e=strToU8(s.name),a="string"==typeof s.data?strToU8(s.data):s.data,l=crc32(a),r=a.length,i=new Uint8Array(30+e.length),c=new DataView(i.buffer);c.setUint32(0,67324752,!0),c.setUint16(4,20,!0),c.setUint16(6,0,!0),c.setUint16(8,0,!0),c.setUint16(10,0,!0),c.setUint16(12,0,!0),c.setUint32(14,l,!0),c.setUint32(18,r,!0),c.setUint32(22,r,!0),c.setUint16(26,e.length,!0),c.setUint16(28,0,!0),i.set(e,30);const m=new Uint8Array(i.length+r);m.set(i,0),m.set(a,i.length),t.push(m);const p=new Uint8Array(46+e.length),d=new DataView(p.buffer);d.setUint32(0,33639248,!0),d.setUint16(4,20,!0),d.setUint16(6,20,!0),d.setUint16(8,0,!0),d.setUint16(10,0,!0),d.setUint16(12,0,!0),d.setUint16(14,0,!0),d.setUint32(16,l,!0),d.setUint32(20,r,!0),d.setUint32(24,r,!0),d.setUint16(28,e.length,!0),d.setUint16(30,0,!0),d.setUint16(32,0,!0),d.setUint16(34,0,!0),d.setUint16(36,0,!0),d.setUint32(38,0,!0),d.setUint32(42,o,!0),p.set(e,46),n.push(p),o+=m.length}const s=n.reduce(((e,t)=>e+t.length),0),a=o,l=new Uint8Array(22),r=new DataView(l.buffer);r.setUint32(0,101010256,!0),r.setUint16(4,0,!0),r.setUint16(6,0,!0),r.setUint16(8,e.length,!0),r.setUint16(10,e.length,!0),r.setUint32(12,s,!0),r.setUint32(16,a,!0),r.setUint16(20,0,!0);const i=[...t,...n,l],c=i.reduce(((e,t)=>e+t.length),0),m=new Uint8Array(c);let p=0;for(const e of i)m.set(e,p),p+=e.length;return m}function escapeXml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")}async function gatherRows(){const e=getFileList(),t=[["File name","Remark","Date","Time","Latitude","Longitude","Noise","Star","Question"]];for(let n=0;n<e.length;n++){const o=e[n];let s=getFileMetadata(n);if(!s||!s.date&&!s.time&&!s.latitude&&!s.longitude)try{const e=await extractGuanoMetadata(o);s=parseGuanoMetadata(e),setFileMetadata(n,s)}catch(e){s={date:"",time:"",latitude:"",longitude:""}}const a=getFileIconState(n),l=getFileNote(n);t.push([o.name,l,s.date,s.time,s.latitude,s.longitude,a.trash?"1":"0",a.star?"1":"0",a.question?"1":"0"])}return t}async function generateCsvRows(){return(await gatherRows()).map((e=>e.map((e=>`"${String(e).replace(/"/g,'""')}"`)).join(",")))}async function exportCsv(){const e=(await generateCsvRows()).join("\n"),t=new Blob([e],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download="export.csv",o.style.display="none",document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(n)}function columnLetter(e){let t="";for(e++;e>0;){const n=(e-1)%26;t=String.fromCharCode(65+n)+t,e=Math.floor((e-1)/26)}return t}async function exportXlsx(){const e=await gatherRows(),t=e[0].map((e=>e.length));for(const n of e)n.forEach(((e,n)=>{const o=String(e).length;o>t[n]&&(t[n]=o)}));const n=t.map(((e,t)=>`<col min="${t+1}" max="${t+1}" width="${e+2}" customWidth="1"/>`)).join("");let o="";e.forEach(((e,t)=>{o+=`<row r="${t+1}">`,e.forEach(((e,n)=>{o+=`<c r="${columnLetter(n)}${t+1}" t="inlineStr"><is><t>${escapeXml(String(e))}</t></is></c>`})),o+="</row>"}));const s=createZip([{name:"[Content_Types].xml",data:'<?xml version="1.0" encoding="UTF-8"?><Types xmlns="http://schemas.openxmlformats.org/package/2006/content-types"><Default Extension="rels" ContentType="application/vnd.openxmlformats-package.relationships+xml"/><Default Extension="xml" ContentType="application/xml"/><Override PartName="/xl/workbook.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet.main+xml"/><Override PartName="/xl/worksheets/sheet1.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.worksheet+xml"/><Override PartName="/xl/styles.xml" ContentType="application/vnd.openxmlformats-officedocument.spreadsheetml.styles+xml"/></Types>'},{name:"_rels/.rels",data:'<?xml version="1.0" encoding="UTF-8"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/officeDocument" Target="xl/workbook.xml"/></Relationships>'},{name:"xl/workbook.xml",data:'<?xml version="1.0" encoding="UTF-8"?><workbook xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"><sheets><sheet name="Sheet1" sheetId="1" r:id="rId1"/></sheets></workbook>'},{name:"xl/_rels/workbook.xml.rels",data:'<?xml version="1.0" encoding="UTF-8"?><Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/worksheet" Target="worksheets/sheet1.xml"/><Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/styles" Target="styles.xml"/></Relationships>'},{name:"xl/worksheets/sheet1.xml",data:`<?xml version="1.0" encoding="UTF-8"?><worksheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships"><sheetViews><sheetView workbookViewId="0"/></sheetViews><sheetFormatPr defaultRowHeight="15"/><cols>${n}</cols><sheetData>${o}</sheetData></worksheet>`},{name:"xl/styles.xml",data:'<?xml version="1.0" encoding="UTF-8"?><styleSheet xmlns="http://schemas.openxmlformats.org/spreadsheetml/2006/main"><fonts count="1"><font><sz val="12"/><color theme="1"/><name val="Calibri"/><family val="2"/></font></fonts><fills count="2"><fill><patternFill patternType="none"/></fill><fill><patternFill patternType="gray125"/></fill></fills><borders count="1"><border><left/><right/><top/><bottom/><diagonal/></border></borders><cellStyleXfs count="1"><xf numFmtId="0" fontId="0" fillId="0" borderId="0"/></cellStyleXfs><cellXfs count="1"><xf numFmtId="0" fontId="0" fillId="0" borderId="0" xfId="0"/></cellXfs><cellStyles count="1"><cellStyle name="Normal" xfId="0" builtinId="0"/></cellStyles></styleSheet>'}]),a=new Blob([s],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),l=URL.createObjectURL(a),r=document.createElement("a");r.href=l,r.download="export.xlsx",r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(l)}function showExportOptions(){showMessageBox({title:"Export",message:"Choose file type to export:",confirmText:"CSV",cancelText:"XLSX",onConfirm:exportCsv,onCancel:exportXlsx})}export function initExportCsv({buttonId:e="exportBtn"}={}){const t=document.getElementById(e);t?t.addEventListener("click",showExportOptions):console.warn(`[exportCsv] Button with id '${e}' not found.`)}