<!DOCTYPE html> <html> <head> <meta charset="UTF-8" /> <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" /> <title>SonoRadar - Bat Spectrogram Viewer</title> <link rel="stylesheet" href="style.css" /> <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+HK&display=swap" rel="stylesheet"> <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"> <link rel="icon" href="./favicon.ico" sizes="any" type="image/x-icon" /> </head> <body> <div style="display: flex; flex-direction: row; height: calc(100vh - 50px);"> <!-- Sidebar --> <div id="sidebar"> <div style="display: flex; justify-content: space-between; margin-bottom: 8px;"> <span id="fileListHeader" style="font-weight: bold;">File List</span> <span id="fileCount" style="font-weight: normal;"></span> </div> <input type="text" id="searchInput" placeholder="Search files..." style="width:100%; margin-bottom: 8px;"> <ul id="fileList"></ul> <div id="Metadata"> <span class="section-title">GUANO Metadata:</span> <pre id="guano-output">(no file selected)</pre> </div> </div> <div style="flex-grow: 1; overflow-x: hidden; padding-left: 15px;"> <div id="control-bar"> <!-- Top Bar --> <div id="top-bar"> <button id="toggleSidebarBtn" class="sidebar-button" title="Toggle File List"> <i class="fas fa-bars"></i> </button> <input type="file" id="fileInput" accept=".wav" multiple style="display: none;"> <button id="fileInputBtn" class="sidebar-button" title="Load files"> <i class="fa-solid fa-cloud-arrow-up"></i> </button> <span id="currentFilePath" class="file-path-display"> <i class="fa-regular fa-file-audio" style="margin-right: 6px;"></i> <span id="fileNameText">Upload wav file(s)</span> </span> <button id="prevBtn" title="Previous file (<)" class="sidebar-button"><i class="fas fa-arrow-left"></i></button> <button id="nextBtn" title="Next file (>)" class="sidebar-button"><i class="fas fa-arrow-right"></i></button> <button id="setting" title="Spectrogram setting" class="sidebar-button"><i class="fa-solid fa-sliders"></i></button> </div> <!-- Tool Bar --> <div id="tool-bar"> <label class="slider-label">Overlap: <select id="overlapInput" class="styled-select"> <option value="auto" selected>Auto</option> <option value="25">25%</option> <option value="50">50%</option> <option value="75">75%</option> <option value="90">90%</option> <option value="95">95%</option> </select> </label> <label class="slider-label">F.Range: <input type="number" id="freqMinInput" title="Minimun frequency (kHz)" value="0" min="0" max="192" step="1" style="width: 40px; padding-right:0px"> - <input type="number" id="freqMaxInput" title="Maximum frequency (kHz)" value="128" min="1" max="192" step="1" style="width: 40px; padding-right:0px"> </label> <button id="applyFreqRangeBtn" title="Apply" class="sidebar-button"><i class="fa-solid fa-check"></i></button> <i class="fa-solid fa-sun"></i> <input type="range" id="brightnessSlider" min="-0.5" max="0.5" step="0.01" value="0" title="Brightness"> <span class="slider-value" id="brightnessVal">0</span> <i class="fa-solid fa-circle-half-stroke"></i> <input type="range" id="gainSlider" min="1" max="4" step="0.1" value="2" title="Contrast"> <span class="slider-value" id="gainVal">2</span> <button id="resetButton" title="Reset to default" class="sidebar-button"><i class="fas fa-rotate-left"></i></button> <label class="slider-label">Grid: <label class="switch" title="Show 10kHz Lines"> <input type="checkbox" id="toggleGridSwitch"> <span class="slider round"></span> </label> </label> <label class="slider-label">FFT: <label class="switch fft-switch" title="256/384kHz"> <input type="checkbox" id="fftSizeSwitch"> <span class="slider round"></span> </label> </label> </div> </div> <div id="spectrogram-settings" style=" padding: 0 0 2px; margin-left: 45px; font-size: 12px; font-family: 'Noto Sans HK', sans-serif; z-index: 10; "></div> <div class="viewer-row"> <div id="freq-labels"></div> <div id="viewer-wrapper" style="position: relative;"> <div id="drop-overlay" style=" position: absolute; top: 0; left: 0; right: 0; bottom: 20px; background-color: rgba(255, 255, 255, 0.5); display: none; align-items: center; justify-content: center; z-index: 1000; pointer-events: none; "> <div style=" position: absolute; top: 20px; left: 20px; right: 20px; bottom: 20px; border: 5px dashed rgba(150, 150, 150, 0.8); border-radius: 10px; "></div> <div style="text-align: center; font-family: 'Noto Sans HK', sans-serif; font-size: 24px; color: #333;"> <i class="fas fa-cloud-arrow-up" style="font-size:60px; color:#666; margin-bottom:10px;"></i> <div>Drop WAV file(s) or folder here</div> </div> </div> <div id="viewer-container"> <div id="spectrogram-only" style="height: 800px;"></div> <canvas id="freq-grid"></canvas> </div> <div id="fixed-overlay"> <div id="hover-line" class="hover-line-horizontal"></div> <div id="hover-line-vertical" class="hover-line-vertical"></div> <div id="hover-label">-</div> <div id="zoom-controls"> <button class="zoom-button" id="zoom-in" title="zoom-in (CTRL+^)">+</button> <button class="zoom-button" id="zoom-out" title="zoom-out (CTRL+v)">âˆ’</button> <button id="expand-btn" class="zoom-button" title="Expand Mode (CTRL+0)"><i class="fas fa-expand"></i></button> </div> </div> </div> </div> <div id="time-axis-wrapper"> <div id="time-axis"></div> </div> <div id="time-label">Time (ms)</div> </div> </div> <script type="module"> import { initWavesurfer, getWavesurfer, getPlugin, replacePlugin, createSpectrogramPlugin, getCurrentColorMap, } from './modules/wsManager.js'; import { initZoomControls } from './modules/zoomControl.js'; import { initFileLoader } from './modules/fileLoader.js'; import { initBrightnessControl } from './modules/brightnessControl.js'; import { initFrequencyHover } from './modules/frequencyHover.js'; import { drawTimeAxis, drawFrequencyGrid } from './modules/axisRenderer.js'; import { initScrollSync } from './modules/scrollSync.js'; import { extractGuanoMetadata } from './modules/guanoReader.js'; import { initDragDropLoader } from './modules/dragDropLoader.js'; import { initSidebar } from './modules/sidebar.js'; const spectrogramHeight = 800; let sidebarControl; let fileLoaderControl; const container = document.getElementById('spectrogram-only'); const viewer = document.getElementById('viewer-container'); const timeAxis = document.getElementById('time-axis'); const timeWrapper = document.getElementById('time-axis-wrapper'); const timeLabel = document.getElementById('time-label'); const freqGrid = document.getElementById('freq-grid'); const freqLabelContainer = document.getElementById('freq-labels'); let duration = 0; let currentFreqMin = 0; let currentFreqMax = 128; let currentSampleRate = 256000; let freqHoverControl = null; const getDuration = () => duration; const guanoOutput = document.getElementById('guano-output'); initWavesurfer({ container, url: 'https://raw.githubusercontent.com/hkbatradar/SonoRadar/main/recording/demo_recording.wav', sampleRate: currentSampleRate, }); updateSpectrogramSettingsText(); fileLoaderControl = initFileLoader({ fileInputId: 'fileInput', wavesurfer: getWavesurfer(), spectrogramHeight, colorMap: [], onPluginReplaced: () => {}, onFileLoaded: (file) => { sidebarControl.refresh(file.name); }, onBeforeLoad: () => { freqHoverControl?.hideHover(); }, onAfterLoad: () => { freqHoverControl?.refreshHover(); } }); sidebarControl = initSidebar({ onFileSelected: (index) => { fileLoaderControl.loadFileAtIndex(index); } }); const toggleGridSwitch = document.getElementById('toggleGridSwitch'); const fftSizeSwitch = document.getElementById('fftSizeSwitch'); freqGrid.style.display = 'none'; toggleGridSwitch.checked = false; fftSizeSwitch.checked = false; toggleGridSwitch.addEventListener('change', () => { freqGrid.style.display = toggleGridSwitch.checked ? 'block' : 'none'; }); fftSizeSwitch.addEventListener('change', () => { currentSampleRate = fftSizeSwitch.checked ? 384000 : 256000; const maxFreq = currentSampleRate / 2000; freqMaxInput.max = maxFreq; freqMinInput.max = maxFreq; if (parseFloat(freqMaxInput.value) > maxFreq) { freqMaxInput.value = maxFreq; } if (currentFreqMax > maxFreq) { currentFreqMax = maxFreq; } if (getWavesurfer()) { getWavesurfer().options.sampleRate = currentSampleRate; } freqHoverControl?.hideHover(); replacePlugin( getCurrentColorMap(), spectrogramHeight, currentFreqMin, currentFreqMax, getOverlapPercent(), () => { duration = getWavesurfer().getDuration(); zoomControl.applyZoom(); renderAxes(); freqHoverControl?.refreshHover(); } ); updateSpectrogramSettingsText(); }); const renderAxes = () => { drawTimeAxis({ containerWidth: container.scrollWidth, duration, zoomLevel: zoomControl.getZoomLevel(), axisElement: timeAxis, labelElement: timeLabel, }); drawFrequencyGrid({ gridCanvas: freqGrid, labelContainer: freqLabelContainer, containerElement: container, spectrogramHeight, maxFrequency: currentFreqMax - currentFreqMin, offsetKHz: currentFreqMin, }); if (!freqHoverControl) { freqHoverControl = initFrequencyHover({ viewerId: 'viewer-container', wrapperId: 'viewer-wrapper', hoverLineId: 'hover-line', hoverLineVId: 'hover-line-vertical', freqLabelId: 'hover-label', spectrogramHeight, spectrogramWidth: container.scrollWidth, maxFrequency: currentFreqMax, minFrequency: currentFreqMin, totalDuration: duration, getZoomLevel: () => zoomControl.getZoomLevel(), getDuration: () => duration }); } else { freqHoverControl.setFrequencyRange(currentFreqMin, currentFreqMax); } }; const wrapper = document.getElementById('viewer-wrapper'); const zoomControl = initZoomControls( getWavesurfer(), container, getDuration, renderAxes, wrapper, () => { freqHoverControl?.hideHover(); }, () => { freqHoverControl?.refreshHover(); } ); initBrightnessControl({ brightnessSliderId: 'brightnessSlider', gainSliderId: 'gainSlider', brightnessValId: 'brightnessVal', gainValId: 'gainVal', resetBtnId: 'resetButton', onColorMapUpdated: (colorMap) => { freqHoverControl?.hideHover(); replacePlugin( colorMap, spectrogramHeight, currentFreqMin, currentFreqMax, getOverlapPercent(), () => { duration = getWavesurfer().getDuration(); zoomControl.applyZoom(); renderAxes(); freqHoverControl?.refreshHover(); } ); }, }); initDragDropLoader({ targetElementId: 'viewer-wrapper', wavesurfer: getWavesurfer(), spectrogramHeight, colorMap: [], onPluginReplaced: () => {}, onFileLoaded: (file) => { sidebarControl.refresh(file.name); }, onBeforeLoad: () => { freqHoverControl?.hideHover(); }, onAfterLoad: () => { freqHoverControl?.refreshHover(); } }); initScrollSync({ scrollSourceId: 'viewer-container', scrollTargetId: 'time-axis-wrapper', }); getWavesurfer().on('ready', () => { duration = getWavesurfer().getDuration(); if (zoomControl.isExpandMode()) { zoomControl.forceExpandMode(); } else { zoomControl.applyZoom(); } plugin?.render(); requestAnimationFrame(() => { renderAxes(); freqHoverControl?.refreshHover(); }); }); getWavesurfer().on('decode', () => { duration = getWavesurfer().getDuration(); zoomControl.applyZoom(); renderAxes(); freqHoverControl?.refreshHover(); }); document.body.addEventListener('touchstart', () => { if (getWavesurfer()?.backend?.ac?.state === 'suspended') { getWavesurfer().backend.ac.resume(); } }, { once: true }); const freqMinInput = document.getElementById('freqMinInput'); const freqMaxInput = document.getElementById('freqMaxInput'); const applyFreqRangeBtn = document.getElementById('applyFreqRangeBtn'); freqMaxInput.max = currentSampleRate / 2000; freqMinInput.max = freqMaxInput.max; function updateSpectrogramSettingsText() { const settingBox = document.getElementById('spectrogram-settings'); const sampleRate = currentSampleRate; const fftSize = 1024; const overlap = getOverlapPercent(); const windowType = 'Hanning'; const overlapText = overlap !== null ? `${overlap}%` : 'Auto'; settingBox.textContent = `Sampling rate: ${sampleRate / 1000}kHz, FFT size: ${fftSize}, Overlap size: ${overlapText}, ${windowType} window`; } function getOverlapPercent() { const select = document.getElementById('overlapInput'); const val = select.value; if (val === 'auto') return null; const parsed = parseInt(val, 10); return isNaN(parsed) ? null : parsed; } applyFreqRangeBtn.addEventListener('click', () => { const min = Math.max(0, parseFloat(freqMinInput.value)); const maxAllowed = currentSampleRate / 2000; const max = Math.min(maxAllowed, parseFloat(freqMaxInput.value)); if (isNaN(min) || isNaN(max) || min >= max) { alert('Please enter valid frequency values. Min must be less than Max.'); return; } updateFrequencyRange(min, max); }); document.getElementById('fileInputBtn').addEventListener('click', () => { document.getElementById('fileInput').click(); }); document.getElementById('overlapInput').addEventListener('change', () => { const colorMap = getCurrentColorMap(); freqHoverControl?.hideHover(); replacePlugin( colorMap, spectrogramHeight, currentFreqMin, currentFreqMax, getOverlapPercent() ); freqHoverControl?.refreshHover(); duration = getWavesurfer().getDuration(); zoomControl.applyZoom(); renderAxes(); updateSpectrogramSettingsText(); }); function updateFrequencyRange(freqMin, freqMax) { const colorMap = getCurrentColorMap(); currentFreqMin = freqMin; currentFreqMax = freqMax; freqHoverControl?.hideHover(); replacePlugin( colorMap, spectrogramHeight, freqMin, freqMax, getOverlapPercent() ); freqHoverControl?.refreshHover(); duration = getWavesurfer().getDuration(); zoomControl.applyZoom(); renderAxes(); if (freqHoverControl) { freqHoverControl.setFrequencyRange(currentFreqMin, currentFreqMax); } } const settingBtn = document.getElementById('setting'); const toolBar = document.getElementById('tool-bar'); settingBtn.addEventListener('click', () => { toolBar.classList.toggle('open'); }); </script> </body> </html>
