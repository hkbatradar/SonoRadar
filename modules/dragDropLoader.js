import{extractGuanoMetadata,parseGuanoMetadata}from"./guanoReader.js";import{getWavSampleRate}from"./fileLoader.js";import{addFilesToList,removeFilesByName,setFileMetadata,getCurrentIndex,getFileList}from"./fileState.js";export function initDragDropLoader({targetElementId:e,wavesurfer:t,spectrogramHeight:a,colorMap:n,onPluginReplaced:o,onFileLoaded:r,onBeforeLoad:i,onAfterLoad:d,onSampleRateDetected:s}){const l=document.getElementById(e),c=document.getElementById("drop-overlay"),f=document.getElementById("fileNameText"),m=document.getElementById("guano-output"),u=document.getElementById("spectrogram-settings");let p=null;function y(){c.style.display="none",document.dispatchEvent(new Event("drop-overlay-hide"))}async function g(e){const a=Array.from(e).filter((e=>"audio/wav"===e.type||e.name.endsWith(".wav")));if(0===a.length)return void alert("Only .wav files are supported.");"function"==typeof i&&i();const n=a.sort(((e,t)=>e.name.localeCompare(t.name)));removeFilesByName("demo_recording.wav");const l=getFileList().length;addFilesToList(n,0);for(let e=0;e<n.length;e++)try{const t=await extractGuanoMetadata(n[e]),a=parseGuanoMetadata(t);setFileMetadata(l+e,a)}catch(t){setFileMetadata(l+e,{date:"",time:"",latitude:"",longitude:""})}await async function(e){if(!e)return;const a=await getWavSampleRate(e);"function"==typeof i&&i(),"function"==typeof r&&r(e),f&&(f.textContent=e.name);try{const t=await extractGuanoMetadata(e);m.textContent=t||"(No GUANO metadata found)";const a=parseGuanoMetadata(t),n=getCurrentIndex();setFileMetadata(n,a)}catch(e){m.textContent="(Error reading GUANO metadata)"}const n=URL.createObjectURL(e);p&&URL.revokeObjectURL(p),p=n,await t.load(n),"function"==typeof o&&o();const l=a||t?.options?.sampleRate||256e3;"function"==typeof s&&await s(l),u&&(u.textContent=`Sampling rate: ${l/1e3}kHz`),"function"==typeof d&&d(),document.dispatchEvent(new Event("file-loaded"))}(n[0])}let v=0;l.addEventListener("dragenter",(e=>{e.preventDefault(),v++,c.style.display="flex",document.dispatchEvent(new Event("drop-overlay-show"))})),l.addEventListener("dragleave",(e=>{e.preventDefault(),v--,0===v&&y()})),l.addEventListener("dragover",(e=>{e.preventDefault(),e.dataTransfer.dropEffect="move"})),l.addEventListener("drop",(async e=>{e.preventDefault(),v=0,y();g(await async function(e){if(!e.items)return Array.from(e.files);const t=async e=>{if(e.isFile)return new Promise((t=>{e.file((e=>t([e])),(()=>t([])))}));if(e.isDirectory){const a=e.createReader(),n=[],o=()=>new Promise((e=>{a.readEntries((async a=>{if(a.length)n.push(...a),e(await o());else{const a=await Promise.all(n.map(t));e(a.flat())}}),(()=>e([])))}));return o()}return[]},a=Array.from(e.items).map((e=>e.webkitGetAsEntry&&e.webkitGetAsEntry())).filter(Boolean);return a.length?(await Promise.all(a.map(t))).flat():Array.from(e.files)}(e.dataTransfer))}))}