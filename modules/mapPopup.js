import{getCurrentIndex,getFileMetadata,getFileList,getFileIconState}from"./fileState.js";let importKmlFileFn=null;export function initMapPopup({buttonId:t="mapBtn",popupId:e="mapPopup",mapId:o="map"}={}){const n=document.getElementById(t),i=document.getElementById(e),a=document.getElementById(o),s=document.getElementById("viewer-container"),r=document.getElementById("control-bar"),l=document.getElementById("sidebar"),c=i.querySelector(".popup-drag-bar"),d=i.querySelector(".popup-close-btn"),p=i.querySelector(".popup-max-btn");if(!n||!i||!a)return;a.style.cursor="default";function m(t,e){const o=i.getBoundingClientRect(),n=t-o.left,a=e-o.top,s=a>=-5&&a<=o.height+5,r=n>=-5&&n<=o.width+5;return{onLeft:Math.abs(n-0)<=5&&s,onRight:Math.abs(n-o.width)<=5&&s,onTop:Math.abs(a-0)<=5&&r,onBottom:Math.abs(a-o.height)<=5&&r}}function u(t){const{onLeft:e,onRight:o,onTop:n,onBottom:i}=t;let a="";return e&&n||o&&i?a="nwse-resize":o&&n||e&&i?a="nesw-resize":e||o?a="ew-resize":(n||i)&&(a="ns-resize"),a}let g=parseInt(localStorage.getItem("mapPopupWidth"),10),f=parseInt(localStorage.getItem("mapPopupHeight"),10);(isNaN(g)||g<=0)&&(g=500),(isNaN(f)||f<=0)&&(f=500),i.style.width=`${g}px`,i.style.height=`${f}px`;let y=null,v=[],h=[],E=null,x=null,b=null,w=[],D=null,k=null,P=null,T=null,C=null,F=!1,S=[],z=null,I=!1,$=null,M=null,N=!1,H=null,O=null;const B=a.querySelector(".coord-scale-wrapper"),R=a.querySelector("#coord-display"),A=a.querySelector("#no-coord-message"),U=a.querySelector("#copy-coord-message");let G=null,K=null,q=!1;const Z=document.createElement("input");Z.type="file",Z.accept=".kml",Z.style.display="none",i.appendChild(Z);const W=document.getElementById("map-drop-overlay");let X=0;function Y(){a.style.cursor=q?"grabbing":F?"text":"default"}function j(){W&&(W.style.display="none",W.style.pointerEvents="none"),y?.dragging.enable()}function V(){A&&(A.style.display="none")}function _(t,e){if(y=L.map(a).setView([t,e],13),y.on("dragstart",(()=>{q=!0,Y()})),y.on("dragend",(()=>{q=!1,Y()})),Y(),K=L.control.scale({position:"bottomleft",metric:!0,imperial:!1}).addTo(y),B){const t=K.getContainer();t.style.position="static",B.appendChild(t)}function o(t){if(!R)return;const{lat:e,lng:o}=t;R.textContent=`${e.toFixed(4)} ${o.toFixed(4)}`}y.on("mousemove",(t=>o(t.latlng))),y.on("move",(()=>o(y.getCenter()))),o(y.getCenter()),y.on("contextmenu",(t=>{const{lat:e,lng:o}=t.latlng,n=`${e.toFixed(6)}\t${o.toFixed(6)}`;navigator.clipboard?.writeText(n).catch((()=>{})),U&&(U.style.display="flex",clearTimeout(G),G=setTimeout((()=>{U.style.display="none"}),3e3))}));const n={attribution:"&copy; CARTO"},i={attribution:"&copy; Google"},s=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors",crossOrigin:"anonymous"}).addTo(y),r=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; Esri",crossOrigin:"anonymous"}),l=L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{...n,crossOrigin:"anonymous"}),c=L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{...n,crossOrigin:"anonymous"}),d=L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",{...i,crossOrigin:"anonymous"}),p=L.tileLayer("https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{...i,crossOrigin:"anonymous"}),m=L.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",{...i,crossOrigin:"anonymous"}),u=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/imagery/wgs84/{z}/{x}/{y}.png",{attribution:"&copy; HKSAR Government",minZoom:0,maxZoom:19,crossOrigin:"anonymous"}),g=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/basemap/wgs84/{z}/{x}/{y}.png",{attribution:"&copy; HKSAR Government",maxZoom:20,minZoom:10,crossOrigin:"anonymous"}),f=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/label/hk/tc/wgs84/{z}/{x}/{y}.png",{attribution:!1,maxZoom:20,minZoom:0,crossOrigin:"anonymous"}),v=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/label/hk/tc/wgs84/{z}/{x}/{y}.png",{attribution:!1,maxZoom:20,minZoom:0,crossOrigin:"anonymous"}),h=L.layerGroup([g,f]),w=L.layerGroup([u,v]);y.on("zoomend",(()=>{y.getZoom()>19&&y.hasLayer(w)&&y.setZoom(19)}));const F={OpenStreetMap:s,"Esri Satellite":r,"Carto Light":l,"Carto Dark":c,"Google Streets":d,"Google Satellite":p,"Google Hybrid":m,"HK Vector":h,"HK Imagery":w};H=L.control.layers(F,null,{position:"topright"}).addTo(y),fetch("https://raw.githubusercontent.com/PanTong55/spectrogram/main/hkgrid.geojson").then((t=>t.json())).then((t=>{O=L.geoJSON(t,{interactive:!1,style:{color:"#3388ff",weight:2,fillColor:"#3388ff",fillOpacity:0}}),H.addOverlay(O,"1km Grid")})),M=(new L.FeatureGroup).addTo(y),$=new L.Control.Draw({position:"topleft",edit:{featureGroup:M},draw:{circlemarker:!1}}),y.on(L.Draw.Event.CREATED,(t=>{M.addLayer(t.layer)}));const S=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-route-toggle-control");t.style.display="flex";const e=L.DomUtil.create("a","",t);e.href="#",e.title="Route options",e.innerHTML='<i class="fa-solid fa-route"></i>',x=e,L.DomEvent.disableClickPropagation(t),L.DomEvent.on(t,"mousedown",L.DomEvent.stopPropagation),L.DomEvent.on(t,"dblclick",L.DomEvent.stopPropagation),b=L.DomUtil.create("div","route-button-group",t),b.style.display="none";const o=L.DomUtil.create("a","",b);o.href="#",o.title="Create Route",o.innerHTML='<i class="fa-solid fa-eye"></i>',E=o,L.DomEvent.on(o,"click",L.DomEvent.stop).on(o,"mousedown",L.DomEvent.stopPropagation).on(o,"dblclick",L.DomEvent.stopPropagation).on(o,"click",ot);const n=L.DomUtil.create("a","",b);n.href="#",n.title="Import KML",n.innerHTML='<i class="fa-solid fa-file-import"></i>',D=n,L.DomEvent.on(n,"click",L.DomEvent.stop).on(n,"mousedown",L.DomEvent.stopPropagation).on(n,"dblclick",L.DomEvent.stopPropagation).on(n,"click",(()=>{Z.value="",Z.click()}));const i=L.DomUtil.create("a","",b);return i.href="#",i.title="Clear KML",i.innerHTML='<i class="fa-solid fa-trash"></i>',k=i,L.DomEvent.on(i,"click",L.DomEvent.stop).on(i,"mousedown",L.DomEvent.stopPropagation).on(i,"dblclick",L.DomEvent.stopPropagation).on(i,"click",tt),L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"mousedown",L.DomEvent.stopPropagation).on(e,"dblclick",L.DomEvent.stopPropagation).on(e,"click",(()=>{const t="flex"===b.style.display;b.style.display=t?"none":"flex",e.classList.toggle("active",!t)})),t}});y.addControl(new S);const z=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-text-toggle-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Text",e.innerHTML='<i class="fa-solid fa-font"></i>',T=e,L.DomEvent.disableClickPropagation(t),L.DomEvent.on(t,"mousedown",L.DomEvent.stopPropagation),L.DomEvent.on(t,"dblclick",L.DomEvent.stopPropagation),L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"mousedown",L.DomEvent.stopPropagation).on(e,"dblclick",L.DomEvent.stopPropagation).on(e,"click",lt),t}});y.addControl(new z);const I=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-export-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Export Map",e.innerHTML='<i class="fa-solid fa-file-export"></i>',C=e,L.DomEvent.disableClickPropagation(t),L.DomEvent.on(t,"mousedown",L.DomEvent.stopPropagation),L.DomEvent.on(t,"dblclick",L.DomEvent.stopPropagation),L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"mousedown",L.DomEvent.stopPropagation).on(e,"dblclick",L.DomEvent.stopPropagation).on(e,"click",it),t}});y.addControl(new I);const N=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-draw-toggle-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Draw",e.innerHTML='<i class="fa-solid fa-pen-to-square"></i>',P=e,L.DomEvent.disableClickPropagation(t),L.DomEvent.on(t,"mousedown",L.DomEvent.stopPropagation),L.DomEvent.on(t,"dblclick",L.DomEvent.stopPropagation),L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"mousedown",L.DomEvent.stopPropagation).on(e,"dblclick",L.DomEvent.stopPropagation).on(e,"click",nt),t}});y.addControl(new N)}function J(){if(!y)return;v.forEach((t=>t.remove())),v=[];const t=getFileList(),e=getCurrentIndex(),o={};function n(t){if(!t)return"";return`${(t.date||"").replace(/\D/g,"")}${t.time||""}`}t.forEach(((t,e)=>{const n=getFileMetadata(e),i=parseFloat(n.latitude),a=parseFloat(n.longitude);if(isNaN(i)||isNaN(a))return;const s=`${i.toFixed(6)},${a.toFixed(6)}`;o[s]||(o[s]=[]),o[s].push({file:t,idx:e,meta:n,lat:i,lon:a})})),Object.values(o).forEach((t=>{t.sort(((t,e)=>n(t.meta).localeCompare(n(e.meta))));const o=t[0],{lat:i,lon:a}=o,s=t.some((t=>t.idx===e)),r=t.every((t=>getFileIconState(t.idx).trash));let l="map-marker-other";s?l="map-marker-current":r&&(l="map-marker-trash");const c=L.divIcon({html:'<i class="fa-solid fa-location-dot"></i>',className:l,iconSize:[28,28],iconAnchor:[14,28]}),d=t.map((t=>t.file.name.replace(/\.wav$/i,""))),p=d.length<=5?d.join("<br>"):`${d[0]}<br>â‹®<br>${d[d.length-1]}`,m=s?1e3:0,u=L.marker([i,a],{icon:c,zIndexOffset:m});u.on("click",(()=>{document.dispatchEvent(new CustomEvent("map-file-selected",{detail:{index:o.idx}}))})),u.bindTooltip(p,{direction:"top",offset:[-3,-32],className:"map-tooltip"}),u.addTo(y),v.push(u)}))}function Q(){h.forEach((t=>t.remove())),h=[],E?.classList.remove("active"),E&&(E.innerHTML='<i class="fa-solid fa-eye"></i>')}function tt(){w.forEach((t=>t.remove())),w=[]}async function et(t){if(!t)return;const e=function(t){const e=(new DOMParser).parseFromString(t,"text/xml"),o=[],n=e.getElementsByTagName("LineString");for(let t=0;t<n.length;t++){const e=n[t].getElementsByTagName("coordinates")[0];if(!e)continue;const i=e.textContent.trim().split(/\s+/).map((t=>{const[e,o]=t.split(",").map(Number);return isNaN(o)||isNaN(e)?null:[o,e]})).filter(Boolean);i.length>1&&o.push(i)}return o}(await t.text());tt();const o=[];e.forEach((t=>{const e=L.polyline(t,{color:"deeppink",weight:2,opacity:.8,renderer:L.canvas()}).addTo(y);w.push(e),o.push(...t)})),o.length>0&&(y.fitBounds(o),dt())}function ot(){h.length>0?Q():(!function(){if(!y)return;Q();const t=getFileList(),e=[];t.forEach(((t,o)=>{const n=getFileMetadata(o),i=parseFloat(n.latitude),a=parseFloat(n.longitude),s=`${(n.date||"").replace(/\D/g,"")}${n.time||""}`;isNaN(i)||isNaN(a)||!s||e.push({lat:i,lon:a,ts:s})})),e.sort(((t,e)=>t.ts.localeCompare(e.ts)));let o=[],n=null;e.forEach((t=>{n&&y.distance([n.lat,n.lon],[t.lat,t.lon])>=1e3&&(o.length>1&&h.push(L.polyline(o,{color:"black",weight:2,opacity:.8,renderer:L.canvas()}).addTo(y)),o=[]),o.push([t.lat,t.lon]),n=t})),o.length>1&&h.push(L.polyline(o,{color:"black",weight:2,opacity:.8,renderer:L.canvas()}).addTo(y))}(),E?.classList.add("active"),E&&(E.innerHTML='<i class="fa-solid fa-eye-slash"></i>'))}function nt(){if(!$)return;!N&&F&&lt(),N?(y.removeControl($),P?.classList.remove("active"),N=!1):($.addTo(y),P?.classList.add("active"),N=!0)}function it(){if(!y||!window.html2canvas)return;const t=y.getContainer(),e=t.querySelector(".leaflet-control-container"),o=[];e&&o.push(e),B&&o.push(B),o.forEach((t=>{t.style.display="none"})),html2canvas(t,{useCORS:!0}).then((t=>{o.forEach((t=>{t.style.display=""}));const e=document.createElement("a");e.href=t.toDataURL("image/png"),e.download="map.png",e.click()})).catch((()=>{o.forEach((t=>{t.style.display=""}))}))}function at(t,e=!1){const o=e?' title="Left click to edit\nRight click to delete"':"";return L.divIcon({className:"map-text-icon",html:`<span class="map-text-label"${o}>${n=t,n.replace(/[&<>"]/g,(t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[t])))}</span>`,iconSize:null,iconAnchor:[0,0],popupAnchor:[0,0]});var n}function st(t){if(!y||z)return;const e=t.getLatLng(),o=y.latLngToContainerPoint(e),n=document.createElement("textarea");n.value=t.text||"",n.className="map-text-input",n.rows=1,n.style.left=`${o.x}px`,n.style.top=`${o.y}px`,y.getContainer().appendChild(n),z=n,y.dragging.disable(),n.focus();const i=()=>{n.style.height="auto",n.style.height=`${n.scrollHeight}px`};i(),n.addEventListener("input",i);const a=()=>{if(!z)return;const e=n.value.trim();y.getContainer().removeChild(n),z=null,y.dragging.enable(),e?(t.text=e,t.setIcon(at(e,F))):(y.removeLayer(t),S=S.filter((e=>e!==t)))};n.addEventListener("keydown",(t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),a())})),n.addEventListener("pointerdown",(t=>t.stopPropagation())),n.addEventListener("blur",(()=>{I=!0,setTimeout((()=>{document.activeElement!==n&&a()}))}))}function rt(t){if(I)return void(I=!1);if(z)return;const e=function(t,e){const o=L.marker(t,{icon:at(e,F),draggable:F});return o.text=e,o.on("dblclick",(()=>{F&&st(o)})),o.on("click",(t=>{F&&!z&&(t.originalEvent.stopPropagation(),st(o))})),o.on("contextmenu",(()=>{F&&!z&&(y.removeLayer(o),S=S.filter((t=>t!==o)))})),o}(t.latlng,"");e.addTo(y),S.push(e),st(e)}function lt(){const t=!F;t&&N&&nt(),F=t,T?.classList.toggle("active",F),F?y.on("click",rt):(y.off("click",rt),z&&z.blur()),S.forEach((t=>{F?t.dragging.enable():t.dragging.disable();const e=t.text||"";t.setIcon(at(e,F))})),Y()}a.addEventListener("dragenter",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),X++,W&&(W.style.display="flex",W.style.pointerEvents="auto"),y?.dragging.disable())})),a.addEventListener("dragover",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),t.dataTransfer.dropEffect="copy")})),a.addEventListener("dragleave",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),X--,X<=0&&j())})),a.addEventListener("drop",(async t=>{t.preventDefault(),X=0,j();const e=Array.from(t.dataTransfer.files).find((t=>t.name.endsWith(".kml")));e&&await et(e)})),importKmlFileFn=et,Z.addEventListener("change",(async()=>{const t=Z.files[0];t&&await et(t)}));const ct=13;function dt(){const t=getCurrentIndex();if(t<0)return J(),navigator.geolocation&&navigator.geolocation.getCurrentPosition((t=>{const{latitude:e,longitude:o}=t.coords,n=L.divIcon({html:'<i class="fa-solid fa-location-crosshairs"></i>',className:"map-marker-device",iconSize:[28,28],iconAnchor:[14,28]});y?y.setView([e,o]):_(e,o);const i=L.marker([e,o],{icon:n,zIndexOffset:1001});i.addTo(y),v.push(i)})),void V();const e=getFileMetadata(t),o=parseFloat(e.latitude),n=parseFloat(e.longitude);if(isNaN(o)||isNaN(n))return J(),void(A&&(A.style.display="flex"));V(),y?"block"!==i.style.display?y.setView([o,n],ct):y.setView([o,n]):_(o,n),J()}function pt(){"block"===i.style.display?(Tt&&mt(),i.style.display="none",document.body.classList.remove("map-open"),F&&lt()):(i.style.display="block",document.body.classList.add("map-open"),i.style.width=`${g}px`,i.style.height=`${f}px`,y&&y.invalidateSize(),dt(),Y())}function mt(){Tt?(i.style.width=`${Ct}px`,i.style.height=`${Ft}px`,i.style.left=`${St}px`,i.style.top=`${zt}px`,p.innerHTML='<i class="fa-regular fa-square"></i>',Tt=!1):(Ct=i.offsetWidth,Ft=i.offsetHeight,St=i.offsetLeft,zt=i.offsetTop,i.style.left="0px",i.style.top="0px",i.style.width=window.innerWidth-2+"px",i.style.height=window.innerHeight-2+"px",p.innerHTML='<i class="fa-regular fa-clone"></i>',Tt=!0),y?.invalidateSize()}let ut=!1,gt=0,ft=0,yt=!1,vt=!1,ht=!1,Lt=!1,Et=!1,xt=0,bt=0,wt=0,Dt=0,kt=0,Pt=0,Tt=!1,Ct=0,Ft=0,St=0,zt=0;function It(){s&&(s.style.pointerEvents="none",s.classList.remove("hide-cursor")),r&&(r.style.pointerEvents="none"),l&&(l.style.pointerEvents="none")}function $t(){s&&(s.style.pointerEvents=""),r&&(r.style.pointerEvents=""),l&&(l.style.pointerEvents="")}c&&c.addEventListener("mousedown",(t=>{Tt||(ut=!0,gt=t.clientX-i.offsetLeft,ft=t.clientY-i.offsetTop,y?.dragging.disable(),It(),document.dispatchEvent(new Event("hide-spectrogram-hover")),t.preventDefault(),t.stopPropagation())})),i.addEventListener("mousemove",(t=>{if(Tt)return;if(ut||yt)return void t.stopPropagation();const e=u(m(t.clientX,t.clientY))||"default";i.style.cursor=e,"default"!==e?(a.style.cursor=e,document.body.style.cursor=e,It(),document.dispatchEvent(new Event("hide-spectrogram-hover")),t.stopPropagation()):(a.style.cursor="",document.body.style.cursor="",$t(),Y())})),i.addEventListener("mousedown",(t=>{if(Tt)return;if(t.target===c||c.contains(t.target))return;const e=m(t.clientX,t.clientY);if(e.onLeft||e.onRight||e.onTop||e.onBottom){yt=!0,vt=e.onLeft,ht=e.onRight,Lt=e.onTop,Et=e.onBottom;const o=u(e)||"default";i.style.cursor=o,a.style.cursor=o,document.body.style.cursor=o,It(),document.dispatchEvent(new Event("hide-spectrogram-hover")),xt=t.clientX,bt=t.clientY,wt=i.offsetWidth,Dt=i.offsetHeight,kt=i.offsetLeft,Pt=i.offsetTop,y?.dragging.disable(),t.preventDefault(),t.stopPropagation()}})),document.addEventListener("mousemove",(t=>{if("block"!==i.style.display||Tt)return;if(ut||yt)return void t.stopPropagation();const e=u(m(t.clientX,t.clientY));e?(document.body.style.cursor=e,a.style.cursor=e,It(),document.dispatchEvent(new Event("hide-spectrogram-hover")),t.stopPropagation()):(document.body.style.cursor="",a.style.cursor="",$t(),Y())}),!0),document.addEventListener("mousedown",(t=>{if("block"!==i.style.display||Tt)return;if(ut||yt)return t.stopPropagation(),void t.preventDefault();if(t.target===c||c.contains(t.target))return;const e=m(t.clientX,t.clientY);if(e.onLeft||e.onRight||e.onTop||e.onBottom){yt=!0,vt=e.onLeft,ht=e.onRight,Lt=e.onTop,Et=e.onBottom;const o=u(e)||"default";i.style.cursor=o,a.style.cursor=o,document.body.style.cursor=o,It(),document.dispatchEvent(new Event("hide-spectrogram-hover")),xt=t.clientX,bt=t.clientY,wt=i.offsetWidth,Dt=i.offsetHeight,kt=i.offsetLeft,Pt=i.offsetTop,y?.dragging.disable(),t.preventDefault(),t.stopPropagation()}}),!0),window.addEventListener("mousemove",(t=>{if(!Tt){if(ut)return i.style.left=t.clientX-gt+"px",i.style.top=t.clientY-ft+"px",void t.stopPropagation();if(yt){const e=t.clientX-xt,o=t.clientY-bt;a.style.cursor=i.style.cursor,document.body.style.cursor=i.style.cursor,It(),document.dispatchEvent(new Event("hide-spectrogram-hover")),ht&&(g=Math.max(200,wt+e),i.style.width=`${g}px`),Et&&(f=Math.max(200,Dt+o),i.style.height=`${f}px`),vt&&(g=Math.max(200,wt-e),i.style.width=`${g}px`,i.style.left=`${kt+e}px`),Lt&&(f=Math.max(200,Dt-o),i.style.height=`${f}px`,i.style.top=`${Pt+o}px`),t.stopPropagation()}}}),!0),window.addEventListener("mouseup",(t=>{Tt||(ut&&(ut=!1,y?.dragging.enable(),$t(),t.stopPropagation()),yt&&(yt=!1,y?.dragging.enable(),localStorage.setItem("mapPopupWidth",g),localStorage.setItem("mapPopupHeight",f),y?.invalidateSize(),document.body.style.cursor="",i.style.cursor="",a.style.cursor="",$t(),Y(),t.stopPropagation()))}),!0),n.addEventListener("click",pt),p?.addEventListener("click",mt),d&&d.addEventListener("click",pt),window.addEventListener("resize",(()=>{Tt&&(i.style.width=window.innerWidth-2+"px",i.style.height=window.innerHeight-2+"px",y?.invalidateSize())})),document.addEventListener("file-loaded",dt),document.addEventListener("file-list-cleared",(()=>J())),document.addEventListener("file-list-changed",(()=>J())),document.addEventListener("file-icon-toggled",(()=>J()))}export async function importKmlFile(t){importKmlFileFn&&t&&await importKmlFileFn(t)}