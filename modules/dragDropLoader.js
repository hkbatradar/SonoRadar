import{extractGuanoMetadata}from"./guanoReader.js";import{addFilesToList}from"./fileState.js";export function initDragDropLoader({targetElementId:e,wavesurfer:t,spectrogramHeight:a,colorMap:n,onPluginReplaced:r,onFileLoaded:o,onBeforeLoad:i,onAfterLoad:s}){const l=document.getElementById(e),d=document.getElementById("drop-overlay"),f=document.getElementById("fileNameText"),c=document.getElementById("guano-output"),m=document.getElementById("spectrogram-settings");let u=null;function p(){d.style.display="none"}async function y(e){const a=Array.from(e).filter((e=>"audio/wav"===e.type||e.name.endsWith(".wav")));if(0===a.length)return void alert("Only .wav files are supported.");const n=a.sort(((e,t)=>e.name.localeCompare(t.name)));addFilesToList(n,0),await async function(e){if(!e)return;"function"==typeof i&&i(),"function"==typeof o&&o(e),f&&(f.textContent=e.name);try{const t=await extractGuanoMetadata(e);c.textContent=t||"(No GUANO metadata found)"}catch(e){c.textContent="(Error reading GUANO metadata)"}const a=URL.createObjectURL(e);u&&URL.revokeObjectURL(u),u=a,await t.load(a),"function"==typeof r&&r();const n=t?.options?.sampleRate||256e3;m&&(m.textContent=`Sampling rate: ${n/1e3}kHz, FFT size: 1024, Overlap size: Auto, Hanning window`),"function"==typeof s&&s()}(n[0])}l.addEventListener("dragover",(e=>{e.preventDefault(),e.dataTransfer.dropEffect="move",d.style.display="flex"})),l.addEventListener("dragleave",(e=>{e.preventDefault(),p()})),l.addEventListener("drop",(async e=>{e.preventDefault(),p();y(await async function(e){if(!e.items)return Array.from(e.files);const t=async e=>{if(e.isFile)return new Promise((t=>{e.file((e=>t([e])),(()=>t([])))}));if(e.isDirectory){const a=e.createReader(),n=[],r=()=>new Promise((e=>{a.readEntries((async a=>{if(a.length)n.push(...a),e(await r());else{const a=await Promise.all(n.map(t));e(a.flat())}}),(()=>e([])))}));return r()}return[]},a=Array.from(e.items).map((e=>e.webkitGetAsEntry&&e.webkitGetAsEntry())).filter(Boolean);return a.length?(await Promise.all(a.map(t))).flat():Array.from(e.files)}(e.dataTransfer))}))}