import{getCurrentIndex,getFileMetadata,getFileList,getFileIconState}from"./fileState.js";let importKmlFileFn=null;export function initMapPopup({buttonId:t="mapBtn",popupId:e="mapPopup",mapId:o="map"}={}){const n=document.getElementById(t),a=document.getElementById(e),i=document.getElementById(o),l=a.querySelector(".popup-drag-bar"),r=a.querySelector(".popup-close-btn");if(!n||!a||!i)return;i.style.cursor="default";function s(t,e){const o=a.getBoundingClientRect(),n=t-o.left,i=e-o.top,l=i>=-5&&i<=o.height+5,r=n>=-5&&n<=o.width+5;return{onLeft:Math.abs(n-0)<=5&&l,onRight:Math.abs(n-o.width)<=5&&l,onTop:Math.abs(i-0)<=5&&r,onBottom:Math.abs(i-o.height)<=5&&r}}function c(t){const{onLeft:e,onRight:o,onTop:n,onBottom:a}=t;let i="";return e&&n||o&&a?i="nwse-resize":o&&n||e&&a?i="nesw-resize":e||o?i="ew-resize":(n||a)&&(i="ns-resize"),i}let d=parseInt(localStorage.getItem("mapPopupWidth"),10),p=parseInt(localStorage.getItem("mapPopupHeight"),10);(isNaN(d)||d<=0)&&(d=500),(isNaN(p)||p<=0)&&(p=500),a.style.width=`${d}px`,a.style.height=`${p}px`;let u=null,m=[],g=[],f=null,y=[],h=null,v=null,x=null,b=null,E=!1,w=[],k=null,T=!1,C=null,D=null,F=!1,S=null,I=null;const N=i.querySelector(".coord-scale-wrapper"),$=i.querySelector("#coord-display"),z=i.querySelector("#no-coord-message"),M=i.querySelector("#copy-coord-message");let B=null,A=null,H=!1;const P=document.createElement("input");P.type="file",P.accept=".kml",P.style.display="none",a.appendChild(P);const R=document.getElementById("map-drop-overlay");let G=0;function K(){i.style.cursor=H?"grabbing":E?"text":"default"}function O(){R&&(R.style.display="none",R.style.pointerEvents="none"),u?.dragging.enable()}function U(){z&&(z.style.display="none")}function X(t,e){if(u=L.map(i).setView([t,e],13),u.on("dragstart",(()=>{H=!0,K()})),u.on("dragend",(()=>{H=!1,K()})),K(),A=L.control.scale({position:"bottomleft",metric:!0,imperial:!1}).addTo(u),N){const t=A.getContainer();t.style.position="static",N.appendChild(t)}function o(t){if(!$)return;const{lat:e,lng:o}=t;$.textContent=`${e.toFixed(4)} ${o.toFixed(4)}`}u.on("mousemove",(t=>o(t.latlng))),u.on("move",(()=>o(u.getCenter()))),o(u.getCenter()),u.on("contextmenu",(t=>{const{lat:e,lng:o}=t.latlng,n=`${e.toFixed(6)}\t${o.toFixed(6)}`;navigator.clipboard?.writeText(n).catch((()=>{})),M&&(M.style.display="flex",clearTimeout(B),B=setTimeout((()=>{M.style.display="none"}),3e3))}));const n={attribution:"&copy; CARTO"},a={attribution:"&copy; Google"},l=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(u),r=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; Esri"}),s=L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",n),c=L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",n),d=L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",a),p=L.tileLayer("https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",a),m=L.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",a),g=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/imagery/wgs84/{z}/{x}/{y}.png",{attribution:"&copy; HKSAR Government",minZoom:0,maxZoom:19}),y=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/basemap/wgs84/{z}/{x}/{y}.png",{attribution:"&copy; HKSAR Government",maxZoom:20,minZoom:10}),E=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/label/hk/tc/wgs84/{z}/{x}/{y}.png",{attribution:!1,maxZoom:20,minZoom:0}),w={OpenStreetMap:l,"Esri Satellite":r,"Carto Light":s,"Carto Dark":c,"Google Streets":d,"Google Satellite":p,"Google Hybrid":m,"HK Vector":L.layerGroup([y,E]),"HK Imagery":L.layerGroup([g,E])};S=L.control.layers(w,null,{position:"topright"}).addTo(u),fetch("https://raw.githubusercontent.com/PanTong55/spectrogram/main/hkgrid.geojson").then((t=>t.json())).then((t=>{I=L.geoJSON(t,{interactive:!1,style:{color:"#3388ff",weight:2,fillColor:"#3388ff",fillOpacity:0}}),S.addOverlay(I,"1km Grid")})),D=(new L.FeatureGroup).addTo(u),C=new L.Control.Draw({position:"topleft",edit:{featureGroup:D},draw:{circlemarker:!1}}),u.on(L.Draw.Event.CREATED,(t=>{D.addLayer(t.layer)}));const k=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-route-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Route",e.innerHTML='<i class="fa-solid fa-route"></i>',f=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",j),t}});u.addControl(new k);const T=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-import-kml-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Import KML",e.innerHTML='<i class="fa-solid fa-file-import"></i>',h=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",(()=>{P.value="",P.click()})),t}});u.addControl(new T);const F=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-clear-kml-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Clear KML",e.innerHTML='<i class="fa-solid fa-trash"></i>',v=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",W),t}});u.addControl(new F);const z=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-text-toggle-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Text",e.innerHTML='<i class="fa-solid fa-font"></i>',b=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",tt),t}});u.addControl(new z);const R=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-draw-toggle-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Draw",e.innerHTML='<i class="fa-solid fa-pen-to-square"></i>',x=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",V),t}});u.addControl(new R)}function Y(){if(!u)return;m.forEach((t=>t.remove())),m=[];const t=getFileList(),e=getCurrentIndex(),o={};function n(t){if(!t)return"";return`${(t.date||"").replace(/\D/g,"")}${t.time||""}`}t.forEach(((t,e)=>{const n=getFileMetadata(e),a=parseFloat(n.latitude),i=parseFloat(n.longitude);if(isNaN(a)||isNaN(i))return;const l=`${a.toFixed(6)},${i.toFixed(6)}`;o[l]||(o[l]=[]),o[l].push({file:t,idx:e,meta:n,lat:a,lon:i})})),Object.values(o).forEach((t=>{t.sort(((t,e)=>n(t.meta).localeCompare(n(e.meta))));const o=t[0],{lat:a,lon:i}=o,l=t.some((t=>t.idx===e)),r=t.some((t=>getFileIconState(t.idx).trash));let s=l?"map-marker-current":"map-marker-other";!l&&r&&(s="map-marker-trash");const c=L.divIcon({html:'<i class="fa-solid fa-location-dot"></i>',className:s,iconSize:[28,28],iconAnchor:[14,28]}),d=t.map((t=>t.file.name.replace(/\.wav$/i,""))),p=d.length<=5?d.join("<br>"):`${d[0]}<br>â‹®<br>${d[d.length-1]}`,g=l?1e3:0,f=L.marker([a,i],{icon:c,zIndexOffset:g});f.on("click",(()=>{document.dispatchEvent(new CustomEvent("map-file-selected",{detail:{index:o.idx}}))})),f.bindTooltip(p,{direction:"top",offset:[-3,-32],className:"map-tooltip"}),f.addTo(u),m.push(f)}))}function q(){g.forEach((t=>t.remove())),g=[],f?.classList.remove("active")}function W(){y.forEach((t=>t.remove())),y=[]}async function Z(t){if(!t)return;const e=function(t){const e=(new DOMParser).parseFromString(t,"text/xml"),o=[],n=e.getElementsByTagName("LineString");for(let t=0;t<n.length;t++){const e=n[t].getElementsByTagName("coordinates")[0];if(!e)continue;const a=e.textContent.trim().split(/\s+/).map((t=>{const[e,o]=t.split(",").map(Number);return isNaN(o)||isNaN(e)?null:[o,e]})).filter(Boolean);a.length>1&&o.push(a)}return o}(await t.text());W();const o=[];e.forEach((t=>{const e=L.polyline(t,{color:"deeppink",weight:2,opacity:.8}).addTo(u);y.push(e),o.push(...t)})),o.length>0&&(u.fitBounds(o),ot())}function j(){g.length>0?q():(!function(){if(!u)return;q();const t=getFileList(),e=[];t.forEach(((t,o)=>{const n=getFileMetadata(o),a=parseFloat(n.latitude),i=parseFloat(n.longitude),l=`${(n.date||"").replace(/\D/g,"")}${n.time||""}`;isNaN(a)||isNaN(i)||!l||e.push({lat:a,lon:i,ts:l})})),e.sort(((t,e)=>t.ts.localeCompare(e.ts)));let o=[],n=null;e.forEach((t=>{n&&u.distance([n.lat,n.lon],[t.lat,t.lon])>=1e3&&(o.length>1&&g.push(L.polyline(o,{color:"black",weight:2,opacity:.8}).addTo(u)),o=[]),o.push([t.lat,t.lon]),n=t})),o.length>1&&g.push(L.polyline(o,{color:"black",weight:2,opacity:.8}).addTo(u))}(),f?.classList.add("active"))}function V(){if(!C)return;!F&&E&&tt(),F?(u.removeControl(C),x?.classList.remove("active"),F=!1):(C.addTo(u),x?.classList.add("active"),F=!0)}function _(t,e=!1){const o=e?' title="Left click to edit\nRight click to delete"':"";return L.divIcon({className:"map-text-icon",html:`<span class="map-text-label"${o}>${n=t,n.replace(/[&<>"]/g,(t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[t])))}</span>`,iconSize:null,iconAnchor:[0,0],popupAnchor:[0,0]});var n}function J(t){if(!u||k)return;const e=t.getLatLng(),o=u.latLngToContainerPoint(e),n=document.createElement("textarea");n.value=t.text||"",n.className="map-text-input",n.rows=1,n.style.left=`${o.x}px`,n.style.top=`${o.y}px`,u.getContainer().appendChild(n),k=n,u.dragging.disable(),n.focus();const a=()=>{n.style.height="auto",n.style.height=`${n.scrollHeight}px`};a(),n.addEventListener("input",a);const i=()=>{if(!k)return;const e=n.value.trim();u.getContainer().removeChild(n),k=null,u.dragging.enable(),e?(t.text=e,t.setIcon(_(e,E))):(u.removeLayer(t),w=w.filter((e=>e!==t)))};n.addEventListener("keydown",(t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),i())})),n.addEventListener("pointerdown",(t=>t.stopPropagation())),n.addEventListener("blur",(()=>{T=!0,setTimeout((()=>{document.activeElement!==n&&i()}))}))}function Q(t){if(T)return void(T=!1);if(k)return;const e=function(t,e){const o=L.marker(t,{icon:_(e,E),draggable:E});return o.text=e,o.on("dblclick",(()=>{E&&J(o)})),o.on("click",(t=>{E&&!k&&(t.originalEvent.stopPropagation(),J(o))})),o.on("contextmenu",(()=>{E&&!k&&(u.removeLayer(o),w=w.filter((t=>t!==o)))})),o}(t.latlng,"");e.addTo(u),w.push(e),J(e)}function tt(){const t=!E;t&&F&&V(),E=t,b?.classList.toggle("active",E),E?u.on("click",Q):(u.off("click",Q),k&&k.blur()),w.forEach((t=>{E?t.dragging.enable():t.dragging.disable();const e=t.text||"";t.setIcon(_(e,E))})),K()}i.addEventListener("dragenter",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),G++,R&&(R.style.display="flex",R.style.pointerEvents="auto"),u?.dragging.disable())})),i.addEventListener("dragover",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),t.dataTransfer.dropEffect="copy")})),i.addEventListener("dragleave",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),G--,G<=0&&O())})),i.addEventListener("drop",(async t=>{t.preventDefault(),G=0,O();const e=Array.from(t.dataTransfer.files).find((t=>t.name.endsWith(".kml")));e&&await Z(e)})),importKmlFileFn=Z,P.addEventListener("change",(async()=>{const t=P.files[0];t&&await Z(t)}));const et=13;function ot(){const t=getCurrentIndex();if(t<0)return Y(),navigator.geolocation&&navigator.geolocation.getCurrentPosition((t=>{const{latitude:e,longitude:o}=t.coords,n=L.divIcon({html:'<i class="fa-solid fa-location-crosshairs"></i>',className:"map-marker-device",iconSize:[28,28],iconAnchor:[14,28]});u?u.setView([e,o]):X(e,o);const a=L.marker([e,o],{icon:n,zIndexOffset:1001});a.addTo(u),m.push(a)})),void U();const e=getFileMetadata(t),o=parseFloat(e.latitude),n=parseFloat(e.longitude);if(isNaN(o)||isNaN(n))return Y(),void(z&&(z.style.display="flex"));U(),u?"block"!==a.style.display?u.setView([o,n],et):u.setView([o,n]):X(o,n),Y()}function nt(){"block"===a.style.display?(a.style.display="none",document.body.classList.remove("map-open"),E&&tt()):(a.style.display="block",document.body.classList.add("map-open"),a.style.width=`${d}px`,a.style.height=`${p}px`,u&&u.invalidateSize(),ot(),K())}let at=!1,it=0,lt=0,rt=!1,st=!1,ct=!1,dt=!1,pt=!1,ut=0,mt=0,gt=0,ft=0,yt=0,ht=0;l&&l.addEventListener("mousedown",(t=>{at=!0,it=t.clientX-a.offsetLeft,lt=t.clientY-a.offsetTop,u?.dragging.disable(),t.preventDefault(),t.stopPropagation()})),a.addEventListener("mousemove",(t=>{if(at||rt)return;const e=c(s(t.clientX,t.clientY))||"default";a.style.cursor=e})),a.addEventListener("mousedown",(t=>{if(t.target===l||l.contains(t.target))return;const e=s(t.clientX,t.clientY);if(e.onLeft||e.onRight||e.onTop||e.onBottom){rt=!0,st=e.onLeft,ct=e.onRight,dt=e.onTop,pt=e.onBottom;const o=c(e)||"default";a.style.cursor=o,document.body.style.cursor=o,ut=t.clientX,mt=t.clientY,gt=a.offsetWidth,ft=a.offsetHeight,yt=a.offsetLeft,ht=a.offsetTop,u?.dragging.disable(),t.preventDefault(),t.stopPropagation()}})),document.addEventListener("mousemove",(t=>{if(at||rt||"block"!==a.style.display)return;const e=c(s(t.clientX,t.clientY));document.body.style.cursor=e||""})),document.addEventListener("mousedown",(t=>{if(at||rt||"block"!==a.style.display)return;if(t.target===l||l.contains(t.target))return;const e=s(t.clientX,t.clientY);if(e.onLeft||e.onRight||e.onTop||e.onBottom){rt=!0,st=e.onLeft,ct=e.onRight,dt=e.onTop,pt=e.onBottom;const o=c(e)||"default";document.body.style.cursor=o,ut=t.clientX,mt=t.clientY,gt=a.offsetWidth,ft=a.offsetHeight,yt=a.offsetLeft,ht=a.offsetTop,u?.dragging.disable(),t.preventDefault(),t.stopPropagation()}})),window.addEventListener("mousemove",(t=>{if(at)return a.style.left=t.clientX-it+"px",void(a.style.top=t.clientY-lt+"px");if(rt){const e=t.clientX-ut,o=t.clientY-mt;document.body.style.cursor=document.body.style.cursor||a.style.cursor,ct&&(d=Math.max(200,gt+e),a.style.width=`${d}px`),pt&&(p=Math.max(200,ft+o),a.style.height=`${p}px`),st&&(d=Math.max(200,gt-e),a.style.width=`${d}px`,a.style.left=`${yt+e}px`),dt&&(p=Math.max(200,ft-o),a.style.height=`${p}px`,a.style.top=`${ht+o}px`)}})),window.addEventListener("mouseup",(()=>{at&&(at=!1,u?.dragging.enable()),rt&&(rt=!1,u?.dragging.enable(),localStorage.setItem("mapPopupWidth",d),localStorage.setItem("mapPopupHeight",p),u?.invalidateSize(),document.body.style.cursor="",a.style.cursor="")})),n.addEventListener("click",nt),r&&r.addEventListener("click",nt),document.addEventListener("file-loaded",ot),document.addEventListener("file-list-cleared",(()=>Y())),document.addEventListener("file-icon-toggled",(()=>Y()))}export async function importKmlFile(t){importKmlFileFn&&t&&await importKmlFileFn(t)}