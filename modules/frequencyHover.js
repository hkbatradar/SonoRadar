export function initFrequencyHover({viewerId:e,wrapperId:t="viewer-wrapper",hoverLineId:n,hoverLineVId:o,freqLabelId:i,spectrogramHeight:l=800,spectrogramWidth:s=1024,maxFrequency:d=128,minFrequency:c=10,totalDuration:r=1e3,getZoomLevel:a,getDuration:u}){const p=document.getElementById(e),m=document.getElementById(t),h=document.getElementById(n),v=document.getElementById(o),f=document.getElementById(i),g=document.getElementById("fixed-overlay"),x=document.getElementById("zoom-controls"),y=document.getElementById("spectrogram-only"),L=[],E=[];let b=null,w=!0,C=!1;const F=()=>y.scrollWidth>p.clientWidth?0:20,$=5;let T=!1,B=!1,M=!1,Y=!1,X=!1,q=0,I=0,R=null,H=null,k=null,S=!1,z=0,N=null;p.addEventListener("force-hover-enable",(()=>{T=!1,X=!1}));const G=()=>{h.style.display="none",v.style.display="none",f.style.display="none"},W=e=>{if(S=!0,H=e.clientX,k=e.clientY,T||M||X)return void G();const t=p.getBoundingClientRect(),n=e.clientX-t.left,o=e.clientY-t.top,i=F();if(o>p.clientHeight-i)return G(),p.classList.remove("hide-cursor"),void(C=!0);C=!1,p.classList.add("hide-cursor");const s=p.scrollLeft||0,r=(1-o/l)*(d-c)+c,a=(n+s)/y.scrollWidth*u();h.style.top=`${o}px`,h.style.display="block",v.style.left=`${n}px`,v.style.display="block";let m;p.clientWidth-n<120?(f.style.transform="translate(-100%, -50%)",m=n-12+"px"):(f.style.transform="translate(0, -50%)",m=`${n+12}px`),f.style.top=`${o}px`,f.style.left=m,f.style.display="block";const g=Number(r.toFixed(1)).toString();f.textContent=`${g} kHz  ${(1e3*a).toFixed(1)} ms`};p.addEventListener("mousemove",W,{passive:!0}),m.addEventListener("mouseleave",(()=>{S=!1,G()})),p.addEventListener("mouseenter",(()=>{p.classList.add("hide-cursor"),S=!0})),p.addEventListener("mouseleave",(()=>{p.classList.remove("hide-cursor"),S=!1}));const D=(e,t,n)=>Math.min(Math.max(e,t),n);x&&(x.addEventListener("mouseenter",(()=>{T=!0,G()})),x.addEventListener("mouseleave",(()=>{T=!1})));const P=document.getElementById("selection-time-info");function A(e,t,n){const o=p.getBoundingClientRect();if(q=e-o.left+p.scrollLeft,I=t-o.top,I>p.clientHeight-F())return;Y=!0,T=!0,G(),R=document.createElement("div"),R.className="selection-rect",p.appendChild(R);const i="touch"===n?"touchmove":"mousemove",s="touch"===n?"touchend":"mouseup",r=e=>{if(!Y)return;const t=p.getBoundingClientRect(),o="touch"===n?e.touches[0].clientX:e.clientX,i="touch"===n?e.touches[0].clientY:e.clientY;let l=o-t.left+p.scrollLeft,s=i-t.top;l=D(l,0,p.scrollWidth),s=D(s,0,p.clientHeight-F());const d=Math.min(l,q),c=Math.abs(l-q),r=u()*a();!function(e,t){const n=Math.min(e,t),o=Math.max(e,t),i=o-n;P.textContent=`Selection time: ${n.toFixed(1)} - ${o.toFixed(1)} (${i.toFixed(1)}ms)`,P.style.display=""}(q/r*u()*1e3,l/r*u()*1e3);const m=Math.min(s,I),h=Math.abs(s-I);R.style.left=`${d}px`,R.style.top=`${m}px`,R.style.width=`${c}px`,R.style.height=`${h}px`},m=e=>{if(!Y)return;Y=!1,window.removeEventListener(i,r),window.removeEventListener(s,m),P.style.display="none";const t=R.getBoundingClientRect(),o=p.getBoundingClientRect(),h=t.left-o.left+p.scrollLeft,v=t.top-o.top,f=t.width,g=t.height;if(f<=3||g<=3){if(p.removeChild(R),R=null,T=!1,"touch"===n){const t=e.changedTouches?e.changedTouches[0].clientX:e.clientX,n=e.changedTouches?e.changedTouches[0].clientY:e.clientY;W({clientX:t,clientY:n})}else W(e);return}const x=(1-(v+g)/l)*(d-c)+c,y=(1-v/l)*(d-c)+c,L=u()*a(),w=h/L*u(),C=(h+f)/L*u(),F=function(e,t,n,o,i,s,r,m,h,v,f){const g={data:{startTime:v,endTime:f,Flow:s,Fhigh:i},rect:h,tooltip:null,expandBtn:null,closeBtn:null,btnGroup:null,durationLabel:null};1e3*m<=100&&(g.tooltip=V(g,e,t,n));const x=document.createElement("div");x.className="selection-duration",x.textContent=`${(1e3*m).toFixed(1)} ms`,h.appendChild(x),g.durationLabel=x,E.push(g),1e3*m>100&&Z(g);return function(e){const t=e.rect;let n=!1,o=null,i=null;t.addEventListener("mousemove",(e=>{if(Y||n)return;if(X||e.target.closest(".selection-close-btn")||e.target.closest(".selection-expand-btn")||e.target.closest(".selection-fit-btn")||e.target.closest(".selection-btn-group"))return void(t.style.cursor="default");const o=t.getBoundingClientRect(),i=e.clientX-o.left,l=e.clientY-o.top;let s="default";const d=i<$,c=i>o.width-$,r=l<$,a=l>o.height-$;d&&r||c&&a?s="nwse-resize":c&&r||d&&a?s="nesw-resize":d||c?s="ew-resize":(r||a)&&(s="ns-resize"),t.style.cursor=s}),{passive:!0}),t.addEventListener("mousedown",(s=>{if(n)return;if(X||s.target.closest(".selection-close-btn")||s.target.closest(".selection-expand-btn")||s.target.closest(".selection-fit-btn")||s.target.closest(".selection-btn-group"))return;const r=t.getBoundingClientRect(),m=s.clientX-r.left,h=s.clientY-r.top,v=m<$,f=m>r.width-$,g=h<$,x=h>r.height-$;if(o=v?"left":f?"right":null,i=g?"top":x?"bottom":null,!o&&!i)return;n=!0,M=!0,s.preventDefault();const y=t=>{if(!n)return;const s=p.getBoundingClientRect(),r=p.scrollLeft||0;let m=t.clientX-s.left+r,h=t.clientY-s.top;const v=u()*a(),f=d-c;if(m=Math.min(Math.max(m,0),v),h=Math.min(Math.max(h,0),l),"left"===o){let t=m/v*u();t=Math.min(t,e.data.endTime-.001),e.data.startTime=t}if("right"===o){let t=m/v*u();t=Math.max(t,e.data.startTime+.001),e.data.endTime=t}if("top"===i){let t=(1-h/l)*f+c;t=Math.max(t,e.data.Flow+.1),e.data.Fhigh=t}if("bottom"===i){let t=(1-h/l)*f+c;t=Math.min(t,e.data.Fhigh-.1),e.data.Flow=t}K()},L=()=>{n=!1,M=!1,o=null,i=null,window.removeEventListener("mousemove",y),window.removeEventListener("mouseup",L)};window.addEventListener("mousemove",y,{passive:!0}),window.addEventListener("mouseup",L)}))}(g),g.rect.addEventListener("mouseenter",(()=>{b=g})),g.rect.addEventListener("mouseleave",(e=>{const t=e.relatedTarget,n=t&&t.closest&&t.closest(".selection-btn-group");b!==g||n||(b=null)})),g}(h,v,f,0,y,x,0,C-w,R,w,C);if(R=null,T=!1,b=F,null!==H&&null!==k){const e=F.rect.getBoundingClientRect();H>=e.left&&H<=e.right&&k>=e.top&&k<=e.bottom&&(b=F)}};window.addEventListener(i,r,{passive:"touch"!==n}),window.addEventListener(s,m)}function O(e){const t=E.indexOf(e);-1!==t&&(p.removeChild(E[t].rect),E[t].tooltip&&p.removeChild(E[t].tooltip),E.splice(t,1),b===e&&(b=null))}function V(e,t,n,o){const{Flow:i,Fhigh:l,startTime:s,endTime:d}=e.data,c=l-i,r=d-s,a=document.createElement("div");return a.className="draggable-tooltip freq-tooltip",a.style.left=`${t+o+10}px`,a.style.top=`${n}px`,a.innerHTML=`\n      <div><b>F.high:</b> <span class="fhigh">${l.toFixed(1)}</span> kHz</div>\n      <div><b>F.Low:</b> <span class="flow">${i.toFixed(1)}</span> kHz</div>\n      <div><b>Bandwidth:</b> <span class="bandwidth">${c.toFixed(1)}</span> kHz</div>\n      <div><b>Duration:</b> <span class="duration">${(1e3*r).toFixed(1)}</span> ms</div>\n      <div><b>Avg.Slope:</b> <span class="slope">${(c/(1e3*r)).toFixed(1)}</span> kHz/ms</div>\n      <div class="tooltip-close-btn">Ã—</div>\n    `,a.addEventListener("mouseenter",(()=>{B=!0,T=!0,G()})),a.addEventListener("mouseleave",(()=>{B=!1,T=!1})),a.querySelector(".tooltip-close-btn").addEventListener("click",(()=>{O(e),B=!1,T=!1})),p.appendChild(a),function(e){let t,n,o=!1;e.addEventListener("mousedown",(i=>{if(i.target.classList.contains("tooltip-close-btn"))return;o=!0;const l=e.getBoundingClientRect();t=i.clientX-l.left,n=i.clientY-l.top})),window.addEventListener("mousemove",(i=>{if(!o)return;const l=p.getBoundingClientRect(),s=i.clientX-l.left+p.scrollLeft-t,d=i.clientY-l.top-n;e.style.left=`${s}px`,e.style.top=`${d}px`}),{passive:!0}),window.addEventListener("mouseup",(()=>{o=!1}))}(a),requestAnimationFrame((()=>J(e,t,n,o))),a}function Z(e){const t=document.createElement("div");t.className="selection-btn-group";const n=document.createElement("i");n.className="fa-solid fa-xmark selection-close-btn",n.title="Close selection",n.addEventListener("click",(t=>{t.stopPropagation(),O(e),T=!1,X=!1,null!==H&&null!==k&&W({clientX:H,clientY:k})})),n.addEventListener("mousedown",(e=>{e.stopPropagation()})),n.addEventListener("mouseenter",(()=>{T=!0,G()})),n.addEventListener("mouseleave",(()=>{T=!1}));const o=document.createElement("i");o.className="fa-solid fa-arrows-left-right-to-line selection-expand-btn",o.title="Crop and expand this session",o.addEventListener("click",(t=>{t.stopPropagation(),T=!1,X=!1,p.dispatchEvent(new CustomEvent("expand-selection",{detail:{startTime:e.data.startTime,endTime:e.data.endTime}})),null!==H&&null!==k&&setTimeout((()=>{W({clientX:H,clientY:k})}),0)})),o.addEventListener("mouseenter",(()=>{T=!0,G()})),o.addEventListener("mouseleave",(()=>{T=!1}));const i=document.createElement("i");i.className="fa-solid fa-up-right-and-down-left-from-center selection-fit-btn",i.title="Fit to window",i.addEventListener("click",(t=>{t.stopPropagation(),p.dispatchEvent(new CustomEvent("fit-window-selection",{detail:{startTime:e.data.startTime,endTime:e.data.endTime,Flow:e.data.Flow,Fhigh:e.data.Fhigh}})),T=!1,X=!1})),i.addEventListener("mouseenter",(()=>{T=!0,G()})),i.addEventListener("mouseleave",(()=>{T=!1})),t.addEventListener("mouseenter",(()=>{X=!0,null!==H&&null!==k?W({clientX:H,clientY:k}):G(),e.rect.style.cursor="default",b=e})),t.addEventListener("mouseleave",(e=>{X=!1;const t=e.relatedTarget,n=t&&t.closest&&t.closest(".selection-rect"),o=t&&t.closest&&t.closest(".selection-btn-group");n||o||(b=null)})),t.addEventListener("mousedown",(e=>{e.stopPropagation()})),t.appendChild(n),t.appendChild(o),t.appendChild(i),e.rect.appendChild(t),e.btnGroup=t,e.closeBtn=n,e.expandBtn=o,e.fitBtn=i,j(e)}function j(e){if(!e.btnGroup)return;const t=e.btnGroup;t.style.left="",t.style.right="-35px";const n=t.getBoundingClientRect(),o=y.getBoundingClientRect();n.right>o.right&&(t.style.right="auto",t.style.left="-35px")}function J(e,t,n,o){if(!e.tooltip)return;const i=e.tooltip,l=i.offsetWidth;let s=t+o+10;s+l>(p.scrollLeft||0)+p.clientWidth&&(s=t-l-10),i.style.left=`${s}px`,i.style.top=`${n}px`}function K(){const e=u()*a(),t=d-c;E.forEach((n=>{const{startTime:o,endTime:i,Flow:s,Fhigh:d}=n.data,r=o/u()*e,a=(i-o)/u()*e,m=(1-(d-c)/t)*l,h=(d-s)/t*l;n.rect.style.left=`${r}px`,n.rect.style.top=`${m}px`,n.rect.style.width=`${a}px`,n.rect.style.height=`${h}px`;1e3*(i-o)<=100?(n.btnGroup&&(n.btnGroup.style.display="none"),n.tooltip||(n.tooltip=V(n,r,m,a))):(n.tooltip&&(p.removeChild(n.tooltip),n.tooltip=null),n.btnGroup?n.btnGroup.style.display="":Z(n)),J(n,r,m,a),function(e,t,n,o,i){const{data:l,tooltip:s}=e,d=l.Flow,c=l.Fhigh,r=c-d,a=l.endTime-l.startTime;s?(e.durationLabel&&(e.durationLabel.textContent=`${(1e3*a).toFixed(1)} ms`),s.querySelector(".fhigh").textContent=c.toFixed(1),s.querySelector(".flow").textContent=d.toFixed(1),s.querySelector(".bandwidth").textContent=r.toFixed(1),s.querySelector(".duration").textContent=(1e3*a).toFixed(1),s.querySelector(".slope").textContent=(r/(1e3*a)).toFixed(1)):e.durationLabel&&(e.durationLabel.textContent=`${(1e3*a).toFixed(1)} ms`)}(n),j(n)}))}return p.addEventListener("mousedown",(e=>{B||M||0===e.button&&A(e.clientX,e.clientY,"mouse")})),p.addEventListener("touchstart",(e=>{if(B||M)return;if(1!==e.touches.length)return;const t=Date.now();t-z<300?(clearTimeout(N),e.preventDefault(),A(e.touches[0].clientX,e.touches[0].clientY,"touch")):(z=t,N=setTimeout((()=>{z=0}),300))})),p.addEventListener("contextmenu",(e=>{if(!w||C||B)return;if(e.target.closest(".selection-expand-btn")||e.target.closest(".selection-fit-btn")||e.target.closest(".selection-btn-group"))return;e.preventDefault();const t=g.getBoundingClientRect(),n=(1-(e.clientY-t.top)/l)*(d-c)+c,o=L.findIndex((e=>Math.abs(e.freq-n)<1));if(-1!==o)g.removeChild(L[o].div),L.splice(o,1);else{if(L.length>=5)return;const e=Math.round((1-(n-c)/(d-c))*l),t=document.createElement("div");t.className="persistent-line",t.style.top=`${e}px`,g.appendChild(t),L.push({freq:n,div:t})}})),{updateSelections:K,clearSelections:function(){E.forEach((e=>{p.removeChild(e.rect),e.tooltip&&p.removeChild(e.tooltip)})),E.length=0,b=null},setFrequencyRange:(e,t)=>{c=e,d=t,K()},hideHover:G,refreshHover:()=>{null!==H&&null!==k&&S&&W({clientX:H,clientY:k})},setPersistentLinesEnabled:e=>{w=e},getHoveredSelection:()=>E.includes(b)?b:null}}