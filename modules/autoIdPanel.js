import{initDropdown}from"./dropdown.js";import{autoIdHK}from"./autoid_HK.js";export function initAutoIdPanel({buttonId:e="autoIdBtn",panelId:t="auto-id-panel",viewerId:n="viewer-container",containerId:l="spectrogram-only",overlayId:i="fixed-overlay",spectrogramHeight:s=800,getDuration:a=(()=>0),getFreqRange:o=(()=>({min:0,max:0})),hideHover:r=(()=>{}),refreshHover:d=(()=>{})}={}){const c=document.getElementById(e),u=document.getElementById(t),m=u.querySelector(".popup-drag-bar"),f=u.querySelector(".popup-close-btn"),y=document.getElementById(n),h=document.getElementById(l),p=document.getElementById(i),g="http://www.w3.org/2000/svg",v=document.createElementNS(g,"svg");v.id="autoid-lines",p.appendChild(v);const E=document.getElementById("layout");E&&u&&u.parentElement!==E&&E.appendChild(u);const F=document.getElementById("autoIdTabResetBtn"),k=document.getElementById("autoid-tabs"),w=[],x=Array.from({length:8},(()=>({callType:3,harmonic:0,result:null,showValidation:!1,inputs:{start:"",end:"",high:"",low:"",knee:"",heel:"",cfStart:"",cfEnd:""},startTime:null,endTime:null,markers:{start:{el:null,freq:null,time:null},end:{el:null,freq:null,time:null},high:{el:null,freq:null,time:null},low:{el:null,freq:null,time:null},knee:{el:null,freq:null,time:null},heel:{el:null,freq:null,time:null},cfStart:{el:null,freq:null,time:null},cfEnd:{el:null,freq:null,time:null}},line:null})));let I=0;if(!c||!u||!y)return;function L(){const e="block"===u.style.display;u.style.display=e?"none":"block",document.body.classList.toggle("autoid-open",!e),document.dispatchEvent(new Event(e?"autoid-close":"autoid-open"))}c.addEventListener("click",L),f?.addEventListener("click",L);let q=!1,b=0,C=0;function B(e){q&&(u.style.left=e.clientX-b+"px",u.style.top=e.clientY-C+"px")}function N(){q=!1,document.removeEventListener("mousemove",B),r()}m?.addEventListener("mousedown",(e=>{q=!0,b=e.clientX-u.offsetLeft,C=e.clientY-u.offsetTop,r(),document.addEventListener("mousemove",B,{passive:!0}),document.addEventListener("mouseup",N,{once:!0}),e.preventDefault()})),F?.addEventListener("click",fe);const M=initDropdown("callTypeInput",["CF-FM","FM-CF-FM","FM","FM-QCF","QCF"]),T=initDropdown("harmonicInput",["0","1","2","3"]);if(T.onChange=function(e,t){x[I].harmonic=t,Z||te()},k)for(let e=0;e<8;e++){const t=document.createElement("button");t.textContent=`${e+1}`,t.className="tab-btn",0===e&&t.classList.add("active"),t.addEventListener("click",(()=>le(e))),k.appendChild(t),w.push(t)}const S={start:document.getElementById("startFreqInput"),end:document.getElementById("endFreqInput"),high:document.getElementById("highFreqInput"),low:document.getElementById("lowFreqInput"),knee:document.getElementById("kneeFreqInput"),heel:document.getElementById("heelFreqInput"),cfStart:document.getElementById("cfStartFreqInput"),cfEnd:document.getElementById("cfEndFreqInput")},$={start:document.getElementById("startFreqRow"),end:document.getElementById("endFreqRow"),high:document.getElementById("highFreqRow"),low:document.getElementById("lowFreqRow"),knee:document.getElementById("kneeFreqRow"),heel:document.getElementById("heelFreqRow"),cfStart:document.getElementById("cfStartFreqRow"),cfEnd:document.getElementById("cfEndFreqRow")},j=document.getElementById("bandwidthVal"),O=document.getElementById("durationVal"),R=document.getElementById("pulseIdBtn"),H=document.getElementById("sequenceIdBtn"),A=document.getElementById("autoIdResult"),Q=document.getElementById("bandwidth-warning"),V=document.getElementById("freq-order-warning"),D=document.getElementById("knee-order-warning"),W=document.getElementById("time-order-warning");const K={start:"#e74c3c",end:"#004cff",high:"#3498db",low:"#9b59b6",knee:"#f39c12",heel:"#16a085",cfStart:"#e67e22",cfEnd:"#1abc9c"},X={start:"Start freq.",end:"End freq.",high:"High freq.",low:"Low freq.",knee:"Knee freq.",heel:"Heel freq.",cfStart:"CF start",cfEnd:"CF end"};let Y=x[I].markers,P=null,_=null,z=null,G=null,J=null,U=!0,Z=!1;function ee(){const e=x[I].result;A&&(e?A.innerHTML=function(e){return e.split(" / ").map((e=>{if(e.endsWith("sp.")){return`<i>${e.replace(" sp.","")}</i> sp.`}return"TBC"===e||"-"===e||"No species matched"===e?e:`<i>${e}</i>`})).join(" / ")}(e):A.textContent="-")}function te(){null!=x[I].result&&(x[I].result=null,ee())}function ne(e){const t=x[e];Y=t.markers,Z=!0,M.select(t.callType),T.select(t.harmonic),Z=!1,Object.keys(S).forEach((e=>{S[e].value=t.inputs[e]||"",null!=t.markers[e].time?S[e].dataset.time=t.markers[e].time:delete S[e].dataset.time})),_=t.startTime,z=t.endTime,re(),de(),ee(),ye()}function le(e){e!==I&&(!function(){const e=x[I];e.callType=M.selectedIndex,e.harmonic=T.selectedIndex,e.startTime=_,e.endTime=z,Object.keys(S).forEach((t=>{e.inputs[t]=S[t].value}))}(),w[I]&&w[I].classList.remove("active"),I=e,w[I]&&w[I].classList.add("active"),ne(e))}function ie(e){U=e,document.body.classList.toggle("markers-disabled",!e)}function se(e){const t=S[e];t&&(t.value="",delete t.dataset.time,t.classList.remove("active-get"),t.classList.remove("invalid"),t.classList.remove("warning"),Y[e].freq=null,Y[e].time=null,Y[e].el&&(Y[e].el.style.display="none"),"start"===e&&(_=null),"end"===e&&(z=null),x[I].inputs[e]="",x[I].markers[e].freq=null,x[I].markers[e].time=null,x[I].startTime=_,x[I].endTime=z,re(),de(),te(),ye())}ie(!0),Object.entries(S).forEach((([e,t])=>{t&&(t.dataset.key=e,t.readOnly=!0,t.addEventListener("click",(()=>{if(P===t)return t.classList.remove("active-get"),P=null,void ie(!0);P&&P.classList.remove("active-get"),P=t,t.classList.add("active-get"),ie(!1)})))}));const ae={};function oe(e,t){const n=$[e];if(!n)return;n.style.display=t?"flex":"none",S[e]&&(S[e].disabled=!t);const l=ae[e];l&&(l.disabled=!t),t||se(e),ye()}function re(){const e=M.items[M.selectedIndex],t=parseFloat(S.high.value),n=parseFloat(S.low.value),l=parseFloat(S.knee.value),i=parseFloat(S.cfStart.value),s=parseFloat(S.end.value);let a=null;["FM-CF-FM","CF-FM"].includes(e)?isNaN(i)||isNaN(s)?j.textContent="-":(a=i-s,j.textContent=a.toFixed(1)):isNaN(t)||isNaN(n)?j.textContent="-":(a=t-n,j.textContent=a.toFixed(1)),null!=_&&null!=z?O.textContent=(1e3*(z-_)).toFixed(1):null!=Y.high.time&&null!=Y.low.time?O.textContent=(1e3*(Y.low.time-Y.high.time)).toFixed(1):O.textContent="-",function(e,t,n,l,i,s){const a="QCF"===M.items[M.selectedIndex]&&null!=l&&l>5,o=!isNaN(e)&&!isNaN(t)&&t>e,r=!isNaN(n)&&!isNaN(t)&&n<t,d=null!=i&&null!=s&&s<i,c=a||o||r||d;S.high&&S.high.classList.toggle("warning",a||o),S.low&&S.low.classList.toggle("warning",a||o||r),S.knee&&S.knee.classList.toggle("warning",r),S.start&&S.start.classList.toggle("warning",d),S.end&&S.end.classList.toggle("warning",d),Q&&(Q.style.display=a?"flex":"none"),V&&(V.style.display=o?"flex":"none"),D&&(D.style.display=r?"flex":"none"),W&&(W.style.display=d?"flex":"none"),R&&(R.disabled=c),H&&(H.disabled=c)}(t,n,l,a,_,z)}function de(){const{min:e,max:t}=o(),n=h.scrollWidth;x.forEach(((l,i)=>{Object.entries(l.markers).forEach((([l,o])=>{if(o.el||(o.el=function(e,t){const n=document.createElement("i");n.className=`fa-solid fa-xmark freq-marker marker-${e}`,n.style.color=K[e],n.dataset.key=e,n.dataset.tab=t;const l=X[e]||e;return n.dataset.title=l,n.setAttribute("aria-label",l),n.addEventListener("mouseenter",r),n.addEventListener("mouseleave",d),n.addEventListener("mousedown",(t=>{U&&(t.stopPropagation(),r(),y.classList.add("hide-cursor"),n.classList.add("hide-cursor"),G=e,J=n,document.addEventListener("mousemove",ue,{passive:!0}),document.addEventListener("mouseup",me,{once:!0}))})),n.addEventListener("click",(e=>e.stopPropagation())),p.appendChild(n),n}(l,i)),null==o.freq||null==o.time)return void(o.el.style.display="none");const c=o.time/a()*n-y.scrollLeft,u=(1-(o.freq-e)/(t-e))*s;o.el.style.left=`${c}px`,o.el.style.top=`${u}px`,o.el.style.display="block",o.el.style.pointerEvents=i===I?"auto":"none",o.el.style.opacity=i===I?"1":"0.5",o.el.dataset.freq=o.freq,o.el.dataset.time=o.time}))})),ce()}function ce(){const{min:e,max:t}=o(),n=h.scrollWidth;x.forEach(((l,i)=>{l.line||(l.line=document.createElementNS(g,"path"),l.line.dataset.tab=i,v.appendChild(l.line));const o=Object.entries(l.markers).filter((([e,t])=>null!=t.freq&&null!=t.time)).sort(((e,t)=>e[1].time-t[1].time)).map((([l,i])=>({x:i.time/a()*n-y.scrollLeft,y:(1-(i.freq-e)/(t-e))*s,key:l})));if(o.length<2)return l.line.setAttribute("d",""),void(l.line.style.display="none");const r=function(e,t=.5){if(e.length<2)return"";let n=`M ${e[0].x} ${e[0].y}`;const l=10;for(let i=0;i<e.length-1;i++){const s=e[i-1]||e[i],a=e[i],o=e[i+1],r=e[i+2]||o,d=i===e.length-2,c=Math.abs(a.y-o.y);if("cfStart"===a.key&&"cfEnd"===o.key)n+=` L ${o.x} ${o.y}`;else if(d&&c<5)n+=` L ${a.x} ${o.y} L ${o.x} ${o.y}`;else{const e=a.x+(o.x-s.x)*t/6,i=a.y+(o.y-s.y)*t/6;let d=o.x-(r.x-a.x)*t/6,c=o.y-(r.y-a.y)*t/6;if("high"===a.key&&"knee"===o.key){const e=Math.hypot(o.x-a.x,o.y-a.y),n=Math.hypot(r.x-o.x,r.y-o.y),l=e?1+n/e*5:1;d=o.x-(r.x-a.x)*t/6*l,c=o.y-(r.y-a.y)*t/6*l}if("cfStart"!==o.key&&"end"!==o.key){const e=Math.abs(a.y-o.y),t=Math.min(l,.6*e);c=Math.min(c,o.y+t),d=Math.min(d,o.x)}n+=` C ${e} ${i} ${d} ${c} ${o.x} ${o.y}`}}return n}(o);l.line.setAttribute("stroke-linejoin","round"),l.line.setAttribute("d",r),l.line.style.display="block",l.line.style.opacity=i===I?"1":"0.5"}))}function ue(e){if(!G||!U)return;const t=y.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,i=y.scrollLeft||0,{min:r,max:d}=o(),c=(1-l/s)*(d-r)+r,u=(n+i)/h.scrollWidth*a(),m=S[G];m&&(m.value=c.toFixed(1),m.dataset.time=u,m===S.start&&(_=u),m===S.end&&(z=u)),x[I].startTime=_,x[I].endTime=z,Y[G].freq=c,Y[G].time=u,re(),de()}function me(){G=null,J&&(J.classList.remove("hide-cursor"),J=null),document.removeEventListener("mousemove",ue),y.classList.remove("hide-cursor"),d(),ye(),te()}function fe(){var e;x[I].showValidation=!1,(e=x[I]).callType=3,e.harmonic=0,e.result=null,e.showValidation=!1,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")})),e.line&&(e.line.setAttribute("d",""),e.line.style.display="none"),M.select(3),T.select(0),Object.values(S).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"),e.classList.remove("invalid"),e.classList.remove("warning"))})),j.textContent="-",O.textContent="-",_=null,z=null,P=null,x[I].result=null,ie(!0),ne(I)}function ye(e=!1){const t=x[I];e&&(t.showValidation=!0);const n=t.showValidation,l={"CF-FM":["cfStart","cfEnd"],"FM-CF-FM":["cfStart","cfEnd"],FM:["high","low"],"FM-QCF":["high","low","knee"],QCF:["high","low"]}[M.items[M.selectedIndex]]||[];let i=!0;return Object.entries(S).forEach((([e,t])=>{if(t)if(l.includes(e)){const e=parseFloat(t.value),l=!isNaN(e);n?t.classList.toggle("invalid",!l):t.classList.remove("invalid"),l||(i=!1)}else t.classList.remove("invalid")})),i}function he(){if(!ye(!0))return void(A&&(A.textContent="-"));const e=M.items[M.selectedIndex],t=parseFloat(S.high.value),n=parseFloat(S.low.value),l=parseFloat(S.knee.value),i=parseFloat(S.heel.value),s=parseFloat(S.start.value),a=parseFloat(S.end.value),o=parseFloat(S.cfStart.value),r=parseFloat(S.cfEnd.value);let d=null;null!=_&&null!=z?d=1e3*(z-_):null!=Y.high.time&&null!=Y.low.time&&(d=1e3*(Y.low.time-Y.high.time));let c=null;["FM-CF-FM","CF-FM"].includes(e)?isNaN(o)||isNaN(a)||(c=o-a):isNaN(t)||isNaN(n)||(c=t-n);const u=null!=Y.knee.time&&null!=Y.low.time?1e3*(Y.knee.time-Y.low.time):null,m=isNaN(l)||isNaN(n)?null:l-n,f=isNaN(i)||isNaN(n)?null:i-n,y=isNaN(l)||isNaN(i)?null:l-i,h=parseInt(T.items[T.selectedIndex],10),p=autoIdHK({callType:e,harmonic:h,highestFreq:t,lowestFreq:n,kneeFreq:l,heelFreq:i,startFreq:s,endFreq:a,cfStart:o,cfEnd:r,duration:d,bandwidth:c,kneeLowTime:u,kneeLowBandwidth:m,heelLowBandwidth:f,kneeHeelBandwidth:y});x[I].result=p,ee()}return u.querySelectorAll(".autoid-marker[data-key]").forEach((e=>{const t=e.dataset.key;ae[t]=e,e.addEventListener("click",(e=>{e.preventDefault(),se(t)}))})),M.onChange=function(e,t){const n=["CF-FM","FM-CF-FM"].includes(e),l=["CF-FM","FM-CF-FM","QCF"].includes(e),i=["QCF","FM-QCF","FM"].includes(e);oe("high",!n),oe("low",!n),oe("knee",!l),oe("heel",!l),oe("cfStart",!i),oe("cfEnd",!i),x[I].callType=t,Z||te(),re(),ce(),ye()},T.select(0),M.select(3),ne(0),y.addEventListener("click",(e=>{if(!P)return;const t=y.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,i=y.scrollLeft||0,{min:r,max:d}=o(),c=(1-l/s)*(d-r)+r,u=(n+i)/h.scrollWidth*a(),m=P.dataset.key;P.value=c.toFixed(1),P.dataset.time=u,Y[m].freq=c,Y[m].time=u,P===S.start&&(_=u),P===S.end&&(z=u),x[I].startTime=_,x[I].endTime=z,P.classList.remove("active-get"),P=null,ie(!0),re(),de(),te()})),y.addEventListener("scroll",de),R?.addEventListener("click",he),H?.addEventListener("click",(function(){he()})),{updateMarkers:de,reset:function(){x.forEach((e=>{e.showValidation=!1,e.callType=3,e.harmonic=0,e.result=null,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.keys(e.markers).forEach((t=>{e.markers[t].freq=null,e.markers[t].time=null})),e.line&&(e.line.setAttribute("d",""),e.line.style.display="none")})),M.select(3),T.select(0),Object.values(S).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"),e.classList.remove("invalid"),e.classList.remove("warning"))})),j.textContent="-",O.textContent="-",_=null,z=null,x.forEach((e=>{Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")}))})),P=null,ie(!0),ne(I)},resetCurrentTab:fe,setMarkerAt:function(e,t,n){const l=S[e];l&&(l.value=t.toFixed(1),l.dataset.time=n,Y[e].freq=t,Y[e].time=n,"start"===e&&(_=n),"end"===e&&(z=n),x[I].startTime=_,x[I].endTime=z,re(),de(),te(),ye())},removeMarker:function(e){se(e)},isFieldEnabled:function(e){const t=S[e];return t&&!t.disabled},getFreqRange:o,getDuration:()=>a(),spectrogramHeight:s}}