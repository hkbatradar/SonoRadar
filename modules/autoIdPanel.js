import{initDropdown}from"./dropdown.js";import{autoIdHK}from"./autoid_HK.js";export function initAutoIdPanel({buttonId:e="autoIdBtn",panelId:t="auto-id-panel",viewerId:n="viewer-container",containerId:l="spectrogram-only",overlayId:s="fixed-overlay",spectrogramHeight:i=800,getDuration:a=(()=>0),getFreqRange:o=(()=>({min:0,max:0})),hideHover:c=(()=>{}),refreshHover:r=(()=>{})}={}){const d=document.getElementById(e),u=document.getElementById(t),m=u.querySelector(".popup-drag-bar"),p=u.querySelector(".popup-close-btn"),f=document.getElementById(n),y=document.getElementById(l),v=document.getElementById(s),E="http://www.w3.org/2000/svg",h=document.createElementNS(E,"svg");h.id="autoid-lines",v.appendChild(h);const g=document.getElementById("layout");g&&u&&u.parentElement!==g&&g.appendChild(u);const L=document.getElementById("autoIdTabResetBtn"),k=document.getElementById("autoid-tabs"),b=[],F=Array.from({length:8},(()=>({callType:3,harmonic:0,autoIdResult:null,showValidation:!1,inputs:{start:"",end:"",high:"",low:"",knee:"",heel:"",cfStart:"",cfEnd:""},startTime:null,endTime:null,markers:{start:{el:null,freq:null,time:null},end:{el:null,freq:null,time:null},high:{el:null,freq:null,time:null},low:{el:null,freq:null,time:null},knee:{el:null,freq:null,time:null},heel:{el:null,freq:null,time:null},cfStart:{el:null,freq:null,time:null},cfEnd:{el:null,freq:null,time:null}},line:null,resultEl:null,curves:{}})));let x=0;if(!d||!u||!f)return;function q(){const e="block"===u.style.display;u.style.display=e?"none":"block",document.body.classList.toggle("autoid-open",!e),document.dispatchEvent(new Event(e?"autoid-close":"autoid-open"))}d.addEventListener("click",q),p?.addEventListener("click",q);let w=!1,I=0,C=0;function M(e){w&&(u.style.left=e.clientX-I+"px",u.style.top=e.clientY-C+"px")}function N(){w=!1,document.removeEventListener("mousemove",M),c()}m?.addEventListener("mousedown",(e=>{w=!0,I=e.clientX-u.offsetLeft,C=e.clientY-u.offsetTop,c(),document.addEventListener("mousemove",M,{passive:!0}),document.addEventListener("mouseup",N,{once:!0}),e.preventDefault()})),L?.addEventListener("click",qe);const B=initDropdown("callTypeInput",["CF-FM","FM-CF-FM","FM","FM-QCF","FM-QCF-FM","QCF"]),T=initDropdown("harmonicInput",["0","1","2","3"]);if(T.onChange=function(e,t){F[x].harmonic=t,Z||ie()},k){k.title="Prev pulse (Ctrl + ←), Next pulse (Ctrl + →)";for(let e=0;e<8;e++){const t=document.createElement("button");t.textContent=`${e+1}`,t.className="tab-btn",t.title=`Pulse ${e+1}`,0===e&&t.classList.add("active"),t.addEventListener("click",(()=>oe(e))),k.appendChild(t),b.push(t)}}const A={start:document.getElementById("startFreqInput"),end:document.getElementById("endFreqInput"),high:document.getElementById("highFreqInput"),low:document.getElementById("lowFreqInput"),knee:document.getElementById("kneeFreqInput"),heel:document.getElementById("heelFreqInput"),cfStart:document.getElementById("cfStartFreqInput"),cfEnd:document.getElementById("cfEndFreqInput")},S={start:document.getElementById("startFreqRow"),end:document.getElementById("endFreqRow"),high:document.getElementById("highFreqRow"),low:document.getElementById("lowFreqRow"),knee:document.getElementById("kneeFreqRow"),heel:document.getElementById("heelFreqRow"),cfStart:document.getElementById("cfStartFreqRow"),cfEnd:document.getElementById("cfEndFreqRow")},$=document.getElementById("bandwidthVal"),j=document.getElementById("durationVal"),R=document.getElementById("pulseIdBtn"),O=document.getElementById("sequenceIdBtn"),K=document.getElementById("autoIdResult"),D=(document.getElementById("bandwidth-warning"),document.getElementById("freq-order-warning"),document.getElementById("knee-order-warning")),H=document.getElementById("time-order-warning");const Q={start:"#e74c3c",end:"#004cff",high:"#3498db",low:"#9b59b6",knee:"#f39c12",heel:"#16a085",cfStart:"#e67e22",cfEnd:"#1abc9c"},P={start:"Start freq.",end:"End freq.",high:"High freq.",low:"Low freq.",knee:"Knee freq.",heel:"Heel freq.",cfStart:"CF start",cfEnd:"CF end"};let V=F[x].markers,W=null,X=null,Y=null,z=null,U=null,_=null,G=null,J=!0,Z=!1,ee=!1,te=!1;function ne(){G=null,le()}function le(){F.forEach(((e,t)=>{Object.values(e.curves||{}).forEach((e=>{const n=t===x&&G===e.p1Key,l=t===x&&G===e.p2Key;e.cp1El&&(e.cp1El.style.display=n?"block":"none"),e.cp1LineEl&&(e.cp1LineEl.style.display=n?"block":"none"),e.cp2El&&(e.cp2El.style.display=l?"block":"none"),e.cp2LineEl&&(e.cp2LineEl.style.display=l?"block":"none")}))}))}function se(){const e=F[x].autoIdResult;K&&(e?K.innerHTML=we(e):K.textContent="-")}function ie(){null!=F[x].autoIdResult&&(F[x].autoIdResult=null,se(),ve())}function ae(e){const t=F[e];V=t.markers,Z=!0,B.select(t.callType),T.select(t.harmonic),Z=!1,Object.keys(A).forEach((e=>{A[e].value=t.inputs[e]||"",null!=t.markers[e].time?A[e].dataset.time=t.markers[e].time:delete A[e].dataset.time})),X=t.startTime,Y=t.endTime,me(),ve(),se(),Ie()}function oe(e){e!==x&&(!function(){const e=F[x];e.callType=B.selectedIndex,e.harmonic=T.selectedIndex,e.startTime=X,e.endTime=Y,Object.keys(A).forEach((t=>{e.inputs[t]=A[t].value}))}(),b[x]&&b[x].classList.remove("active"),x=e,b[x]&&b[x].classList.add("active"),G=null,ae(e))}function ce(e){J=e,document.body.classList.toggle("markers-disabled",!e)}function re(e){const t=A[e];t&&(t.value="",delete t.dataset.time,t.classList.remove("active-get"),t.classList.remove("invalid"),t.classList.remove("warning"),V[e].freq=null,V[e].time=null,V[e].el&&(V[e].el.style.display="none"),"start"===e&&(X=null),"end"===e&&(Y=null),F[x].inputs[e]="",F[x].markers[e].freq=null,F[x].markers[e].time=null,F[x].startTime=X,F[x].endTime=Y,me(),ve(),Z||ie(),Ie())}document.addEventListener("click",ne),ce(!0),Object.entries(A).forEach((([e,t])=>{t&&(t.dataset.key=e,t.readOnly=!0,t.addEventListener("click",(()=>{if(W===t)return t.classList.remove("active-get"),W=null,void ce(!0);W&&W.classList.remove("active-get"),W=t,t.classList.add("active-get"),ce(!1)})))}));const de={};function ue(e,t){const n=S[e];if(!n)return;n.style.display=t?"flex":"none",A[e]&&(A[e].disabled=!t);const l=de[e];l&&(l.disabled=!t),t||re(e),Ie()}function me(){B.items[B.selectedIndex],parseFloat(A.high.value);const e=parseFloat(A.low.value),t=parseFloat(A.knee.value);parseFloat(A.cfStart.value),parseFloat(A.end.value);let n=null;const l=Object.values(V).filter((e=>null!=e.freq&&!isNaN(e.freq)&&e.el&&""!==e.el.value)).map((e=>e.freq));if(l.length>=2){n=Math.max(...l)-Math.min(...l),$.textContent=n.toFixed(1)}else $.textContent="-";const s=Object.values(V).filter((e=>null!=e.time&&!isNaN(e.freq))).map((e=>e.time));if(s.length>=2){const e=Math.max(...s),t=Math.min(...s);j.textContent=(1e3*(e-t)).toFixed(1)}else j.textContent="-";!function(e,t,n,l,s,i){const a=document.getElementById("QCF-duration-warning"),o=document.getElementById("QCF-slope-warning"),c=document.getElementById("highfreq-warning"),r=document.getElementById("lowfreq-warning");let d=!1,u=!1;if("QCF"===B.items[B.selectedIndex]){let e=null;const t=Object.values(V).filter((e=>null!=e.time&&!isNaN(e.time))).map((e=>e.time));if(t.length>=2){const n=Math.max(...t),l=Math.min(...t);e=1e3*Math.abs(n-l),d=e<1}if(null!=l&&null!=e&&e>0){const t=l/e;u=!(t<1&&t>=.1)}}const m=Object.values(V).filter((e=>null!=e.freq&&!isNaN(e.freq))).map((e=>e.freq));let p=!1,f=!1;if(m.length>1){const e=V.high?.freq,t=V.low?.freq,n=Math.max(...m),l=Math.min(...m);isNaN(e)||e===n||(p=!0),isNaN(t)||t===l||(f=!0)}const y=!isNaN(n)&&!isNaN(t)&&n<t,v=null!=s&&null!=i&&i<s,E=d||u||p||f||y||v;A.high&&A.high.classList.toggle("warning",p),A.low&&A.low.classList.toggle("warning",f||y),A.knee&&A.knee.classList.toggle("warning",y),A.start&&A.start.classList.toggle("warning",v||d),A.end&&A.end.classList.toggle("warning",v||d),a&&(a.style.display=d?"flex":"none"),o&&(o.style.display=u?"flex":"none"),c&&(c.style.display=p?"flex":"none"),r&&(r.style.display=f?"flex":"none"),D&&(D.style.display=y?"flex":"none"),H&&(H.style.display=v?"flex":"none"),R&&(R.disabled=E),O&&(O.disabled=E)}(0,e,t,n,X,Y)}function pe(e,t){const n=document.createElement("i");n.className=`fa-solid fa-xmark freq-marker marker-${e}`,n.style.color=Q[e],n.dataset.key=e,n.dataset.tab=t;const l=P[e]||e;return n.dataset.title=l,n.setAttribute("aria-label",l),n.addEventListener("mouseenter",c),n.addEventListener("mouseleave",r),n.addEventListener("mousedown",(t=>{J&&(t.stopPropagation(),c(),f.classList.add("hide-cursor"),n.classList.add("hide-cursor"),z=e,U=n,ee=!1,document.addEventListener("mousemove",ke,{passive:!0}),document.addEventListener("mouseup",be,{once:!0}))})),n.addEventListener("click",(n=>{if(n.stopPropagation(),ee)return void(ee=!1);const l=F[t];let s=!1;Object.values(l.curves||{}).forEach((t=>{t.p1Key!==e&&t.p2Key!==e||!t.cp1El&&!t.cp2El||(s=!0)})),s||ge(),function(e){G=e,le()}(e)})),v.appendChild(n),n}function fe(e,t,n){const l=document.createElement("div");return l.className="path-handle",l.dataset.tab=e,l.dataset.seg=t,l.dataset.handle=n,l.addEventListener("mousedown",(s=>{J&&(s.stopPropagation(),c(),f.classList.add("hide-cursor"),l.classList.add("hide-cursor"),document.querySelectorAll(".freq-marker").forEach((e=>e.classList.add("hide-cursor"))),document.querySelectorAll(".path-handle").forEach((e=>e.classList.add("dragging"))),document.querySelectorAll(".handle-connector").forEach((e=>e.classList.add("dragging"))),_={tabIdx:e,segKey:t,handleKey:n,el:l},document.addEventListener("mousemove",Fe,{passive:!0}),document.addEventListener("mouseup",xe,{once:!0}))})),l.addEventListener("mouseenter",c),l.addEventListener("mouseleave",r),l.addEventListener("contextmenu",(e=>{e.preventDefault(),e.stopPropagation()})),l.addEventListener("click",(e=>e.stopPropagation())),l.style.display="none",v.appendChild(l),l}function ye(e){const t=document.createElement("div");return t.className="pulseid-result",t.dataset.tab=e,v.appendChild(t),t.addEventListener("click",(t=>{t.stopPropagation(),"block"!==u.style.display&&(u.style.display="block",document.body.classList.add("autoid-open"),document.dispatchEvent(new Event("autoid-open"))),oe(e)})),t.addEventListener("mouseenter",c),t.addEventListener("mouseleave",r),t.addEventListener("contextmenu",(e=>{e.preventDefault(),e.stopPropagation()})),t}function ve(){const{min:e,max:t}=o(),n=y.scrollWidth;F.forEach(((l,s)=>{let o=1/0,c=-1/0,r=-1/0,d=!1;Object.entries(l.markers).forEach((([l,u])=>{if(u.el||(u.el=pe(l,s)),null==u.freq||null==u.time)return void(u.el.style.display="none");const m=u.time/a()*n-f.scrollLeft,p=(1-(u.freq-e)/(t-e))*i;u.el.style.left=`${m}px`,u.el.style.top=`${p}px`,u.el.style.display="block",u.el.style.pointerEvents=s!==x||te?"none":"auto",u.el.style.opacity=s===x?"1":"0.5",u.el.dataset.freq=u.freq,u.el.dataset.time=u.time;const y=`${P[l]||l} (${Number(u.freq).toFixed(1)} kHz)`;u.el.dataset.title=y,u.el.setAttribute("aria-label",y),o=Math.min(o,m),c=Math.max(c,m),r=Math.max(r,p),d=!0})),l.resultEl||(l.resultEl=ye(s));const u=l.resultEl;l.autoIdResult&&d?(u.innerHTML=we(l.autoIdResult),u.style.left=(o+c)/2+"px",u.style.top=`${r+20}px`,u.style.display="block",u.classList.toggle("inactive",s!==x)):u.style.display="none"})),ge()}function Ee(e,t){const n=f.scrollLeft||0,{min:l,max:s}=o();return{time:(e+n)/y.scrollWidth*a(),freq:(1-t/i)*(s-l)+l}}function he(e,t){const n=y.scrollWidth,{min:l,max:s}=o();return{x:e/a()*n-f.scrollLeft,y:(1-(t-l)/(s-l))*i}}function ge(){const{min:e,max:t}=o(),n=y.scrollWidth;F.forEach(((l,s)=>{l.line||(l.line=document.createElementNS(E,"path"),l.line.dataset.tab=s,h.appendChild(l.line));const o=Object.entries(l.markers).filter((([e,t])=>null!=t.freq&&null!=t.time)).sort(((e,t)=>e[1].time-t[1].time)).map((([l,s])=>({x:s.time/a()*n-f.scrollLeft,y:(1-(s.freq-e)/(t-e))*i,key:l})));if(o.length<2)return l.line.setAttribute("d",""),l.line.style.display="none",Object.values(l.curves||{}).forEach((e=>{e.cp1El?.remove(),e.cp2El?.remove(),e.cp1LineEl?.remove(),e.cp2LineEl?.remove()})),void(l.curves={});const c=function(e,t,n,l=.5){if(e.length<2)return"";let s=`M ${e[0].x} ${e[0].y}`;const i=10,a=[];for(let o=0;o<e.length-1;o++){const c=e[o-1]||e[o],r=e[o],d=e[o+1],u=e[o+2]||d,m=`${r.key}-${d.key}`;a.push(m);const p=o===e.length-2,f=Math.abs(r.y-d.y);if("cfStart"===r.key&&"cfEnd"===d.key){t.curves[m]&&(t.curves[m].cp1El?.remove(),t.curves[m].cp2El?.remove(),t.curves[m].cp1LineEl?.remove(),t.curves[m].cp2LineEl?.remove(),delete t.curves[m]),s+=` L ${d.x} ${d.y}`;continue}if(p&&f<5){t.curves[m]&&(t.curves[m].cp1El?.remove(),t.curves[m].cp2El?.remove(),t.curves[m].cp1LineEl?.remove(),t.curves[m].cp2LineEl?.remove(),delete t.curves[m]),s+=` L ${r.x} ${d.y} L ${d.x} ${d.y}`;continue}t.curves[m]||(t.curves[m]={});const y=t.curves[m];let v,g,L,k;y.p1Key=r.key,y.p2Key=d.key;const b=z&&(r.key===z||d.key===z);if(!b&&y.cp1&&y.cp2)({x:v,y:g}=he(y.cp1.time,y.cp1.freq)),({x:L,y:k}=he(y.cp2.time,y.cp2.freq));else{if(v=r.x+(d.x-c.x)*l/6,g=r.y+(d.y-c.y)*l/6,L=d.x-(u.x-r.x)*l/6,k=d.y-(u.y-r.y)*l/6,"high"===r.key&&"knee"===d.key){const e=Math.hypot(d.x-r.x,d.y-r.y),t=Math.hypot(u.x-d.x,u.y-d.y),n=e?1+t/e*2:1;L=d.x-(u.x-r.x)*l/6*n,k=d.y-(u.y-r.y)*l/6*n}if("cfStart"!==d.key&&"end"!==d.key){const e=Math.abs(r.y-d.y),t=Math.min(i,.6*e);k=Math.min(k,d.y+t),L=Math.min(L,d.x)}const e=Ee(v,g),t=Ee(L,k);y.cp1=e,y.cp2=t}if(b)y.cp1El?.remove(),y.cp2El?.remove(),y.cp1LineEl?.remove(),y.cp2LineEl?.remove(),delete y.cp1El,delete y.cp2El,delete y.cp1LineEl,delete y.cp2LineEl;else{y.cp1El||(y.cp1El=fe(n,m,"cp1")),y.cp2El||(y.cp2El=fe(n,m,"cp2")),y.cp1LineEl||(y.cp1LineEl=document.createElementNS(E,"line"),y.cp1LineEl.classList.add("handle-connector"),y.cp1LineEl.style.display="none",y.cp1LineEl.setAttribute("stroke","#4b0082"),y.cp1LineEl.setAttribute("stroke-width","1"),h.appendChild(y.cp1LineEl)),y.cp2LineEl||(y.cp2LineEl=document.createElementNS(E,"line"),y.cp2LineEl.classList.add("handle-connector"),y.cp2LineEl.style.display="none",y.cp2LineEl.setAttribute("stroke","#4b0082"),y.cp2LineEl.setAttribute("stroke-width","1"),h.appendChild(y.cp2LineEl)),y.cp1El.style.left=`${v}px`,y.cp1El.style.top=`${g}px`,y.cp2El.style.left=`${L}px`,y.cp2El.style.top=`${k}px`;const e=5;y.cp1LineEl.setAttribute("x1",r.x),y.cp1LineEl.setAttribute("y1",r.y);const t=v-r.x,l=g-r.y,s=Math.hypot(t,l)||1,i=v-t/s*e,a=g-l/s*e;y.cp1LineEl.setAttribute("x2",i),y.cp1LineEl.setAttribute("y2",a),y.cp2LineEl.setAttribute("x1",d.x),y.cp2LineEl.setAttribute("y1",d.y);const o=L-d.x,c=k-d.y,u=Math.hypot(o,c)||1,p=L-o/u*e,f=k-c/u*e;y.cp2LineEl.setAttribute("x2",p),y.cp2LineEl.setAttribute("y2",f)}s+=` C ${v} ${g} ${L} ${k} ${d.x} ${d.y}`}return Object.keys(t.curves).forEach((e=>{if(!a.includes(e)){const n=t.curves[e];n.cp1El?.remove(),n.cp2El?.remove(),n.cp1LineEl?.remove(),n.cp2LineEl?.remove(),delete t.curves[e]}})),s}(o,l,s);l.line.setAttribute("stroke-linejoin","round"),l.line.setAttribute("d",c),l.line.style.display="block",l.line.style.opacity=s===x?"1":"0.5"})),le()}function Le(e,t=x){const n=F[t];Object.entries(n.curves||{}).forEach((([t,l])=>{l.p1Key!==e&&l.p2Key!==e||(l.cp1El?.remove(),l.cp2El?.remove(),l.cp1LineEl?.remove(),l.cp2LineEl?.remove(),delete n.curves[t])})),ne()}function ke(e){if(!z||!J)return;ee||(Le(z),ge()),ee=!0;const t=f.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,s=f.scrollLeft||0,{min:c,max:r}=o(),d=(1-l/i)*(r-c)+c,u=(n+s)/y.scrollWidth*a(),m=A[z];m&&(m.value=d.toFixed(1),m.dataset.time=u,m===A.start&&(X=u),m===A.end&&(Y=u)),F[x].startTime=X,F[x].endTime=Y,V[z].freq=d,V[z].time=u,me(),ve()}function be(){const e=z;z=null,U&&(U.classList.remove("hide-cursor"),U=null),document.removeEventListener("mousemove",ke),f.classList.remove("hide-cursor"),r(),Ie(),ie(),e&&ee&&(Le(e),ge())}function Fe(e){if(!_||!J)return;const t=f.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,{time:s,freq:i}=Ee(n,l),{tabIdx:a,segKey:o,handleKey:c}=_,r=F[a].curves[o];r&&(r[c]={time:s,freq:i}),ge()}function xe(){_&&(_.el.classList.remove("hide-cursor"),document.querySelectorAll(".path-handle").forEach((e=>e.classList.remove("dragging"))),document.querySelectorAll(".handle-connector").forEach((e=>e.classList.remove("dragging"))),document.querySelectorAll(".freq-marker").forEach((e=>e.classList.remove("hide-cursor"))),_=null,document.removeEventListener("mousemove",Fe),f.classList.remove("hide-cursor"),r(),ie())}function qe(){var e;F[x].showValidation=!1,(e=F[x]).callType=3,e.harmonic=0,e.autoIdResult=null,e.showValidation=!1,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")})),Object.values(e.curves||{}).forEach((e=>{e.cp1El?.remove(),e.cp2El?.remove(),e.cp1LineEl?.remove(),e.cp2LineEl?.remove()})),e.curves={},e.line&&(e.line.setAttribute("d",""),e.line.style.display="none"),B.select(3),T.select(0),Object.values(A).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"),e.classList.remove("invalid"),e.classList.remove("warning"))})),$.textContent="-",j.textContent="-",X=null,Y=null,W=null,F[x].autoIdResult=null,G=null,ce(!0),ae(x)}function we(e){return e.split(" / ").map((e=>{if(e.endsWith("sp.")){return`<i>${e.replace(" sp.","")}</i> sp.`}return"TBC"===e||"-"===e||"No species matched"===e?e:`<i>${e}</i>`})).join(" / ")}function Ie(e=!1){const t=F[x];e&&(t.showValidation=!0);const n=t.showValidation,l={"CF-FM":["cfStart","cfEnd"],"FM-CF-FM":["cfStart","cfEnd"],FM:["high","low"],"FM-QCF":["high","low","knee"],"FM-QCF-FM":["high","knee","heel","low"],QCF:["high","low"]}[B.items[B.selectedIndex]]||[];let s=!0;return Object.entries(A).forEach((([e,t])=>{if(t)if(l.includes(e)){const e=parseFloat(t.value),l=!isNaN(e);n?t.classList.toggle("invalid",!l):t.classList.remove("invalid"),l||(s=!1)}else t.classList.remove("invalid")})),s}function Ce(){if(!Ie(!0))return F[x].autoIdResult=null,K&&(K.textContent="-"),void ve();const e=B.items[B.selectedIndex],t=parseFloat(A.high.value),n=parseFloat(A.low.value),l=parseFloat(A.knee.value),s=parseFloat(A.heel.value),i=parseFloat(A.start.value),a=parseFloat(A.end.value),o=parseFloat(A.cfStart.value),c=parseFloat(A.cfEnd.value);let r=null;const d=Object.values(V).filter((e=>null!=e.time&&!isNaN(e.freq))).map((e=>e.time));if(d.length>=2){r=1e3*(Math.max(...d)-Math.min(...d))}let u=null;["FM-CF-FM","CF-FM"].includes(e)?isNaN(o)||isNaN(a)||(u=o-a):isNaN(t)||isNaN(n)||(u=t-n);const m=null!=V.knee.time&&null!=V.low.time?1e3*(V.knee.time-V.low.time):null,p=isNaN(l)||isNaN(n)?null:l-n,f=isNaN(s)||isNaN(n)?null:s-n,y=isNaN(l)||isNaN(s)?null:l-s,v=parseInt(T.items[T.selectedIndex],10),E=autoIdHK({callType:e,harmonic:v,highestFreq:t,lowestFreq:n,kneeFreq:l,heelFreq:s,startFreq:i,endFreq:a,cfStart:o,cfEnd:c,duration:r,bandwidth:u,kneeLowTime:m,kneeLowBandwidth:p,heelLowBandwidth:f,kneeHeelBandwidth:y});F[x].autoIdResult=E,se(),ve()}return u.querySelectorAll(".autoid-marker[data-key]").forEach((e=>{const t=e.dataset.key;de[t]=e,e.addEventListener("click",(e=>{e.preventDefault(),re(t)}))})),B.onChange=function(e,t){const n=["CF-FM","FM-CF-FM"].includes(e),l=["CF-FM","FM-CF-FM","QCF"].includes(e),s=["QCF","FM-QCF","FM","FM-QCF-FM"].includes(e);ue("high",!n),ue("low",!n),ue("knee",!l),ue("heel",!l),ue("cfStart",!s),ue("cfEnd",!s),F[x].callType=t,Z||ie(),me(),ge(),F[x].showValidation=!1,Ie()},T.select(0),B.select(3),ae(0),document.addEventListener("keydown",(e=>{"Control"!==e.key||te||(te=!0,ve())})),document.addEventListener("keyup",(e=>{"Control"===e.key&&te&&(te=!1,ve())})),f.addEventListener("click",(e=>{if(!W)return;const t=f.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,s=f.scrollLeft||0,{min:c,max:r}=o(),d=(1-l/i)*(r-c)+c,u=(n+s)/y.scrollWidth*a(),m=W.dataset.key;W.value=d.toFixed(1),W.dataset.time=u,V[m].freq=d,V[m].time=u,W===A.start&&(X=u),W===A.end&&(Y=u),F[x].startTime=X,F[x].endTime=Y,W.classList.remove("active-get"),W=null,ce(!0),me(),ve(),ie()})),f.addEventListener("scroll",ve),R?.addEventListener("click",Ce),O?.addEventListener("click",(function(){Ce()})),document.addEventListener("keydown",(e=>{document.body.classList.contains("autoid-open")&&("INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName||e.target.isContentEditable||("Enter"===e.key&&e.ctrlKey?(e.preventDefault(),R?.click()):"Enter"===e.key&&e.shiftKey?(e.preventDefault(),O?.click()):e.ctrlKey&&"ArrowLeft"===e.key?(e.preventDefault(),x>0&&oe(x-1)):e.ctrlKey&&"ArrowRight"===e.key&&(e.preventDefault(),x<7&&oe(x+1))))})),{updateMarkers:ve,reset:function(){F.forEach((e=>{e.showValidation=!1,e.callType=3,e.harmonic=0,e.autoIdResult=null,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.keys(e.markers).forEach((t=>{e.markers[t].freq=null,e.markers[t].time=null})),Object.values(e.curves||{}).forEach((e=>{e.cp1El?.remove(),e.cp2El?.remove(),e.cp1LineEl?.remove(),e.cp2LineEl?.remove()})),e.curves={},e.line&&(e.line.setAttribute("d",""),e.line.style.display="none")})),B.select(3),T.select(0),Object.values(A).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"),e.classList.remove("invalid"),e.classList.remove("warning"))})),$.textContent="-",j.textContent="-",X=null,Y=null,F.forEach((e=>{Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")}))})),W=null,G=null,ce(!0),ae(x)},resetCurrentTab:qe,setMarkerAt:function(e,t,n){const l=A[e];l&&(l.value=t.toFixed(1),l.dataset.time=n,V[e].freq=t,V[e].time=n,"start"===e&&(X=n),"end"===e&&(Y=n),F[x].startTime=X,F[x].endTime=Y,Le(e,x),me(),ve(),ie(),Ie())},removeMarker:function(e){re(e)},isFieldEnabled:function(e){const t=A[e];return t&&!t.disabled},getFreqRange:o,getDuration:()=>a(),spectrogramHeight:i}}