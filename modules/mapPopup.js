import{getCurrentIndex,getFileMetadata,getFileList}from"./fileState.js";export function initMapPopup({buttonId:t="mapBtn",popupId:e="mapPopup",mapId:o="map"}={}){const n=document.getElementById(t),a=document.getElementById(e),i=document.getElementById(o),l=a.querySelector(".popup-drag-bar"),r=a.querySelector(".popup-close-btn");if(!n||!a||!i)return;i.style.cursor="grab";function s(t,e){const o=a.getBoundingClientRect(),n=t-o.left,i=e-o.top;return{onLeft:n>=-5&&n<5,onRight:n<=o.width+5&&n>o.width-5,onTop:i>=-5&&i<5,onBottom:i<=o.height+5&&i>o.height-5}}function c(t){const{onLeft:e,onRight:o,onTop:n,onBottom:a}=t;let i="";return e&&n||o&&a?i="nwse-resize":o&&n||e&&a?i="nesw-resize":e||o?i="ew-resize":(n||a)&&(i="ns-resize"),i}let d=parseInt(localStorage.getItem("mapPopupWidth"),10),p=parseInt(localStorage.getItem("mapPopupHeight"),10);(isNaN(d)||d<=0)&&(d=500),(isNaN(p)||p<=0)&&(p=500),a.style.width=`${d}px`,a.style.height=`${p}px`;let m=null,u=[],f=[],g=null,y=[],h=null,v=null,x=null,E=null,b=null,w=!1;const k=i.querySelector(".coord-scale-wrapper"),T=i.querySelector("#coord-display");let D=null;const C=document.createElement("input");C.type="file",C.accept=".kml",C.style.display="none",a.appendChild(C);const z=document.getElementById("map-drop-overlay");let N=0;function I(){z&&(z.style.display="none",z.style.pointerEvents="none"),m?.dragging.enable()}function S(t,e){if(m=L.map(i).setView([t,e],13),D=L.control.scale({position:"bottomleft",metric:!0,imperial:!1}).addTo(m),k){const t=D.getContainer();t.style.position="static",k.appendChild(t)}function o(t){if(!T)return;const{lat:e,lng:o}=t;T.textContent=`${e.toFixed(4)} ${o.toFixed(4)}`}m.on("mousemove",(t=>o(t.latlng))),m.on("move",(()=>o(m.getCenter()))),o(m.getCenter());const n={attribution:"&copy; CARTO"},a={attribution:"&copy; Google"},l=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors"}).addTo(m),r=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; Esri"}),s=L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",n),c=L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",n),d=L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",a),p=L.tileLayer("https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",a),u=L.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",a),f=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/imagery/wgs84/{z}/{x}/{y}.png",{attribution:"&copy; HKSAR Government",minZoom:0,maxZoom:19}),y=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/basemap/wgs84/{z}/{x}/{y}.png",{attribution:"&copy; HKSAR Government",maxZoom:20,minZoom:10}),w=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/label/hk/tc/wgs84/{z}/{x}/{y}.png",{attribution:!1,maxZoom:20,minZoom:0}),z={OpenStreetMap:l,"Esri Satellite":r,"Carto Light":s,"Carto Dark":c,"Google Streets":d,"Google Satellite":p,"Google Hybrid":u,"HK Vector":L.layerGroup([y,w]),"HK Imagery":L.layerGroup([f,w])};L.control.layers(z,null,{position:"topright"}).addTo(m),b=(new L.FeatureGroup).addTo(m),E=new L.Control.Draw({position:"topleft",edit:{featureGroup:b}}),m.on(L.Draw.Event.CREATED,(t=>{b.addLayer(t.layer)}));const N=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-route-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Route",e.innerHTML='<i class="fa-solid fa-route"></i>',g=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",H),t}});m.addControl(new N);const I=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-import-kml-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Import KML",e.innerHTML='<i class="fa-solid fa-file-import"></i>',h=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",(()=>{C.value="",C.click()})),t}});m.addControl(new I);const S=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-clear-kml-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Clear KML",e.innerHTML='<i class="fa-solid fa-trash"></i>',v=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",M),t}});m.addControl(new S);const F=L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-draw-toggle-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Draw",e.innerHTML='<i class="fa-solid fa-pen-to-square"></i>',x=e,L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"click",A),t}});m.addControl(new F)}function F(){if(!m)return;u.forEach((t=>t.remove())),u=[];const t=getFileList(),e=getCurrentIndex(),o={};function n(t){if(!t)return"";return`${(t.date||"").replace(/\D/g,"")}${t.time||""}`}t.forEach(((t,e)=>{const n=getFileMetadata(e),a=parseFloat(n.latitude),i=parseFloat(n.longitude);if(isNaN(a)||isNaN(i))return;const l=`${a.toFixed(6)},${i.toFixed(6)}`;o[l]||(o[l]=[]),o[l].push({file:t,idx:e,meta:n,lat:a,lon:i})})),Object.values(o).forEach((t=>{t.sort(((t,e)=>n(t.meta).localeCompare(n(e.meta))));const o=t[0],{lat:a,lon:i}=o,l=t.some((t=>t.idx===e)),r=l?"map-marker-current":"map-marker-other",s=L.divIcon({html:'<i class="fa-solid fa-location-dot"></i>',className:r,iconSize:[28,28],iconAnchor:[14,28]}),c=t.map((t=>t.file.name.replace(/\.wav$/i,""))),d=c.length<=5?c.join("<br>"):`${c[0]}<br>â‹®<br>${c[c.length-1]}`,p=l?1e3:0,f=L.marker([a,i],{icon:s,zIndexOffset:p});f.on("click",(()=>{document.dispatchEvent(new CustomEvent("map-file-selected",{detail:{index:o.idx}}))})),f.bindTooltip(d,{direction:"top",offset:[-3,-32],className:"map-tooltip"}),f.addTo(m),u.push(f)}))}function $(){f.forEach((t=>t.remove())),f=[],g?.classList.remove("active")}function M(){y.forEach((t=>t.remove())),y=[]}function B(t){const e=[],o=(new DOMParser).parseFromString(t,"text/xml").getElementsByTagName("LineString");for(let t=0;t<o.length;t++){const n=o[t].getElementsByTagName("coordinates")[0];if(!n)continue;const a=n.textContent.trim().split(/\s+/).map((t=>{const[e,o]=t.split(",").map(Number);return isNaN(o)||isNaN(e)?null:[o,e]})).filter(Boolean);a.length>1&&e.push(a)}return e}function H(){f.length>0?$():(!function(){if(!m)return;$();const t=getFileList(),e=[];t.forEach(((t,o)=>{const n=getFileMetadata(o),a=parseFloat(n.latitude),i=parseFloat(n.longitude),l=`${(n.date||"").replace(/\D/g,"")}${n.time||""}`;isNaN(a)||isNaN(i)||!l||e.push({lat:a,lon:i,ts:l})})),e.sort(((t,e)=>t.ts.localeCompare(e.ts)));let o=[],n=null;e.forEach((t=>{n&&m.distance([n.lat,n.lon],[t.lat,t.lon])>=1e3&&(o.length>1&&f.push(L.polyline(o,{color:"black",weight:2,opacity:.8}).addTo(m)),o=[]),o.push([t.lat,t.lon]),n=t})),o.length>1&&f.push(L.polyline(o,{color:"black",weight:2,opacity:.8}).addTo(m))}(),g?.classList.add("active"))}function A(){E&&(w?(m.removeControl(E),x?.classList.remove("active"),w=!1):(E.addTo(m),x?.classList.add("active"),w=!0))}function R(){const t=getCurrentIndex();if(t<0)return F(),void(navigator.geolocation&&navigator.geolocation.getCurrentPosition((t=>{const{latitude:e,longitude:o}=t.coords,n=L.divIcon({html:'<i class="fa-solid fa-location-crosshairs"></i>',className:"map-marker-device",iconSize:[28,28],iconAnchor:[14,28]});m?m.setView([e,o]):S(e,o);const a=L.marker([e,o],{icon:n,zIndexOffset:1001});a.addTo(m),u.push(a)})));const e=getFileMetadata(t),o=parseFloat(e.latitude),n=parseFloat(e.longitude);isNaN(o)||isNaN(n)||(m?m.setView([o,n]):S(o,n),F())}function G(){"block"===a.style.display?(a.style.display="none",document.body.classList.remove("map-open"),$(),M()):(a.style.display="block",document.body.classList.add("map-open"),a.style.width=`${d}px`,a.style.height=`${p}px`,m&&m.invalidateSize(),R())}i.addEventListener("dragenter",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),N++,z&&(z.style.display="flex",z.style.pointerEvents="auto"),m?.dragging.disable())})),i.addEventListener("dragover",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),t.dataTransfer.dropEffect="copy")})),i.addEventListener("dragleave",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),N--,N<=0&&I())})),i.addEventListener("drop",(async t=>{t.preventDefault(),N=0,I();const e=Array.from(t.dataTransfer.files).find((t=>t.name.endsWith(".kml")));if(!e)return;const o=B(await e.text());M();const n=[];o.forEach((t=>{const e=L.polyline(t,{color:"deeppink",weight:2,opacity:.8}).addTo(m);y.push(e),n.push(...t)})),n.length>0&&m.fitBounds(n)})),C.addEventListener("change",(async()=>{const t=C.files[0];if(!t)return;const e=B(await t.text());M();const o=[];e.forEach((t=>{const e=L.polyline(t,{color:"deeppink",weight:2,opacity:.8}).addTo(m);y.push(e),o.push(...t)})),o.length>0&&m.fitBounds(o)}));let P=!1,X=0,Y=0,U=!1,O=!1,K=!1,W=!1,Z=!1,q=0,V=0,j=0,_=0,J=0,Q=0;l&&l.addEventListener("mousedown",(t=>{P=!0,X=t.clientX-a.offsetLeft,Y=t.clientY-a.offsetTop,m?.dragging.disable(),t.preventDefault(),t.stopPropagation()})),a.addEventListener("mousemove",(t=>{if(P||U)return;const e=c(s(t.clientX,t.clientY))||"default";a.style.cursor=e})),a.addEventListener("mousedown",(t=>{if(t.target===l||l.contains(t.target))return;const e=s(t.clientX,t.clientY);if(e.onLeft||e.onRight||e.onTop||e.onBottom){U=!0,O=e.onLeft,K=e.onRight,W=e.onTop,Z=e.onBottom;const o=c(e)||"default";a.style.cursor=o,document.body.style.cursor=o,q=t.clientX,V=t.clientY,j=a.offsetWidth,_=a.offsetHeight,J=a.offsetLeft,Q=a.offsetTop,m?.dragging.disable(),t.preventDefault(),t.stopPropagation()}})),document.addEventListener("mousemove",(t=>{if(P||U||"block"!==a.style.display)return;const e=c(s(t.clientX,t.clientY));document.body.style.cursor=e||""})),document.addEventListener("mousedown",(t=>{if(P||U||"block"!==a.style.display)return;if(t.target===l||l.contains(t.target))return;const e=s(t.clientX,t.clientY);if(e.onLeft||e.onRight||e.onTop||e.onBottom){U=!0,O=e.onLeft,K=e.onRight,W=e.onTop,Z=e.onBottom;const o=c(e)||"default";document.body.style.cursor=o,q=t.clientX,V=t.clientY,j=a.offsetWidth,_=a.offsetHeight,J=a.offsetLeft,Q=a.offsetTop,m?.dragging.disable(),t.preventDefault(),t.stopPropagation()}})),window.addEventListener("mousemove",(t=>{if(P)return a.style.left=t.clientX-X+"px",void(a.style.top=t.clientY-Y+"px");if(U){const e=t.clientX-q,o=t.clientY-V;document.body.style.cursor=document.body.style.cursor||a.style.cursor,K&&(d=Math.max(200,j+e),a.style.width=`${d}px`),Z&&(p=Math.max(200,_+o),a.style.height=`${p}px`),O&&(d=Math.max(200,j-e),a.style.width=`${d}px`,a.style.left=`${J+e}px`),W&&(p=Math.max(200,_-o),a.style.height=`${p}px`,a.style.top=`${Q+o}px`)}})),window.addEventListener("mouseup",(()=>{P&&(P=!1,m?.dragging.enable()),U&&(U=!1,m?.dragging.enable(),localStorage.setItem("mapPopupWidth",d),localStorage.setItem("mapPopupHeight",p),m?.invalidateSize(),document.body.style.cursor="",a.style.cursor="")})),n.addEventListener("click",G),r&&r.addEventListener("click",G),document.addEventListener("file-loaded",R),document.addEventListener("file-list-cleared",(()=>F()))}