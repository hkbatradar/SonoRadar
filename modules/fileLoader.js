import{extractGuanoMetadata,parseGuanoMetadata}from"./guanoReader.js";import{addFilesToList,getFileList,getCurrentIndex,setCurrentIndex,removeFilesByName,setFileMetadata}from"./fileState.js";import{showMessageBox}from"./messageBox.js";export async function getWavSampleRate(e){if(!e)return 256e3;const t=await e.arrayBuffer(),n=new DataView(t);let a=12;for(;a<n.byteLength-8;){const e=String.fromCharCode(n.getUint8(a),n.getUint8(a+1),n.getUint8(a+2),n.getUint8(a+3)),t=n.getUint32(a+4,!0);if("fmt "===e)return n.getUint32(a+12,!0);a+=8+t,t%2==1&&(a+=1)}return 256e3}export async function getWavDuration(e){if(!e)return 0;const t=await e.arrayBuffer(),n=new DataView(t);let a=12,o=0,r=1,i=16,s=0;for(;a<n.byteLength-8;){const e=String.fromCharCode(n.getUint8(a),n.getUint8(a+1),n.getUint8(a+2),n.getUint8(a+3)),t=n.getUint32(a+4,!0);if("fmt "===e)r=n.getUint16(a+10,!0),o=n.getUint32(a+12,!0),i=n.getUint16(a+22,!0);else if("data"===e){s=t;break}a+=8+t,t%2==1&&(a+=1)}if(o>0&&s>0){return s/(i/8*r)/o}return 0}let lastObjectUrl=null;export function initFileLoader({fileInputId:e,wavesurfer:t,spectrogramHeight:n,colorMap:a,onPluginReplaced:o,onFileLoaded:r,onBeforeLoad:i,onAfterLoad:s,onSampleRateDetected:l}){const d=document.getElementById(e),c=document.getElementById("prevBtn"),u=document.getElementById("nextBtn"),g=document.getElementById("fileNameText"),f=document.getElementById("guano-output"),m=document.getElementById("spectrogram-settings"),p=document.getElementById("upload-overlay"),y=document.getElementById("upload-progress-bar"),h=document.getElementById("upload-progress-text");function w(e,t){if(y){const n=t>0?e/t*100:0;y.style.width=`${n}%`}h&&(h.textContent=`${e}/${t}`)}async function x(e){if(!e)return;const n=await getWavSampleRate(e);"function"==typeof i&&i(),"function"==typeof r&&r(e),"function"==typeof l&&await l(n,!0),g&&(g.textContent=e.name);try{const t=await extractGuanoMetadata(e);f.textContent=t||"(No GUANO metadata found)";const n=parseGuanoMetadata(t),a=getCurrentIndex();setFileMetadata(a,n)}catch(e){f.textContent="(Error reading GUANO metadata)"}const a=URL.createObjectURL(e);lastObjectUrl&&URL.revokeObjectURL(lastObjectUrl),lastObjectUrl=a,await t.load(a),"function"==typeof o&&o();const d=n||t?.options?.sampleRate||256e3;m&&(m.textContent=`Sampling rate: ${d/1e3}kHz`),"function"==typeof s&&s(),document.dispatchEvent(new Event("file-loaded"))}return d.addEventListener("change",(async e=>{const t=Array.from(e.target.files),n=t[0];if(!n)return;const a=t.filter((e=>e.name.endsWith(".wav")));var o;o=a.length,p&&(document.dispatchEvent(new Event("drop-overlay-hide")),y&&(y.style.width="0%"),h&&(h.textContent=`0/${o}`),p.style.display="flex"),"function"==typeof i&&i();let r=0;const s=a.sort(((e,t)=>e.name.localeCompare(t.name))),l=[],c=[];for(let e=0;e<s.length;e++){if(await getWavDuration(s[e])>20)r++;else{l.push(s[e]);try{const t=await extractGuanoMetadata(s[e]);c.push(parseGuanoMetadata(t))}catch(e){c.push({date:"",time:"",latitude:"",longitude:""})}}w(e+1,s.length)}const u=l.findIndex((e=>e.name===n.name));removeFilesByName("demo_recording.wav");const g=getFileList().length;if(l.length>0){addFilesToList(l,u>=0?u:0);for(let e=0;e<l.length;e++)setFileMetadata(g+e,c[e])}p&&(p.style.display="none"),l.length>0&&await x(l[u>=0?u:0]),d.value="",r>0&&showMessageBox({title:"Warning",message:`.wav files longer than 20 seconds are not supported and a total of (${r}) such files were skipped during the loading process. Please trim or preprocess these files to meet the duration requirement before loading.`})})),c.addEventListener("click",(()=>{const e=getCurrentIndex();if(e>0){setCurrentIndex(e-1);x(getFileList()[e-1])}})),u.addEventListener("click",(()=>{const e=getCurrentIndex(),t=getFileList();if(e<t.length-1){setCurrentIndex(e+1);x(t[e+1])}})),document.addEventListener("keydown",(e=>{e.ctrlKey||("ArrowUp"===e.key?(e.preventDefault(),c.click()):"ArrowDown"===e.key&&(e.preventDefault(),u.click()))})),{loadFileAtIndex:async e=>{const t=getFileList();e>=0&&e<t.length&&(setCurrentIndex(e),await x(t[e]))}}}