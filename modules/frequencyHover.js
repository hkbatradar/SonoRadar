export function initFrequencyHover({viewerId:e,wrapperId:t="viewer-wrapper",hoverLineId:n,hoverLineVId:o,freqLabelId:i,spectrogramHeight:l=800,spectrogramWidth:s=1024,maxFrequency:d=128,minFrequency:r=10,totalDuration:a=1e3,getZoomLevel:c,getDuration:u,isExpandMode:p=(()=>!1)}){const m=document.getElementById(e),v=document.getElementById(t),h=document.getElementById(n),f=document.getElementById(o),y=document.getElementById(i),g=document.getElementById("fixed-overlay"),x=document.getElementById("zoom-controls"),L=document.getElementById("spectrogram-only"),E=[],b=[];let w=!0,C=!1;const F=()=>p()?20:0,$=5;let B=!1,I=!1,k=!1,z=!1,T=0,Y=0,q=null,H=null,M=null;const R=()=>{h.style.display="none",f.style.display="none",y.style.display="none"},X=e=>{if(H=e.clientX,M=e.clientY,B||k)return void R();const t=m.getBoundingClientRect(),n=e.clientX-t.left,o=e.clientY-t.top;if(o>m.clientHeight-F())return R(),m.classList.remove("hide-cursor"),void(C=!0);C=!1,m.classList.add("hide-cursor");const i=m.scrollLeft||0,s=(1-o/l)*(d-r)+r,a=(n+i)/L.scrollWidth*u();h.style.top=`${o}px`,h.style.display="block",f.style.left=`${n}px`,f.style.display="block";let c;m.clientWidth-n<120?(y.style.transform="translate(-100%, -50%)",c=n-12+"px"):(y.style.transform="translate(0, -50%)",c=`${n+12}px`),y.style.top=`${o}px`,y.style.left=c,y.style.display="block",y.textContent=`${s.toFixed(1)} kHz   ${(1e3*a).toFixed(1)} ms`};m.addEventListener("mousemove",X,{passive:!0}),v.addEventListener("mouseleave",R),m.addEventListener("mouseenter",(()=>m.classList.add("hide-cursor"))),m.addEventListener("mouseleave",(()=>m.classList.remove("hide-cursor")));function S(e,t,n,o,i){const{data:l,tooltip:s}=e,d=l.Flow,r=l.Fhigh,a=r-d,c=l.endTime-l.startTime;s?(e.durationLabel&&(e.durationLabel.textContent=`${(1e3*c).toFixed(1)} ms`),s.querySelector(".fhigh").textContent=r.toFixed(1),s.querySelector(".flow").textContent=d.toFixed(1),s.querySelector(".bandwidth").textContent=a.toFixed(1),s.querySelector(".duration").textContent=(1e3*c).toFixed(1)):e.durationLabel&&(e.durationLabel.textContent=`${(1e3*c).toFixed(1)} ms`)}function D(){const e=u()*c(),t=d-r;b.forEach((n=>{const{startTime:o,endTime:i,Flow:s,Fhigh:d}=n.data,a=o/u()*e,c=(i-o)/u()*e,p=(1-(d-r)/t)*l,m=(d-s)/t*l;if(n.rect.style.left=`${a}px`,n.rect.style.top=`${p}px`,n.rect.style.width=`${c}px`,n.rect.style.height=`${m}px`,n.tooltip){const e=a+c+10;n.tooltip.style.left=`${e}px`,n.tooltip.style.top=`${p}px`,S(n)}else S(n)}))}return m.addEventListener("mouseleave",(e=>{z&&(z&&(z=!1,q&&m.contains(q)&&m.removeChild(q),q=null,B=!1),R())})),x&&(x.addEventListener("mouseenter",(()=>{B=!0,R()})),x.addEventListener("mouseleave",(()=>{B=!1}))),m.addEventListener("mousedown",(e=>{if(I||k)return;if(0!==e.button)return;const t=m.getBoundingClientRect();T=e.clientX-t.left+m.scrollLeft,Y=e.clientY-t.top,Y>m.clientHeight-F()||(z=!0,B=!0,R(),q=document.createElement("div"),q.style.position="absolute",q.style.border="1px solid black",q.style.backgroundColor="rgba(0,0,0,0.05)",q.style.zIndex="20",m.appendChild(q))})),m.addEventListener("mousemove",(e=>{if(!z)return;const t=m.getBoundingClientRect(),n=e.clientX>=t.left&&e.clientX<=t.right,o=e.clientY>=t.top&&e.clientY<=t.bottom-F();if(!n||!o)return m.removeChild(q),q=null,z=!1,B=!1,void R();const i=e.clientX-t.left+m.scrollLeft,l=e.clientY-t.top,s=Math.min(i,T),d=Math.min(l,Y),r=Math.abs(i-T),a=Math.abs(l-Y);q.style.left=`${s}px`,q.style.top=`${d}px`,q.style.width=`${r}px`,q.style.height=`${a}px`}),{passive:!0}),m.addEventListener("mouseup",(e=>{if(!z)return;z=!1;const t=q.getBoundingClientRect(),n=m.getBoundingClientRect(),o=t.left-n.left+m.scrollLeft,i=t.top-n.top,s=t.width,a=t.height;if(s<=3||a<=3)return m.removeChild(q),q=null,B=!1,void X(e);const p=(1-(i+a)/l)*(d-r)+r,v=(1-i/l)*(d-r)+r,h=v-p,f=u()*c(),y=o/f*u(),g=(o+s)/f*u();!function(e,t,n,o,i,s,a,p,v,h,f){let y=null;1e3*p<=100&&(y=document.createElement("div"),y.className="draggable-tooltip",y.style.position="absolute",y.style.left=`${e+n+10}px`,y.style.top=`${t}px`,y.style.zIndex="30",y.style.padding="6px 10px",y.style.background="white",y.style.border="1px solid black",y.style.fontSize="12px",y.style.fontFamily="Noto Sans HK",y.style.boxShadow="2px 2px 5px rgba(0,0,0,0.2)",y.style.cursor="move",y.innerHTML=`\n        <div><b>F.high:</b> <span class="fhigh">${i.toFixed(1)}</span> kHz</div>\n        <div><b>F.Low:</b> <span class="flow">${s.toFixed(1)}</span> kHz</div>\n        <div><b>Bandwidth:</b> <span class="bandwidth">${a.toFixed(1)}</span> kHz</div>\n        <div><b>Duration:</b> <span class="duration">${(1e3*p).toFixed(1)}</span> ms</div>\n        <div style="position:absolute; top:2px; right:6px; cursor:pointer;" class="close-btn">Ã—</div>\n      `,y.addEventListener("mouseenter",(()=>{I=!0,B=!0,R()})),y.addEventListener("mouseleave",(()=>{I=!1,B=!1})),m.appendChild(y));let g=null,x=null,L=null;1e3*p>100&&(g=document.createElement("i"),g.className="fa-solid fa-arrows-left-right-to-line selection-expand-btn",g.title="Crop and expand this session",g.addEventListener("click",(e=>{e.stopPropagation(),m.dispatchEvent(new CustomEvent("expand-selection",{detail:{startTime:h,endTime:f}}))})),g.addEventListener("mouseenter",(()=>{B=!0,R()})),g.addEventListener("mouseleave",(()=>{B=!1})),v.appendChild(g),x=document.createElement("i"),x.className="fa-solid fa-xmark selection-close-btn",x.title="Close selection",x.addEventListener("click",(e=>{e.stopPropagation();const t=b.findIndex((e=>e.rect===v));-1!==t&&(m.removeChild(b[t].rect),b[t].tooltip&&m.removeChild(b[t].tooltip),b.splice(t,1)),B=!1})),x.addEventListener("mousedown",(e=>{e.stopPropagation()})),x.addEventListener("mouseenter",(()=>{B=!0,R()})),x.addEventListener("mouseleave",(()=>{B=!1})),v.appendChild(x));L=document.createElement("div"),L.className="selection-duration",L.textContent=`${(1e3*p).toFixed(1)} ms`,v.appendChild(L);const E={data:{startTime:h,endTime:f,Flow:s,Fhigh:i},rect:v,tooltip:y,expandBtn:g,closeBtn:x,durationLabel:L};b.push(E),y&&(!function(e){let t,n,o=!1;e.addEventListener("mousedown",(i=>{if(i.target.classList.contains("close-btn"))return;o=!0;const l=e.getBoundingClientRect();t=i.clientX-l.left,n=i.clientY-l.top})),window.addEventListener("mousemove",(i=>{if(!o)return;const l=m.getBoundingClientRect(),s=i.clientX-l.left+m.scrollLeft-t,d=i.clientY-l.top-n;e.style.left=`${s}px`,e.style.top=`${d}px`}),{passive:!0}),window.addEventListener("mouseup",(()=>{o=!1}))}(y),y.querySelector(".close-btn").addEventListener("click",(()=>{const e=b.findIndex((e=>e.tooltip===y));-1!==e&&(m.removeChild(b[e].rect),m.removeChild(b[e].tooltip),b.splice(e,1)),I=!1,B=!1})));!function(e){const t=e.rect;let n=!1,o=null,i=null;t.addEventListener("mousemove",(e=>{if(z||n)return;if(e.target.closest(".selection-close-btn"))return void(t.style.cursor="default");const o=t.getBoundingClientRect(),i=e.clientX-o.left,l=e.clientY-o.top;let s="default";const d=i<$,r=i>o.width-$,a=l<$,c=l>o.height-$;d&&a||r&&c?s="nwse-resize":r&&a||d&&c?s="nesw-resize":d||r?s="ew-resize":(a||c)&&(s="ns-resize"),t.style.cursor=s}),{passive:!0}),t.addEventListener("mousedown",(s=>{if(n)return;if(s.target.closest(".selection-close-btn"))return;const a=t.getBoundingClientRect(),p=s.clientX-a.left,v=s.clientY-a.top,h=p<$,f=p>a.width-$,y=v<$,g=v>a.height-$;if(o=h?"left":f?"right":null,i=y?"top":g?"bottom":null,!o&&!i)return;n=!0,k=!0,s.preventDefault();const x=t=>{if(!n)return;const s=m.getBoundingClientRect(),a=m.scrollLeft||0,p=t.clientX-s.left+a,v=t.clientY-s.top,h=u()*c(),f=d-r;if("left"===o){let t=p/h*u();t=Math.min(t,e.data.endTime-.001),e.data.startTime=t}if("right"===o){let t=p/h*u();t=Math.max(t,e.data.startTime+.001),e.data.endTime=t}if("top"===i){let t=(1-v/l)*f+r;t=Math.max(t,e.data.Flow+.1),e.data.Fhigh=t}if("bottom"===i){let t=(1-v/l)*f+r;t=Math.min(t,e.data.Fhigh-.1),e.data.Flow=t}D()},L=()=>{n=!1,k=!1,o=null,i=null,window.removeEventListener("mousemove",x),window.removeEventListener("mouseup",L)};window.addEventListener("mousemove",x,{passive:!0}),window.addEventListener("mouseup",L)}))}(E)}(o,i,s,0,v,p,h,g-y,q,y,g),q=null,B=!1})),m.addEventListener("contextmenu",(e=>{if(!w||C||I)return;e.preventDefault();const t=g.getBoundingClientRect(),n=(1-(e.clientY-t.top)/l)*(d-r)+r,o=E.findIndex((e=>Math.abs(e.freq-n)<1));if(-1!==o)g.removeChild(E[o].div),E.splice(o,1);else{if(E.length>=5)return;const e=Math.round((1-(n-r)/(d-r))*l),t=document.createElement("div");t.style.position="absolute",t.style.top=`${e}px`,t.style.left="0",t.style.width="100%",t.style.height="1px",t.style.background="red",t.style.zIndex="15",g.appendChild(t),E.push({freq:n,div:t})}})),{updateSelections:D,clearSelections:function(){b.forEach((e=>{m.removeChild(e.rect),e.tooltip&&m.removeChild(e.tooltip)})),b.length=0},setFrequencyRange:(e,t)=>{r=e,d=t,D()},hideHover:R,refreshHover:()=>{null!==H&&null!==M&&X({clientX:H,clientY:M})},setPersistentLinesEnabled:e=>{w=e}}}