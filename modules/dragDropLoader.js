import{extractGuanoMetadata,parseGuanoMetadata}from"./guanoReader.js";import{getWavSampleRate,getWavDuration}from"./fileLoader.js";import{addFilesToList,removeFilesByName,setFileMetadata,getCurrentIndex,getFileList}from"./fileState.js";import{showMessageBox}from"./messageBox.js";import{importKmlFile}from"./mapPopup.js";export function initDragDropLoader({targetElementId:e,wavesurfer:t,spectrogramHeight:a,colorMap:n,onPluginReplaced:o,onFileLoaded:r,onBeforeLoad:s,onAfterLoad:i,onSampleRateDetected:l}){const d=document.getElementById(e),m=document.getElementById("drop-overlay"),f=document.getElementById("upload-overlay"),u=document.getElementById("upload-progress-bar"),c=document.getElementById("upload-progress-text"),p=document.getElementById("fileNameText"),g=document.getElementById("guano-output");document.getElementById("spectrogram-settings-text");let y=null;function v(){m.style.display="flex",document.dispatchEvent(new Event("drop-overlay-show"))}function w(){m.style.display="none",document.dispatchEvent(new Event("drop-overlay-hide"))}function h(e,t){if(u){const a=t>0?e/t*100:0;u.style.width=`${a}%`}c&&(c.textContent=`${e}/${t}`)}let E=null;async function x(e){const a=Array.from(e).find((e=>e.name.toLowerCase().endsWith(".kml")));a&&(E=a);const n=Array.from(e).filter((e=>"audio/wav"===e.type||e.name.endsWith(".wav")));if(0===n.length)return showMessageBox({title:"Reminder",message:"Only .wav files are supported."}),void v();var d;d=n.length,f&&(u&&(u.style.width="0%"),c&&(c.textContent=`0/${d}`),f.style.display="flex"),"function"==typeof s&&s();let m=0,w=0;const x=n.sort(((e,t)=>e.name.localeCompare(t.name))),L=[],B=[];for(let e=0;e<x.length;e++){const t=x[e],a=await getWavDuration(t);if(t.size<204800)w++;else if(a>20)m++;else{L.push(t);try{const e=await extractGuanoMetadata(t);B.push(parseGuanoMetadata(e))}catch(e){B.push({date:"",time:"",latitude:"",longitude:""})}}h(e+1,x.length)}removeFilesByName("demo_recording.wav");const F=getFileList().length;if(L.length>0){addFilesToList(L,0);for(let e=0;e<L.length;e++)setFileMetadata(F+e,B[e])}f&&(f.style.display="none"),L.length>0&&(await async function(e){if(!e)return;const a=await getWavSampleRate(e);"function"==typeof s&&s(),"function"==typeof r&&r(e),p&&(p.textContent=e.name);try{const t=await extractGuanoMetadata(e);g.textContent=t||"(No GUANO metadata found)";const a=parseGuanoMetadata(t),n=getCurrentIndex();setFileMetadata(n,a)}catch(e){g.textContent="(Error reading GUANO metadata)"}const n=URL.createObjectURL(e);y&&URL.revokeObjectURL(y),y=n,await t.load(n),"function"==typeof o&&o();const d=a||t?.options?.sampleRate||256e3;"function"==typeof l&&await l(d),"function"==typeof i&&i(),document.dispatchEvent(new Event("file-loaded"))}(L[0]),E&&(await importKmlFile(E),E=null)),m>0&&showMessageBox({title:"Warning",message:`.wav files longer than 20 seconds are not supported and a total of (${m}) such files were skipped during the loading process. Please trim or preprocess these files to meet the duration requirement before loading.`}),w>0&&showMessageBox({title:"Warning",message:`${w} wav files were skipped due to small file size (<200kb).`})}let L=0;function B(e){return Array.from(e.dataTransfer?.types||[]).includes("Files")}d.addEventListener("dragenter",(e=>{B(e)&&(e.preventDefault(),L++,v())})),d.addEventListener("dragleave",(e=>{B(e)&&(e.preventDefault(),L--,0===L&&w())})),d.addEventListener("dragover",(e=>{B(e)&&(e.preventDefault(),e.dataTransfer.dropEffect="move")})),d.addEventListener("drop",(async e=>{if(!B(e))return;e.preventDefault(),L=0,w();x(await async function(e){if(!e.items)return Array.from(e.files);const t=async e=>{if(e.isFile)return new Promise((t=>{e.file((e=>t([e])),(()=>t([])))}));if(e.isDirectory){const a=e.createReader(),n=[],o=()=>new Promise((e=>{a.readEntries((async a=>{if(a.length)n.push(...a),e(await o());else{const a=await Promise.all(n.map(t));e(a.flat())}}),(()=>e([])))}));return o()}return[]},a=Array.from(e.items).map((e=>e.webkitGetAsEntry&&e.webkitGetAsEntry())).filter(Boolean);return a.length?(await Promise.all(a.map(t))).flat():Array.from(e.files)}(e.dataTransfer))}))}