import{getCurrentIndex,getFileMetadata,getFileList,getFileIconState}from"./fileState.js";let importKmlFileFn=null;export function initMapPopup({buttonId:t="mapBtn",popupId:e="mapPopup",mapId:o="map"}={}){const n=document.getElementById(t),i=document.getElementById(e),a=document.getElementById(o),s=document.getElementById("viewer-container"),l=document.getElementById("control-bar"),r=document.getElementById("sidebar"),c=i.querySelector(".popup-drag-bar"),p=i.querySelector(".popup-close-btn"),d=i.querySelector(".popup-min-btn"),m=i.querySelector(".popup-max-btn");if(!n||!i||!a)return;a.style.cursor="default";function u(t,e){const o=i.getBoundingClientRect(),n=t-o.left,a=e-o.top,s=a>=-5&&a<=o.height+5,l=n>=-5&&n<=o.width+5;return{onLeft:Math.abs(n-0)<=5&&s,onRight:Math.abs(n-o.width)<=5&&s,onTop:Math.abs(a-0)<=5&&l,onBottom:Math.abs(a-o.height)<=5&&l}}function g(t){const{onLeft:e,onRight:o,onTop:n,onBottom:i}=t;let a="";return e&&n||o&&i?a="nwse-resize":o&&n||e&&i?a="nesw-resize":e||o?a="ew-resize":(n||i)&&(a="ns-resize"),a}let y=parseInt(localStorage.getItem("mapPopupWidth"),10),f=parseInt(localStorage.getItem("mapPopupHeight"),10);(isNaN(y)||y<=0)&&(y=500),(isNaN(f)||f<=0)&&(f=500),i.style.width=`${y}px`,i.style.height=`${f}px`;let v=null,h=[],E=[],x=null,w=null,b=null,D=[],k=null,P=null,T=null,C=null,z=null,S=!1,$=[],F=null,I=!1,M=null,H=null,N=!1,O=null,B=null;const R=a.querySelector(".coord-scale-wrapper"),A=a.querySelector("#coord-display"),U=a.querySelector("#no-coord-message"),q=a.querySelector("#copy-coord-message");let G=null,K=null,Z=!1,W=null,X=null,Y=null,j=null,V=null;const _=document.createElement("input");_.type="file",_.accept=".kml",_.style.display="none",i.appendChild(_);const J=document.getElementById("map-drop-overlay");let Q=0,tt=!1;function et(){[...h,...$].forEach((t=>{const e=t.getElement?t.getElement():t._icon;e&&(e.style.pointerEvents=tt?"none":"")}))}function ot(){a.style.cursor=Z?"grabbing":S?"text":"default"}function nt(){J&&(J.style.display="none",J.style.pointerEvents="none"),v?.dragging.enable()}function it(){U&&(U.style.display="none")}function at(t,e){if(v=L.map(a).setView([t,e],13),v.createPane("annotationPane"),v.getPane("annotationPane").style.zIndex=650,X=v.zoomControl.getContainer(),v.on("dragstart",(()=>{Z=!0,ot()})),v.on("dragend",(()=>{Z=!1,ot()})),ot(),K=L.control.scale({position:"bottomleft",metric:!0,imperial:!1}).addTo(v),R){const t=K.getContainer();t.style.position="static",R.appendChild(t)}function o(t){if(!A)return;const{lat:e,lng:o}=t;A.textContent=`${e.toFixed(4)} ${o.toFixed(4)}`}v.on("mousemove",(t=>o(t.latlng))),v.on("move",(()=>o(v.getCenter()))),o(v.getCenter()),v.on("contextmenu",(t=>{const{lat:e,lng:o}=t.latlng,n=`${e.toFixed(6)}\t${o.toFixed(6)}`;navigator.clipboard?.writeText(n).catch((()=>{})),q&&(q.style.display="flex",clearTimeout(G),G=setTimeout((()=>{q.style.display="none"}),3e3))}));const n={attribution:"&copy; CARTO"},i={attribution:"&copy; Google"},s=L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{attribution:"&copy; OpenStreetMap contributors",crossOrigin:"anonymous"}).addTo(v),l=L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}",{attribution:"&copy; Esri",crossOrigin:"anonymous"}),r=L.tileLayer("https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",{...n,crossOrigin:"anonymous"}),c=L.tileLayer("https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",{...n,crossOrigin:"anonymous"}),p=L.tileLayer("https://mt1.google.com/vt/lyrs=m&x={x}&y={y}&z={z}",{...i,crossOrigin:"anonymous"}),d=L.tileLayer("https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}",{...i,crossOrigin:"anonymous"}),m=L.tileLayer("https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",{...i,crossOrigin:"anonymous"}),u=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/imagery/wgs84/{z}/{x}/{y}.png",{attribution:"&copy; HKSAR Government",minZoom:0,maxZoom:19,crossOrigin:"anonymous"}),g=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/basemap/wgs84/{z}/{x}/{y}.png",{attribution:"&copy; HKSAR Government",maxZoom:20,minZoom:10,crossOrigin:"anonymous"}),y=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/label/hk/tc/wgs84/{z}/{x}/{y}.png",{attribution:!1,maxZoom:20,minZoom:0,crossOrigin:"anonymous"}),f=L.tileLayer("https://mapapi.geodata.gov.hk/gs/api/v1.0.0/xyz/label/hk/tc/wgs84/{z}/{x}/{y}.png",{attribution:!1,maxZoom:20,minZoom:0,crossOrigin:"anonymous"}),h=L.layerGroup([g,y]),E=L.layerGroup([u,f]);v.on("zoomend",(()=>{v.getZoom()>19&&v.hasLayer(E)&&v.setZoom(19)}));const D={OpenStreetMap:s,"Esri Satellite":l,"Carto Light":r,"Carto Dark":c,"Google Streets":p,"Google Satellite":d,"Google Hybrid":m,"HK Vector":h,"HK Imagery":E};O=L.control.layers(D,null,{position:"topright"}).addTo(v),W=O.getContainer(),fetch("https://raw.githubusercontent.com/PanTong55/spectrogram/main/hkgrid.geojson").then((t=>t.json())).then((t=>{B=L.geoJSON(t,{interactive:!1,style:{color:"#3388ff",weight:2,fillColor:"#3388ff",fillOpacity:0}}),O.addOverlay(B,"1km Grid")})),H=(new L.FeatureGroup).addTo(v);const S=L.canvas({pane:"annotationPane"});M=new L.Control.Draw({position:"topleft",edit:{featureGroup:H},draw:{circlemarker:!1,polyline:{shapeOptions:{renderer:S,pane:"annotationPane"}},polygon:{shapeOptions:{renderer:S,pane:"annotationPane"}},rectangle:{shapeOptions:{renderer:S,pane:"annotationPane"}},circle:{shapeOptions:{renderer:S,pane:"annotationPane"}}}}),v.on(L.Draw.Event.CREATED,(t=>{t.layer&&t.layer instanceof L.Path&&(t.layer.options.renderer=S,t.layer.options.pane="annotationPane"),H.addLayer(t.layer)}));const $=new(L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-route-toggle-control");t.style.display="flex";const e=L.DomUtil.create("a","",t);e.href="#",e.title="Route options",e.innerHTML='<i class="fa-solid fa-route"></i>',w=e,L.DomEvent.disableClickPropagation(t),L.DomEvent.on(t,"mousedown",L.DomEvent.stopPropagation),L.DomEvent.on(t,"dblclick",L.DomEvent.stopPropagation),b=L.DomUtil.create("div","route-button-group",t),b.style.display="none";const o=L.DomUtil.create("a","",b);o.href="#",o.title="Create Route",o.innerHTML='<i class="fa-solid fa-eye"></i>',x=o,L.DomEvent.on(o,"click",L.DomEvent.stop).on(o,"mousedown",L.DomEvent.stopPropagation).on(o,"dblclick",L.DomEvent.stopPropagation).on(o,"click",pt);const n=L.DomUtil.create("a","",b);n.href="#",n.title="Import KML",n.innerHTML='<i class="fa-solid fa-file-import"></i>',k=n,L.DomEvent.on(n,"click",L.DomEvent.stop).on(n,"mousedown",L.DomEvent.stopPropagation).on(n,"dblclick",L.DomEvent.stopPropagation).on(n,"click",(()=>{_.value="",_.click()}));const i=L.DomUtil.create("a","",b);return i.href="#",i.title="Clear KML",i.innerHTML='<i class="fa-solid fa-trash"></i>',P=i,L.DomEvent.on(i,"click",L.DomEvent.stop).on(i,"mousedown",L.DomEvent.stopPropagation).on(i,"dblclick",L.DomEvent.stopPropagation).on(i,"click",rt),L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"mousedown",L.DomEvent.stopPropagation).on(e,"dblclick",L.DomEvent.stopPropagation).on(e,"click",(()=>{const t="flex"===b.style.display;b.style.display=t?"none":"flex",e.classList.toggle("active",!t)})),t}}));v.addControl($),Y=$.getContainer();const F=new(L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-text-toggle-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Text",e.innerHTML='<i class="fa-solid fa-font"></i>',C=e,L.DomEvent.disableClickPropagation(t),L.DomEvent.on(t,"mousedown",L.DomEvent.stopPropagation),L.DomEvent.on(t,"dblclick",L.DomEvent.stopPropagation),L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"mousedown",L.DomEvent.stopPropagation).on(e,"dblclick",L.DomEvent.stopPropagation).on(e,"click",ft),t}}));v.addControl(F),V=F.getContainer();const I=new(L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-export-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Export Map",e.innerHTML='<i class="fa-solid fa-file-export"></i>',z=e,L.DomEvent.disableClickPropagation(t),L.DomEvent.on(t,"mousedown",L.DomEvent.stopPropagation),L.DomEvent.on(t,"dblclick",L.DomEvent.stopPropagation),L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"mousedown",L.DomEvent.stopPropagation).on(e,"dblclick",L.DomEvent.stopPropagation).on(e,"click",mt),t}}));v.addControl(I),j=I.getContainer();const N=new(L.Control.extend({options:{position:"topleft"},onAdd(){const t=L.DomUtil.create("div","leaflet-bar leaflet-draw-toggle-control"),e=L.DomUtil.create("a","",t);return e.href="#",e.title="Draw",e.innerHTML='<i class="fa-solid fa-pen-to-square"></i>',T=e,L.DomEvent.disableClickPropagation(t),L.DomEvent.on(t,"mousedown",L.DomEvent.stopPropagation),L.DomEvent.on(t,"dblclick",L.DomEvent.stopPropagation),L.DomEvent.on(e,"click",L.DomEvent.stop).on(e,"mousedown",L.DomEvent.stopPropagation).on(e,"dblclick",L.DomEvent.stopPropagation).on(e,"click",dt),t}}));v.addControl(N)}function st(){if(!v)return;h.forEach((t=>t.remove())),h=[];const t=getFileList(),e=getCurrentIndex(),o={};function n(t){if(!t)return"";return`${(t.date||"").replace(/\D/g,"")}${t.time||""}`}t.forEach(((t,e)=>{const n=getFileMetadata(e),i=parseFloat(n.latitude),a=parseFloat(n.longitude);if(isNaN(i)||isNaN(a))return;const s=`${i.toFixed(6)},${a.toFixed(6)}`;o[s]||(o[s]=[]),o[s].push({file:t,idx:e,meta:n,lat:i,lon:a})})),Object.values(o).forEach((t=>{t.sort(((t,e)=>n(t.meta).localeCompare(n(e.meta))));const o=t[0],{lat:i,lon:a}=o,s=t.some((t=>t.idx===e)),l=t.every((t=>getFileIconState(t.idx).trash));let r="map-marker-other";s?r="map-marker-current":l&&(r="map-marker-trash");const c=L.divIcon({html:'<i class="fa-solid fa-location-dot"></i>',className:r,iconSize:[28,28],iconAnchor:[14,28]}),p=t.map((t=>t.file.name.replace(/\.wav$/i,""))),d=p.length<=5?p.join("<br>"):`${p[0]}<br>â‹®<br>${p[p.length-1]}`,m=s?1e3:0,u=L.marker([i,a],{icon:c,zIndexOffset:m});u.on("click",(()=>{document.dispatchEvent(new CustomEvent("map-file-selected",{detail:{index:o.idx}}))})),u.bindTooltip(d,{direction:"top",offset:[-3,-32],className:"map-tooltip"}),u.addTo(v),h.push(u)})),et()}function lt(){E.forEach((t=>t.remove())),E=[],x?.classList.remove("active"),x&&(x.innerHTML='<i class="fa-solid fa-eye"></i>')}function rt(){D.forEach((t=>t.remove())),D=[]}async function ct(t){if(!t)return;const e=function(t){const e=(new DOMParser).parseFromString(t,"text/xml"),o=[],n=e.getElementsByTagName("LineString");for(let t=0;t<n.length;t++){const e=n[t].getElementsByTagName("coordinates")[0];if(!e)continue;const i=e.textContent.trim().split(/\s+/).map((t=>{const[e,o]=t.split(",").map(Number);return isNaN(o)||isNaN(e)?null:[o,e]})).filter(Boolean);i.length>1&&o.push(i)}return o}(await t.text());rt();const o=[];e.forEach((t=>{const e=L.polyline(t,{color:"deeppink",weight:2,opacity:.8,renderer:L.canvas()}).addTo(v);D.push(e),o.push(...t)})),o.length>0&&(v.fitBounds(o),ht())}function pt(){E.length>0?lt():(!function(){if(!v)return;lt();const t=getFileList(),e=[];t.forEach(((t,o)=>{const n=getFileMetadata(o),i=parseFloat(n.latitude),a=parseFloat(n.longitude),s=`${(n.date||"").replace(/\D/g,"")}${n.time||""}`;isNaN(i)||isNaN(a)||!s||e.push({lat:i,lon:a,ts:s})})),e.sort(((t,e)=>t.ts.localeCompare(e.ts)));let o=[],n=null;e.forEach((t=>{n&&v.distance([n.lat,n.lon],[t.lat,t.lon])>=1e3&&(o.length>1&&E.push(L.polyline(o,{color:"black",weight:2,opacity:.8,renderer:L.canvas()}).addTo(v)),o=[]),o.push([t.lat,t.lon]),n=t})),o.length>1&&E.push(L.polyline(o,{color:"black",weight:2,opacity:.8,renderer:L.canvas()}).addTo(v))}(),x?.classList.add("active"),x&&(x.innerHTML='<i class="fa-solid fa-eye-slash"></i>'))}function dt(){if(!M)return;!N&&S&&ft(),N?(v.removeControl(M),T?.classList.remove("active"),N=!1):(M.addTo(v),T?.classList.add("active"),N=!0)}function mt(){if(!v||!window.html2canvas)return;const t=v.getContainer(),e=t.querySelector(".leaflet-control-container"),o=[];e&&o.push(e),R&&o.push(R),o.forEach((t=>{t.style.display="none"})),html2canvas(t,{useCORS:!0}).then((t=>{o.forEach((t=>{t.style.display=""}));const e=document.createElement("a");e.href=t.toDataURL("image/png"),e.download="map.png",e.click()})).catch((()=>{o.forEach((t=>{t.style.display=""}))}))}function ut(t,e=!1){const o=e?' title="Left click to edit\nRight click to delete"':"";return L.divIcon({className:"map-text-icon",html:`<span class="map-text-label"${o}>${n=t,n.replace(/[&<>"]/g,(t=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;"}[t])))}</span>`,iconSize:null,iconAnchor:[0,0],popupAnchor:[0,0]});var n}function gt(t){if(!v||F)return;const e=t.getLatLng(),o=v.latLngToContainerPoint(e),n=document.createElement("textarea");n.value=t.text||"",n.className="map-text-input",n.rows=1,n.style.left=`${o.x}px`,n.style.top=`${o.y}px`,v.getContainer().appendChild(n),F=n,v.dragging.disable(),n.focus();const i=()=>{n.style.height="auto",n.style.height=`${n.scrollHeight}px`};i(),n.addEventListener("input",i);const a=()=>{if(!F)return;const e=n.value.trim();v.getContainer().removeChild(n),F=null,v.dragging.enable(),e?(t.text=e,t.setIcon(ut(e,S))):(v.removeLayer(t),$=$.filter((e=>e!==t))),et()};n.addEventListener("keydown",(t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),a())})),n.addEventListener("pointerdown",(t=>t.stopPropagation())),n.addEventListener("blur",(()=>{I=!0,setTimeout((()=>{document.activeElement!==n&&a()}))}))}function yt(t){if(I)return void(I=!1);if(F)return;const e=function(t,e){const o=L.marker(t,{icon:ut(e,S),draggable:S,pane:"annotationPane",zIndexOffset:1e3});return o.text=e,o.on("dblclick",(()=>{S&&gt(o)})),o.on("click",(t=>{S&&!F&&(t.originalEvent.stopPropagation(),gt(o))})),o.on("contextmenu",(()=>{S&&!F&&(v.removeLayer(o),$=$.filter((t=>t!==o)),et())})),o}(t.latlng,"");e.addTo(v),$.push(e),et(),gt(e)}function ft(){const t=!S;t&&N&&dt(),S=t,C?.classList.toggle("active",S),S?v.on("click",yt):(v.off("click",yt),F&&F.blur()),$.forEach((t=>{S?t.dragging.enable():t.dragging.disable();const e=t.text||"";t.setIcon(ut(e,S)),t.setZIndexOffset(1e3)})),et(),ot()}document.addEventListener("keydown",(t=>{"Control"!==t.key||tt||(tt=!0,et())})),document.addEventListener("keyup",(t=>{"Control"===t.key&&tt&&(tt=!1,et())})),a.addEventListener("dragenter",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),Q++,J&&(J.style.display="flex",J.style.pointerEvents="auto"),v?.dragging.disable())})),a.addEventListener("dragover",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),t.dataTransfer.dropEffect="copy")})),a.addEventListener("dragleave",(t=>{t.dataTransfer.types?.includes("Files")&&(t.preventDefault(),Q--,Q<=0&&nt())})),a.addEventListener("drop",(async t=>{t.preventDefault(),Q=0,nt();const e=Array.from(t.dataTransfer.files).find((t=>t.name.endsWith(".kml")));e&&await ct(e)})),importKmlFileFn=ct,_.addEventListener("change",(async()=>{const t=_.files[0];t&&await ct(t)}));const vt=13;function ht(){const t=getCurrentIndex();if(t<0)return st(),navigator.geolocation&&navigator.geolocation.getCurrentPosition((t=>{const{latitude:e,longitude:o}=t.coords,n=L.divIcon({html:'<i class="fa-solid fa-location-pin"></i>',className:"map-marker-device",iconSize:[28,28],iconAnchor:[14,28]});v?v.setView([e,o]):at(e,o);const i=L.marker([e,o],{icon:n,zIndexOffset:1001});i.addTo(v),h.push(i),et()})),void it();const e=getFileMetadata(t),o=parseFloat(e.latitude),n=parseFloat(e.longitude);if(isNaN(o)||isNaN(n))return st(),void(U&&(U.style.display="flex"));it(),v?"block"!==i.style.display?v.setView([o,n],vt):v.setView([o,n]):at(o,n),st()}function Lt(){"block"===i.style.display?(Nt&&Et(),Ot&&xt(),i.style.display="none",document.body.classList.remove("map-open"),S&&ft()):(i.style.display="block",document.body.classList.add("map-open"),i.style.width=`${y}px`,i.style.height=`${f}px`,v&&v.invalidateSize(),ht(),ot())}function Et(){Nt?(i.style.width=`${Bt}px`,i.style.height=`${Rt}px`,i.style.left=`${At}px`,i.style.top=`${Ut}px`,m.innerHTML='<i class="fa-regular fa-square"></i>',Nt=!1):(Bt=i.offsetWidth,Rt=i.offsetHeight,At=i.offsetLeft,Ut=i.offsetTop,i.style.left="0px",i.style.top="0px",i.style.width=window.innerWidth-2+"px",i.style.height=window.innerHeight-2+"px",m.innerHTML='<i class="fa-regular fa-clone"></i>',Nt=!0),v?.invalidateSize()}function xt(){Ot?(i.style.width=`${qt}px`,i.style.height=`${Gt}px`,i.style.left=`${Kt}px`,i.style.top=`${Zt}px`,d.innerHTML='<i class="fa-solid fa-window-minimize"></i>',W&&(W.style.display=""),X&&(X.style.display=""),Y&&(Y.style.display=""),j&&(j.style.display=""),R&&(R.style.display=""),V&&V.style.setProperty("margin-top","1px","important"),Ot=!1):(Nt&&Et(),qt=i.offsetWidth,Gt=i.offsetHeight,Kt=i.offsetLeft,Zt=i.offsetTop,i.style.left="0px",i.style.top=window.innerHeight-362+"px",i.style.width="290px",i.style.height="360px",d.innerHTML='<i class="fa-solid fa-window-maximize"></i>',W&&(W.style.display="none"),X&&(X.style.display="none"),Y&&(Y.style.display="none"),j&&(j.style.display="none"),R&&(R.style.display="none"),V&&V.style.setProperty("margin-top","10px","important"),Ot=!0),v?.invalidateSize()}let wt=!1,bt=0,Dt=0,kt=!1,Pt=!1,Tt=!1,Ct=!1,zt=!1,St=0,$t=0,Ft=0,It=0,Mt=0,Ht=0,Nt=!1,Ot=!1,Bt=0,Rt=0,At=0,Ut=0,qt=0,Gt=0,Kt=0,Zt=0;function Wt(){s&&(s.style.pointerEvents="none",s.classList.remove("hide-cursor")),l&&(l.style.pointerEvents="none"),r&&(r.style.pointerEvents="none")}function Xt(){s&&(s.style.pointerEvents=""),l&&(l.style.pointerEvents=""),r&&(r.style.pointerEvents="")}c&&c.addEventListener("mousedown",(t=>{Nt||(wt=!0,bt=t.clientX-i.offsetLeft,Dt=t.clientY-i.offsetTop,v?.dragging.disable(),Wt(),document.dispatchEvent(new Event("hide-spectrogram-hover")),t.preventDefault(),t.stopPropagation())})),i.addEventListener("mousemove",(t=>{if(Nt)return;if(wt||kt)return void t.stopPropagation();const e=g(u(t.clientX,t.clientY))||"default";i.style.cursor=e,"default"!==e?(a.style.cursor=e,document.body.style.cursor=e,Wt(),document.dispatchEvent(new Event("hide-spectrogram-hover")),t.stopPropagation()):(a.style.cursor="",document.body.style.cursor="",Xt(),ot())})),i.addEventListener("mousedown",(t=>{if(Nt)return;if(t.target===c||c.contains(t.target))return;const e=u(t.clientX,t.clientY);if(e.onLeft||e.onRight||e.onTop||e.onBottom){kt=!0,Pt=e.onLeft,Tt=e.onRight,Ct=e.onTop,zt=e.onBottom;const o=g(e)||"default";i.style.cursor=o,a.style.cursor=o,document.body.style.cursor=o,Wt(),document.dispatchEvent(new Event("hide-spectrogram-hover")),St=t.clientX,$t=t.clientY,Ft=i.offsetWidth,It=i.offsetHeight,Mt=i.offsetLeft,Ht=i.offsetTop,v?.dragging.disable(),t.preventDefault(),t.stopPropagation()}})),document.addEventListener("mousemove",(t=>{if("block"!==i.style.display||Nt)return;if(wt||kt)return void t.stopPropagation();const e=g(u(t.clientX,t.clientY));e?(document.body.style.cursor=e,a.style.cursor=e,Wt(),document.dispatchEvent(new Event("hide-spectrogram-hover")),t.stopPropagation()):(document.body.style.cursor="",a.style.cursor="",Xt(),ot())}),!0),document.addEventListener("mousedown",(t=>{if("block"!==i.style.display||Nt)return;if(wt||kt)return t.stopPropagation(),void t.preventDefault();if(t.target===c||c.contains(t.target))return;const e=u(t.clientX,t.clientY);if(e.onLeft||e.onRight||e.onTop||e.onBottom){kt=!0,Pt=e.onLeft,Tt=e.onRight,Ct=e.onTop,zt=e.onBottom;const o=g(e)||"default";i.style.cursor=o,a.style.cursor=o,document.body.style.cursor=o,Wt(),document.dispatchEvent(new Event("hide-spectrogram-hover")),St=t.clientX,$t=t.clientY,Ft=i.offsetWidth,It=i.offsetHeight,Mt=i.offsetLeft,Ht=i.offsetTop,v?.dragging.disable(),t.preventDefault(),t.stopPropagation()}}),!0),window.addEventListener("mousemove",(t=>{if(!Nt){if(wt)return i.style.left=t.clientX-bt+"px",i.style.top=t.clientY-Dt+"px",void t.stopPropagation();if(kt){const e=t.clientX-St,o=t.clientY-$t;a.style.cursor=i.style.cursor,document.body.style.cursor=i.style.cursor,Wt(),document.dispatchEvent(new Event("hide-spectrogram-hover")),Tt&&(y=Math.max(200,Ft+e),i.style.width=`${y}px`),zt&&(f=Math.max(200,It+o),i.style.height=`${f}px`),Pt&&(y=Math.max(200,Ft-e),i.style.width=`${y}px`,i.style.left=`${Mt+e}px`),Ct&&(f=Math.max(200,It-o),i.style.height=`${f}px`,i.style.top=`${Ht+o}px`),t.stopPropagation()}}}),!0),window.addEventListener("mouseup",(t=>{Nt||(wt&&(wt=!1,v?.dragging.enable(),Xt(),t.stopPropagation()),kt&&(kt=!1,v?.dragging.enable(),localStorage.setItem("mapPopupWidth",y),localStorage.setItem("mapPopupHeight",f),v?.invalidateSize(),document.body.style.cursor="",i.style.cursor="",a.style.cursor="",Xt(),ot(),t.stopPropagation()))}),!0),n.addEventListener("click",Lt),m?.addEventListener("click",Et),d?.addEventListener("click",xt),p&&p.addEventListener("click",Lt),window.addEventListener("resize",(()=>{Nt?(i.style.width=window.innerWidth-2+"px",i.style.height=window.innerHeight-2+"px",v?.invalidateSize()):Ot&&(i.style.top=window.innerHeight-362+"px")})),document.addEventListener("file-loaded",ht),document.addEventListener("file-list-cleared",(()=>st())),document.addEventListener("file-list-changed",(()=>st())),document.addEventListener("file-icon-toggled",(()=>st()))}export async function importKmlFile(t){importKmlFileFn&&t&&await importKmlFileFn(t)}