import{initDropdown}from"./dropdown.js";import{autoIdHK}from"./autoid_HK.js";export function initAutoIdPanel({buttonId:e="autoIdBtn",panelId:t="auto-id-panel",viewerId:n="viewer-container",containerId:l="spectrogram-only",overlayId:s="fixed-overlay",spectrogramHeight:i=800,getDuration:a=(()=>0),getFreqRange:o=(()=>({min:0,max:0})),hideHover:c=(()=>{}),refreshHover:r=(()=>{})}={}){const d=document.getElementById(e),u=document.getElementById(t),m=u.querySelector(".popup-drag-bar"),p=u.querySelector(".popup-close-btn"),v=document.getElementById(n),y=document.getElementById(l),E=document.getElementById(s),f="http://www.w3.org/2000/svg",h=document.createElementNS(f,"svg");h.id="autoid-lines",E.appendChild(h);const g=document.getElementById("layout");g&&u&&u.parentElement!==g&&g.appendChild(u);const L=document.getElementById("autoIdTabResetBtn"),k=document.getElementById("autoid-tabs"),x=[],F=Array.from({length:8},(()=>({callType:3,harmonic:0,autoIdResult:null,showValidation:!1,inputs:{start:"",end:"",high:"",low:"",knee:"",heel:"",cfStart:"",cfEnd:""},startTime:null,endTime:null,markers:{start:{el:null,freq:null,time:null},end:{el:null,freq:null,time:null},high:{el:null,freq:null,time:null},low:{el:null,freq:null,time:null},knee:{el:null,freq:null,time:null},heel:{el:null,freq:null,time:null},cfStart:{el:null,freq:null,time:null},cfEnd:{el:null,freq:null,time:null}},line:null,resultEl:null,curves:{}})));let b=0;if(!d||!u||!v)return;function I(){const e="block"===u.style.display;u.style.display=e?"none":"block",document.body.classList.toggle("autoid-open",!e),document.dispatchEvent(new Event(e?"autoid-close":"autoid-open"))}d.addEventListener("click",I),p?.addEventListener("click",I);let w=!1,q=0,C=0;function N(e){w&&(u.style.left=e.clientX-q+"px",u.style.top=e.clientY-C+"px")}function M(){w=!1,document.removeEventListener("mousemove",N),c()}m?.addEventListener("mousedown",(e=>{w=!0,q=e.clientX-u.offsetLeft,C=e.clientY-u.offsetTop,c(),document.addEventListener("mousemove",N,{passive:!0}),document.addEventListener("mouseup",M,{once:!0}),e.preventDefault()})),L?.addEventListener("click",qe);const B=initDropdown("callTypeInput",["CF-FM","FM-CF-FM","FM","FM-QCF","QCF"]),T=initDropdown("harmonicInput",["0","1","2","3"]);if(T.onChange=function(e,t){F[b].harmonic=t,te||oe()},k){k.title="Prev tag (Ctrl + ←), Next tag (Ctrl + →)";for(let e=0;e<8;e++){const t=document.createElement("button");t.textContent=`${e+1}`,t.className="tab-btn",t.title=`Tag ${e+1}`,0===e&&t.classList.add("active"),t.addEventListener("click",(()=>re(e))),k.appendChild(t),x.push(t)}}const R={start:document.getElementById("startFreqInput"),end:document.getElementById("endFreqInput"),high:document.getElementById("highFreqInput"),low:document.getElementById("lowFreqInput"),knee:document.getElementById("kneeFreqInput"),heel:document.getElementById("heelFreqInput"),cfStart:document.getElementById("cfStartFreqInput"),cfEnd:document.getElementById("cfEndFreqInput")},$={start:document.getElementById("startFreqRow"),end:document.getElementById("endFreqRow"),high:document.getElementById("highFreqRow"),low:document.getElementById("lowFreqRow"),knee:document.getElementById("kneeFreqRow"),heel:document.getElementById("heelFreqRow"),cfStart:document.getElementById("cfStartFreqRow"),cfEnd:document.getElementById("cfEndFreqRow")},A=document.getElementById("bandwidthVal"),j=document.getElementById("durationVal"),S=document.getElementById("pulseIdBtn"),O=document.getElementById("sequenceIdBtn"),K=document.getElementById("autoIdResult"),D=document.getElementById("bandwidth-warning"),H=document.getElementById("freq-order-warning"),P=document.getElementById("knee-order-warning"),Q=document.getElementById("time-order-warning");const V={start:"#e74c3c",end:"#004cff",high:"#3498db",low:"#9b59b6",knee:"#f39c12",heel:"#16a085",cfStart:"#e67e22",cfEnd:"#1abc9c"},W={start:"Start freq.",end:"End freq.",high:"High freq.",low:"Low freq.",knee:"Knee freq.",heel:"Heel freq.",cfStart:"CF start",cfEnd:"CF end"};let X=F[b].markers,Y=null,U=null,_=null,z=null,G=null,J=null,Z=null,ee=!0,te=!1,ne=!1,le=!1;function se(){Z=null,ie()}function ie(){F.forEach(((e,t)=>{Object.values(e.curves||{}).forEach((e=>{const n=t===b&&Z===e.p1Key,l=t===b&&Z===e.p2Key;e.cp1El&&(e.cp1El.style.display=n?"block":"none"),e.cp1LineEl&&(e.cp1LineEl.style.display=n?"block":"none"),e.cp2El&&(e.cp2El.style.display=l?"block":"none"),e.cp2LineEl&&(e.cp2LineEl.style.display=l?"block":"none")}))}))}function ae(){const e=F[b].autoIdResult;K&&(e?K.innerHTML=Ce(e):K.textContent="-")}function oe(){null!=F[b].autoIdResult&&(F[b].autoIdResult=null,ae(),he())}function ce(e){const t=F[e];X=t.markers,te=!0,B.select(t.callType),T.select(t.harmonic),te=!1,Object.keys(R).forEach((e=>{R[e].value=t.inputs[e]||"",null!=t.markers[e].time?R[e].dataset.time=t.markers[e].time:delete R[e].dataset.time})),U=t.startTime,_=t.endTime,ve(),he(),ae(),Ne()}function re(e){e!==b&&(!function(){const e=F[b];e.callType=B.selectedIndex,e.harmonic=T.selectedIndex,e.startTime=U,e.endTime=_,Object.keys(R).forEach((t=>{e.inputs[t]=R[t].value}))}(),x[b]&&x[b].classList.remove("active"),b=e,x[b]&&x[b].classList.add("active"),Z=null,ce(e))}function de(e){ee=e,document.body.classList.toggle("markers-disabled",!e)}function ue(e){const t=R[e];t&&(t.value="",delete t.dataset.time,t.classList.remove("active-get"),t.classList.remove("invalid"),t.classList.remove("warning"),X[e].freq=null,X[e].time=null,X[e].el&&(X[e].el.style.display="none"),"start"===e&&(U=null),"end"===e&&(_=null),F[b].inputs[e]="",F[b].markers[e].freq=null,F[b].markers[e].time=null,F[b].startTime=U,F[b].endTime=_,ve(),he(),te||oe(),Ne())}document.addEventListener("click",se),de(!0),Object.entries(R).forEach((([e,t])=>{t&&(t.dataset.key=e,t.readOnly=!0,t.addEventListener("click",(()=>{if(Y===t)return t.classList.remove("active-get"),Y=null,void de(!0);Y&&Y.classList.remove("active-get"),Y=t,t.classList.add("active-get"),de(!1)})))}));const me={};function pe(e,t){const n=$[e];if(!n)return;n.style.display=t?"flex":"none",R[e]&&(R[e].disabled=!t);const l=me[e];l&&(l.disabled=!t),t||ue(e),Ne()}function ve(){const e=B.items[B.selectedIndex],t=parseFloat(R.high.value),n=parseFloat(R.low.value),l=parseFloat(R.knee.value),s=parseFloat(R.cfStart.value),i=parseFloat(R.end.value);let a=null;["FM-CF-FM","CF-FM"].includes(e)?isNaN(s)||isNaN(i)?A.textContent="-":(a=s-i,A.textContent=a.toFixed(1)):isNaN(t)||isNaN(n)?A.textContent="-":(a=t-n,A.textContent=a.toFixed(1));const o=Object.values(X).filter((e=>null!=e.time&&!isNaN(e.freq))).map((e=>e.time));if(o.length>=2){const e=Math.max(...o),t=Math.min(...o);j.textContent=(1e3*(e-t)).toFixed(1)}else j.textContent="-";!function(e,t,n,l,s,i){const a="QCF"===B.items[B.selectedIndex]&&null!=l&&l>5,o=!isNaN(e)&&!isNaN(t)&&t>e,c=!isNaN(n)&&!isNaN(t)&&n<t,r=null!=s&&null!=i&&i<s,d=a||o||c||r;R.high&&R.high.classList.toggle("warning",a||o),R.low&&R.low.classList.toggle("warning",a||o||c),R.knee&&R.knee.classList.toggle("warning",c),R.start&&R.start.classList.toggle("warning",r),R.end&&R.end.classList.toggle("warning",r),D&&(D.style.display=a?"flex":"none"),H&&(H.style.display=o?"flex":"none"),P&&(P.style.display=c?"flex":"none"),Q&&(Q.style.display=r?"flex":"none"),S&&(S.disabled=d),O&&(O.disabled=d)}(t,n,l,a,U,_)}function ye(e,t){const n=document.createElement("i");n.className=`fa-solid fa-xmark freq-marker marker-${e}`,n.style.color=V[e],n.dataset.key=e,n.dataset.tab=t;const l=W[e]||e;return n.dataset.title=l,n.setAttribute("aria-label",l),n.addEventListener("mouseenter",c),n.addEventListener("mouseleave",r),n.addEventListener("mousedown",(t=>{ee&&(t.stopPropagation(),c(),v.classList.add("hide-cursor"),n.classList.add("hide-cursor"),z=e,G=n,ne=!1,document.addEventListener("mousemove",Fe,{passive:!0}),document.addEventListener("mouseup",be,{once:!0}))})),n.addEventListener("click",(t=>{t.stopPropagation(),ne?ne=!1:function(e){Z=e,ie()}(e)})),E.appendChild(n),n}function Ee(e,t,n){const l=document.createElement("div");return l.className="path-handle",l.dataset.tab=e,l.dataset.seg=t,l.dataset.handle=n,l.addEventListener("mousedown",(s=>{ee&&(s.stopPropagation(),c(),v.classList.add("hide-cursor"),l.classList.add("hide-cursor"),J={tabIdx:e,segKey:t,handleKey:n,el:l},document.addEventListener("mousemove",Ie,{passive:!0}),document.addEventListener("mouseup",we,{once:!0}))})),l.addEventListener("mouseenter",c),l.addEventListener("mouseleave",r),l.addEventListener("contextmenu",(e=>{e.preventDefault(),e.stopPropagation()})),l.addEventListener("click",(e=>e.stopPropagation())),l.style.display="none",E.appendChild(l),l}function fe(e){const t=document.createElement("div");return t.className="pulseid-result",t.dataset.tab=e,E.appendChild(t),t.addEventListener("click",(t=>{t.stopPropagation(),"block"!==u.style.display&&(u.style.display="block",document.body.classList.add("autoid-open"),document.dispatchEvent(new Event("autoid-open"))),re(e)})),t.addEventListener("mouseenter",c),t.addEventListener("mouseleave",r),t.addEventListener("contextmenu",(e=>{e.preventDefault(),e.stopPropagation()})),t}function he(){const{min:e,max:t}=o(),n=y.scrollWidth;F.forEach(((l,s)=>{let o=1/0,c=-1/0,r=-1/0,d=!1;Object.entries(l.markers).forEach((([l,u])=>{if(u.el||(u.el=ye(l,s)),null==u.freq||null==u.time)return void(u.el.style.display="none");const m=u.time/a()*n-v.scrollLeft,p=(1-(u.freq-e)/(t-e))*i;u.el.style.left=`${m}px`,u.el.style.top=`${p}px`,u.el.style.display="block",u.el.style.pointerEvents=s!==b||le?"none":"auto",u.el.style.opacity=s===b?"1":"0.5",u.el.dataset.freq=u.freq,u.el.dataset.time=u.time,o=Math.min(o,m),c=Math.max(c,m),r=Math.max(r,p),d=!0})),l.resultEl||(l.resultEl=fe(s));const u=l.resultEl;l.autoIdResult&&d?(u.innerHTML=Ce(l.autoIdResult),u.style.left=(o+c)/2+"px",u.style.top=`${r+20}px`,u.style.display="block",u.classList.toggle("inactive",s!==b)):u.style.display="none"})),ke()}function ge(e,t){const n=v.scrollLeft||0,{min:l,max:s}=o();return{time:(e+n)/y.scrollWidth*a(),freq:(1-t/i)*(s-l)+l}}function Le(e,t){const n=y.scrollWidth,{min:l,max:s}=o();return{x:e/a()*n-v.scrollLeft,y:(1-(t-l)/(s-l))*i}}function ke(){const{min:e,max:t}=o(),n=y.scrollWidth;F.forEach(((l,s)=>{l.line||(l.line=document.createElementNS(f,"path"),l.line.dataset.tab=s,h.appendChild(l.line));const o=Object.entries(l.markers).filter((([e,t])=>null!=t.freq&&null!=t.time)).sort(((e,t)=>e[1].time-t[1].time)).map((([l,s])=>({x:s.time/a()*n-v.scrollLeft,y:(1-(s.freq-e)/(t-e))*i,key:l})));if(o.length<2)return l.line.setAttribute("d",""),l.line.style.display="none",Object.values(l.curves||{}).forEach((e=>{e.cp1El?.remove(),e.cp2El?.remove(),e.cp1LineEl?.remove(),e.cp2LineEl?.remove()})),void(l.curves={});const c=function(e,t,n,l=.5){if(e.length<2)return"";let s=`M ${e[0].x} ${e[0].y}`;const i=10,a=[];for(let o=0;o<e.length-1;o++){const c=e[o-1]||e[o],r=e[o],d=e[o+1],u=e[o+2]||d,m=`${r.key}-${d.key}`;a.push(m);const p=o===e.length-2,v=Math.abs(r.y-d.y);if("cfStart"===r.key&&"cfEnd"===d.key){t.curves[m]&&(t.curves[m].cp1El?.remove(),t.curves[m].cp2El?.remove(),t.curves[m].cp1LineEl?.remove(),t.curves[m].cp2LineEl?.remove(),delete t.curves[m]),s+=` L ${d.x} ${d.y}`;continue}if(p&&v<5){t.curves[m]&&(t.curves[m].cp1El?.remove(),t.curves[m].cp2El?.remove(),t.curves[m].cp1LineEl?.remove(),t.curves[m].cp2LineEl?.remove(),delete t.curves[m]),s+=` L ${r.x} ${d.y} L ${d.x} ${d.y}`;continue}t.curves[m]||(t.curves[m]={});const y=t.curves[m];let E,g,L,k;y.p1Key=r.key,y.p2Key=d.key;const x=z&&(r.key===z||d.key===z);if(!x&&y.cp1&&y.cp2)({x:E,y:g}=Le(y.cp1.time,y.cp1.freq)),({x:L,y:k}=Le(y.cp2.time,y.cp2.freq));else{if(E=r.x+(d.x-c.x)*l/6,g=r.y+(d.y-c.y)*l/6,L=d.x-(u.x-r.x)*l/6,k=d.y-(u.y-r.y)*l/6,"high"===r.key&&"knee"===d.key){const e=Math.hypot(d.x-r.x,d.y-r.y),t=Math.hypot(u.x-d.x,u.y-d.y),n=e?1+t/e*5:1;L=d.x-(u.x-r.x)*l/6*n,k=d.y-(u.y-r.y)*l/6*n}if("cfStart"!==d.key&&"end"!==d.key){const e=Math.abs(r.y-d.y),t=Math.min(i,.6*e);k=Math.min(k,d.y+t),L=Math.min(L,d.x)}const e=ge(E,g),t=ge(L,k);y.cp1=e,y.cp2=t}if(x)y.cp1El?.remove(),y.cp2El?.remove(),y.cp1LineEl?.remove(),y.cp2LineEl?.remove(),delete y.cp1El,delete y.cp2El,delete y.cp1LineEl,delete y.cp2LineEl;else{y.cp1El||(y.cp1El=Ee(n,m,"cp1")),y.cp2El||(y.cp2El=Ee(n,m,"cp2")),y.cp1LineEl||(y.cp1LineEl=document.createElementNS(f,"line"),y.cp1LineEl.classList.add("handle-connector"),y.cp1LineEl.style.display="none",y.cp1LineEl.setAttribute("stroke","#4b0082"),y.cp1LineEl.setAttribute("stroke-width","1"),h.appendChild(y.cp1LineEl)),y.cp2LineEl||(y.cp2LineEl=document.createElementNS(f,"line"),y.cp2LineEl.classList.add("handle-connector"),y.cp2LineEl.style.display="none",y.cp2LineEl.setAttribute("stroke","#4b0082"),y.cp2LineEl.setAttribute("stroke-width","1"),h.appendChild(y.cp2LineEl)),y.cp1El.style.left=`${E}px`,y.cp1El.style.top=`${g}px`,y.cp2El.style.left=`${L}px`,y.cp2El.style.top=`${k}px`;const e=5;y.cp1LineEl.setAttribute("x1",r.x),y.cp1LineEl.setAttribute("y1",r.y);const t=E-r.x,l=g-r.y,s=Math.hypot(t,l)||1,i=E-t/s*e,a=g-l/s*e;y.cp1LineEl.setAttribute("x2",i),y.cp1LineEl.setAttribute("y2",a),y.cp2LineEl.setAttribute("x1",d.x),y.cp2LineEl.setAttribute("y1",d.y);const o=L-d.x,c=k-d.y,u=Math.hypot(o,c)||1,p=L-o/u*e,v=k-c/u*e;y.cp2LineEl.setAttribute("x2",p),y.cp2LineEl.setAttribute("y2",v)}s+=` C ${E} ${g} ${L} ${k} ${d.x} ${d.y}`}return Object.keys(t.curves).forEach((e=>{if(!a.includes(e)){const n=t.curves[e];n.cp1El?.remove(),n.cp2El?.remove(),n.cp1LineEl?.remove(),n.cp2LineEl?.remove(),delete t.curves[e]}})),s}(o,l,s);l.line.setAttribute("stroke-linejoin","round"),l.line.setAttribute("d",c),l.line.style.display="block",l.line.style.opacity=s===b?"1":"0.5"})),ie()}function xe(e,t=b){const n=F[t];Object.entries(n.curves||{}).forEach((([t,l])=>{l.p1Key!==e&&l.p2Key!==e||(l.cp1El?.remove(),l.cp2El?.remove(),l.cp1LineEl?.remove(),l.cp2LineEl?.remove(),delete n.curves[t])})),se()}function Fe(e){if(!z||!ee)return;ne||(xe(z),ke()),ne=!0;const t=v.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,s=v.scrollLeft||0,{min:c,max:r}=o(),d=(1-l/i)*(r-c)+c,u=(n+s)/y.scrollWidth*a(),m=R[z];m&&(m.value=d.toFixed(1),m.dataset.time=u,m===R.start&&(U=u),m===R.end&&(_=u)),F[b].startTime=U,F[b].endTime=_,X[z].freq=d,X[z].time=u,ve(),he()}function be(){const e=z;z=null,G&&(G.classList.remove("hide-cursor"),G=null),document.removeEventListener("mousemove",Fe),v.classList.remove("hide-cursor"),r(),Ne(),oe(),e&&ne&&(xe(e),ke())}function Ie(e){if(!J||!ee)return;const t=v.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,{time:s,freq:i}=ge(n,l),{tabIdx:a,segKey:o,handleKey:c}=J,r=F[a].curves[o];r&&(r[c]={time:s,freq:i}),ke()}function we(){J&&(J.el.classList.remove("hide-cursor"),J=null,document.removeEventListener("mousemove",Ie),v.classList.remove("hide-cursor"),r(),oe())}function qe(){var e;F[b].showValidation=!1,(e=F[b]).callType=3,e.harmonic=0,e.autoIdResult=null,e.showValidation=!1,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")})),Object.values(e.curves||{}).forEach((e=>{e.cp1El?.remove(),e.cp2El?.remove(),e.cp1LineEl?.remove(),e.cp2LineEl?.remove()})),e.curves={},e.line&&(e.line.setAttribute("d",""),e.line.style.display="none"),B.select(3),T.select(0),Object.values(R).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"),e.classList.remove("invalid"),e.classList.remove("warning"))})),A.textContent="-",j.textContent="-",U=null,_=null,Y=null,F[b].autoIdResult=null,Z=null,de(!0),ce(b)}function Ce(e){return e.split(" / ").map((e=>{if(e.endsWith("sp.")){return`<i>${e.replace(" sp.","")}</i> sp.`}return"TBC"===e||"-"===e||"No species matched"===e?e:`<i>${e}</i>`})).join(" / ")}function Ne(e=!1){const t=F[b];e&&(t.showValidation=!0);const n=t.showValidation,l={"CF-FM":["cfStart","cfEnd"],"FM-CF-FM":["cfStart","cfEnd"],FM:["high","low"],"FM-QCF":["high","low","knee"],QCF:["high","low"]}[B.items[B.selectedIndex]]||[];let s=!0;return Object.entries(R).forEach((([e,t])=>{if(t)if(l.includes(e)){const e=parseFloat(t.value),l=!isNaN(e);n?t.classList.toggle("invalid",!l):t.classList.remove("invalid"),l||(s=!1)}else t.classList.remove("invalid")})),s}function Me(){if(!Ne(!0))return F[b].autoIdResult=null,K&&(K.textContent="-"),void he();const e=B.items[B.selectedIndex],t=parseFloat(R.high.value),n=parseFloat(R.low.value),l=parseFloat(R.knee.value),s=parseFloat(R.heel.value),i=parseFloat(R.start.value),a=parseFloat(R.end.value),o=parseFloat(R.cfStart.value),c=parseFloat(R.cfEnd.value);let r=null;const d=Object.values(X).filter((e=>null!=e.time&&!isNaN(e.freq))).map((e=>e.time));if(d.length>=2){r=1e3*(Math.max(...d)-Math.min(...d))}let u=null;["FM-CF-FM","CF-FM"].includes(e)?isNaN(o)||isNaN(a)||(u=o-a):isNaN(t)||isNaN(n)||(u=t-n);const m=null!=X.knee.time&&null!=X.low.time?1e3*(X.knee.time-X.low.time):null,p=isNaN(l)||isNaN(n)?null:l-n,v=isNaN(s)||isNaN(n)?null:s-n,y=isNaN(l)||isNaN(s)?null:l-s,E=parseInt(T.items[T.selectedIndex],10),f=autoIdHK({callType:e,harmonic:E,highestFreq:t,lowestFreq:n,kneeFreq:l,heelFreq:s,startFreq:i,endFreq:a,cfStart:o,cfEnd:c,duration:r,bandwidth:u,kneeLowTime:m,kneeLowBandwidth:p,heelLowBandwidth:v,kneeHeelBandwidth:y});F[b].autoIdResult=f,ae(),he()}return u.querySelectorAll(".autoid-marker[data-key]").forEach((e=>{const t=e.dataset.key;me[t]=e,e.addEventListener("click",(e=>{e.preventDefault(),ue(t)}))})),B.onChange=function(e,t){const n=["CF-FM","FM-CF-FM"].includes(e),l=["CF-FM","FM-CF-FM","QCF"].includes(e),s=["QCF","FM-QCF","FM"].includes(e);pe("high",!n),pe("low",!n),pe("knee",!l),pe("heel",!l),pe("cfStart",!s),pe("cfEnd",!s),F[b].callType=t,te||oe(),ve(),ke(),Ne()},T.select(0),B.select(3),ce(0),document.addEventListener("keydown",(e=>{"Control"!==e.key||le||(le=!0,he())})),document.addEventListener("keyup",(e=>{"Control"===e.key&&le&&(le=!1,he())})),v.addEventListener("click",(e=>{if(!Y)return;const t=v.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,s=v.scrollLeft||0,{min:c,max:r}=o(),d=(1-l/i)*(r-c)+c,u=(n+s)/y.scrollWidth*a(),m=Y.dataset.key;Y.value=d.toFixed(1),Y.dataset.time=u,X[m].freq=d,X[m].time=u,Y===R.start&&(U=u),Y===R.end&&(_=u),F[b].startTime=U,F[b].endTime=_,Y.classList.remove("active-get"),Y=null,de(!0),ve(),he(),oe()})),v.addEventListener("scroll",he),S?.addEventListener("click",Me),O?.addEventListener("click",(function(){Me()})),document.addEventListener("keydown",(e=>{document.body.classList.contains("autoid-open")&&("INPUT"===e.target.tagName||"TEXTAREA"===e.target.tagName||e.target.isContentEditable||("Enter"===e.key&&e.ctrlKey?(e.preventDefault(),S?.click()):"Enter"===e.key&&e.shiftKey?(e.preventDefault(),O?.click()):e.ctrlKey&&"ArrowLeft"===e.key?(e.preventDefault(),b>0&&re(b-1)):e.ctrlKey&&"ArrowRight"===e.key&&(e.preventDefault(),b<7&&re(b+1))))})),{updateMarkers:he,reset:function(){F.forEach((e=>{e.showValidation=!1,e.callType=3,e.harmonic=0,e.autoIdResult=null,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.keys(e.markers).forEach((t=>{e.markers[t].freq=null,e.markers[t].time=null})),Object.values(e.curves||{}).forEach((e=>{e.cp1El?.remove(),e.cp2El?.remove(),e.cp1LineEl?.remove(),e.cp2LineEl?.remove()})),e.curves={},e.line&&(e.line.setAttribute("d",""),e.line.style.display="none")})),B.select(3),T.select(0),Object.values(R).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"),e.classList.remove("invalid"),e.classList.remove("warning"))})),A.textContent="-",j.textContent="-",U=null,_=null,F.forEach((e=>{Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")}))})),Y=null,Z=null,de(!0),ce(b)},resetCurrentTab:qe,setMarkerAt:function(e,t,n){const l=R[e];l&&(l.value=t.toFixed(1),l.dataset.time=n,X[e].freq=t,X[e].time=n,"start"===e&&(U=n),"end"===e&&(_=n),F[b].startTime=U,F[b].endTime=_,ve(),he(),oe(),Ne())},removeMarker:function(e){ue(e)},isFieldEnabled:function(e){const t=R[e];return t&&!t.disabled},getFreqRange:o,getDuration:()=>a(),spectrogramHeight:i}}