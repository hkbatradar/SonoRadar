import{initDropdown}from"./dropdown.js";import{autoIdHK}from"./autoid_HK.js";export function initAutoIdPanel({buttonId:e="autoIdBtn",panelId:t="auto-id-panel",viewerId:n="viewer-container",containerId:l="spectrogram-only",overlayId:a="fixed-overlay",spectrogramHeight:s=800,getDuration:i=(()=>0),getFreqRange:o=(()=>({min:0,max:0})),hideHover:r=(()=>{}),refreshHover:d=(()=>{})}={}){const c=document.getElementById(e),u=document.getElementById(t),m=u.querySelector(".popup-drag-bar"),f=u.querySelector(".popup-close-btn"),y=document.getElementById(n),p=document.getElementById(l),h=document.getElementById(a),g="http://www.w3.org/2000/svg",v=document.createElementNS(g,"svg");v.id="autoid-lines",h.appendChild(v);const E=document.getElementById("layout");E&&u&&u.parentElement!==E&&E.appendChild(u);const F=document.getElementById("autoIdTabResetBtn"),k=document.getElementById("autoid-tabs"),I=[],L=Array.from({length:8},(()=>({callType:3,harmonic:0,autoIdResult:null,showValidation:!1,inputs:{start:"",end:"",high:"",low:"",knee:"",heel:"",cfStart:"",cfEnd:""},startTime:null,endTime:null,markers:{start:{el:null,freq:null,time:null},end:{el:null,freq:null,time:null},high:{el:null,freq:null,time:null},low:{el:null,freq:null,time:null},knee:{el:null,freq:null,time:null},heel:{el:null,freq:null,time:null},cfStart:{el:null,freq:null,time:null},cfEnd:{el:null,freq:null,time:null}},line:null,resultEl:null})));let x=0;if(!c||!u||!y)return;function w(){const e="block"===u.style.display;u.style.display=e?"none":"block",document.body.classList.toggle("autoid-open",!e),document.dispatchEvent(new Event(e?"autoid-close":"autoid-open"))}c.addEventListener("click",w),f?.addEventListener("click",w);let b=!1,q=0,C=0;function N(e){b&&(u.style.left=e.clientX-q+"px",u.style.top=e.clientY-C+"px")}function M(){b=!1,document.removeEventListener("mousemove",N),r()}m?.addEventListener("mousedown",(e=>{b=!0,q=e.clientX-u.offsetLeft,C=e.clientY-u.offsetTop,r(),document.addEventListener("mousemove",N,{passive:!0}),document.addEventListener("mouseup",M,{once:!0}),e.preventDefault()})),F?.addEventListener("click",ye);const B=initDropdown("callTypeInput",["CF-FM","FM-CF-FM","FM","FM-QCF","QCF"]),T=initDropdown("harmonicInput",["0","1","2","3"]);if(T.onChange=function(e,t){L[x].harmonic=t,Z||te()},k)for(let e=0;e<8;e++){const t=document.createElement("button");t.textContent=`${e+1}`,t.className="tab-btn",0===e&&t.classList.add("active"),t.addEventListener("click",(()=>le(e))),k.appendChild(t),I.push(t)}const R={start:document.getElementById("startFreqInput"),end:document.getElementById("endFreqInput"),high:document.getElementById("highFreqInput"),low:document.getElementById("lowFreqInput"),knee:document.getElementById("kneeFreqInput"),heel:document.getElementById("heelFreqInput"),cfStart:document.getElementById("cfStartFreqInput"),cfEnd:document.getElementById("cfEndFreqInput")},S={start:document.getElementById("startFreqRow"),end:document.getElementById("endFreqRow"),high:document.getElementById("highFreqRow"),low:document.getElementById("lowFreqRow"),knee:document.getElementById("kneeFreqRow"),heel:document.getElementById("heelFreqRow"),cfStart:document.getElementById("cfStartFreqRow"),cfEnd:document.getElementById("cfEndFreqRow")},$=document.getElementById("bandwidthVal"),j=document.getElementById("durationVal"),O=document.getElementById("pulseIdBtn"),H=document.getElementById("sequenceIdBtn"),A=document.getElementById("autoIdResult"),D=document.getElementById("bandwidth-warning"),Q=document.getElementById("freq-order-warning"),V=document.getElementById("knee-order-warning"),P=document.getElementById("time-order-warning");const W={start:"#e74c3c",end:"#004cff",high:"#3498db",low:"#9b59b6",knee:"#f39c12",heel:"#16a085",cfStart:"#e67e22",cfEnd:"#1abc9c"},K={start:"Start freq.",end:"End freq.",high:"High freq.",low:"Low freq.",knee:"Knee freq.",heel:"Heel freq.",cfStart:"CF start",cfEnd:"CF end"};let X=L[x].markers,Y=null,_=null,z=null,G=null,J=null,U=!0,Z=!1;function ee(){const e=L[x].autoIdResult;A&&(e?A.innerHTML=pe(e):A.textContent="-")}function te(){null!=L[x].autoIdResult&&(L[x].autoIdResult=null,ee(),ce())}function ne(e){const t=L[e];X=t.markers,Z=!0,B.select(t.callType),T.select(t.harmonic),Z=!1,Object.keys(R).forEach((e=>{R[e].value=t.inputs[e]||"",null!=t.markers[e].time?R[e].dataset.time=t.markers[e].time:delete R[e].dataset.time})),_=t.startTime,z=t.endTime,re(),ce(),ee(),he()}function le(e){e!==x&&(!function(){const e=L[x];e.callType=B.selectedIndex,e.harmonic=T.selectedIndex,e.startTime=_,e.endTime=z,Object.keys(R).forEach((t=>{e.inputs[t]=R[t].value}))}(),I[x]&&I[x].classList.remove("active"),x=e,I[x]&&I[x].classList.add("active"),ne(e))}function ae(e){U=e,document.body.classList.toggle("markers-disabled",!e)}function se(e){const t=R[e];t&&(t.value="",delete t.dataset.time,t.classList.remove("active-get"),t.classList.remove("invalid"),t.classList.remove("warning"),X[e].freq=null,X[e].time=null,X[e].el&&(X[e].el.style.display="none"),"start"===e&&(_=null),"end"===e&&(z=null),L[x].inputs[e]="",L[x].markers[e].freq=null,L[x].markers[e].time=null,L[x].startTime=_,L[x].endTime=z,re(),ce(),Z||te(),he())}ae(!0),Object.entries(R).forEach((([e,t])=>{t&&(t.dataset.key=e,t.readOnly=!0,t.addEventListener("click",(()=>{if(Y===t)return t.classList.remove("active-get"),Y=null,void ae(!0);Y&&Y.classList.remove("active-get"),Y=t,t.classList.add("active-get"),ae(!1)})))}));const ie={};function oe(e,t){const n=S[e];if(!n)return;n.style.display=t?"flex":"none",R[e]&&(R[e].disabled=!t);const l=ie[e];l&&(l.disabled=!t),t||se(e),he()}function re(){const e=B.items[B.selectedIndex],t=parseFloat(R.high.value),n=parseFloat(R.low.value),l=parseFloat(R.knee.value),a=parseFloat(R.cfStart.value),s=parseFloat(R.end.value);let i=null;["FM-CF-FM","CF-FM"].includes(e)?isNaN(a)||isNaN(s)?$.textContent="-":(i=a-s,$.textContent=i.toFixed(1)):isNaN(t)||isNaN(n)?$.textContent="-":(i=t-n,$.textContent=i.toFixed(1));const o=Object.values(X).filter((e=>null!=e.time&&!isNaN(e.freq))).map((e=>e.time));if(o.length>=2){const e=Math.max(...o),t=Math.min(...o);j.textContent=(1e3*(e-t)).toFixed(1)}else j.textContent="-";!function(e,t,n,l,a,s){const i="QCF"===B.items[B.selectedIndex]&&null!=l&&l>5,o=!isNaN(e)&&!isNaN(t)&&t>e,r=!isNaN(n)&&!isNaN(t)&&n<t,d=null!=a&&null!=s&&s<a,c=i||o||r||d;R.high&&R.high.classList.toggle("warning",i||o),R.low&&R.low.classList.toggle("warning",i||o||r),R.knee&&R.knee.classList.toggle("warning",r),R.start&&R.start.classList.toggle("warning",d),R.end&&R.end.classList.toggle("warning",d),D&&(D.style.display=i?"flex":"none"),Q&&(Q.style.display=o?"flex":"none"),V&&(V.style.display=r?"flex":"none"),P&&(P.style.display=d?"flex":"none"),O&&(O.disabled=c),H&&(H.disabled=c)}(t,n,l,i,_,z)}function de(e){const t=document.createElement("div");return t.className="pulseid-result",t.dataset.tab=e,h.appendChild(t),t.addEventListener("click",(t=>{t.stopPropagation(),"block"!==u.style.display&&(u.style.display="block",document.body.classList.add("autoid-open"),document.dispatchEvent(new Event("autoid-open"))),le(e)})),t.addEventListener("mouseenter",r),t.addEventListener("mouseleave",d),t.addEventListener("contextmenu",(e=>{e.preventDefault(),e.stopPropagation()})),t}function ce(){const{min:e,max:t}=o(),n=p.scrollWidth;L.forEach(((l,a)=>{let o=1/0,c=-1/0,u=-1/0,m=!1;Object.entries(l.markers).forEach((([l,f])=>{if(f.el||(f.el=function(e,t){const n=document.createElement("i");n.className=`fa-solid fa-xmark freq-marker marker-${e}`,n.style.color=W[e],n.dataset.key=e,n.dataset.tab=t;const l=K[e]||e;return n.dataset.title=l,n.setAttribute("aria-label",l),n.addEventListener("mouseenter",r),n.addEventListener("mouseleave",d),n.addEventListener("mousedown",(t=>{U&&(t.stopPropagation(),r(),y.classList.add("hide-cursor"),n.classList.add("hide-cursor"),G=e,J=n,document.addEventListener("mousemove",me,{passive:!0}),document.addEventListener("mouseup",fe,{once:!0}))})),n.addEventListener("click",(e=>e.stopPropagation())),h.appendChild(n),n}(l,a)),null==f.freq||null==f.time)return void(f.el.style.display="none");const p=f.time/i()*n-y.scrollLeft,g=(1-(f.freq-e)/(t-e))*s;f.el.style.left=`${p}px`,f.el.style.top=`${g}px`,f.el.style.display="block",f.el.style.pointerEvents=a===x?"auto":"none",f.el.style.opacity=a===x?"1":"0.5",f.el.dataset.freq=f.freq,f.el.dataset.time=f.time,o=Math.min(o,p),c=Math.max(c,p),u=Math.max(u,g),m=!0})),l.resultEl||(l.resultEl=de(a));const f=l.resultEl;l.autoIdResult&&m?(f.innerHTML=pe(l.autoIdResult),f.style.left=(o+c)/2+"px",f.style.top=`${u+20}px`,f.style.display="block",f.classList.toggle("inactive",a!==x)):f.style.display="none"})),ue()}function ue(){const{min:e,max:t}=o(),n=p.scrollWidth;L.forEach(((l,a)=>{l.line||(l.line=document.createElementNS(g,"path"),l.line.dataset.tab=a,v.appendChild(l.line));const o=Object.entries(l.markers).filter((([e,t])=>null!=t.freq&&null!=t.time)).sort(((e,t)=>e[1].time-t[1].time)).map((([l,a])=>({x:a.time/i()*n-y.scrollLeft,y:(1-(a.freq-e)/(t-e))*s,key:l})));if(o.length<2)return l.line.setAttribute("d",""),void(l.line.style.display="none");const r=function(e,t=.5){if(e.length<2)return"";let n=`M ${e[0].x} ${e[0].y}`;const l=10;for(let a=0;a<e.length-1;a++){const s=e[a-1]||e[a],i=e[a],o=e[a+1],r=e[a+2]||o,d=a===e.length-2,c=Math.abs(i.y-o.y);if("cfStart"===i.key&&"cfEnd"===o.key)n+=` L ${o.x} ${o.y}`;else if(d&&c<5)n+=` L ${i.x} ${o.y} L ${o.x} ${o.y}`;else{const e=i.x+(o.x-s.x)*t/6,a=i.y+(o.y-s.y)*t/6;let d=o.x-(r.x-i.x)*t/6,c=o.y-(r.y-i.y)*t/6;if("high"===i.key&&"knee"===o.key){const e=Math.hypot(o.x-i.x,o.y-i.y),n=Math.hypot(r.x-o.x,r.y-o.y),l=e?1+n/e*5:1;d=o.x-(r.x-i.x)*t/6*l,c=o.y-(r.y-i.y)*t/6*l}if("cfStart"!==o.key&&"end"!==o.key){const e=Math.abs(i.y-o.y),t=Math.min(l,.6*e);c=Math.min(c,o.y+t),d=Math.min(d,o.x)}n+=` C ${e} ${a} ${d} ${c} ${o.x} ${o.y}`}}return n}(o);l.line.setAttribute("stroke-linejoin","round"),l.line.setAttribute("d",r),l.line.style.display="block",l.line.style.opacity=a===x?"1":"0.5"}))}function me(e){if(!G||!U)return;const t=y.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,a=y.scrollLeft||0,{min:r,max:d}=o(),c=(1-l/s)*(d-r)+r,u=(n+a)/p.scrollWidth*i(),m=R[G];m&&(m.value=c.toFixed(1),m.dataset.time=u,m===R.start&&(_=u),m===R.end&&(z=u)),L[x].startTime=_,L[x].endTime=z,X[G].freq=c,X[G].time=u,re(),ce()}function fe(){G=null,J&&(J.classList.remove("hide-cursor"),J=null),document.removeEventListener("mousemove",me),y.classList.remove("hide-cursor"),d(),he(),te()}function ye(){var e;L[x].showValidation=!1,(e=L[x]).callType=3,e.harmonic=0,e.autoIdResult=null,e.showValidation=!1,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")})),e.line&&(e.line.setAttribute("d",""),e.line.style.display="none"),B.select(3),T.select(0),Object.values(R).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"),e.classList.remove("invalid"),e.classList.remove("warning"))})),$.textContent="-",j.textContent="-",_=null,z=null,Y=null,L[x].autoIdResult=null,ae(!0),ne(x)}function pe(e){return e.split(" / ").map((e=>{if(e.endsWith("sp.")){return`<i>${e.replace(" sp.","")}</i> sp.`}return"TBC"===e||"-"===e||"No species matched"===e?e:`<i>${e}</i>`})).join(" / ")}function he(e=!1){const t=L[x];e&&(t.showValidation=!0);const n=t.showValidation,l={"CF-FM":["cfStart","cfEnd"],"FM-CF-FM":["cfStart","cfEnd"],FM:["high","low"],"FM-QCF":["high","low","knee"],QCF:["high","low"]}[B.items[B.selectedIndex]]||[];let a=!0;return Object.entries(R).forEach((([e,t])=>{if(t)if(l.includes(e)){const e=parseFloat(t.value),l=!isNaN(e);n?t.classList.toggle("invalid",!l):t.classList.remove("invalid"),l||(a=!1)}else t.classList.remove("invalid")})),a}function ge(){if(!he(!0))return L[x].autoIdResult=null,A&&(A.textContent="-"),void ce();const e=B.items[B.selectedIndex],t=parseFloat(R.high.value),n=parseFloat(R.low.value),l=parseFloat(R.knee.value),a=parseFloat(R.heel.value),s=parseFloat(R.start.value),i=parseFloat(R.end.value),o=parseFloat(R.cfStart.value),r=parseFloat(R.cfEnd.value);let d=null;const c=Object.values(X).filter((e=>null!=e.time&&!isNaN(e.freq))).map((e=>e.time));if(c.length>=2){d=1e3*(Math.max(...c)-Math.min(...c))}let u=null;["FM-CF-FM","CF-FM"].includes(e)?isNaN(o)||isNaN(i)||(u=o-i):isNaN(t)||isNaN(n)||(u=t-n);const m=null!=X.knee.time&&null!=X.low.time?1e3*(X.knee.time-X.low.time):null,f=isNaN(l)||isNaN(n)?null:l-n,y=isNaN(a)||isNaN(n)?null:a-n,p=isNaN(l)||isNaN(a)?null:l-a,h=parseInt(T.items[T.selectedIndex],10),g=autoIdHK({callType:e,harmonic:h,highestFreq:t,lowestFreq:n,kneeFreq:l,heelFreq:a,startFreq:s,endFreq:i,cfStart:o,cfEnd:r,duration:d,bandwidth:u,kneeLowTime:m,kneeLowBandwidth:f,heelLowBandwidth:y,kneeHeelBandwidth:p});L[x].autoIdResult=g,ee(),ce()}return u.querySelectorAll(".autoid-marker[data-key]").forEach((e=>{const t=e.dataset.key;ie[t]=e,e.addEventListener("click",(e=>{e.preventDefault(),se(t)}))})),B.onChange=function(e,t){const n=["CF-FM","FM-CF-FM"].includes(e),l=["CF-FM","FM-CF-FM","QCF"].includes(e),a=["QCF","FM-QCF","FM"].includes(e);oe("high",!n),oe("low",!n),oe("knee",!l),oe("heel",!l),oe("cfStart",!a),oe("cfEnd",!a),L[x].callType=t,Z||te(),re(),ue(),he()},T.select(0),B.select(3),ne(0),y.addEventListener("click",(e=>{if(!Y)return;const t=y.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,a=y.scrollLeft||0,{min:r,max:d}=o(),c=(1-l/s)*(d-r)+r,u=(n+a)/p.scrollWidth*i(),m=Y.dataset.key;Y.value=c.toFixed(1),Y.dataset.time=u,X[m].freq=c,X[m].time=u,Y===R.start&&(_=u),Y===R.end&&(z=u),L[x].startTime=_,L[x].endTime=z,Y.classList.remove("active-get"),Y=null,ae(!0),re(),ce(),te()})),y.addEventListener("scroll",ce),O?.addEventListener("click",ge),H?.addEventListener("click",(function(){ge()})),{updateMarkers:ce,reset:function(){L.forEach((e=>{e.showValidation=!1,e.callType=3,e.harmonic=0,e.autoIdResult=null,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.keys(e.markers).forEach((t=>{e.markers[t].freq=null,e.markers[t].time=null})),e.line&&(e.line.setAttribute("d",""),e.line.style.display="none")})),B.select(3),T.select(0),Object.values(R).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"),e.classList.remove("invalid"),e.classList.remove("warning"))})),$.textContent="-",j.textContent="-",_=null,z=null,L.forEach((e=>{Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")}))})),Y=null,ae(!0),ne(x)},resetCurrentTab:ye,setMarkerAt:function(e,t,n){const l=R[e];l&&(l.value=t.toFixed(1),l.dataset.time=n,X[e].freq=t,X[e].time=n,"start"===e&&(_=n),"end"===e&&(z=n),L[x].startTime=_,L[x].endTime=z,re(),ce(),te(),he())},removeMarker:function(e){se(e)},isFieldEnabled:function(e){const t=R[e];return t&&!t.disabled},getFreqRange:o,getDuration:()=>i(),spectrogramHeight:s}}