import{initDropdown}from"./dropdown.js";import{autoIdHK}from"./autoid_HK.js";export function initAutoIdPanel({buttonId:e="autoIdBtn",panelId:t="auto-id-panel",viewerId:n="viewer-container",containerId:l="spectrogram-only",overlayId:i="fixed-overlay",spectrogramHeight:s=800,getDuration:o=(()=>0),getFreqRange:a=(()=>({min:0,max:0})),hideHover:r=(()=>{}),refreshHover:d=(()=>{})}={}){const c=document.getElementById(e),u=document.getElementById(t),m=u.querySelector(".popup-drag-bar"),f=u.querySelector(".popup-close-btn"),p=document.getElementById(n),y=document.getElementById(l),h=document.getElementById(i),g="http://www.w3.org/2000/svg",v=document.createElementNS(g,"svg");v.id="autoid-lines",h.appendChild(v);const E=document.getElementById("layout");E&&u&&u.parentElement!==E&&E.appendChild(u);const F=document.getElementById("autoIdTabResetBtn"),k=document.getElementById("autoid-tabs"),w=[],I=Array.from({length:5},(()=>({callType:3,harmonic:0,result:null,showValidation:!1,inputs:{start:"",end:"",high:"",low:"",knee:"",heel:"",cfStart:"",cfEnd:""},startTime:null,endTime:null,markers:{start:{el:null,freq:null,time:null},end:{el:null,freq:null,time:null},high:{el:null,freq:null,time:null},low:{el:null,freq:null,time:null},knee:{el:null,freq:null,time:null},heel:{el:null,freq:null,time:null},cfStart:{el:null,freq:null,time:null},cfEnd:{el:null,freq:null,time:null}},line:null})));let x=0;if(!c||!u||!p)return;function L(){const e="block"===u.style.display;u.style.display=e?"none":"block",document.body.classList.toggle("autoid-open",!e),document.dispatchEvent(new Event(e?"autoid-close":"autoid-open"))}c.addEventListener("click",L),f?.addEventListener("click",L);let b=!1,q=0,C=0;function B(e){b&&(u.style.left=e.clientX-q+"px",u.style.top=e.clientY-C+"px")}function M(){b=!1,document.removeEventListener("mousemove",B),r()}m?.addEventListener("mousedown",(e=>{b=!0,q=e.clientX-u.offsetLeft,C=e.clientY-u.offsetTop,r(),document.addEventListener("mousemove",B,{passive:!0}),document.addEventListener("mouseup",M,{once:!0}),e.preventDefault()})),F?.addEventListener("click",ue);const T=initDropdown("callTypeInput",["CF-FM","FM-CF-FM","FM","FM-QCF","QCF"]),N=initDropdown("harmonicInput",["0","1","2","3"]);if(N.onChange=function(e,t){I[x].harmonic=t,G||Z()},k)for(let e=0;e<5;e++){const t=document.createElement("button");t.textContent=`${e+1}`,t.className="tab-btn",0===e&&t.classList.add("active"),t.addEventListener("click",(()=>te(e))),k.appendChild(t),w.push(t)}const S={start:document.getElementById("startFreqInput"),end:document.getElementById("endFreqInput"),high:document.getElementById("highFreqInput"),low:document.getElementById("lowFreqInput"),knee:document.getElementById("kneeFreqInput"),heel:document.getElementById("heelFreqInput"),cfStart:document.getElementById("cfStartFreqInput"),cfEnd:document.getElementById("cfEndFreqInput")},$={start:document.getElementById("startFreqRow"),end:document.getElementById("endFreqRow"),high:document.getElementById("highFreqRow"),low:document.getElementById("lowFreqRow"),knee:document.getElementById("kneeFreqRow"),heel:document.getElementById("heelFreqRow"),cfStart:document.getElementById("cfStartFreqRow"),cfEnd:document.getElementById("cfEndFreqRow")},R=document.getElementById("bandwidthVal"),j=document.getElementById("durationVal"),O=document.getElementById("pulseIdBtn"),H=document.getElementById("sequenceIdBtn"),A=document.getElementById("autoIdResult"),Q=document.getElementById("bandwidth-warning"),V=document.getElementById("freq-order-warning"),D=document.getElementById("knee-order-warning"),W=document.getElementById("time-order-warning");const X={start:"#e74c3c",end:"#004cff",high:"#3498db",low:"#9b59b6",knee:"#f39c12",heel:"#16a085",cfStart:"#e67e22",cfEnd:"#1abc9c"};let Y=I[x].markers,K=null,P=null,U=null,_=null,z=!0,G=!1;function J(){const e=I[x].result;A&&(e?A.innerHTML=function(e){if(new Set(["Hipposideros armiger","Hipposideros gentilis","Rhinolophus affinis","Rhinolophus pusillus","Rhinolophus sinicus"]).has(e))return`<i>${e}</i>`;if("Hipposideros sp."===e)return"<i>Hipposideros</i> sp.";if("Rhinolophus sp."===e)return"<i>Rhinolophus</i> sp.";return e}(e):A.textContent="-")}function Z(){null!=I[x].result&&(I[x].result=null,J())}function ee(e){const t=I[e];Y=t.markers,G=!0,T.select(t.callType),N.select(t.harmonic),G=!1,Object.keys(S).forEach((e=>{S[e].value=t.inputs[e]||"",null!=t.markers[e].time?S[e].dataset.time=t.markers[e].time:delete S[e].dataset.time})),P=t.startTime,U=t.endTime,oe(),ae(),J(),me()}function te(e){e!==x&&(!function(){const e=I[x];e.callType=T.selectedIndex,e.harmonic=N.selectedIndex,e.startTime=P,e.endTime=U,Object.keys(S).forEach((t=>{e.inputs[t]=S[t].value}))}(),w[x]&&w[x].classList.remove("active"),x=e,w[x]&&w[x].classList.add("active"),ee(e))}function ne(e){z=e,document.body.classList.toggle("markers-disabled",!e)}function le(e){const t=S[e];t&&(t.value="",delete t.dataset.time,t.classList.remove("active-get"),t.classList.remove("invalid"),t.classList.remove("warning"),Y[e].freq=null,Y[e].time=null,Y[e].el&&(Y[e].el.style.display="none"),"start"===e&&(P=null),"end"===e&&(U=null),I[x].inputs[e]="",I[x].markers[e].freq=null,I[x].markers[e].time=null,I[x].startTime=P,I[x].endTime=U,oe(),ae(),Z(),me())}ne(!0),Object.entries(S).forEach((([e,t])=>{t&&(t.dataset.key=e,t.readOnly=!0,t.addEventListener("click",(()=>{if(K===t)return t.classList.remove("active-get"),K=null,void ne(!0);K&&K.classList.remove("active-get"),K=t,t.classList.add("active-get"),ne(!1)})))}));const ie={};function se(e,t){const n=$[e];if(!n)return;n.style.display=t?"flex":"none",S[e]&&(S[e].disabled=!t);const l=ie[e];l&&(l.disabled=!t),t||le(e),me()}function oe(){const e=T.items[T.selectedIndex],t=parseFloat(S.high.value),n=parseFloat(S.low.value),l=parseFloat(S.knee.value),i=parseFloat(S.cfStart.value),s=parseFloat(S.end.value);let o=null;["FM-CF-FM","CF-FM"].includes(e)?isNaN(i)||isNaN(s)?R.textContent="-":(o=i-s,R.textContent=o.toFixed(1)):isNaN(t)||isNaN(n)?R.textContent="-":(o=t-n,R.textContent=o.toFixed(1)),null!=P&&null!=U?j.textContent=(1e3*(U-P)).toFixed(1):null!=Y.high.time&&null!=Y.low.time?j.textContent=(1e3*(Y.low.time-Y.high.time)).toFixed(1):j.textContent="-",function(e,t,n,l,i,s){const o="QCF"===T.items[T.selectedIndex]&&null!=l&&l>5,a=!isNaN(e)&&!isNaN(t)&&t>e,r=!isNaN(n)&&!isNaN(t)&&n<t,d=null!=i&&null!=s&&s<i;S.high&&S.high.classList.toggle("warning",o||a),S.low&&S.low.classList.toggle("warning",o||a||r),S.knee&&S.knee.classList.toggle("warning",r),S.start&&S.start.classList.toggle("warning",d),S.end&&S.end.classList.toggle("warning",d),Q&&(Q.style.display=o?"flex":"none"),V&&(V.style.display=a?"flex":"none"),D&&(D.style.display=r?"flex":"none"),W&&(W.style.display=d?"flex":"none")}(t,n,l,o,P,U)}function ae(){const{min:e,max:t}=a(),n=y.scrollWidth;I.forEach(((l,i)=>{Object.entries(l.markers).forEach((([l,a])=>{if(a.el||(a.el=function(e,t){const n=document.createElement("i");return n.className=`fa-solid fa-xmark freq-marker marker-${e}`,n.style.color=X[e],n.dataset.key=e,n.dataset.tab=t,n.title=`${e.charAt(0).toUpperCase()+e.slice(1)} freq. marker`,n.addEventListener("mouseenter",r),n.addEventListener("mouseleave",d),n.addEventListener("mousedown",(t=>{z&&(t.stopPropagation(),r(),_=e,document.addEventListener("mousemove",de,{passive:!0}),document.addEventListener("mouseup",ce,{once:!0}))})),n.addEventListener("click",(e=>e.stopPropagation())),h.appendChild(n),n}(l,i)),null==a.freq||null==a.time)return void(a.el.style.display="none");const c=a.time/o()*n-p.scrollLeft,u=(1-(a.freq-e)/(t-e))*s;a.el.style.left=`${c}px`,a.el.style.top=`${u}px`,a.el.style.display="block",a.el.style.pointerEvents=i===x?"auto":"none",a.el.style.opacity=i===x?"1":"0.5",a.el.dataset.freq=a.freq,a.el.dataset.time=a.time}))})),re()}function re(){const{min:e,max:t}=a(),n=y.scrollWidth;I.forEach(((l,i)=>{l.line||(l.line=document.createElementNS(g,"path"),l.line.dataset.tab=i,v.appendChild(l.line));const a=Object.entries(l.markers).filter((([e,t])=>null!=t.freq&&null!=t.time)).sort(((e,t)=>e[1].time-t[1].time)).map((([l,i])=>({x:i.time/o()*n-p.scrollLeft,y:(1-(i.freq-e)/(t-e))*s,key:l})));if(a.length<2)return l.line.setAttribute("d",""),void(l.line.style.display="none");const r=function(e,t=.5){if(e.length<2)return"";let n=`M ${e[0].x} ${e[0].y}`;const l=10;for(let i=0;i<e.length-1;i++){const s=e[i-1]||e[i],o=e[i],a=e[i+1],r=e[i+2]||a,d=i===e.length-2,c=Math.abs(o.y-a.y);if("cfStart"===o.key&&"cfEnd"===a.key)n+=` L ${a.x} ${a.y}`;else if(d&&c<5)n+=` L ${o.x} ${a.y} L ${a.x} ${a.y}`;else{const e=o.x+(a.x-s.x)*t/6,i=o.y+(a.y-s.y)*t/6;let d=a.x-(r.x-o.x)*t/6,c=a.y-(r.y-o.y)*t/6;if("cfStart"!==a.key&&"end"!==a.key){const e=Math.abs(o.y-a.y),t=Math.min(l,.6*e);c=Math.min(c,a.y+t),d=Math.min(d,a.x)}n+=` C ${e} ${i} ${d} ${c} ${a.x} ${a.y}`}}return n}(a);l.line.setAttribute("stroke-linejoin","round"),l.line.setAttribute("d",r),l.line.style.display="block",l.line.style.opacity=i===x?"1":"0.5"}))}function de(e){if(!_||!z)return;const t=p.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,i=p.scrollLeft||0,{min:r,max:d}=a(),c=(1-l/s)*(d-r)+r,u=(n+i)/y.scrollWidth*o(),m=S[_];m&&(m.value=c.toFixed(1),m.dataset.time=u,m===S.start&&(P=u),m===S.end&&(U=u)),I[x].startTime=P,I[x].endTime=U,Y[_].freq=c,Y[_].time=u,oe(),ae()}function ce(){_=null,document.removeEventListener("mousemove",de),d(),me(),Z()}function ue(){var e;I[x].showValidation=!1,(e=I[x]).callType=3,e.harmonic=0,e.result=null,e.showValidation=!1,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")})),e.line&&(e.line.setAttribute("d",""),e.line.style.display="none"),T.select(3),N.select(0),Object.values(S).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"),e.classList.remove("invalid"),e.classList.remove("warning"))})),R.textContent="-",j.textContent="-",P=null,U=null,K=null,I[x].result=null,ne(!0),ee(x)}function me(e=!1){const t=I[x];e&&(t.showValidation=!0);const n=t.showValidation,l={"CF-FM":["cfStart","cfEnd"],"FM-CF-FM":["cfStart","cfEnd"],FM:["high","low"],"FM-QCF":["high","low","knee"],QCF:["high","low"]}[T.items[T.selectedIndex]]||[];let i=!0;return Object.entries(S).forEach((([e,t])=>{if(t)if(l.includes(e)){const e=parseFloat(t.value),l=!isNaN(e);n?t.classList.toggle("invalid",!l):t.classList.remove("invalid"),l||(i=!1)}else t.classList.remove("invalid")})),i}return u.querySelectorAll(".autoid-marker[data-key]").forEach((e=>{const t=e.dataset.key;ie[t]=e,e.addEventListener("click",(e=>{e.preventDefault(),le(t)}))})),T.onChange=function(e,t){const n=["CF-FM","FM-CF-FM"].includes(e),l=["CF-FM","FM-CF-FM","QCF"].includes(e),i=["QCF","FM-QCF","FM"].includes(e);se("high",!n),se("low",!n),se("knee",!l),se("heel",!l),se("cfStart",!i),se("cfEnd",!i),I[x].callType=t,G||Z(),oe(),re(),me()},N.select(0),T.select(3),ee(0),p.addEventListener("click",(e=>{if(!K)return;const t=p.getBoundingClientRect(),n=e.clientX-t.left,l=e.clientY-t.top,i=p.scrollLeft||0,{min:r,max:d}=a(),c=(1-l/s)*(d-r)+r,u=(n+i)/y.scrollWidth*o(),m=K.dataset.key;K.value=c.toFixed(1),K.dataset.time=u,Y[m].freq=c,Y[m].time=u,K===S.start&&(P=u),K===S.end&&(U=u),I[x].startTime=P,I[x].endTime=U,K.classList.remove("active-get"),K=null,ne(!0),oe(),ae(),Z()})),p.addEventListener("scroll",ae),O?.addEventListener("click",(function(){if(!me(!0))return void(A&&(A.textContent="-"));const e=T.items[T.selectedIndex],t=parseFloat(S.low.value),n=parseFloat(S.cfStart.value);let l=null;null!=P&&null!=U?l=1e3*(U-P):null!=Y.high.time&&null!=Y.low.time&&(l=1e3*(Y.low.time-Y.high.time));const i=autoIdHK({callType:e,cfStart:n,duration:l,lowFreq:t});I[x].result=i,J()})),H?.addEventListener("click",(function(){me(!0)?(I[x].result=null,J()):A&&(A.textContent="-")})),{updateMarkers:ae,reset:function(){I.forEach((e=>{e.showValidation=!1,e.callType=3,e.harmonic=0,e.result=null,Object.keys(e.inputs).forEach((t=>{e.inputs[t]=""})),e.startTime=null,e.endTime=null,Object.keys(e.markers).forEach((t=>{e.markers[t].freq=null,e.markers[t].time=null})),e.line&&(e.line.setAttribute("d",""),e.line.style.display="none")})),T.select(3),N.select(0),Object.values(S).forEach((e=>{e&&(e.value="",delete e.dataset.time,e.classList.remove("active-get"),e.classList.remove("invalid"),e.classList.remove("warning"))})),R.textContent="-",j.textContent="-",P=null,U=null,I.forEach((e=>{Object.values(e.markers).forEach((e=>{e.freq=null,e.time=null,e.el&&(e.el.style.display="none")}))})),K=null,ne(!0),ee(x)},resetCurrentTab:ue,setMarkerAt:function(e,t,n){const l=S[e];l&&(l.value=t.toFixed(1),l.dataset.time=n,Y[e].freq=t,Y[e].time=n,"start"===e&&(P=n),"end"===e&&(U=n),I[x].startTime=P,I[x].endTime=U,oe(),ae(),Z(),me())},removeMarker:function(e){le(e)},isFieldEnabled:function(e){const t=S[e];return t&&!t.disabled},getFreqRange:a,getDuration:()=>o(),spectrogramHeight:s}}