import{extractGuanoMetadata,parseGuanoMetadata}from"./guanoReader.js";import{addFilesToList,getFileList,getCurrentIndex,setCurrentIndex,removeFilesByName,setFileMetadata}from"./fileState.js";export async function getWavSampleRate(e){if(!e)return 256e3;const t=await e.arrayBuffer(),n=new DataView(t);let a=12;for(;a<n.byteLength-8;){const e=String.fromCharCode(n.getUint8(a),n.getUint8(a+1),n.getUint8(a+2),n.getUint8(a+3)),t=n.getUint32(a+4,!0);if("fmt "===e)return n.getUint32(a+12,!0);a+=8+t,t%2==1&&(a+=1)}return 256e3}let lastObjectUrl=null;export function initFileLoader({fileInputId:e,wavesurfer:t,spectrogramHeight:n,colorMap:a,onPluginReplaced:o,onFileLoaded:r,onBeforeLoad:i,onAfterLoad:d,onSampleRateDetected:l}){const c=document.getElementById(e),s=document.getElementById("prevBtn"),u=document.getElementById("nextBtn"),m=document.getElementById("fileNameText"),g=document.getElementById("guano-output"),f=document.getElementById("spectrogram-settings"),p=document.getElementById("upload-overlay"),y=document.getElementById("upload-progress-bar"),x=document.getElementById("upload-progress-text");function v(e,t){if(y){const n=t>0?e/t*100:0;y.style.width=`${n}%`}x&&(x.textContent=`${e}/${t}`)}async function w(e){if(!e)return;const n=await getWavSampleRate(e);"function"==typeof i&&i(),"function"==typeof r&&r(e),"function"==typeof l&&await l(n,!0),m&&(m.textContent=e.name);try{const t=await extractGuanoMetadata(e);g.textContent=t||"(No GUANO metadata found)";const n=parseGuanoMetadata(t),a=getCurrentIndex();setFileMetadata(a,n)}catch(e){g.textContent="(Error reading GUANO metadata)"}const a=URL.createObjectURL(e);lastObjectUrl&&URL.revokeObjectURL(lastObjectUrl),lastObjectUrl=a,await t.load(a),"function"==typeof o&&o();const c=n||t?.options?.sampleRate||256e3;f&&(f.textContent=`Sampling rate: ${c/1e3}kHz`),"function"==typeof d&&d(),document.dispatchEvent(new Event("file-loaded"))}return c.addEventListener("change",(async e=>{const t=Array.from(e.target.files),n=t[0];if(!n)return;const a=t.filter((e=>e.name.endsWith(".wav")));var o;o=a.length,p&&(document.dispatchEvent(new Event("drop-overlay-hide")),y&&(y.style.width="0%"),x&&(x.textContent=`0/${o}`),p.style.display="flex"),"function"==typeof i&&i();const r=a.sort(((e,t)=>e.name.localeCompare(t.name))),d=r.findIndex((e=>e.name===n.name));removeFilesByName("demo_recording.wav");const l=getFileList().length;addFilesToList(r,d);for(let e=0;e<r.length;e++){try{const t=await extractGuanoMetadata(r[e]),n=parseGuanoMetadata(t);setFileMetadata(l+e,n)}catch(t){setFileMetadata(l+e,{date:"",time:"",latitude:"",longitude:""})}v(e+1,r.length)}p&&(p.style.display="none"),await w(n),c.value=""})),s.addEventListener("click",(()=>{const e=getCurrentIndex();if(e>0){setCurrentIndex(e-1);w(getFileList()[e-1])}})),u.addEventListener("click",(()=>{const e=getCurrentIndex(),t=getFileList();if(e<t.length-1){setCurrentIndex(e+1);w(t[e+1])}})),document.addEventListener("keydown",(e=>{e.ctrlKey||("ArrowUp"===e.key?(e.preventDefault(),s.click()):"ArrowDown"===e.key&&(e.preventDefault(),u.click()))})),{loadFileAtIndex:async e=>{const t=getFileList();e>=0&&e<t.length&&(setCurrentIndex(e),await w(t[e]))}}}